# =============================================================================
# Audit Event Identifier: DSU-CIC-600004
# Pipeline Type: Woodpecker CI
# Description: CI pipeline for style enforcement and secret detection
# Last Updated: 2026-02-28
# Version: 1.0
# =============================================================================
---
pipeline:
  style-enforcement:
    image: ubuntu:24.04
    commands:
      - apt-get update && apt-get install -y git python3 python3-pip
      - pip3 install ansible-lint detect-secrets
      - chmod +x dev_tools/tools/style-guide-enforcement/enforce_style_guide.sh
      - ./dev_tools/tools/style-guide-enforcement/enforce_style_guide.sh --report

  detect-secrets:
    image: ubuntu:24.04
    commands:
      - apt-get update && apt-get install -y git python3 python3-pip jq
      - pip3 install detect-secrets==1.3.0
      - detect-secrets scan --all-files --json > .secrets_scan.json || true
      - SECRET_COUNT=$(jq '.results | length' .secrets_scan.json)
      - echo "Found $SECRET_COUNT potential secrets"
      - if [ "$SECRET_COUNT" -gt 0 ]; then echo "ERROR: Secrets detected in repository!"; cat .secrets_scan.json; exit 1; fi

  ansible-lint:
    image: ubuntu:24.04
    commands:
      - apt-get update && apt-get install -y git python3 python3-pip
      - pip3 install ansible-lint==24.12.2
      - ansible-lint -v -c .ansible-lint.yml site.yml

branches: [main, 'ci/**']
