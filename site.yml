---
# WARNING: This playbook is part of the solution stack.
# Use production_deploy.yml as the primary deployment entrypoint.

# Unified Deployment Playbook
# Generated by GitHub Copilot Agent for User Custom Stack
# Modified to skip failing security/audit_integrity in container env

- ansible.builtin.import_playbook: playbooks/bootstrap_ssh.yml

- name: Apply Secure Infrastructure Base (Custom)
  hosts: all
  become: true
  vars:
    base_hardened_roles:
      - ops/pre_connection
      - core/repositories
      - core/updates
      - core/bootstrap
      - core/logging
      # - security/audit_integrity # Skipped due to container failure
      - core/time
      - core/entropy
      - security/tpm_guard
  tasks:
    - name: Execute Base Roles
      ansible.builtin.include_tasks: tasks/run_role.yml
      loop: "{{ base_hardened_roles }}"
      loop_control:
        loop_var: role_item

- name: Deploy Container Stack
  hosts: all
  become: true
  vars:
    container_stack_roles:
      - containers/runtime
      - containers/config
      - containers/quadlets
      - containers/caddy       # Reverse Proxy (custom Porkbun build)
      - containers/media       # Media Stack (Jellyfin, Arr, etc.)
      - containers/ops         # Ops Stack (Homarr, Vaultwarden, Filebrowser)
      - containers/anubis      # AI Firewall
      - containers/monitoring  # Prometheus/Grafana

  tasks:
    - name: Execute Container Roles
      ansible.builtin.include_tasks: tasks/run_role.yml
      loop: "{{ container_stack_roles }}"
      loop_control:
        loop_var: role_item

  post_tasks:
    - name: Force systemd reload to pick up new Quadlets
      ansible.builtin.systemd:
        daemon_reload: true
        scope: "{{ (podman_rootless_enabled | default(false) | bool) | ternary('user', 'system') }}"
      environment: "{{ containers_systemd_env | default({}) }}"
      become: true
      become_user: "{{ (podman_rootless_enabled | default(false) | bool) | ternary(podman_rootless_user, 'root') }}"

    - name: Ensure Caddy is running
      ansible.builtin.systemd:
        name: caddy
        state: started
        enabled: true
        scope: "{{ (podman_rootless_enabled | default(false) | bool) | ternary('user', 'system') }}"
      environment: "{{ containers_systemd_env | default({}) }}"
      become: true
      become_user: "{{ (podman_rootless_enabled | default(false) | bool) | ternary(podman_rootless_user, 'root') }}"
