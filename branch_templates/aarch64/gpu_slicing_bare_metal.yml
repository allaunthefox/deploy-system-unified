---
# WARNING: THIS IS A REFERENCE TEMPLATE ONLY.
# DO NOT RUN THIS PLAYBOOK DIRECTLY FOR PRODUCTION DEPLOYMENTS.
# USE THE ROOT-LEVEL PLAYBOOKS (e.g., production_deploy.yml) INSTEAD.

# GPU Slicing Bare Metal Deployment Template (aarch64)
# For ARM Server (Grace Hopper, Ampere Altra + A100/H100) or Jetson Orin AGX
# Features: NVIDIA MIG configuration (Server) or Shared Memory (SoC)

- ansible.builtin.import_playbook: ../base_hardened.yml
- name: Deploy GPU Slicing (Bare Metal - ARM64)
  hosts: all
  become: true

  vars:
    # ARM-specific defaults (can be overridden)
    gpu_arch_setup: "aarch64"
    containers_gpu_vendor: "nvidia" # Default for Grace/Jetson

  pre_tasks:
    - name: Validate System Identity
      ansible.builtin.assert:
        that:
          - ansible_fqdn is defined
          - ansible_architecture == "aarch64"
        fail_msg: "System must be aarch64 architecture."

    # ... [Standard preflight & directory creation] ...
    - name: Precreate essential directories (idempotent)
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        mode: "{{ item.mode | default('0755') }}"
        owner: "{{ item.owner | default('root') }}"
        group: "{{ item.group | default('root') }}"
      loop:
        - { path: "/var/lib/deploy-system", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/var/lib/deploy-system/checkpoints", mode: '0700', owner: 'root', group: 'root' }
        - { path: "/var/lib/deploy-system/backups", mode: '0700', owner: 'root', group: 'root' }
        - { path: "/var/lib/deploy-system/logs", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/tmp/deploy-system", mode: '0755', owner: 'root', group: 'root' }
      become: true

    - name: Include preflight checks
      ansible.builtin.import_role:
        name: ops/preflight
      tags: [preflight]

  roles:
    - core/bootstrap
    - core/identity
    - role: networking/physical
    - networking/firewall
    - security/hardening
    - security/access
    - role: ops/monitoring
    - core/logging

    # GPU Driver Stack
    - role: hardware/gpu
      vars:
        gpu_stack_enable: true
        gpu_stack_vendor: "{{ containers_gpu_vendor }}"
        gpu_stack_arch: "aarch64"
        gpu_stack_mode: server

    # GPU-specific configuration
    - role: containers/runtime
      vars:
        containers_enable_gpu_support: true
        containers_gpu_vendor: "{{ containers_gpu_vendor }}"
        containers_gpu_slicing:
          # Strategy depends on hardware: MIG for Server GPU, Time-Slicing for SoC
          strategy: "{{ 'mig' if 'tegra' not in ansible_kernel else 'time-slicing' }}"
          auto_strategy:
            bare_metal: "mig"
          mig: { enabled: true, profiles: ["1g.5gb"] }
          time_slicing: { enabled: true, max_instances: 4 } # Common on Jetson

    - role: containers/quadlets
      vars:
        quadlet_enable_gpu_support: true
        quadlet_gpu_vendor: "{{ containers_gpu_vendor }}"
        quadlet_gpu_slicing:
          strategy: "{{ 'mig' if 'tegra' not in ansible_kernel else 'time-slicing' }}"
          mig: { enabled: true, profiles: ["1g.5gb"] }
          time_slicing: { enabled: true, max_instances: 4 }

  post_tasks:
    - name: Verify GPU functionality (NVIDIA)
      ansible.builtin.command:
        cmd: "{{ 'tegastats' if 'tegra' in ansible_kernel else 'nvidia-smi' }}"
        # Note: tegastats is interactive, might need timeout or different check like checking /sys/devices/gpu...
      register: gpu_check_output
      changed_when: false
      failed_when: false
      when: containers_gpu_vendor == "nvidia"

    - name: Display Deployment Info
      ansible.builtin.debug:
        msg: "Deployed on Aarch64. GPU Status: {{ gpu_check_output.stdout_lines[0] | default('Checked') }}"
