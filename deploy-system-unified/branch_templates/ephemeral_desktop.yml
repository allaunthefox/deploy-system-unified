---
# WARNING: THIS IS A REFERENCE TEMPLATE ONLY.
# DO NOT RUN THIS PLAYBOOK DIRECTLY FOR PRODUCTION DEPLOYMENTS.
# USE THE ROOT-LEVEL PLAYBOOKS (e.g., production_deploy.yml) INSTEAD.

# Ephemeral Desktop - Volatile Workstation Environment
# Solution: Base Ephemeral Infrastructure + Desktop/GUI Stack
# Use Case: Live ISOs, Kiosks, Secure Temporary Workstations

- ansible.builtin.import_playbook: base_hardened.yml
- ansible.builtin.import_playbook: base_ephemeral.yml

- name: Deploy Ephemeral Desktop Workload
  hosts: all
  become: true
  roles:
    # 1. Desktop Networking (Wi-Fi/GUI) - The primary test target
    - role: networking/desktop
      vars:
        networking_desktop_enable_wifi: true
        # Use iwd for testing if desired, or default wpa_supplicant
        # networking_desktop_wifi_backend: "iwd"

    # 2. Hardware/GPU in Desktop Mode
    - role: hardware/gpu
      vars:
        gpu_stack_enable: true
        gpu_stack_mode: desktop
        gpu_desktop_enable_wayland_support: true

    # 3. Core System Services (Updated for OpenRC/Systemd compat)
    - role: core/time
    - role: core/logging
    - role: ops/monitoring
      vars:
        monitoring_enable_node_exporter: true

    # 4. Container Runtime check (GPU passthrough validation)
    - role: containers/runtime
      vars:
        containers_enable_gpu_support: true

  post_tasks:
    - name: Verify NetworkManager Status
      ansible.builtin.command: systemctl status NetworkManager
      when: ansible_facts['service_mgr'] == 'systemd'
      ignore_errors: true
      changed_when: false
      tags: [verification]

    - name: Verify GPU Device Permissions (Desktop Mode)
      ansible.builtin.shell: getent group video | grep -q "{{ ansible_facts['user_id'] }}"
      ignore_errors: true # In ephemeral/molecule, user might be root or different
      changed_when: false
      tags: [verification]
