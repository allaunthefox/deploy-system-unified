name: Idempotence â€” role wrappers

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  idempotence-wrappers:
    name: Run idempotence wrapper playbooks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run idempotence wrapper playbooks inside container
        run: |
          set -euo pipefail
          docker run --rm -v "$PWD":/workspace -w /workspace ubuntu:22.04 bash -lc '
            export DEBIAN_FRONTEND=noninteractive;
            export ANSIBLE_ROLES_PATH=/workspace/projects/deploy-system-unified/roles:/workspace/projects/deploy-system-unified;
            apt-get update -y; apt-get install -y --no-install-recommends python3 python3-pip jq ca-certificates openssh-client;
            pip3 install --no-cache-dir "ansible-core>=2.15,<2.16";
            chmod +x projects/deploy-system-unified/dev_tools/ci/generate_test_secrets.sh || true;
            projects/deploy-system-unified/dev_tools/ci/generate_test_secrets.sh --output projects/deploy-system-unified/dev_tools/ci/test_secrets.yml;

            echo "==> idempotence: containers/caddy";
            ansible-playbook projects/deploy-system-unified/dev_tools/ci/idempotence-containers-caddy.yml --extra-vars @projects/deploy-system-unified/dev_tools/ci/test_secrets.yml;

            echo "==> idempotence: containers/authentik";
            ansible-playbook projects/deploy-system-unified/dev_tools/ci/idempotence-containers-authentik.yml --extra-vars @projects/deploy-system-unified/dev_tools/ci/test_secrets.yml;

            echo "==> idempotence: security/scanning";
            ansible-playbook projects/deploy-system-unified/dev_tools/ci/idempotence-security-scanning.yml --extra-vars @projects/deploy-system-unified/dev_tools/ci/test_secrets.yml;
          '
