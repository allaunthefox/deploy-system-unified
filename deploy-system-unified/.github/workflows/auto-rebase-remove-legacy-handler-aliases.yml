name: Auto-rebase & retarget alias-removal PR

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  rebase-and-retarget:
    if: "github.event.pull_request.number == 124 && github.event.pull_request.merged == true"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Rebase branch `chore/remove-legacy-handler-aliases` onto `main`
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git fetch origin main
          git fetch origin chore/remove-legacy-handler-aliases || true
          git checkout --force chore/remove-legacy-handler-aliases
          git rebase origin/main
          git push --force-with-lease origin chore/remove-legacy-handler-aliases

      - name: Retarget PR #125 to `main`
        uses: actions/github-script@v6
        with:
          script: |
            const pr = await github.rest.pulls.get({ owner: context.repo.owner, repo: context.repo.repo, pull_number: 125 }).catch(() => null);
            if (!pr) {
              console.log('PR #125 not found');
            } else {
              if (pr.data.base.ref !== 'main') {
                await github.rest.pulls.update({ owner: context.repo.owner, repo: context.repo.repo, pull_number: 125, base: 'main' });
                console.log('Retargeted PR #125 to main');
              } else {
                console.log('PR #125 already targets main');
              }
            }

      - name: Trigger style & idempotence workflows on the rebased branch
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({ owner: context.repo.owner, repo: context.repo.repo, workflow_id: 'style-enforcement.yml', ref: 'chore/remove-legacy-handler-aliases' });
            await github.rest.actions.createWorkflowDispatch({ owner: context.repo.owner, repo: context.repo.repo, workflow_id: 'idempotence-wrappers.yml', ref: 'chore/remove-legacy-handler-aliases' });
            console.log('Triggered style-enforcement and idempotence-wrappers workflows on chore/remove-legacy-handler-aliases');

      - name: Post status comments
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: github.event.pull_request.number, body: 'Auto-action: `chore/remove-legacy-handler-aliases` has been rebased onto `main` and retargeted. CI workflows were triggered.' });
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: 125, body: 'This PR was automatically rebased onto `main` and CI checks were triggered. Please review and merge when ready.' });
