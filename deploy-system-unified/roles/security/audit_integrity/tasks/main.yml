---
# Tasks for security/audit_integrity role - Cryptographic Log Immutability
- name: Derive audit integrity guards
  ansible.builtin.set_fact:
    _audit_integrity_is_container: "{{ ansible_virtualization_type | default('') in ['docker', 'podman', 'container', 'lxc'] }}"
    _audit_integrity_is_systemd: "{{ ansible_service_mgr | default('') == 'systemd' }}"
  changed_when: false

- name: Detect systemd-journal group
  ansible.builtin.getent:
    database: group
    key: systemd-journal
  register: audit_integrity_journal_group
  failed_when: false
  changed_when: false
  when: _audit_integrity_is_systemd

- name: Select journald group
  ansible.builtin.set_fact:
    _audit_integrity_journal_group: >-
      {{
        'systemd-journal'
        if 'systemd-journal' in (audit_integrity_journal_group.ansible_facts | default({})).get('getent_group', {})
        else 'root'
      }}
  changed_when: false
  when: _audit_integrity_is_systemd

- name: Ensure persistent journal directory exists
  ansible.builtin.file:
    path: /var/log/journal
    state: directory
    owner: root
    group: "{{ _audit_integrity_journal_group | default('root') }}"
    mode: '2755'
  become: true
  when:
    - _audit_integrity_is_systemd
    - not _audit_integrity_is_container

- name: Check if journal FSS keys are already initialized
  ansible.builtin.find:
    paths: /var/log/journal
    patterns: fss.pub
    file_type: file
  register: journal_fss_stat
  become: true
  failed_when: false
  changed_when: false
  when:
    - _audit_integrity_is_systemd
    - not _audit_integrity_is_container

- name: Initialize Forward Secure Sealing (FSS) keys
  ansible.builtin.shell: |
    set -o pipefail
    journalctl --setup-keys --force 2>&1 | grep -E "[0-9a-f]{6}-[0-9a-f]{6}" | tail -n 1
  args:
    executable: /bin/bash
  register: fss_verification_key_output
  become: true
  when:
    - _audit_integrity_is_systemd
    - not _audit_integrity_is_container
    - (journal_fss_stat.matched | default(0) | int) == 0
  notify: restart_journald
  no_log: true

- name: Resolve vault password file (controller)
  ansible.builtin.set_fact:
    _audit_integrity_vault_password_file: >-
      {{
        lookup('env', 'ANSIBLE_VAULT_PASSWORD_FILE') | default('', true)
        or lookup(
          'first_found',
          {
            'files': ['.vault_pass'],
            'paths': [playbook_dir, playbook_dir ~ '/..']
          },
          errors='ignore'
        )
      }}
  changed_when: false
  delegate_to: localhost
  become: false
  when:
    - audit_integrity_store_keys | bool
    - fss_verification_key_output.changed | default(false)

- name: Fail if vault password file is unavailable
  ansible.builtin.fail:
    msg: "No vault password file found. Set ANSIBLE_VAULT_PASSWORD_FILE or create .vault_pass in the playbook or repo root."
  delegate_to: localhost
  become: false
  when:
    - audit_integrity_store_keys | bool
    - fss_verification_key_output.changed | default(false)
    - _audit_integrity_vault_password_file | default('') | length == 0

- name: Create secure temporary file for FSS key capture
  ansible.builtin.tempfile:
    state: file
    prefix: "fss_key_{{ inventory_hostname }}_"
    suffix: ".txt"
  register: fss_temp_file
  delegate_to: localhost
  become: false
  when:
    - audit_integrity_store_keys | bool
    - fss_verification_key_output.changed | default(false)
  no_log: true

- name: Store FSS verification key on controller
  ansible.builtin.copy:
    content: |
      TARGET: {{ inventory_hostname }}
      TIMESTAMP: {{ ansible_date_time.iso8601 | default('unknown') }}
      VERIFICATION_KEY: {{ fss_verification_key_output.stdout }}
    dest: "{{ fss_temp_file.path }}"
    mode: '0600'
  delegate_to: localhost
  become: false
  when:
    - audit_integrity_store_keys | bool
    - fss_verification_key_output.changed | default(false)
    - fss_temp_file.path is defined
  no_log: true

- name: Encrypt FSS key with Ansible Vault
  ansible.builtin.command:
    argv:
      - ansible-vault
      - encrypt
      - --vault-password-file
      - "{{ _audit_integrity_vault_password_file }}"
      - --encrypt-vault-id
      - "{{ audit_integrity_vault_encrypt_id }}"
      - "{{ fss_temp_file.path }}"
  delegate_to: localhost
  become: false
  when:
    - audit_integrity_store_keys | bool
    - fss_verification_key_output.changed | default(false)
    - fss_temp_file.path is defined
    - _audit_integrity_vault_password_file | default('') | length > 0
  no_log: true

- name: Ensure audit integrity output directory exists
  ansible.builtin.file:
    path: "{{ audit_integrity_output_dir }}"
    state: directory
    mode: '0700'
  delegate_to: localhost
  become: false
  when:
    - audit_integrity_store_keys | bool
    - fss_verification_key_output.changed | default(false)

- name: Move encrypted FSS key to final destination
  ansible.builtin.copy:
    src: "{{ fss_temp_file.path }}"
    dest: "{{ audit_integrity_output_dir }}/fss_v_{{ inventory_hostname }}_{{ deployment_id | default('manual') }}.vault"
    mode: '0600'
  delegate_to: localhost
  become: false
  when:
    - audit_integrity_store_keys | bool
    - fss_verification_key_output.changed | default(false)
    - fss_temp_file.path is defined
  no_log: true

- name: Remove temporary FSS key file
  ansible.builtin.file:
    path: "{{ fss_temp_file.path }}"
    state: absent
  delegate_to: localhost
  become: false
  when:
    - audit_integrity_store_keys | bool
    - fss_verification_key_output.changed | default(false)
    - fss_temp_file.path is defined
  no_log: true

- name: Ensure Seal is enabled in journald configuration
  ansible.builtin.lineinfile:
    path: /etc/systemd/journald.conf
    regexp: '^#?Seal='
    line: 'Seal=yes'
  become: true
  notify: restart_journald
  when:
    - _audit_integrity_is_systemd
    - not _audit_integrity_is_container