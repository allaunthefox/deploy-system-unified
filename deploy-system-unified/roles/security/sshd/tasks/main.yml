---
# SSHD configuration role - Enhanced SSH daemon configuration
- name: Check if sshd_config backup exists
  ansible.builtin.stat:
    path: "{{ sshd_config_path }}.backup"
  register: sshd_config_backup
  become: true

- name: Backup original sshd_config (only if missing)
  ansible.builtin.copy:
    src: "{{ sshd_config_path }}"
    dest: "{{ sshd_config_path }}.backup"
    remote_src: true
    mode: '0600'
    force: false
  become: true
  when:
    - sshd_backup_config.stat.exists is not defined or not sshd_config_backup.stat.exists
    - sshd_backup_config | default(true)

- name: Determine SSH service name
  ansible.builtin.set_fact:
    ssh_service_name: "{{ 'ssh' if ansible_facts['os_family'] == 'Debian' else 'sshd' }}"

- name: Ensure SSH privilege separation directory exists (for validation in containers)
  ansible.builtin.file:
    path: /run/sshd
    state: directory
    mode: '0755'
  become: true

- name: Configure SSH port
  ansible.builtin.lineinfile:
    path: "{{ sshd_config_path }}"
    regexp: '^#?Port '
    line: "Port {{ ssh_effective_port | default(system_ssh_port) | default(22) }}"
    validate: '/usr/sbin/sshd -t -f %s'
  become: true
  notify: restart sshd
- name: Configure SSH protocol and algorithms
  ansible.builtin.blockinfile:
    path: /etc/ssh/sshd_config
    marker: "# {mark} ANSIBLE MANAGED - SECURITY ALGORITHMS"
    block: |
      # Use only strong ciphers (FIPS 140-2 compliant)
      Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com
      # Use only strong MACs (FIPS 140-2 compliant)
      MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com
      # Use only strong key exchange algorithms
      KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group16-sha512
      # Use only strong host key algorithms
      HostKeyAlgorithms ssh-ed25519,rsa-sha2-512,rsa-sha2-256
    validate: '/usr/sbin/sshd -t -f %s'
  become: true
  notify: restart sshd
- name: Disable weak SSH host keys
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/ssh/ssh_host_dsa_key
    - /etc/ssh/ssh_host_dsa_key.pub
    - /etc/ssh/ssh_host_ecdsa_key
    - /etc/ssh/ssh_host_ecdsa_key.pub
  become: true
  when: sshd_disable_weak_keys | default(false)
- name: Generate strong Ed25519 host key if missing
  ansible.builtin.command:
    cmd: ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N ""
    creates: /etc/ssh/ssh_host_ed25519_key
  become: true
- name: Generate strong RSA host key if missing
  ansible.builtin.command:
    cmd: ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key -N ""
    creates: /etc/ssh/ssh_host_rsa_key
  become: true
- name: Set correct permissions on SSH host keys
  ansible.builtin.file:
    path: "{{ item.path }}"
    mode: "{{ item.mode }}"
    owner: root
    group: root
  loop:
    - { path: '/etc/ssh/ssh_host_ed25519_key', mode: '0600' }
    - { path: '/etc/ssh/ssh_host_ed25519_key.pub', mode: '0644' }
    - { path: '/etc/ssh/ssh_host_rsa_key', mode: '0600' }
    - { path: '/etc/ssh/ssh_host_rsa_key.pub', mode: '0644' }
  become: true
- name: Comment out unmanaged SSH authentication settings
  ansible.builtin.replace:
    path: "{{ sshd_config_path }}"
    regexp: '^(PermitRootLogin|PasswordAuthentication|UsePAM|X11Forwarding)\s+'
    replace: '# \1 '
    validate: '/usr/sbin/sshd -t -f %s'
  become: true
- name: Configure enhanced SSH security settings
  ansible.builtin.blockinfile:
    path: "{{ sshd_config_path }}"
    marker: "# {mark} ANSIBLE MANAGED - ENHANCED SECURITY SETTINGS"
    block: |
      # Enhanced security settings
      LogLevel VERBOSE
      X11Forwarding {{ 'yes' if sshd_allow_x11_forwarding | bool else 'no' }}
      AllowTcpForwarding {{ 'yes' if sshd_allow_tcp_forwarding | bool else 'no' }}
      AllowAgentForwarding {{ 'yes' if sshd_allow_agent_forwarding | bool else 'no' }}
      AllowStreamLocalForwarding no
      PermitTunnel no
      Compression delayed
      ClientAliveInterval 300
      ClientAliveCountMax 2
      LoginGraceTime 60
      MaxAuthTries 3
      MaxSessions 10
      PermitEmptyPasswords no
      PermitRootLogin {{ sshd_permit_root_login }}
      PubkeyAuthentication yes
      PasswordAuthentication {{ sshd_password_authentication }}
      ChallengeResponseAuthentication no
      UsePAM yes
      UseDNS no
    validate: '/usr/sbin/sshd -t -f %s'
  become: true
  notify: restart sshd
- name: Verify sshd_config has single-instance directives
  ansible.builtin.shell: |
    awk '
      /^[[:space:]]*#/ { next }
      /^[[:space:]]*$/ { next }
      /^[[:space:]]*Match[[:space:]]+/ { in_match=1; next }
      in_match == 1 { next }
      {
        key=tolower($1)
        allowed = "^(port|permitrootlogin|passwordauthentication|" \
                "x11forwarding|allowtcpforwarding|allowagentforwarding|" \
                "clientaliveinterval|clientalivecountmax|maxauthtries|loglevel|" \
                "pubkeyauthentication|usepam|usedns|challengeresponseauthentication|" \
                "permitemptypasswords|maxsessions|logingracetime|compression|" \
                "allowstreamlocalforwarding|permittunnel)$"
        if (key ~ allowed) {
          count[key]++
        }
      }
      END {
        if (count["port"] != 1) {
          print "Port directive count=" (count["port"] + 0)
          exit 1
        }
        for (k in count) {
          if (count[k] > 1) {
            print "Duplicate directive " k " count=" count[k]
            dup=1
          }
        }
        if (dup) { exit 2 }
      }
    ' {{ sshd_config_path }}
  changed_when: false
  become: true
- name: Add trusted-group Match blocks for allowed forwarding (conditional)
  ansible.builtin.blockinfile:
    path: "{{ sshd_config_path }}"
    marker: "# {mark} ANSIBLE MANAGED - TRUSTED SSH EXCEPTIONS"
    block: |
      {% for grp in sshd_trusted_groups %}
      Match Group {{ grp }}
        AllowAgentForwarding yes
        AllowTcpForwarding yes
        X11Forwarding no
      {% endfor %}
    validate: '/usr/sbin/sshd -t -f %s'
  become: true
  when: sshd_enable_trusted_group_exceptions | default(false)
  notify: restart sshd
- name: Set SSHD configuration completion flag
  ansible.builtin.set_fact:
    security_sshd_complete: true
