---
# Main entry point for hardware/gpu

- name: Check if GPU Stack is enabled
  ansible.builtin.debug:
    msg: "GPU Stack is {{ 'enabled' if gpu_stack_enable else 'disabled' }}"

- name: End play if GPU Stack is disabled
  ansible.builtin.meta: end_play
  when: not gpu_stack_enable

- name: Check for EFI Environment
  ansible.builtin.stat:
    path: /sys/firmware/efi
  register: efi_sysfs

- name: Set EFI Fact
  ansible.builtin.set_fact:
    gpu_stack_efi_present: "{{ efi_sysfs.stat.exists }}"

- name: Normalize Architecture
  ansible.builtin.set_fact:
    _gpu_norm_arch: >-
      {{
        'x86_64' if gpu_stack_arch in ['amd64', 'x86_64'] else
        'aarch64' if gpu_stack_arch in ['arm64', 'aarch64', 'armv8b', 'armv8l'] else
        'riscv64' if gpu_stack_arch in ['riscv64', 'risc64', 'riscv'] else
        gpu_stack_arch
      }}

- name: Normalize Vendor List (Single or Multi-Vendor)
  ansible.builtin.set_fact:
    _gpu_vendor_list: "{{ [gpu_stack_vendor] if gpu_stack_vendor is string else gpu_stack_vendor }}"

- name: Detect Virtualization Environment
  ansible.builtin.set_fact:
    _gpu_is_container: "{{ (ansible_facts['virtualization_type'] | default('unknown') in ['docker', 'podman', 'container', 'lxc']) or (ansible_facts['is_chroot'] | default(false)) }}"
    _gpu_is_vm: "{{ (ansible_facts['virtualization_role'] | default('unknown') == 'guest') and (ansible_facts['virtualization_type'] | default('unknown') not in ['docker', 'podman', 'container', 'lxc']) }}"

- name: Validate Global Config
  ansible.builtin.assert:
    that:
      - gpu_stack_mode in ['server', 'desktop', 'hybrid']
    fail_msg: "Invalid GPU mode: {{ gpu_stack_mode }}"

- name: Run Video Hardware Detection
  ansible.builtin.include_tasks: detect_video.yml


- name: Resolve Driver Conflicts
  ansible.builtin.include_tasks: driver_integrity.yml

- name: Resolve and Validate GPU Vendor
  block:
    - name: Set Vendor from Auto-Detection
      ansible.builtin.set_fact:
        gpu_stack_vendor: "{{ _gpu_primary_detected_vendor }}"
      when: gpu_stack_vendor in ['auto', 'generic']

    - name: Validate Manual Vendor Configuration
      ansible.builtin.assert:
        that:
          - (gpu_stack_vendor in _gpu_detected_vendor_list) or (gpu_stack_vendor == 'generic')
        fail_msg: "Configured GPU vendor '{{ gpu_stack_vendor }}' was not detected in hardware (Detected: {{ _gpu_detected_vendor_list }}). Set gpu_force_vendor=true to bypass."
      when:
        - gpu_stack_vendor not in ['auto', 'generic']
        - not (gpu_force_vendor | default(false))

- name: Normalize Vendor List (Final)
  ansible.builtin.set_fact:
    _gpu_vendor_list: "{{ [gpu_stack_vendor] if gpu_stack_vendor is string else gpu_stack_vendor }}"

- name: Iterate over defined vendors
  ansible.builtin.include_tasks: vendor_setup.yml
  loop: "{{ _gpu_vendor_list }}"
  loop_control:
    loop_var: current_vendor

- name: Optional - Configure Hybrid Graphics (Prime/Optimus)
  ansible.builtin.include_tasks: features/hybrid_setup.yml
  when: gpu_stack_mode in ['hybrid', 'desktop'] and _gpu_vendor_list | length > 1

- name: Optional - Configure Desktop Environment Features
  ansible.builtin.include_tasks: features/desktop_setup.yml
  when: gpu_stack_mode in ['desktop', 'hybrid']

- name: Optional - Configure eGPU Support
  ansible.builtin.include_tasks: features/egpu.yml
  when: gpu_stack_enable_egpu | default(false)

- name: Optional - Configure GPU Slicing Support
  ansible.builtin.include_tasks: features/gpu_slicing.yml
  when: gpu_stack_enable_slicing | default(false) or gpu_stack_slicing_strategy | default('none') != 'none'

- name: Optional - Configure RDMA Support
  ansible.builtin.include_tasks: features/rdma.yml
  when: gpu_stack_enable_rdma | default(false)

- name: Optional - Configure DP Alt Mode
  ansible.builtin.include_tasks: features/dp_alt_mode.yml
  when: gpu_stack_enable_dp_alt_mode | default(false)

- name: Optional - Verify Vulkan Capabilities
  ansible.builtin.include_tasks: features/vulkan_validation.yml
  when: gpu_stack_mode in ['desktop', 'hybrid']

- name: Optional - Verify Containerized Vulkan Projection
  ansible.builtin.include_tasks: features/verify_container_vulkan.yml
  when: 
    - gpu_stack_mode in ['desktop', 'hybrid']
    - gpu_vulkan_supported | bool


- name: Save Role Checkpoint
  ansible.builtin.include_tasks: save_checkpoint.yml
  vars:
    additional_phases: ["hardware/gpu"]


