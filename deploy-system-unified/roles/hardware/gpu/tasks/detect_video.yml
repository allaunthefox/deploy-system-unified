---
# Hardware Detection Logic
# Detects Installed GPU Vendors to override generic defaults

- name: Detect GPU vendors via lspci (Manual Parsing)
  block:
    - name: Run lspci to find VGA devices (Class 03xx)
      # Output format: "00:02.0 0300: 1a03:2000 (rev 41)"
      # awk grabs 3rd column (ID pair), cut splits vendor
      ansible.builtin.shell: "lspci -n | grep -E ' 03[0-9a-f]{2}: ' | awk '{print $3}'"
      register: lspci_raw_ids
      changed_when: false
      failed_when: false
      args:
        pipefail: true

    - name: Parse detected vendors from lspci
      ansible.builtin.set_fact:
        _detected_pci_vendors: "{{ (lspci_raw_ids.stdout_lines | default([])) | map('split', ':') | map('first') | unique }}"

    - name: Detect ASPEED AST2600/AST2400 (SP5) via lspci
      ansible.builtin.set_fact:
        _gpu_override_aspeed_drm: true
      # Check if any line in stdout matches 1a03:2000 or 1a03:2600
      when: (lspci_raw_ids.stdout_lines | default([])) | select('match', '^1a03:(2000|2600)') | list | length > 0

- name: Detect Generic/Minimal Vendors (VIA, SiS, Matrox, Aspeed)
  ansible.builtin.set_fact:
    gpu_stack_vendor: "generic"
  when:
    - gpu_stack_vendor == "auto" or gpu_stack_vendor == "generic"
    - _detected_pci_vendors | intersect(['1106', '1039', '1a03', '102b']) | length > 0

- name: Detect Intel (Legacy or Modern)
  ansible.builtin.set_fact:
    gpu_stack_vendor: "intel"
  when:
    - gpu_stack_vendor == "auto" or gpu_stack_vendor == "generic"
    - "'8086' in _detected_pci_vendors"
    # Don't override if minimal vendors were preferred, but usually identifying Intel is safe unless it's a minimal SoC.
    # Logic: If both Intel and Matrox/Aspeed exist (Server), usually Matrox/Aspeed is primary video, but Intel is Compute?
    # User said: "ASPEED... Every modern Supermicro... Matrox... Dell".
    # If standard Intel role installs too much, we might want generic. But I added legacy packages to Intel role previously.
    # However, user instruction for VIA/SiS was "default to generic".
    # For Matrox/Aspeed/Intel 800-series, user said "minimal video providers".
    # If I see Matrox/Aspeed, it's safer to stick to generic (which now includes ast/mga drivers) than Intel role.

- name: Force Generic for Minimal Video Providers (Matrox/Aspeed overriding Intel)
  ansible.builtin.set_fact:
    gpu_stack_vendor: "generic"
  when:
    - "'1a03' in _detected_pci_vendors or '102b' in _detected_pci_vendors"
    - gpu_stack_vendor != "intel" # Allow user to explictly force 'intel' in vars if they really want it.
