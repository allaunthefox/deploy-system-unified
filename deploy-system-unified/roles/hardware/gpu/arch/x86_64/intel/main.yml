---
# Intel GPU Setup for x86_64 (OS Agnostic)

- name: Define Intel driver packages (Debian/Ubuntu)
  ansible.builtin.set_fact:
    intel_driver_packages:
      - intel-media-va-driver-non-free  # Preferred for full codec support
      - libmfx1
      - intel-gpu-tools
      - i965-va-driver-shaders          # Legacy non-free shaders
      - mesa-vulkan-drivers             # Vulkan support (Anvil)
      - libgl1-mesa-dri                 # OpenGL DRI
      - libglx-mesa0                    # GLX
      - firmware-misc-nonfree           # Required for GuC/HuC firmware on modern chips

    # Legacy (i8xx/Gen2-Gen4) and Server Graphics (Matrox/Aspeed)
    intel_legacy_packages:
      - xserver-xorg-video-intel        # Legacy DDX for Gen2-4
      - xserver-xorg-video-vesa         # Universal fallback
      - xserver-xorg-video-fbdev        # Framebuffer fallback
      - xserver-xorg-video-mga          # Matrox G200 (Common servers)
      - xserver-xorg-video-ast          # Aspeed AST (Common servers)
  when: ansible_os_family == 'Debian'

- name: Define Intel driver packages (RedHat/Fedora)
  ansible.builtin.set_fact:
    intel_driver_packages:
      - intel-media-driver
      - libmfx
      - intel-gpu-tools
      - libva-intel-driver
      - mesa-dri-drivers
      - mesa-vulkan-drivers
    intel_legacy_packages:
      - xorg-x11-drv-intel
      - xorg-x11-drv-vesa
      - xorg-x11-drv-fbdev
      - xorg-x11-drv-mga
      - xorg-x11-drv-ast  # Typically provided by generic or specific pkg
  when: ansible_os_family == 'RedHat'

- name: Define Intel driver packages (Alpine)
  ansible.builtin.set_fact:
    intel_driver_packages:
      - intel-media-driver
      - libva-intel-driver
      - libva-utils
      - intel-gpu-tools
  when: ansible_os_family == 'Alpine'

- name: Define Intel driver packages (Arch Linux)
  ansible.builtin.set_fact:
    intel_driver_packages:
      - intel-media-driver
      - libva-intel-driver
      - intel-gpu-tools
  when: ansible_os_family == 'Archlinux'

- name: Install Intel GPU firmware and drivers
  ansible.builtin.package:
    name: "{{ intel_driver_packages | default(['intel-media-driver']) }}"
    state: present
  become: true
  failed_when: false # Ignore if package name mismatch on unknown distros

- name: Install Legacy and Minimal Video Providers (i8xx/Matrox/Aspeed)
  ansible.builtin.package:
    name: "{{ intel_legacy_packages | default([]) }}"
    state: present
  become: true
  failed_when: false
  when: ansible_os_family in ['Debian', 'RedHat']

- name: Configure HuC/GuC firmware loading (i915)
  ansible.builtin.copy:
    content: "options i915 enable_guc=3"
    dest: /etc/modprobe.d/i915.conf
    mode: '0644'
  become: true
  notify: update-initramfs
  when:
    - ansible_os_family in ['Debian', 'RedHat']
    - not _gpu_is_container | default(false)
    - gpu_stack_reservation | default('host') != 'vfio'

- name: Configure Xe Driver Probe (Experimental/Battlemage)
  ansible.builtin.copy:
    # Force probe for newer devices if kernel is older (<6.8)
    content: "options xe force_probe=*"
    dest: /etc/modprobe.d/xe_probe.conf
    mode: '0644'
  become: true
  when:
    - ansible_kernel is version('6.8', '<')
    - ansible_kernel is version('6.2', '>=')
    - not _gpu_is_container | default(false)
  notify: update-initramfs

- name: Configure Battlemage Force Probe via grub.d
  ansible.builtin.copy:
    dest: /etc/default/grub.d/intel-battlemage.cfg
    content: |
      # Core/Battlemage Force Probe
      GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT} i915.force_probe=!9a49 xe.force_probe=9a49"
    owner: root
    group: root
    mode: '0644'
  become: true
  when:
    - gpu_battlemage_force_probe | bool
    - not _gpu_is_container | default(false)
  notify: update-grub

- name: Setup Intel OneAPI Repository (Debian/Ubuntu)
  block:
    - name: Download Intel OneAPI GPG key
      ansible.builtin.get_url:
        url: "{{ intel_oneapi_gpg_key_url }}"
        dest: "{{ intel_oneapi_gpg_keyring_path }}"
        mode: '0644'

    - name: Ensure Intel OneAPI fingerprint is configured when verification is enabled
      ansible.builtin.assert:
        that:
          - intel_oneapi_gpg_fingerprint | length > 0
        fail_msg: "intel_oneapi_gpg_fingerprint must be set when intel_oneapi_gpg_fingerprint_verify=true."
      when: intel_oneapi_gpg_fingerprint_verify | default(false) | bool

    - name: Read Intel OneAPI GPG fingerprint
      ansible.builtin.command:
        cmd: "gpg --show-keys --with-colons {{ intel_oneapi_gpg_keyring_path }}"
      register: intel_oneapi_keyinfo
      changed_when: false
      when: intel_oneapi_gpg_fingerprint_verify | default(false) | bool

    - name: Extract Intel OneAPI GPG fingerprint
      ansible.builtin.set_fact:
        intel_oneapi_actual_fingerprint: >-
          {{ (intel_oneapi_keyinfo.stdout_lines
              | select('match', '^fpr:')
              | map('regex_replace', '^fpr:+([0-9A-F]+):.*', '\\1')
              | list
              | first
              | default('')) | upper }}
      when: intel_oneapi_gpg_fingerprint_verify | default(false) | bool

    - name: Verify Intel OneAPI GPG fingerprint
      ansible.builtin.assert:
        that:
          - intel_oneapi_actual_fingerprint != ""
          - intel_oneapi_actual_fingerprint == (intel_oneapi_gpg_fingerprint | regex_replace('[^0-9A-Fa-f]', '') | upper)
        fail_msg: "Intel OneAPI GPG fingerprint mismatch. Expected {{ intel_oneapi_gpg_fingerprint }}, got {{ intel_oneapi_actual_fingerprint }}."
      when: intel_oneapi_gpg_fingerprint_verify | default(false) | bool

    - name: Add Intel OneAPI repository
      ansible.builtin.apt_repository:
        repo: "{{ intel_oneapi_repo }}"
        state: present
        filename: oneapi
  become: true
  when:
    - ansible_os_family == 'Debian'
    - gpu_stack_enable_oneapi | default(false) | bool

- name: Setup Intel OneAPI Repository (RHEL-compatible (AlmaLinux/Rocky/CentOS Stream))
  ansible.builtin.yum_repository:
    name: oneAPI
    description: Intel OneAPI repository
    baseurl: https://yum.repos.intel.com/oneapi
    gpgcheck: true
    repo_gpgcheck: true
    gpgkey: https://yum.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB
    enabled: true
  become: true
  when:
    - ansible_os_family == 'RedHat'
    - gpu_stack_enable_oneapi | default(false) | bool

- name: Install Intel OneAPI Base Toolkit
  ansible.builtin.package:
    name: intel-basekit
    state: present
  become: true
  when: gpu_stack_enable_oneapi | default(false) | bool

- name: Install Intel Level Zero Support
  ansible.builtin.package:
    name:
      - intel-level-zero-gpu
      - level-zero-tests
    state: present
  become: true
  when: gpu_stack_enable_level_zero | default(false) | bool
