# LXC GPU Configuration
# This file is automatically generated by Ansible

# GPU support enabled
lxc.enable_gpu_support = {{ lxc_enable_gpu_support }}

# GPU vendor
lxc.gpu_vendor = {{ lxc_gpu_vendor }}

# GPU slicing strategy
lxc.gpu_slicing_strategy = {{ lxc_gpu_slicing_strategy }}

{% if lxc_gpu_slicing_strategy == "passthrough" %}
# GPU passthrough configuration
{% for device in lxc_gpu_passthrough_devices %}
lxc.cgroup2.devices.allow = c {{ device }} rwm
lxc.mount.entry = {{ device }} {{ device }} none bind,create=file,optional
{% endfor %}

{% for mount in lxc_gpu_passthrough_mounts %}
{% set mount_parts = mount.split(':') %}
lxc.mount.entry = {{ mount_parts[0] }} {{ mount_parts[1] }} {{ mount_parts[2] }} {{ mount_parts[3] | default('none') }}
{% endfor %}

# GPU capabilities (drop only valid Linux CAP_* values)
{% set caps = lxc_gpu_passthrough_capabilities | default([]) | select('match', '^CAP_') | list %}
{% for cap in caps %}
lxc.cap.drop = {{ cap }}
{% endfor %}
{% endif %}

{% if lxc_gpu_slicing_strategy == "mig" %}
# NVIDIA MIG configuration
{% for device in lxc_gpu_mig_devices %}
lxc.cgroup2.devices.allow = c {{ device }} rwm
lxc.mount.entry = {{ device }} {{ device }} none bind,create=file,optional
{% endfor %}

# MIG profile configuration
lxc.gpu_mig_profile = {{ lxc_gpu_slicing.mig.profiles | default(['1g.5gb']) | join(',') }}
{% endif %}

{% if lxc_gpu_slicing_strategy == "vgpu" %}
# NVIDIA vGPU configuration
lxc.cgroup2.devices.allow = c {{ lxc_gpu_vgpu_device }} rwm
lxc.mount.entry = {{ lxc_gpu_vgpu_device }} {{ lxc_gpu_vgpu_device }} none bind,create=file,optional

# vGPU profile and license server
lxc.gpu_vgpu_profile = {{ lxc_gpu_slicing.vgpu.profile }}
lxc.gpu_vgpu_license_server = {{ lxc_gpu_slicing.vgpu.license_server }}
{% endif %}

{% if lxc_gpu_slicing_strategy == "sriov" %}
# AMD SR-IOV configuration
{% for device in lxc_gpu_sriov_devices %}
lxc.cgroup2.devices.allow = c {{ device }} rwm
lxc.mount.entry = {{ device }} {{ device }} none bind,create=file,optional
{% endfor %}

# SR-IOV virtual function count
lxc.gpu_sriov_vf_count = {{ lxc_gpu_slicing.sriov.vf_count }}
{% endif %}

{% if lxc_gpu_slicing_strategy == "level-zero" %}
# Intel Level Zero configuration
lxc.cgroup2.devices.allow = c /dev/dri rwm
lxc.mount.entry = /dev/dri /dev/dri none bind,create=dir,optional

# Level Zero partitions
lxc.gpu_level_zero_partitions = {{ lxc_gpu_slicing.level_zero.partitions | to_json }}
{% endif %}

{% if lxc_gpu_slicing_strategy == "oneapi" %}
# Intel OneAPI configuration
lxc.cgroup2.devices.allow = c /dev/dri rwm
lxc.cgroup2.devices.allow = c /dev/kfd rwm
lxc.mount.entry = /dev/dri /dev/dri none bind,create=dir,optional
lxc.mount.entry = /dev/kfd /dev/kfd none bind,create=file,optional

# OneAPI toolkit and components
lxc.gpu_oneapi_toolkit = {{ lxc_gpu_slicing.oneapi.toolkit }}
lxc.gpu_oneapi_components = {{ lxc_gpu_slicing.oneapi.components | join(',') }}

# OneAPI environment variables
lxc.environment = INTEL_ONEAPI_ROOT=/opt/intel/oneapi
lxc.environment = PATH=/opt/intel/oneapi/compiler/latest/bin:$PATH
lxc.environment = LD_LIBRARY_PATH=/opt/intel/oneapi/compiler/latest/lib:$LD_LIBRARY_PATH
{% endif %}

# GPU resource limits
lxc.cgroup2.memory.limit_in_bytes = {{ lxc_gpu_resource_limits.memory }}
lxc.cgroup2.cpu.max = {{ lxc_gpu_resource_limits.cpu }}

# GPU device selectors
lxc.gpu_device_selectors = {{ lxc_gpu_default_configs[lxc_gpu_vendor].devices | join(',') }}
