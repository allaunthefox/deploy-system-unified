---
- hosts: localhost
  connection: local
  gather_facts: false
  vars:
    containers_secrets_dir: "{{ playbook_dir }}/molecule_shared"
    containers_secrets_owner: "{{ lookup('env','USER') }}"
    containers_fail_secure: true
  tasks:
    - name: Run verify_secrets and capture result
      block:
        - ansible.builtin.include_tasks: "../../tasks/verify_secrets.yml"
      rescue:
        - name: Capture failure into verify_result
          ansible.builtin.set_fact:
            verify_result:
              failed: true
              msg: "{{ (ansible_failed_result.msg | default(ansible_failed_result)) | string }}"
      always:
        - name: Ensure verify_result exists
          ansible.builtin.set_fact:
            verify_result: "{{ verify_result | default({'failed': false}) }}"

    - name: Assert that verify_secrets failed as expected
      ansible.builtin.assert:
        that:
          - verify_result.failed | default(false)
        fail_msg: "Expected verify_secrets to fail, but it succeeded"
        success_msg: "verify_secrets correctly failed as expected"

    - name: Verify specific failure conditions
      ansible.builtin.assert:
        that:
          - verify_result.failed | default(false)
          - verify_result.msg is defined
          - "'has no attribute' not in (verify_result.msg | default(''))"
        fail_msg: "verify_secrets failed but no error message provided or internal attribute-access error occurred"
        success_msg: "verify_secrets failed with proper error message (no attribute-access template errors)"

    - name: Log test case and result
      ansible.builtin.debug:
        msg: "Test case '{{ lookup('env','test_case') | default('unknown') }}' - verify_secrets {{ 'PASSED' if verify_result.failed | default(false) else 'FAILED' }}"
