---
# Defaults for containers/runtime role
containers_install_podman: true
containers_enable_socket: true

# Rootless Podman Support (shared defaults)
podman_rootless_enabled: false
podman_rootless_user: "{{ ansible_user | default('prod') }}"
podman_rootless_user_home: "/home/{{ podman_rootless_user }}"
podman_rootless_network_mode: "slirp4netns"
podman_rootless_allow_privileged_ports: false
podman_rootless_privileged_port_start: 1024

containers_systemd_dir: >-
  {{ podman_rootless_enabled | bool
     | ternary(podman_rootless_user_home ~ '/.config/containers/systemd',
               '/etc/containers/systemd') }}
containers_systemd_scope: "{{ podman_rootless_enabled | bool | ternary('user', 'system') }}"
containers_systemd_owner: "{{ podman_rootless_enabled | bool | ternary(podman_rootless_user, 'root') }}"
containers_systemd_group: "{{ podman_rootless_enabled | bool | ternary(podman_rootless_user, 'root') }}"
containers_secrets_dir: >-
  {{ podman_rootless_enabled | bool
     | ternary(podman_rootless_user_home ~ '/.config/containers/secrets',
               '/etc/containers/secrets') }}
containers_secrets_owner: "{{ podman_rootless_enabled | bool | ternary(podman_rootless_user, 'root') }}"
containers_secrets_group: "{{ podman_rootless_enabled | bool | ternary(podman_rootless_user, 'root') }}"
containers_systemd_env: {}

# Intel OneAPI repository (supply-chain hardening)
intel_oneapi_gpg_key_url: "https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB"
intel_oneapi_gpg_keyring_path: "/usr/share/keyrings/oneapi-archive-keyring.gpg"
intel_oneapi_repo: "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main"
intel_oneapi_gpg_fingerprint: "BF4385F91CA5FC005AB39E1C1A8497B11911E097"
intel_oneapi_gpg_fingerprint_verify: false

# Image Pull Safety / Rate Limit Avoidance
# Docker Hub Anonymous Limit: 100 pulls / 6 hrs
# Safe Retry Strategy to avoid Abuse Detection blocking:
containers_pull_retries: 5
containers_pull_delay: 30

# Architecture override (explicit target architecture)
containers_arch_override: ""
# GPU support configuration
containers_enable_gpu_support: false
containers_gpu_vendor: "nvidia"  # Options: nvidia, amd, intel
containers_gpu_count: 1

# GPU Allocation Mapping
# Used to pin specific GPUs to containers.
# Example:
# containers_gpu_allocation_map:
#   - container_name: "jellyfin"
#     pci_id: "0000:03:00.0"
#   - container_name: "stable-diffusion"
#     vendor: "nvidia"
#     index: 0
containers_gpu_allocation_map: []

# GPU slicing configuration
containers_gpu_slicing:
  strategy: "auto"  # auto, mig, vgpu, time-slicing, sriov, level-zero, oneapi, passthrough
  auto_strategy:
    bare_metal: "mig"
    virtual_host: "sriov"
    virtual_guest: "passthrough"
  # Strategy-specific configurations
  mig: { enabled: false }
  vgpu: { enabled: false, profile: "", license_server: "" }
  time_slicing: { enabled: false, max_instances: 4 }
  sriov: { enabled: false, vf_count: 4 }
  level_zero: { enabled: false, partitions: [] }
  oneapi: { enabled: false, toolkit: "base", components: ["compiler", "mpi", "tbb"] }
  passthrough: { devices: [] }
# Runtime-specific GPU slicing configuration
containers_gpu_slicing.kubernetes:
  enabled: true
  device_plugins:
    - name: "nvidia-device-plugin"
      version: "v0.13.0"
      image: "nvcr.io/nvidia/k8s-device-plugin:v0.13.0"
  node_labels:
    - "nvidia.com/gpu.count={{ containers_gpu_count }}"
containers_gpu_slicing.podman:
  enabled: true
  quadlet:
    capabilities: ["CAP_SYS_ADMIN"]
    device_cgroups: ["/dev/nvidia*", "/dev/dri"]
    mounts: ["/usr/bin/nvidia-smi:/usr/bin/nvidia-smi:ro"]
containers_gpu_slicing.lxc:
  enabled: true
  config:
    cgroup2:
      devices:
        allow: ["/dev/nvidia*", "/dev/dri"]
      memory: "8Gi"
      cpu: "4"
# GPU profile definitions
containers_gpu_profiles:
  # NVIDIA GPU profiles
  nvidia:
    driver_packages:
      debian: ["nvidia-driver", "nvidia-container-toolkit"]
      redhat: ["nvidia-driver", "nvidia-container-toolkit"]
      arch: ["nvidia", "nvidia-container-toolkit"]
    runtime_config:
      crun:
        enabled: true
        config_path: "/usr/share/containers/containers.conf"
      runc:
        enabled: false
    capabilities: []
    device_cgroups: ["/dev/nvidia*"]
    mount_points: ["/usr/bin/nvidia-smi:/usr/bin/nvidia-smi:ro", "/usr/lib/x86_64-linux-gnu/nvidia:/usr/lib/x86_64-linux-gnu/nvidia:ro"]
  # AMD GPU profiles
  amd:
    driver_packages:
      debian: ["mesa-utils", "rocm-amdgpu-pro"]
      redhat: ["mesa-utils", "rocm-amdgpu-pro"]
      arch: ["mesa", "rocm"]
    runtime_config:
      crun:
        enabled: true
        config_path: "/usr/share/containers/containers.conf"
      runc:
        enabled: false
    capabilities: []
    device_cgroups: ["/dev/dri"]
    mount_points: ["/dev/dri:/dev/dri:rw", "/dev/kfd:/dev/kfd:rw"]
  # Intel GPU profiles
  intel:
    driver_packages:
      debian: ["intel-gpu-tools", "intel-media-va-driver"]
      redhat: ["intel-gpu-tools", "intel-media-driver"]
      arch: ["intel-media-driver", "libva-intel-driver"]
    runtime_config:
      crun:
        enabled: true
        config_path: "/usr/share/containers/containers.conf"
      runc:
        enabled: false
    capabilities: []
    device_cgroups: ["/dev/dri"]
    mount_points: ["/dev/dri:/dev/dri:rw"]
# Default GPU device selectors
containers_gpu_device_selectors:
  - "vendor==NVIDIA"
  - "vendor==AMD"
  - "vendor==Intel"
