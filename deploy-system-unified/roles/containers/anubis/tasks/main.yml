---
# Tasks for containers/anubis - Web AI Firewall
- name: Create Anubis Network Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/anubis_net.network"
    content: |
      [Network]
      NetworkName=anubis_net
      Driver=bridge
      Subnet=10.89.50.0/24
      Gateway=10.89.50.1
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  notify: reload_systemd

- name: Validate Quadlet GPU capabilities (Linux CAP_* only)
  ansible.builtin.assert:
    that:
      - quadlet_gpu_capabilities | default([]) | reject('match', '^CAP_') | list | length == 0
    fail_msg: "Invalid quadlet_gpu_capabilities: only Linux CAP_* values are allowed."
  when: quadlet_enable_gpu_support | default(false)

- name: Create Anubis container quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/anubis.container"
    content: |
      [Unit]
      Description=Anubis Web AI Firewall
      After=network-online.target
      Wants=network-online.target

      [Container]
      Image={{ anubis_image }}
      ContainerName={{ anubis_container_name }}
      {% if podman_rootless_enabled | bool %}
      Network=anubis_net.network
      PublishPort=31338:31338
      {% else %}
      Network=host
      {% endif %}
      Exec=-bind :31338
      Environment=PORT=31338
      Environment=TARGET={{ anubis_target_url }}
      Environment=DIFFICULTY={{ anubis_difficulty }}
      # Thoth/GeoIP warnings are non-fatal; Host networking required due to Netlink/VPS limits
      Environment=VALIDATORS=user-agent,proof-of-work
      {% if quadlet_enable_gpu_support %}
      # GPU support configuration
      {% set caps = quadlet_gpu_capabilities | default([]) | select('match', '^CAP_') | list %}
      {% if caps | length > 0 %}
      Capabilities={{ caps | join(' ') }}
      {% endif %}
      {% for device in quadlet_gpu_devices | default(quadlet_gpu_default_configs[quadlet_gpu_vendor]['devices']) %}
      Device={{ device }}
      {% endfor %}
      {% for mount in quadlet_gpu_default_configs[quadlet_gpu_vendor]['mounts'] %}
      Volume={{ mount }}
      {% endfor %}
      {% endif %}
      [Service]
      Restart=always
      TimeoutStartSec=300
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  notify:
    - reload_systemd
    - restart anubis
  when: anubis_enabled | bool
- name: Enable and start Anubis service (if systemd is available and running)
  ansible.builtin.systemd:
    name: anubis
    enabled: true
    state: started
    scope: "{{ containers_systemd_scope }}"
  environment: "{{ containers_systemd_env }}"
  become: true
  become_user: "{{ containers_systemd_owner }}"
  when: anubis_enabled | bool and ansible_service_mgr == "systemd" and ansible_facts['service_mgr'] == "systemd" and (ansible_facts['os_family'] != 'Container' or '/run/systemd/system' in ansible_facts['mounts'] | map(attribute='mount') | list)
  failed_when: false  # Ignore failures if systemd isn't available