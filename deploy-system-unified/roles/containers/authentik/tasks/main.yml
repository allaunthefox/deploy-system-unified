---
# Tasks for containers/authentik

- name: Verify Authentik secrets when fail-secure is enabled
  ansible.builtin.include_tasks: verify_secrets.yml
  when:
    - containers_authentik_fail_secure | default(true) | bool

- name: Create Authentik Directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0750'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  loop:
    - "{{ authentik_base_dir }}"
    - "{{ authentik_data_dir }}"
    - "{{ authentik_config_dir }}"
    - "{{ authentik_data_dir }}/media"
    - "{{ authentik_data_dir }}/custom-templates"
    - "{{ authentik_data_dir }}/postgres"
    - "{{ authentik_data_dir }}/redis"
  become: true

- name: Create Authentik secrets file
  ansible.builtin.template:
    src: authentik.env.j2
    dest: "{{ containers_secrets_dir }}/authentik.env"
    mode: '0600'
    owner: "{{ containers_secrets_owner }}"
    group: "{{ containers_secrets_group }}"
  become: true

- name: Create Authentik Postgres Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/authentik-postgres.container"
    content: |
      [Unit]
      Description=Authentik PostgreSQL Database
      After=network-online.target

      [Container]
      Image={{ authentik_postgres_image }}
      ContainerName=authentik-postgres

      {% if authentik_network_name == 'host' %}
      Network=host
      {% else %}
      Network={{ authentik_network_name }}.network
      {% endif %}

      EnvironmentFile={{ containers_secrets_dir }}/authentik.env

      Volume={{ authentik_data_dir }}/postgres:/var/lib/postgresql/data:Z

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0600'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  notify: reload systemd

- name: Create Authentik Redis Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/authentik-redis.container"
    content: |
      [Unit]
      Description=Authentik Redis
      After=network-online.target

      [Container]
      Image={{ authentik_redis_image }}
      ContainerName=authentik-redis

      {% if authentik_network_name == 'host' %}
      Network=host
      {% else %}
      Network={{ authentik_network_name }}.network
      {% endif %}

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0600'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  notify: reload systemd

- name: Create Authentik Server Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/authentik-server.container"
    content: |
      [Unit]
      Description=Authentik Server
      After=authentik-postgres.service authentik-redis.service
      Requires=authentik-postgres.service authentik-redis.service

      [Container]
      Image={{ authentik_image }}
      ContainerName=authentik-server

      {% if authentik_network_name == 'host' %}
      Network=host
      {% else %}
      Network={{ authentik_network_name }}.network
      {% endif %}
      # Internal port 9000, exposed to Caddy via bridge

      Exec=server

      EnvironmentFile={{ containers_secrets_dir }}/authentik.env

      Volume={{ authentik_data_dir }}/media:/media:Z
      Volume={{ authentik_data_dir }}/custom-templates:/templates:Z

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0600'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  notify: reload systemd

- name: Create Authentik Worker Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/authentik-worker.container"
    content: |
      [Unit]
      Description=Authentik Worker
      After=authentik-postgres.service authentik-redis.service authentik-server.service
      Requires=authentik-postgres.service authentik-redis.service

      [Container]
      Image={{ authentik_image }}
      ContainerName=authentik-worker

      {% if authentik_network_name == 'host' %}
      Network=host
      {% else %}
      Network={{ authentik_network_name }}.network
      {% endif %}

      Exec=worker

      EnvironmentFile={{ containers_secrets_dir }}/authentik.env

      Volume={{ authentik_data_dir }}/media:/media:Z
      Volume={{ authentik_data_dir }}/custom-templates:/templates:Z

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0600'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  notify: reload systemd

- name: Deploy Caddy Authentik Configuration
  ansible.builtin.copy:
    dest: /srv/containers/caddy/conf.d/authentik.caddy
    content: |
      # Authentik Config
      auth.example.com {
        reverse_proxy {{ 'localhost' if (authentik_network_name == 'host' or not podman_rootless_enabled | default(true) | bool) else 'authentik-server' }}:9000
      }

      # Reusable snippet for other sites to protect themselves
      (authentik_protect) {
        forward_auth {{ 'localhost' if (authentik_network_name == 'host' or not podman_rootless_enabled | default(true) | bool) else 'authentik-server' }}:9000 {
            uri /outpost.goauthentik.io/auth/caddy
            copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name
            copy_headers X-Authentik-Uid X-Authentik-Jwt X-Authentik-Meta-Jwks
            copy_headers X-Authentik-Meta-Outpost-Token X-Authentik-Meta-Provider-Slug
            copy_headers X-Authentik-Meta-App-Slug X-Authentik-Meta-Version
        }
      }
    mode: '0644'
  become: true
  # Only deploy if using Caddy as the ingress
  when: true
  notify: restart caddy
