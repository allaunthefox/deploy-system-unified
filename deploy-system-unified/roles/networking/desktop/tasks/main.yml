---
# Tasks for networking/desktop

- name: Define Desktop Networking Packages
  ansible.builtin.set_fact:
    _net_desktop_packages: "{{
      ['network-manager', 'network-manager-gnome', 'wireless-tools'] if ansible_os_family == 'Debian' else
      ['NetworkManager', 'network-manager-applet', 'wireless-tools'] if ansible_os_family == 'RedHat' else
      ['networkmanager', 'network-manager-applet', 'wireless_tools'] if ansible_os_family == 'Archlinux' else
      ['networkmanager', 'network-manager-applet', 'wireless-tools'] if ansible_os_family == 'Alpine' else
      ['NetworkManager']
    }}"
    _net_service_name: "{{
      'networkmanager' if ansible_os_family == 'Alpine' else
      'NetworkManager'
    }}"

- name: Add Wi-Fi Backend Packages
  ansible.builtin.set_fact:
    _net_desktop_packages: "{{ _net_desktop_packages + [_wifi_pkg] }}"
  vars:
    _wifi_pkg: "{{ 'wpasupplicant' if networking_desktop_wifi_backend == 'wpa_supplicant' and ansible_os_family == 'Debian' else networking_desktop_wifi_backend }}"
  when: networking_desktop_enable_wifi | bool

- name: Install Desktop Networking Tools
  ansible.builtin.package:
    name: "{{ _net_desktop_packages }}"
    state: present
  become: true
  register: _net_install

- name: Enable NetworkManager Service
  ansible.builtin.service:
    name: "{{ _net_service_name }}"
    enabled: true
    state: started
  become: true

- name: Configure Wi-Fi Backend (NetworkManager.conf)
  ansible.builtin.ini_file:
    path: /etc/NetworkManager/NetworkManager.conf
    section: device
    option: wifi.backend
    value: "{{ networking_desktop_wifi_backend }}"
    mode: '0644'
  become: true
  when:
    - networking_desktop_enable_wifi | bool
    - _net_service_name in ["NetworkManager", "networkmanager"]
  notify: restart_networkmanager

- name: Ensure NetworkManager-wait-online is enabled
  ansible.builtin.service:
    name: NetworkManager-wait-online
    enabled: true
  become: true
  when: ansible_facts['service_mgr'] == 'systemd'