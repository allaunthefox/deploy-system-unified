---
# Main entry point for kubernetes/node

- name: Normalize Architecture
  ansible.builtin.set_fact:
    _k8s_norm_arch: >-
      {{
        'x86_64' if ansible_architecture in ['amd64', 'x86_64'] else
        'aarch64' if ansible_architecture in ['arm64', 'aarch64', 'armv8b', 'armv8l'] else
        'riscv64' if ansible_architecture in ['riscv64', 'risc64', 'riscv'] else
        ansible_architecture
      }}

- name: Validate OS Compatibility
  ansible.builtin.assert:
    that:
      - ansible_os_family in ['Debian', 'RedHat', 'Archlinux', 'Alpine']
    fail_msg: "Unsupported OS for Kubernetes prototype: {{ ansible_os_family }}"

- name: Run K3s Pre-flight Checks
  ansible.builtin.include_role:
    name: kubernetes/master
    tasks_from: preflight.yml

- name: Install K3s Binary
  ansible.builtin.include_role:
    name: kubernetes/master
    tasks_from: install.yml

- name: Configure K3s Agent
  ansible.builtin.template:
    src: k3s-agent.service.j2
    dest: /etc/systemd/system/k3s-agent.service
    mode: '0644'
  become: true
  notify: reload systemd

- name: Start K3s Agent
  ansible.builtin.systemd:
    name: k3s-agent
    state: started
    enabled: true
  become: true
