---
- name: Encrypt SSH connection info with SOPS (idempotent)
  ansible.builtin.shell: |
    encrypted_file="{{ connection_info_temp_file.path }}.sops.yml"
    sops -e "{{ connection_info_temp_file.path }}" > "$encrypted_file"
  register: sops_encryption
  changed_when: false
  failed_when: sops_encryption.rc != 0
  delegate_to: localhost
  when: connection_info_temp_file is defined
  no_log: true
  run_once: true

- name: Verify SOPS encryption succeeded and set path (idempotent)
  ansible.builtin.stat:
    path: "{{ connection_info_temp_file.path }}.sops.yml"
  register: sops_encrypted_stat
  delegate_to: localhost
  changed_when: false
  run_once: true

- name: Set encrypted SSH info path for sops (idempotent)
  ansible.builtin.set_fact:
    encrypted_ssh_info_path: "{{ connection_info_temp_file.path }}.sops.yml"
  when:
    - sops_encrypted_stat is defined
    - sops_encrypted_stat.stat.exists
  delegate_to: localhost
  run_once: true
