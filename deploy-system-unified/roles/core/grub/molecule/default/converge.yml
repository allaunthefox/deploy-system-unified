---
- hosts: localhost
  connection: local
  gather_facts: false
  environment:
    PATH: "/tmp/grub-mock-bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  vars:
    grub_test_path: "/tmp/molecule-grub-default"
    core_grub_role_path: "{{ playbook_dir | regex_replace('/molecule/default$', '') }}"
    core_grub_config_path: "{{ grub_test_path }}"
    core_grub_enabled: true
    core_grub_force_update: false
    core_grub_base_params:
      - "quiet"
      - "splash"
      - "console=tty0"
    core_grub_security_params:
      - "slab_nomerge"
      - "slab_nomerge"
      - "pti=on"
    core_grub_hardware_params:
      - "console=tty0"
      - "video=1024x768@60"
    core_grub_isolation_params:
      - "iommu=pt"
    core_grub_performance_params:
      - "zswap.enabled=1"
    core_grub_extra_params:
      - "console=ttyS0,115200n8"
      - ""
  tasks:
    - name: Force handler OS family to Debian
      ansible.builtin.set_fact:
        ansible_os_family: "Debian"
      changed_when: false

    - name: Ensure mock bin directory exists
      ansible.builtin.file:
        path: /tmp/grub-mock-bin
        state: directory
        mode: '0755'

    - name: Install mock update-grub
      ansible.builtin.copy:
        dest: /tmp/grub-mock-bin/update-grub
        content: |
          #!/usr/bin/env bash
          echo "update-grub" >> /tmp/grub_handler.log
        mode: '0755'

    - name: Install mock grub2-mkconfig
      ansible.builtin.copy:
        dest: /tmp/grub-mock-bin/grub2-mkconfig
        content: |
          #!/usr/bin/env bash
          echo "grub2-mkconfig $*" >> /tmp/grub_handler.log
        mode: '0755'

    - name: Check for existing test GRUB config
      ansible.builtin.stat:
        path: "{{ grub_test_path }}"
      register: grub_test_stat

    - name: Ensure test GRUB config exists
      ansible.builtin.copy:
        dest: "{{ grub_test_path }}"
        content: |
          GRUB_CMDLINE_LINUX_DEFAULT="quiet"
        mode: '0644'
      when: not grub_test_stat.stat.exists

    - name: Run core/grub with ordered parameters
      ansible.builtin.include_role:
        name: "{{ core_grub_role_path }}"

    - name: Flush handlers
      ansible.builtin.meta: flush_handlers
