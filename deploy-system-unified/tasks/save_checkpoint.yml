---
# Generic task to save the current session state
# Requires: 'checkpoint_status' (default: running) and 'additional_phases' (optional)
# Updates: 'completed_phases' fact and 'session.json' file

- name: Update completed phases fact
  ansible.builtin.set_fact:
    completed_phases: "{{ completed_phases | default([]) | union(additional_phases | default([])) | unique }}"

- name: Check Chrony Status (Integration)
  ansible.builtin.shell: |
    if command -v chronyc >/dev/null 2>&1; then
      chronyc tracking || echo "Not synchronized"
    else
      echo "Chrony not installed"
    fi
  register: chrony_tracking_check
  changed_when: false
  become: true

- name: Save Deployment Checkpoint with Chrony Integration
  ansible.builtin.copy:
    content: |
      {
        "timestamp": "{{ ansible_date_time.iso8601 }}",
        "status": "{{ checkpoint_status | default('running') }}",
        "time_sync": {
          "source": "chrony",
          "details": {{ chrony_tracking_check.stdout_lines | default([]) | to_json }}
        },
        "completed_phases": {{ completed_phases | to_json }}
      }
    dest: /var/lib/deploy-system/checkpoints/session.json
    mode: '0600'
  become: true
  changed_when: false
