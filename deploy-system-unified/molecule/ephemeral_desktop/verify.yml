---
- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: Verify ephemeral audit rules exist
      ansible.builtin.stat:
        path: /etc/audit/rules.d/ephemeral.rules
      register: audit_rules
    - name: Validate audit rules
      ansible.builtin.assert:
        that:
          - audit_rules.stat.exists
      when: audit_rules.stat is defined
    - name: Check SSHD MaxAuthTries
      ansible.builtin.command: grep "MaxAuthTries 3" /etc/ssh/sshd_config
      register: sshd_auth_check
      failed_when: false
      changed_when: false
    - name: Validate SSHD MaxAuthTries
      ansible.builtin.assert:
        that:
          - sshd_auth_check.rc == 0
