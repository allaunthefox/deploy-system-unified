---
# create.yml - Ansible-Native container creation for kubernetes-master
# This playbook creates the test instance using Podman with CentOS Stream 9
#
# Args:
#     molecule_ephemeral_directory: Molecule's ephemeral directory for state
#
# Returns:
#     Creates a Podman container named 'instance' with systemd support
#
# Example:
#     molecule create -s kubernetes-master

- name: Create
  hosts: localhost
  gather_facts: false
  vars:
    molecule_file: "{{ molecule_ephemeral_directory }}/../molecule.yml"
    molecule_instance_config: "{{ molecule_ephemeral_directory }}/instance_config.yml"

  tasks:
    # Create a Podman container with systemd support for K3s testing
    - name: Create molecule instance
      containers.podman.podman_container:
        name: instance
        image: centos:stream9
        privileged: true
        state: started
        command: /sbin/init
        tmpfs:
          - /run
          - /tmp
        volumes:
          - /sys/fs/cgroup:/sys/fs/cgroup:ro
      register: container

    # Save instance configuration for other playbooks to reference
    - name: Save instance config
      ansible.builtin.copy:
        content: |
          molecule_instances:
            - name: instance
              image: centos:stream9
              state: started
        dest: "{{ molecule_instance_config }}"

    # Wait for the container to be ready
    - name: Wait for instance to be ready
      ansible.builtin.wait_for:
        timeout: 60
      register: wait_result
      failed_when: false
