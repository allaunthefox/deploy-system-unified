---
- name: Verify
  hosts: all
  gather_facts: false
  vars:
    expected_ssh_port: "{{ ssh_effective_port | default(system_ssh_port) | default(22) }}"
  tasks:
    - name: Verify development container directories
      ansible.builtin.stat:
        path: "{{ item }}"
      register: dev_dirs
      loop:
        - /srv/containers
        - /srv/containers/config
    - name: Validate development directories
      ansible.builtin.assert:
        that:
          - item.stat.exists
      loop: "{{ dev_dirs.results }}"
    - name: Check SSHD config for port {{ expected_ssh_port }}
      ansible.builtin.command: grep "Port {{ expected_ssh_port }}" /etc/ssh/sshd_config
      register: sshd_port_check
      failed_when: false
      changed_when: false
    - name: Validate SSHD port
      ansible.builtin.assert:
        that:
          - sshd_port_check.rc == 0
