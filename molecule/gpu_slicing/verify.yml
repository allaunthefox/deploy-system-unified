# =============================================================================
# Audit Event Identifier: DSU-TST-1000736
# Last Updated: 2026-02-28
# =============================================================================
---
# verify.yml - Verification playbook for molecule tests
# Validates that deployment was successful by checking directories, packages, and configurations
#
# Args:
#     Runs on all hosts defined in inventory
#
# Returns:
#     Passes if all required directories, packages, and configurations exist and are correct
#
# Example:
#     molecule verify -s gpu_slicing

- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: Verify essential directories exist
      ansible.builtin.stat:
        path: "{{ item }}"
      register: dir_stats
      loop:
        - /var/lib/deploy-system
        - /var/lib/deploy-system/checkpoints
        - /var/lib/deploy-system/backups
        - /var/lib/deploy-system/logs
        - /tmp/deploy-system
        - /etc/security
    - name: Validate directory existence
      ansible.builtin.assert:
        that:
          - item.stat.exists
          - item.stat.isdir
        fail_msg: "Directory {{ item.item }} should exist"
      loop: "{{ dir_stats.results }}"

    - name: Verify essential packages are installed (Debian/Ubuntu)
      ansible.builtin.package_facts:
        manager: apt
      when: ansible_os_family == 'Debian'
    - name: Assert essential packages are installed (Debian/Ubuntu)
      ansible.builtin.assert:
        that:
          - "'curl' in ansible_facts.packages"
          - "'wget' in ansible_facts.packages"
          - "'git' in ansible_facts.packages"
          - "'sudo' in ansible_facts.packages"
          - "'vim' in ansible_facts.packages"
        fail_msg: "Essential packages for Debian/Ubuntu are not installed."
      when: ansible_os_family == 'Debian'

    - name: Verify essential packages are installed (RedHat/CentOS)
      ansible.builtin.package_facts:
        manager: dnf
      when: ansible_os_family == 'RedHat'
    - name: Assert essential packages are installed (RedHat/CentOS)
      ansible.builtin.assert:
        that:
          - "'curl' in ansible_facts.packages"
          - "'wget' in ansible_facts.packages"
          - "'git' in ansible_facts.packages"
          - "'sudo' in ansible_facts.packages"
          - "'vim' in ansible_facts.packages"
        fail_msg: "Essential packages for RedHat/CentOS are not installed."
      when: ansible_os_family == 'RedHat'

    - name: Verify essential packages are installed (Archlinux)
      ansible.builtin.package_facts:
        manager: pacman
      when: ansible_distribution == 'Archlinux'
    - name: Assert essential packages are installed (Archlinux)
      ansible.builtin.assert:
        that:
          - "'curl' in ansible_facts.packages"
          - "'wget' in ansible_facts.packages"
          - "'git' in ansible_facts.packages"
          - "'sudo' in ansible_facts.packages"
          - "'vim' in ansible_facts.packages"
        fail_msg: "Essential packages for Archlinux are not installed."
      when: ansible_distribution == 'Archlinux'

    - name: Verify essential packages are installed (Alpine)
      ansible.builtin.package_facts:
        manager: apk
      when: ansible_os_family == 'Alpine'
    - name: Assert essential packages are installed (Alpine)
      ansible.builtin.assert:
        that:
          - "'curl' in ansible_facts.packages"
          - "'wget' in ansible_facts.packages"
          - "'git' in ansible_facts.packages"
          - "'sudo' in ansible_facts.packages"
          - "'vim' in ansible_facts.packages"
        fail_msg: "Essential packages for Alpine are not installed."
      when: ansible_os_family == 'Alpine'

    - name: Verify preflight flag exists
      ansible.builtin.stat:
        path: /tmp/preflight_completed.flag
      register: preflight_flag
    - name: Validate preflight flag
      ansible.builtin.assert:
        that:
          - preflight_flag.stat.exists
        fail_msg: "Preflight completion flag should exist"
