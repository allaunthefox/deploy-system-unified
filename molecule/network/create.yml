---
# create.yml - Ansible-Native container creation for network scenario
# This playbook creates cEOS containers for network testing
#
# Args:
#     molecule_ephemeral_directory: Molecule's ephemeral directory for state
#
# Returns:
#     Creates cEOS containers for network device testing
#
# Example:
#     molecule create -s network

- name: Create
  hosts: localhost
  gather_facts: false
  vars:
    molecule_file: "{{ molecule_ephemeral_directory }}/../molecule.yml"
    molecule_instance_config: "{{ molecule_ephemeral_directory }}/instance_config.yml"
    # cEOS image - requires Arista license for production use
    ceos_image: "ceos:latest"
    # Container names for network topology
    network_devices:
      - ceos-01
      - ceos-02

  tasks:
    # Create a Podman network for cEOS containers
    - name: Create molecule network
      containers.podman.podman_network:
        name: molecule-network
        state: present
        driver: bridge

    # Create cEOS containers
    - name: Create cEOS network containers
      containers.podman.podman_container:
        name: "{{ item }}"
        image: "{{ ceos_image }}"
        privileged: true
        state: started
        # cEOS requires these flags for proper operation
        env:
          CEOS: "1"
          container: "docker"
          EOS_PLATFORM: "ceoslab"
        # Map ports for eAPI access
        published_ports:
          - "80{{ loop_index }}:80"
          - "443{{ loop_index }}:443"
        networks:
          - molecule-network
      loop: "{{ network_devices }}"
      loop_control:
        loop_var: item
        index_var: loop_index

    # Wait for cEOS to boot and be ready
    - name: Wait for cEOS devices to boot
      ansible.builtin.wait_for:
        timeout: 120
      register: wait_result
      failed_when: false

    # Save instance configuration for other playbooks to reference
    - name: Save instance config
      ansible.builtin.copy:
        content: |
          molecule_instances:
            {% for device in network_devices %}
            - name: {{ device }}
              image: {{ ceos_image }}
              state: started
            {% endfor %}
        dest: "{{ molecule_instance_config }}"
