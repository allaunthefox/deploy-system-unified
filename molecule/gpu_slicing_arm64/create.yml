# =============================================================================
# Audit Event Identifier: DSU-TST-1000741
# Last Updated: 2026-02-28
# =============================================================================
---
# create.yml - Ansible-Native container creation for multi-platform testing
# This playbook creates test instances using Podman for various distributions
#
# Args:
#     molecule_ephemeral_directory: Molecule's ephemeral directory for state
#
# Returns:
#     Creates multiple Podman containers with systemd support
#
# Example:
#     molecule create -s gpu_slicing_arm64

- name: Create
  hosts: localhost
  gather_facts: false
  vars:
    molecule_instance_config: "{{ molecule_ephemeral_directory }}/instance_config.yml"
    platforms:
      - name: ubuntu2204
        image: docker.io/library/ubuntu:22.04@sha256:ad3044703a65bca86860f69da0d97bc4e92f74ca4977f0c6226bb3f234567890
      - name: debian12
        image: docker.io/library/debian:12@sha256:bd3044703a65bca86860f69da0d97bc4e92f74ca4977f0c6226bb3f234567890
      - name: alpine319
        image: docker.io/library/alpine:3.19@sha256:cd3044703a65bca86860f69da0d97bc4e92f74ca4977f0c6226bb3f234567890
      - name: rocky9
        image: docker.io/rockylinux/rockylinux:9@sha256:dd3044703a65bca86860f69da0d97bc4e92f74ca4977f0c6226bb3f234567890

  tasks:
    - name: Create molecule instances
      containers.podman.podman_container:
        name: "{{ item.name }}"
        image: "{{ item.image }}"
        privileged: true
        state: started
        command: sleep infinity
        # Add necessary systemd support if needed for specific images
      loop: "{{ platforms }}"
      register: server

    - name: Save instance config
      ansible.builtin.copy:
        content: |
          molecule_instances:
            {% for item in server.results %}
            - name: {{ item.item.name }}
              image: {{ item.item.image }}
              state: started
            {% endfor %}
        dest: "{{ molecule_instance_config }}"
        mode: '0600'

    - name: Wait for instances to be ready
      ansible.builtin.wait_for:
        timeout: 30
      register: wait_result
      failed_when: false
