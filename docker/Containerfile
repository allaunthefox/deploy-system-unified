# =============================================================================
# Audit Event Identifier: DSU-CNT-850001
# File Type: Container Build Definition (Containerfile)
# Description: Deploy-System-Unified containerized management system
# Build: podman build -t deploy-system-unified:latest -f docker/Containerfile .
# Compliance: Non-root USER, HEALTHCHECK, pinned dependencies
# Last Updated: 2026-02-28
# Version: 1.0
# =============================================================================
# Deploy-System-Unified - Containerized Management System (Podman-native with Docker compatibility)
# Build with: podman build -t deploy-system-unified:latest -f docker/Containerfile .
# Build with: docker build -t deploy-system-unified:latest -f docker/Containerfile .
# Run with: podman run --rm deploy-system-unified:latest
# Run with: docker run --rm deploy-system-unified:latest
#
# Strict Compliance:
#   - Base image pinned to digest (deterministic build)
#   - Non-root USER (least privilege)
#   - HEALTHCHECK instruction (container health visibility)
#   - Version-pinned dependencies
#   - --no-install-recommends (minimal image)
#   - Cache cleanup in same layer
#   - Podman-native with Docker compatibility

# Pin to specific digest for deterministic builds
# Image: ubuntu:24.04 (Noble Numbat)
# Digest verified: 2026-02-27
FROM ubuntu@sha256:77906da86b60585ce12215807090eb327e7386c8fafb5402369e421f44eff17e

# Prevent interactive prompts during build
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Configuration - Centralized (DRY principle)
ENV INSTALL_DIR=/opt/deploy-system
ENV CONFIG_DIR=${INSTALL_DIR}/config
ENV LOG_DIR=${INSTALL_DIR}/logs
ENV DATA_DIR=${INSTALL_DIR}/data

# Create non-root user (least privilege)
# UID/GID explicitly set for reproducibility
RUN groupadd --gid 1000 deploy && \
    useradd --uid 1000 --gid deploy --shell /bin/bash --create-home deploy

# Install dependencies with version pinning and minimal packages
RUN apt-get update && \
    apt-get install --no-install-recommends --yes \
    # Core utilities
    ca-certificates=20240203 \
    curl=8.5.0-2ubuntu10.1 \
    wget=1.21.4-1ubuntu4.1 \
    gnupg=2.4.4-2ubuntu17.1 \
    # Python
    python3=3.12.3-0ubuntu2 \
    python3-pip=24.0+dfsg-1ubuntu1.1 \
    # Ansible
    ansible=2.16.3+dfsg-1 \
    ansible-core=2.16.3-1 \
    # Git for collection installation
    git=1:2.43.0-1ubuntu7 \
    # SSH for remote deployments
    openssh-client=1:9.6p1-3ubuntu13.5 \
    # Cleanup in same layer to reduce image size
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean \
    && rm -rf /tmp/* /var/tmp/*

# Set working directory
WORKDIR ${INSTALL_DIR}

# Copy requirements first (better layer caching)
COPY requirements.txt ${INSTALL_DIR}/
COPY requirements.yml ${INSTALL_DIR}/

# Install Python dependencies with version pinning
RUN pip3 install --no-cache-dir --break-system-packages \
    -r ${INSTALL_DIR}/requirements.txt

# Install Ansible collections
RUN ansible-galaxy collection install -r ${INSTALL_DIR}/requirements.yml && \
    rm -rf ~/.ansible/collections/.galaxy_token

# Copy application files
COPY --chown=deploy:deploy . ${INSTALL_DIR}/

# Create directories with proper permissions
RUN mkdir -p ${CONFIG_DIR} ${LOG_DIR} ${DATA_DIR} && \
    chmod 750 ${INSTALL_DIR} ${CONFIG_DIR} && \
    chmod 755 ${LOG_DIR} ${DATA_DIR}

# Set environment variables
ENV PATH=${INSTALL_DIR}/scripts:${PATH} \
    ANSIBLE_CONFIG=${INSTALL_DIR}/ansible.cfg \
    ANSIBLE_ROLES_PATH=${INSTALL_DIR}/roles \
    ANSIBLE_COLLECTIONS_PATH=~/.ansible/collections

# Copy entrypoint script
COPY --chown=deploy:deploy docker/entrypoint.sh ${INSTALL_DIR}/entrypoint.sh
RUN chmod +x ${INSTALL_DIR}/entrypoint.sh

# Switch to non-root user (security best practice)
USER deploy

# Expose documentation port (if web UI added later)
EXPOSE 8080/tcp

# Health check (container health visibility)
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD ["/opt/deploy-system/entrypoint.sh", "healthcheck"]

# Volume mounts for persistence
# - Config: Mount custom configurations
# - Logs: Persist deployment logs
# - Data: Store checkpoints, backups
VOLUME ["${CONFIG_DIR}", "${LOG_DIR}", "${DATA_DIR}"]

# Labels for container metadata
LABEL maintainer="allaunthefox"
LABEL org.opencontainers.image.title="Deploy-System-Unified"
LABEL org.opencontainers.image.description="Modular, security-first infrastructure deployment"
LABEL org.opencontainers.image.version="1.0.0"
LABEL org.opencontainers.image.source="https://github.com/allaunthefox/deploy-system-unified"
LABEL org.opencontainers.image.licenses="GPL-3.0"

# Default command
ENTRYPOINT ["${INSTALL_DIR}/entrypoint.sh"]
CMD ["--help"]
