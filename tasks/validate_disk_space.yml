---
# Disk Space Preflight Validation
# Ensures sufficient disk space before deployment

- name: "ISO 27001 §8.8 | 450050 | Gather disk usage facts"
  ansible.builtin.shell:
    cmd: df -h --output=target,size,used,avail,pcent 2>/dev/null | grep -E "^/|/var|/boot"
  register: disk_usage
  changed_when: false
  failed_when: false
  tags:
    - preflight
    - disk
    - 450050

- name: "ISO 27001 §8.8 | 450051 | Check root partition free space"
  ansible.builtin.shell:
    cmd: df -P / | tail -1 | awk '{print $4}'
  register: root_free_kb
  changed_when: false
  tags:
    - preflight
    - disk
    - 450051

- name: "ISO 27001 §8.8 | 450052 | Check /var partition free space"
  ansible.builtin.shell:
    cmd: df -P /var 2>/dev/null | tail -1 | awk '{print $4}' || df -P / | tail -1 | awk '{print $4}'
  register: var_free_kb
  changed_when: false
  failed_when: false
  tags:
    - preflight
    - disk
    - 450052

- name: "ISO 27001 §8.8 | 450053 | Check /boot partition free space"
  ansible.builtin.shell:
    cmd: df -P /boot 2>/dev/null | tail -1 | awk '{print $4}' || echo "0"
  register: boot_free_kb
  changed_when: false
  failed_when: false
  tags:
    - preflight
    - disk
    - 450054

- name: "ISO 27001 §8.8 | 450054 | CRITICAL: Assert root partition has minimum space"
  ansible.builtin.assert:
    that:
      - (root_free_kb.stdout | default('0') | int) >= 5242880  # 5GB in KB
    fail_msg: >-
      CRITICAL: Insufficient disk space on root partition!
      
      Available: {{ (root_free_kb.stdout | default('0') | int / 1024 / 1024) | round(2) }} GB
      Required: 5 GB minimum
      
      This will cause:
      - Container pull failures
      - Package installation failures
      - Log file exhaustion
      
      ACTION REQUIRED:
      1. Clean up disk: apt clean, journalctl --vacuum-time=7d
      2. Remove unused containers/images
      3. Expand disk if needed
      
      See: docs/preflight/DISK_SPACE.md
  tags:
    - preflight
    - disk
    - critical
    - 450054

- name: "ISO 27001 §8.8 | 450055 | Assert /var has space for containers"
  ansible.builtin.assert:
    that:
      - (var_free_kb.stdout | default('0') | int) >= 10485760  # 10GB in KB
    fail_msg: >-
      WARNING: Low disk space on /var!
      
      Available: {{ (var_free_kb.stdout | default('0') | int / 1024 / 1024) | round(2) }} GB
      Recommended: 10 GB for containers
      
      Container deployments may fail or run out of space.
      
      ACTION RECOMMENDED:
      1. Clean old containers: podman system prune
      2. Remove unused images
      3. Consider expanding /var
  when: containers_enabled | default(false) | bool
  tags:
    - preflight
    - disk
    - containers
    - 450055

- name: "ISO 27001 §8.8 | 450056 | Assert /boot has space for kernel updates"
  ansible.builtin.assert:
    that:
      - (boot_free_kb.stdout | default('0') | int) >= 102400  # 100MB in KB
    fail_msg: >-
      CRITICAL: Insufficient /boot space for kernel updates!
      
      Available: {{ (boot_free_kb.stdout | default('0') | int / 1024) | round(2) }} MB
      Required: 100 MB minimum
      
      Kernel updates will FAIL, leaving system vulnerable!
      
      ACTION REQUIRED:
      1. Remove old kernels: apt autoremove --purge
      2. Check /boot contents: ls -lh /boot
      3. Expand /boot partition if needed
  when:
    - boot_free_kb.stdout | default('0') | int > 0
    - kernel_updates_enabled | default(true) | bool
  tags:
    - preflight
    - disk
    - boot
    - kernel
    - critical
    - 450056

- name: "ISO 27001 §8.8 | 450057 | Display disk space summary"
  ansible.builtin.debug:
    msg:
      - "Root (/) free: {{ (root_free_kb.stdout | default('0') | int / 1024 / 1024) | round(2) }} GB (min: 5 GB)"
      - "/var free: {{ (var_free_kb.stdout | default('0') | int / 1024 / 1024) | round(2) }} GB (rec: 10 GB)"
      - "/boot free: {{ (boot_free_kb.stdout | default('0') | int / 1024) | round(2) }} MB (min: 100 MB)"
      - "Status: {{ 'PASS' if (root_free_kb.stdout | default('0') | int) >= 5242880 else 'FAIL' }}"
  tags:
    - preflight
    - disk
    - 450057
