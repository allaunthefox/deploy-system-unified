---
# Cloud-Init Reconciliation
# Prevents cloud-init from reverting SSH/hardening changes on reboot

- name: "ISO 27001 §8.8 | 450090 | Detect cloud-init installation"
  ansible.builtin.stat:
    path: /etc/cloud/cloud.cfg
  register: cloud_init_config
  tags:
    - cloud-init
    - reconciliation
    - 450090

- name: "ISO 27001 §8.8 | 450091 | Check cloud-init status"
  ansible.builtin.shell:
    cmd: cloud-init status 2>/dev/null || echo "not_installed"
  register: cloud_init_status
  changed_when: false
  failed_when: false
  when: cloud_init_config.stat.exists
  tags:
    - cloud-init
    - reconciliation
    - 450091

- name: "ISO 27001 §8.8 | 450092 | Set cloud-init facts"
  ansible.builtin.set_fact:
    cloud_init_installed: "{{ cloud_init_config.stat.exists }}"
    cloud_init_status: "{{ cloud_init_status.stdout | default('not_installed') }}"
  tags:
    - cloud-init
    - reconciliation
    - 450092

- name: "ISO 27001 §8.8 | 450093 | Assert cloud-init policy"
  ansible.builtin.assert:
    that:
      - cloud_init_installed | bool
      - cloud_init_policy is defined
      - cloud_init_policy in ['disable', 'preserve', 'reconcile']
    fail_msg: >-
      Cloud-init detected on VPS/Cloud instance!
      
      Status: {{ cloud_init_status }}
      
      Without policy configuration, cloud-init may:
      - Revert SSH port changes on reboot
      - Overwrite SSH authorized_keys
      - Re-enable password authentication
      - Revert user/group changes
      
      ACTION REQUIRED: Add to inventory/group_vars/all/cloud.yml:
      
      Option 1: Disable cloud-init (recommended for static configs)
        ```yaml
        cloud_init_policy: disable
        ```
      
      Option 2: Preserve cloud-init but prevent SSH reversion
        ```yaml
        cloud_init_policy: preserve
        cloud_init_disable_ssh_changes: true
        ```
      
      Option 3: Reconcile with cloud-init (advanced)
        ```yaml
        cloud_init_policy: reconcile
        cloud_init_run_on_boot: true
        ```
      
      See: docs/deployment/CLOUD_INIT_RECONCILIATION.md
  when:
    - cloud_init_installed | bool
    - cloud_init_policy is not defined
  tags:
    - cloud-init
    - reconciliation
    - policy
    - 450093

- name: "ISO 27001 §8.8 | 450094 | Disable cloud-init (if policy requires)"
  ansible.builtin.file:
    path: /etc/cloud/cloud-init.disabled
    state: touch
    mode: '0644'
  when:
    - cloud_init_installed | bool
    - cloud_init_policy | default('') == 'disable'
  become: true
  notify: conditional_reboot
  tags:
    - cloud-init
    - reconciliation
    - disable
    - 450094

- name: "ISO 27001 §8.8 | 450095 | Stop and disable cloud-init services"
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
    enabled: false
    masked: true
  loop:
    - cloud-init.service
    - cloud-init-local.service
    - cloud-config.service
    - cloud-final.service
  when:
    - cloud_init_installed | bool
    - cloud_init_policy | default('') == 'disable'
  become: true
  tags:
    - cloud-init
    - reconciliation
    - disable
    - 450095

- name: "ISO 27001 §8.8 | 450096 | Configure cloud-init to preserve SSH changes"
  ansible.builtin.copy:
    dest: /etc/cloud/cloud.cfg.d/99-preserve-ssh.cfg
    content: |
      # Prevent cloud-init from reverting SSH configuration
      # Generated by Deploy-System-Unified
      
      # Disable SSH key management by cloud-init
      ssh_pwauth: false
      
      # Disable user management that could affect SSH
      disable_root: false
      
      # Preserve existing SSH configuration
      ssh_deletekeys: false
      ssh_genkeytypes: []
      
      # Prevent SSH config overwrite
      ssh_quiet_keygen: true
    mode: '0644'
  when:
    - cloud_init_installed | bool
    - cloud_init_policy | default('') == 'preserve'
    - cloud_init_disable_ssh_changes | default(true) | bool
  become: true
  tags:
    - cloud-init
    - reconciliation
    - preserve
    - 450096

- name: "ISO 27001 §8.8 | 450097 | Create cloud-init reconciliation script"
  ansible.builtin.copy:
    dest: /usr/local/bin/cloud-init-reconcile.sh
    content: |
      #!/bin/bash
      # Cloud-init reconciliation script
      # Re-applies SSH hardening after cloud-init runs
      
      set -e
      
      echo "Reconciling SSH configuration after cloud-init..."
      
      # Re-apply SSH port if changed
      if [ -f /etc/ssh/sshd_config.d/99-hardened.conf ]; then
        echo "SSH hardening config preserved"
      fi
      
      # Re-apply firewall rules if needed
      if command -v iptables-save >/dev/null 2>&1; then
        iptables-save > /etc/iptables/rules.v4
        echo "Firewall rules reconciled"
      fi
      
      echo "Reconciliation complete"
    mode: '0755'
  when:
    - cloud_init_installed | bool
    - cloud_init_policy | default('') == 'reconcile'
  become: true
  tags:
    - cloud-init
    - reconciliation
    - reconcile
    - 450097

- name: "ISO 27001 §8.8 | 450098 | Add reconciliation to cloud-init final"
  ansible.builtin.copy:
    dest: /etc/cloud/cloud.cfg.d/99-reconcile.cfg
    content: |
      # Run reconciliation script after cloud-init completes
      final_message: "Reconciling hardening configuration..."
      
      runcmd:
        - /usr/local/bin/cloud-init-reconcile.sh || true
    mode: '0644'
  when:
    - cloud_init_installed | bool
    - cloud_init_policy | default('') == 'reconcile'
  become: true
  tags:
    - cloud-init
    - reconciliation
    - reconcile
    - 450098

- name: "ISO 27001 §8.8 | 450099 | Display cloud-init reconciliation status"
  ansible.builtin.debug:
    msg:
      - "Cloud-init installed: {{ cloud_init_installed }}"
      - "Cloud-init status: {{ cloud_init_status | default('N/A') }}"
      - "Policy: {{ cloud_init_policy | default('NOT SET') }}"
      - "Status: {{ 'CONFIGURED' if (cloud_init_policy is defined) else 'NOT CONFIGURED - ACTION REQUIRED' }}"
  when: cloud_init_installed | bool
  tags:
    - cloud-init
    - reconciliation
    - 450099
