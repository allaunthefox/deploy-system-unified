# =============================================================================
# Audit Event Identifier: DSU-PLY-100841
# Last Updated: 2026-02-28
# =============================================================================
---
# Centralized Secret Hygiene Assertions
# Fails deployment if placeholder/weak secrets are detected

- name: "ISO 27001 ยง9.2 | 400007 | CRITICAL: Assert no placeholder secrets in memory"
  ansible.builtin.assert:
    that:
      - item.value is defined
      - item.value != 'CHANGE_ME_IN_SOPS'
      - item.value != 'changeme'
      - item.value != 'CHANGEME'
      - item.value != 'ChangeMe'
      - item.value != 'default'
      - item.value != 'Default'
      - item.value != 'DEFAULT'
      - item.value != 'placeholder'
      - item.value != 'Placeholder'
      - item.value != 'PLACEHOLDER'
      - item.value | length >= 8
    fail_msg: >-
      CRITICAL: Placeholder or weak secret detected for {{ item.key }}!
      
      Value: {{ item.value | default('UNDEFINED', true) | regex_replace('.', '*') }}
      Length: {{ item.value | default('', true) | length }}
      
      ACTION REQUIRED:
      1. Set environment variable before deployment:
         export {{ item.key | upper }}=$(openssl rand -base64 32)
      2. Or use SOPS/Vault to encrypt the secret
      3. Never commit plaintext secrets to version control
      
      See: docs/development/CI_VAULT_CONFIG.md
  loop: "{{ secret_hygiene_vars | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  when: secret_hygiene_vars is defined
  tags:
    - security
    - secrets
    - preflight
    - 400007

- name: "ISO 27001 ยง9.2 | 400008 | Assert Helm chart passwords are not default"
  ansible.builtin.command:
    cmd: >-
      grep -riE "password.*:.*['\"]?(changeme|change[_-]?me|default|placeholder)['\"]?"
      charts/*/values.yaml 2>/dev/null || true
  register: helm_password_check
  changed_when: false
  failed_when: helm_password_check.stdout | length > 0
  fail_msg: >-
    CRITICAL: Helm charts contain placeholder passwords!
    
    Found:
    {{ helm_password_check.stdout }}
    
    ACTION REQUIRED:
    1. Edit charts/database-stack/values.yaml
    2. Set passwords to empty strings: password: ""
    3. Deploy with: helm install ... --set postgresql.password=$(openssl rand -base64 32)
  tags:
    - security
    - secrets
    - helm
    - 400008
