# =============================================================================
# Audit Event Identifier: DSU-PLY-100848
# Last Updated: 2026-02-28
# =============================================================================
---
# Generic wrapper to run a role with checkpointing
# Input: 'role_item' (the role name or object with role/vars)
# SIMPLIFIED VERSION: Ignores vars to avoid Ansible Dictionary/String type errors

- name: "ISO 9001 | 600013 | Determine Role Name"
  ansible.builtin.set_fact:
    current_role_name: "{{ role_item.role if role_item is mapping else role_item }}"

- name: "ISO 9001 | 600016 | Check Phase: {{ current_role_name }}"
  ansible.builtin.debug:
    msg: "Phase {{ current_role_name }} already completed. Skipping."
  when: current_role_name in completed_phases | default([])

- name: "ISO 9001 | 600013 | Execute Phase: {{ current_role_name }}"
  block:
    - name: "ISO 9001 | 600013 | Include Role: {{ current_role_name }}"
      ansible.builtin.include_role:
        name: "{{ current_role_name }}"
      # Inline vars disabled. Configure dynamic vars via group_vars/host_vars.

    - name: "ISO 27037 | 520000 | Checkpoint Phase: {{ current_role_name }}"
      ansible.builtin.include_tasks: save_checkpoint.yml
      vars:
        additional_phases: ["{{ current_role_name }}"]
  when: current_role_name not in completed_phases | default([])
