# =============================================================================
# Audit Event Identifier: DSU-PLY-100851
# Last Updated: 2026-02-28
# =============================================================================
---
# Post-Deployment Container Health Validation
# Validates that deployed containers are running and healthy

- name: "ISO 27001 ยง8.8 | 700001 | Validate container is running"
  ansible.builtin.command:
    cmd: podman inspect {{ container_name | default(item) }} --format '{{ '{{' }}.State.Status {{ '}}' }}'
  register: container_status
  changed_when: false
  failed_when: container_status.stdout != 'running'
  fail_msg: >-
    Container {{ container_name | default(item) }} is not running!
    Status: {{ container_status.stdout | default('UNKNOWN') }}
    
    ACTION REQUIRED:
    1. Check container logs: podman logs {{ container_name | default(item) }}
    2. Verify systemd unit: systemctl status {{ container_name | default(item) }}.service
    3. Check Quadlet file: cat /etc/containers/systemd/{{ container_name | default(item) }}.container
  tags:
    - containers
    - validation
    - health
    - 700001

- name: "ISO 27001 ยง8.8 | 700002 | Wait for container port to be reachable"
  ansible.builtin.wait_for:
    host: "{{ container_host | default('127.0.0.1') }}"
    port: "{{ container_port }}"
    timeout: 120
    state: started
  when: container_port is defined
  tags:
    - containers
    - validation
    - health
    - 700002

- name: "ISO 27001 ยง8.8 | 700003 | Validate HTTP health endpoint (if configured)"
  ansible.builtin.uri:
    url: "http://{{ container_host | default('127.0.0.1') }}:{{ container_port }}{{ container_health_path | default('/health') }}"
    method: GET
    status_code: "{{ container_health_status_code | default([200, 204, 301, 302], true) }}"
    timeout: 30
  register: health_check
  until: health_check.status in (container_health_status_code | default([200, 204, 301, 302], true))
  retries: 5
  delay: 10
  when:
    - container_port is defined
    - container_health_path is defined
  tags:
    - containers
    - validation
    - health
    - 700003

- name: "ISO 27001 ยง8.8 | 700004 | Display container health summary"
  ansible.builtin.debug:
    msg:
      - "Container: {{ container_name | default(item) }}"
      - "Status: {{ container_status.stdout | default('UNKNOWN') }}"
      - "Port {{ container_port | default('N/A') }}: {{ 'Reachable' if container_port is defined else 'N/A' }}"
      - "Health Check: {{ 'Passed' if (health_check is defined and health_check.status in [200, 204]) else 'Skipped' }}"
  tags:
    - containers
    - validation
    - health
    - 700004
