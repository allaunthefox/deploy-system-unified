---
# Kernel Module Validation
# Ensures required kernel modules are loaded for container/K8s functionality

- name: "ISO 27001 §8.8 | 450070 | Detect virtualization type"
  ansible.builtin.set_fact:
    is_container: >-
      {{ ansible_virtualization_type | default('bare_metal') in ['docker', 'podman', 'container', 'lxc', 'openvz'] }}
  tags:
    - kernel
    - modules
    - validation
    - 450070

- name: "ISO 27001 §8.8 | 450071 | Get loaded kernel modules"
  ansible.builtin.shell:
    cmd: lsmod
  register: loaded_modules
  changed_when: false
  failed_when: false
  when: not is_container | bool
  tags:
    - kernel
    - modules
    - validation
    - 450071

- name: "ISO 27001 §8.8 | 450072 | Define required modules for Kubernetes"
  ansible.builtin.set_fact:
    kubernetes_required_modules:
      - br_netfilter
      - overlay
      - nf_conntrack
      - nf_conntrack_ipv4
      - iptable_filter
      - ip_tables
  when: kubernetes_enabled | default(false) | bool
  tags:
    - kernel
    - modules
    - kubernetes
    - 450072

- name: "ISO 27001 §8.8 | 450073 | Define required modules for containers"
  ansible.builtin.set_fact:
    container_required_modules:
      - overlay
      - br_netfilter
  when: containers_enabled | default(false) | bool
  tags:
    - kernel
    - modules
    - containers
    - 450073

- name: "ISO 27001 §8.8 | 450074 | Check required modules are loaded"
  ansible.builtin.shell:
    cmd: lsmod | grep -q "^{{ item }} " && echo "loaded" || echo "not_loaded"
  loop: "{{ (kubernetes_required_modules if (kubernetes_enabled | default(false)) else []) + (container_required_modules if (containers_enabled | default(false)) else []) | unique }}"
  register: module_status
  changed_when: false
  failed_when: false
  when: not is_container | bool
  tags:
    - kernel
    - modules
    - validation
    - 450074

- name: "ISO 27001 §8.8 | 450075 | Set missing modules fact"
  ansible.builtin.set_fact:
    missing_modules: >-
      {{ module_status.results | selectattr('stdout', 'defined') | selectattr('stdout', 'eq', 'not_loaded') | map(attribute='item') | list }}
  when: module_status is defined
  tags:
    - kernel
    - modules
    - validation
    - 450075

- name: "ISO 27001 §8.8 | 450076 | CRITICAL: Assert all required modules are loaded"
  ansible.builtin.assert:
    that:
      - missing_modules | length == 0
    fail_msg: >-
      CRITICAL: Required kernel modules NOT loaded!
      
      Missing: {{ missing_modules | to_nice_json }}
      
      This will cause:
      - Kubernetes cluster join failures
      - Container network isolation failures
      - CNI plugin errors
      
      ACTION REQUIRED:
      1. Load modules: modprobe {{ missing_modules | join(' ') }}
      2. Make permanent: echo -e "{{ missing_modules | map('regex_replace', '^', 'modules\n') | join('\n') }}" >> /etc/modules-load.d/k8s.conf
      3. Verify: lsmod | grep -E '{{ missing_modules | join('|') }}'
      
      See: docs/kubernetes/KERNEL_MODULES.md
  when:
    - missing_modules is defined
    - missing_modules | length > 0
  tags:
    - kernel
    - modules
    - critical
    - kubernetes
    - 450076

- name: "ISO 27001 §8.8 | 450077 | Load missing modules (if auto-load enabled)"
  ansible.builtin.command: modprobe {{ item }}
  loop: "{{ missing_modules | default([]) }}"
  register: modprobe_result
  changed_when: modprobe_result.rc == 0
  failed_when: false
  when:
    - missing_modules is defined
    - kernel_modules_auto_load | default(true) | bool
  become: true
  tags:
    - kernel
    - modules
    - auto-load
    - 450077

- name: "ISO 27001 §8.8 | 450078 | Create modules-load.d configuration"
  ansible.builtin.copy:
    dest: /etc/modules-load.d/k8s.conf
    content: |
      # Kubernetes/Container required modules
      # Auto-generated by Deploy-System-Unified
      {{ (missing_modules | default([])) | join('\n') }}
    mode: '0644'
  when:
    - missing_modules is defined
    - missing_modules | length > 0
    - kernel_modules_auto_load | default(true) | bool
  become: true
  tags:
    - kernel
    - modules
    - persistence
    - 450078

- name: "ISO 27001 §8.8 | 450079 | Check br_netfilter sysctl requirement"
  ansible.builtin.shell:
    cmd: sysctl -n net.bridge.bridge-nf-call-iptables 2>/dev/null || echo "0"
  register: br_netfilter_sysctl
  changed_when: false
  failed_when: false
  when: "'br_netfilter' in (missing_modules | default([]))"
  tags:
    - kernel
    - modules
    - sysctl
    - 450079

- name: "ISO 27001 §8.8 | 450080 | Enable br_netfilter sysctl"
  ansible.posix.sysctl:
    name: net.bridge.bridge-nf-call-iptables
    value: '1'
    sysctl_file: /etc/sysctl.d/99-kubernetes.conf
    reload: true
  when:
    - "'br_netfilter' in (missing_modules | default([]))"
    - (br_netfilter_sysctl.stdout | default('0')) != '1'
  become: true
  tags:
    - kernel
    - modules
    - sysctl
    - kubernetes
    - 450080

- name: "ISO 27001 §8.8 | 450081 | Display kernel module validation summary"
  ansible.builtin.debug:
    msg:
      - "Virtualization: {{ ansible_virtualization_type | default('bare_metal') }}"
      - "Is container: {{ is_container }}"
      - "Required modules: {{ (kubernetes_required_modules if (kubernetes_enabled | default(false)) else []) + (container_required_modules if (containers_enabled | default(false)) else []) | unique }}"
      - "Missing modules: {{ missing_modules | default([]) }}"
      - "Status: {{ 'PASS' if (missing_modules | default([]) | length) == 0 else 'FAIL - Load required modules' }}"
  tags:
    - kernel
    - modules
    - validation
    - 450081
