# =============================================================================
# Audit Event Identifier: DSU-PLY-100009
# Playbook Type: Base Hardening
# Description: Base hardened infrastructure deployment
# Last Updated: 2026-02-28
# Version: 1.0
# =============================================================================
---
# WARNING: This playbook is part of the solution stack.
# Use production_deploy.yml as the primary deployment entrypoint.

# Base Hardened Infrastructure - The Secure Foundation
# This playbook handles all core system setup and security hardening.

- ansible.builtin.import_playbook: playbooks/preflight_gate.yml
- ansible.builtin.import_playbook: playbooks/bootstrap_ssh.yml

- name: "ISO 27001 ยง9.2 | 100009 | Apply Secure Infrastructure Base"
  hosts: all
  become: true
  vars:
    base_hardened_roles:
      # Operations Pre-Flight (Controller-side)
      - ops/preflight
      - ops/pre_connection
      # Core system setup (The Foundational Base)
      - core/repositories
      - core/updates
      - core/bootstrap
      - core/logging
      - security/audit_integrity
      - core/time
      - core/entropy
      - core/secrets
      # Security Baseline (Establish Default-Deny First)
      - networking/firewall
      - security/mac_apparmor
      - security/kernel
      - security/hardware_isolation
      - security/hardening
      - security/access
      - security/sshd             # CIS Level 1 & ISO 27001 Compliant
      - security/file_integrity
      - storage/dedupe            # NoDupeLabs Archival Standards
      - security/sbom             # Supply Chain Integrity
      - core/grub
      # Advanced Security & Isolation Measures
      - security/sandboxing
      - security/firejail
      - security/resource_protection
      - networking/container_networks
      - networking/vpn_mesh
      - security/headscale         # Q3 2026: Zero Trust Controller (Optional)
      - security/tailscale         # Q3 2026: Zero Trust Client (Optional)
      - security/vault_integration # Q3 2026: Secret Rotation Lifecycle
      - networking/services/endlessh
      - security/ips
      - security/advanced
      # Operations Utilities
      - ops/session
      - ops/connection_info

  tasks:
    - name: "ISO 9001 | 600013 | Execute Base Hardened Roles with Granular Checkpoints"
      ansible.builtin.include_tasks: tasks/run_role.yml
      loop: "{{ base_hardened_roles }}"
      loop_control:
        loop_var: role_item

  handlers:
    - name: Import Global Handlers
      ansible.builtin.import_tasks: handlers/main.yml
