---
# WARNING: This playbook is part of the solution stack.
# Use production_deploy.yml as the primary deployment entrypoint.

# Base Hardened Infrastructure - The Secure Foundation
# This playbook handles all core system setup and security hardening.

- ansible.builtin.import_playbook: playbooks/preflight_assertions.yml
- ansible.builtin.import_playbook: playbooks/preflight_validate.yml
- ansible.builtin.import_playbook: playbooks/bootstrap_ssh.yml

- name: Apply Secure Infrastructure Base
  hosts: all
  become: true
  vars:
    base_hardened_roles:
      # Operations Pre-Flight (Controller-side)
      - ops/preflight
      - ops/pre_connection
      # Core system setup (The Foundational Base)
      - core/repositories
      - core/updates
      - core/bootstrap
      - core/logging
      - security/audit_integrity
      - core/time
      - core/entropy
      - core/secrets
      # Security Baseline (Establish Default-Deny First)
      - networking/firewall
      - security/mac_apparmor
      - security/kernel
      - security/hardware_isolation
      - security/hardening
      - security/access
      - security/sshd
      - security/file_integrity
      - core/grub
      # Advanced Security & Isolation Measures
      - security/sandboxing
      - security/firejail
      - security/resource_protection
      - networking/container_networks
      - networking/vpn_mesh
      - networking/services/endlessh
      - security/ips
      - security/advanced
      # Operations Utilities
      - ops/session
      - ops/connection_info

  tasks:
    - name: Execute Base Hardened Roles with Granular Checkpoints
      ansible.builtin.include_tasks: tasks/run_role.yml
      loop: "{{ base_hardened_roles }}"
      loop_control:
        loop_var: role_item
