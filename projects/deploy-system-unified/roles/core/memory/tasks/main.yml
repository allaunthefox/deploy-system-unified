---
# Tasks for core/memory - Intelligent Memory Compression

- name: Detect Physical Swap
  ansible.builtin.shell: swapon --show=NAME --noheadings | wc -l
  register: physical_swap_count
  changed_when: false
  become: true

- name: Detect Shared Video Memory (UMA)
  ansible.builtin.shell: |
    if lspci -v 2>/dev/null | grep -i "VGA" | grep -i "Intel"; then echo "true";
    elif [ "$(lspci 2>/dev/null | grep -c "VGA")" -eq 1 ] && lspci 2>/dev/null | grep -i "VGA" | grep -E "Renoir|Cezanne|Raven|Picasso|VanGogh|Rembrandt|Phoenix|Stoney|Carrizo|Kaveri|Temash|Kabini|Mullins"; then echo "true";
    else echo "false"; fi
  register: uma_detection
  changed_when: false
  when: memory_shared_vram == 'auto'

- name: Determine Memory Strategy (Auto-Selection)
  ansible.builtin.set_fact:
    active_memory_strategy: >-
      {{
        'zram' if (
           memory_compression_strategy == 'force_zram' or
           (memory_compression_strategy == 'auto' and memory_shared_vram == true) or
           (memory_compression_strategy == 'auto' and memory_shared_vram == 'auto' and uma_detection.stdout == 'true') or
           (memory_compression_strategy == 'auto' and ansible_memtotal_mb < 8192) or
           (memory_compression_strategy == 'auto' and physical_swap_count.stdout | int == 0)
        ) else
        'zswap' if (
           memory_compression_strategy == 'force_zswap' or
           (memory_compression_strategy == 'auto' and ansible_memtotal_mb >= 8192 and physical_swap_count.stdout | int > 0)
        ) else
        'none'
      }}

- name: Report Selected Strategy
  ansible.builtin.debug:
    msg: "System Memory: {{ ansible_memtotal_mb }}MB. Strategy Selected: {{ active_memory_strategy | upper }}"

- name: Resolve Configuration Conflicts (Intelligent Resolution)
  ansible.builtin.set_fact:
    # Danger: ZRAM requires high swappiness to actually compress. If using database profile (swappiness=10),
    # ZRAM becomes useless unless we bump it up. However, if physical swap exists, 10 is fine.
    # Resolution: If ZRAM is sole swap, FORCE moderate swappiness (60) even for databases to prevent OOM.
    memory_swappiness: >-
      {{
        60 if (active_memory_strategy == 'zram' and physical_swap_count.stdout | int == 0 and memory_swappiness | int < 60)
        else memory_swappiness
      }}
    # Danger: THP 'always' kills Redis latency.
    memory_thp_state: >-
      {{
        'madvise' if (memory_workload_profile == 'database' and memory_thp_state == 'always')
        else memory_thp_state
      }}

- name: Validate Final Configuration
  ansible.builtin.debug:
    msg: >-
      Conflict Resolution Applied:
      Swappiness set to {{ memory_swappiness }} (Reason: {{ 'ZRAM-OOM-Protection' if active_memory_strategy == 'zram' and physical_swap_count.stdout|int == 0 else 'Profile-Default' }}).
      THP set to {{ memory_thp_state }} (Reason: {{ 'Database-Latency-Protection' if memory_workload_profile == 'database' else 'User-Configured' }}).

- name: Configure ZRAM (zram-generator)
  when: active_memory_strategy == 'zram'
  block:
    - name: Install zram-generator
      ansible.builtin.package:
        name: zram-generator
        state: present
      become: true

    - name: Configure zram-generator.conf
      ansible.builtin.copy:
        content: |
          [zram0]
          zram-size = {{ (ansible_memtotal_mb * (memory_zram_size_percent | float / 100)) | int }}
          compression-algorithm = {{ memory_zram_algorithm }}
          swap-priority = {{ memory_zram_priority }}
          fs-type = swap
        dest: /etc/systemd/zram-generator.conf
        mode: '0644'
      become: true
      notify: restart systemd-zram-setup

- name: Configure ZSwap (Kernel Modules)
  when: active_memory_strategy == 'zswap'
  block:
    - name: Enable ZSwap Kernel Parameters
      ansible.builtin.lineinfile:
        path: /etc/default/grub
        regexp: '^GRUB_CMDLINE_LINUX_DEFAULT='
        line: 'GRUB_CMDLINE_LINUX_DEFAULT="\1 zswap.enabled=1 zswap.compressor={{ memory_zswap_compressor }} zswap.max_pool_percent={{ memory_zswap_max_pool_percent }}"'
        backrefs: true
      become: true
      notify: update-grub

    - name: Disable ZRAM (Conflict Avoidance)
      ansible.builtin.systemd:
        name: systemd-zram-setup@zram0.service
        state: stopped
        enabled: false
      failed_when: false
      become: true

- name: Tune Virtual Memory for Compression
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: true
    sysctl_file: /etc/sysctl.d/99-memory-tuning.conf
  loop:
    - { key: 'vm.swappiness', value: '{{ memory_swappiness }}' }
    - { key: 'vm.vfs_cache_pressure', value: '{{ memory_cache_pressure }}' }
    - { key: 'vm.page-cluster', value: '0' } # Essential for ZRAM/ZSwap effectiveness
    - { key: 'vm.dirty_bytes', value: '{{ memory_dirty_bytes }}', condition: "{{ memory_dirty_bytes | int > 0 }}" }
    - { key: 'vm.dirty_background_bytes', value: '{{ memory_dirty_background_bytes }}', condition: "{{ memory_dirty_background_bytes | int > 0 }}" }
  when: active_memory_strategy != 'none' or memory_workload_profile == 'database'
  become: true

- name: Configure Transparent Huge Pages (THP)
  ansible.builtin.shell: |
    echo {{ memory_thp_state }} > /sys/kernel/mm/transparent_hugepage/enabled
    echo {{ memory_thp_state }} > /sys/kernel/mm/transparent_hugepage/defrag
  changed_when: false
  become: true
  when: memory_workload_profile != 'standard'
