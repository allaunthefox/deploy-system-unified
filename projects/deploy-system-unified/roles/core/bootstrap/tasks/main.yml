---
# Core bootstrap role - System initialization and base configuration
- name: Gather system facts
  ansible.builtin.setup:
    gather_subset:
      - '!all'
      - '!min'
      - distribution
      - os_family
      - pkg_mgr
- name: Set distribution-specific variables
  ansible.builtin.set_fact:
    core_pkg_manager: "{{ ansible_facts['pkg_mgr'] }}"
    core_os_family: "{{ ansible_facts['os_family'] }}"
    core_distribution: "{{ ansible_facts['distribution'] | lower }}"

- name: Construct Base Package List
  ansible.builtin.set_fact:
    _bootstrap_packages: "{{ system_base_packages.common + (system_base_packages[core_os_family] | default([])) }}"

- name: Ensure base packages are installed (Debian/Ubuntu)
  ansible.builtin.apt:
    name: "{{ _bootstrap_packages }}"
    state: present
    update_cache: true
  when: core_os_family == 'Debian'
  become: true

- name: Ensure base packages are installed (RedHat/CentOS)
  ansible.builtin.dnf:
    name: "{{ _bootstrap_packages }}"
    state: present
  when: core_os_family == 'RedHat'
  become: true

- name: Ensure base packages are installed (Arch)
  community.general.pacman:
    name: "{{ _bootstrap_packages }}"
    state: present
  when: core_distribution == 'archlinux'
  become: true

- name: Ensure base packages are installed (Alpine)
  community.general.apk:
    name: "{{ _bootstrap_packages }}"
    state: present
  when: core_os_family == 'Alpine'
  become: true
- name: Create standard system directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop: "{{ system_standard_directories }}"
  become: true
- name: Detect Virtualization Environment
  ansible.builtin.set_fact:
    virt_type: "{{ ansible_virtualization_type | default('bare-metal') | lower }}"
    is_virtualized: "{{ true if (ansible_virtualization_role | default('host') == 'guest') else false }}"
- name: Report Virtualization Profile
  ansible.builtin.debug:
    msg: "Environment detected as {{ virt_type | upper }} (Guest: {{ is_virtualized }})."
- name: Generate high-entropy Deployment ID (Forensic Primary Key)
  ansible.builtin.set_fact:
    deployment_id: "{{ ansible_date_time.iso8601_micro | hash('sha256') | truncate(16, True, '') }}"
- name: Set bootstrap completion flag
  ansible.builtin.set_fact:
    core_bootstrap_complete: true
