---
# Tasks for core/time role
- name: Install time synchronization service (idempotent)
  ansible.builtin.package:
    name: "{{ time_service_mapping[ansible_distribution | lower].package }}"
    state: present
  become: true
  when: ansible_distribution | lower in time_service_mapping.keys()
- name: Configure secure time synchronization (idempotent)
  ansible.builtin.template:
    src: chrony.conf.j2
    dest: "{{ time_service_mapping[ansible_distribution | lower].conf_dir }}/chrony.conf"
    mode: '0644'
    owner: root
    group: root
  become: true
  notify: restart chrony
  when:
    - ansible_distribution | lower in time_service_mapping.keys()
    - virt_type != "container" # Containers typically share host clock
- name: Enable and start time synchronization service (idempotent)
  ansible.builtin.service:
    name: "{{ time_service_mapping[ansible_distribution | lower].service }}"
    enabled: true
    state: started
  become: true
  when:
    - ansible_distribution | lower in time_service_mapping.keys()
    - virt_type != "container"
- name: Verify time synchronization is working (idempotent)
  ansible.builtin.command: chronyc tracking
  register: time_sync_status
  changed_when: false
  become: true
  ignore_errors: true
- name: Validate time synchronization quality (idempotent)
  ansible.builtin.assert:
    that:
      - "'System time' in time_sync_status.stdout"
    fail_msg: "Time synchronization not properly configured - checkpoint functionality may be unreliable"
  when: not time_sync_status.failed
