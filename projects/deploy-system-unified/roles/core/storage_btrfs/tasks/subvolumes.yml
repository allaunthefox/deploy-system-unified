---
# Btrfs subvolume management
- name: Check if path is on a Btrfs filesystem
  ansible.builtin.shell: |
    stat -f -c %T "{{ item.path | dirname }}"
  register: fs_type_check
  loop: "{{ btrfs_subvolumes | default([]) }}"
  changed_when: false
  failed_when: false
- name: Create Btrfs subvolumes
  ansible.builtin.command:
    cmd: "btrfs subvolume create {{ item.item.path }}"
  loop: "{{ fs_type_check.results }}"
  when:
    - item.stdout == "btrfs"
    - item.item.path is not directory
  become: true
