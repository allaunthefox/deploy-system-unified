---
# Tasks for core/logging role - Mandatory Forensic Readiness
- name: Ensure journald directory exists for persistence
  ansible.builtin.file:
    path: /var/log/journal
    state: directory
    mode: '0755'
    owner: root
    group: "{{ 'systemd-journal' if ansible_facts['service_mgr'] == 'systemd' else 'root' }}"
  become: true
- name: Configure journald for forensic integrity and rate limiting
  ansible.builtin.lineinfile:
    path: /etc/systemd/journald.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^#?Storage=', line: 'Storage=persistent' }
    - { regexp: '^#?Compress=', line: 'Compress=yes' }
    - { regexp: '^#?Seal=', line: 'Seal=yes' }
    - { regexp: '^#?ForwardToSyslog=', line: 'ForwardToSyslog=yes' }
    - { regexp: '^#?RateLimitIntervalSec=', line: 'RateLimitIntervalSec=30s' }
    - { regexp: '^#?RateLimitBurst=', line: 'RateLimitBurst=1000' }
    - { regexp: '^#?MaxFileSec=', line: 'MaxFileSec=1day' }
    - { regexp: '^#?MaxRetentionSec=', line: 'MaxRetentionSec=30day' }
  become: true
  notify: restart journald
  when: ansible_facts['service_mgr'] == 'systemd'
- name: Install systemd-journal-remote for log aggregation readiness
  ansible.builtin.package:
    name: systemd-journal-remote
    state: present
  become: true
  ignore_errors: true # Some minimal distros might not have this package
  when: ansible_facts['service_mgr'] == 'systemd'
- name: Ensure rsyslog configuration directory exists (Debian/Ubuntu)
  ansible.builtin.file:
    path: /etc/rsyslog.d
    state: directory
    mode: '0755'
  become: true
  when: ansible_facts['os_family'] == 'Debian'
- name: Configure rsyslog for centralized log shipping (Debian/Ubuntu)
  ansible.builtin.copy:
    dest: /etc/rsyslog.d/50-centralized-logging.conf
    content: |
      # Centralized logging configuration
      *.* @@{{ logging_central_server | default('logs.example.com') }}:514
    mode: '0644'
  become: true
  when: ansible_facts['os_family'] == 'Debian'
  notify: restart rsyslog
- name: Ensure rsyslog configuration directory exists (RedHat/CentOS)
  ansible.builtin.file:
    path: /etc/rsyslog.d
    state: directory
    mode: '0755'
  become: true
  when: ansible_facts['os_family'] == 'RedHat'
- name: Configure rsyslog for centralized log shipping (RedHat/CentOS)
  ansible.builtin.copy:
    dest: /etc/rsyslog.d/50-centralized-logging.conf
    content: |
      # Centralized logging configuration
      *.* @@{{ logging_central_server | default('logs.example.com') }}:514
    mode: '0644'
  become: true
  when: ansible_facts['os_family'] == 'RedHat'
  notify: restart rsyslog
- name: Ensure rsyslog is running and enabled (Debian/Ubuntu)
  ansible.builtin.systemd:
    name: rsyslog
    state: started
    enabled: true
  become: true
  when: ansible_facts['os_family'] == 'Debian' and ansible_facts['service_mgr'] == 'systemd'
  failed_when: false
- name: Ensure rsyslog is running and enabled (RedHat/CentOS)
  ansible.builtin.systemd:
    name: rsyslog
    state: started
    enabled: true
  become: true
  when: ansible_facts['os_family'] == 'RedHat' and ansible_facts['service_mgr'] == 'systemd'
  failed_when: false
- name: Create logrotate configuration for application logs
  ansible.builtin.copy:
    dest: /etc/logrotate.d/applications
    content: |
      /var/log/*.log /var/log/*/*.log {
          daily
          missingok
          rotate 30
          compress
          delaycompress
          notifempty
          create 644 root root
          postrotate
              /bin/systemctl reload rsyslog > /dev/null 2>&1 || true
          endscript
      }
    mode: '0644'
  become: true
- name: Validate journald configuration
  ansible.builtin.command:
    cmd: journalctl --verify
  register: journal_verify
  changed_when: false
  failed_when: false
  become: true
- name: Warn about journald verification issues
  ansible.builtin.debug:
    msg: "WARNING: Journald verification found issues: {{ journal_verify.stderr }}"
  when: journal_verify.rc != 0 and journal_verify.stderr | length > 0
