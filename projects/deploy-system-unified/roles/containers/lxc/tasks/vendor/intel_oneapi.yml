---
- name: Configure LXC container for Intel OneAPI
  block:
    - name: Install Intel OneAPI toolkit
      ansible.builtin.command:
        cmd: "bash -c 'curl -L https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB | apt-key add - && echo \"deb https://apt.repos.intel.com/oneapi all main\" > /etc/apt/sources.list.d/oneAPI.list && apt-get update && apt-get install -y intel-oneapi-{{ lxc_gpu_slicing.oneapi.toolkit }}'"
      register: intel_oneapi_install
      changed_when: true
      failed_when: false
      become: true
      when: ansible_facts['os_family'] == 'Debian'
    - name: Set Intel OneAPI environment variables
      ansible.builtin.lineinfile:
        path: /etc/profile.d/intel-oneapi.sh
        line: "{{ item }}"
        create: true
        mode: '0755'
      loop:
        - 'source /opt/intel/oneapi/setvars.sh'
      become: true
    - name: Create LXC OneAPI configuration template
      ansible.builtin.template:
        src: lxc-gpu-config.j2
        dest: /etc/lxc/default.conf.d/oneapi.conf
        mode: '0644'
      become: true
  when:
    - lxc_enable_gpu_support
    - lxc_gpu_slicing_strategy == "oneapi"
    - lxc_gpu_vendor == "intel"
