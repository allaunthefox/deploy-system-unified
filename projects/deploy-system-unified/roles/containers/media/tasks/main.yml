---
# Tasks for containers/media

- name: Pull Media Images
  ansible.builtin.include_tasks: pull_images.yml

- name: Create Media Network Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/{{ media_network }}.network"
    content: |
      [Network]
      NetworkName={{ media_network }}
      Driver=bridge
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  notify: reload systemd

- name: Create Media Directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ media_puid }}"
    group: "{{ media_pgid }}"
  loop:
    - "{{ media_root_dir }}"
    - "{{ media_root_dir}}/movies"
    - "{{ media_root_dir}}/tv"
    - "{{ media_root_dir}}/music"
    - "{{ media_root_dir}}/books"
    - "{{ media_root_dir}}/downloads"
    - "{{ media_config_dir }}"
    - "{{ media_config_dir }}/jellyfin"
    - "{{ media_config_dir }}/plex"
    - "{{ media_config_dir }}/radarr"
    - "{{ media_config_dir }}/sonarr"
    - "{{ media_config_dir }}/lidarr"
    - "{{ media_config_dir }}/readarr"
    - "{{ media_config_dir }}/prowlarr"
    - "{{ media_config_dir }}/jellyseerr"
    - "{{ media_config_dir }}/navidrome"
    - "{{ media_config_dir }}/transmission"
    - "{{ media_config_dir }}/bazarr"
    - "{{ media_config_dir }}/kavita"
    - "{{ media_config_dir }}/audiobookshelf"
  become: true

- name: Create Media Pod Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/{{ media_pod_name }}.pod"
    content: |
      [Pod]
      PodName={{ media_pod_name }}

      {% if podman_rootless_enabled | bool %}
      # Rootless networking uses user-defined networks + published ports
      Network={{ media_pod_network }}.network

      {% if not media_gatekeeper_mode %}
      PublishPort={{ jellyfin_port_http }}:8096
      PublishPort={{ plex_port_http }}:32400
      PublishPort={{ radarr_port }}:7878
      PublishPort={{ sonarr_port }}:8989
      PublishPort={{ lidarr_port }}:8686
      PublishPort={{ readarr_port }}:8787
      PublishPort={{ prowlarr_port }}:9696
      PublishPort={{ jellyseerr_port }}:5055
      PublishPort={{ navidrome_port }}:4533
      PublishPort={{ transmission_port_web }}:9091
      PublishPort={{ bazarr_port }}:6767
      PublishPort={{ kavita_port }}:5000
      PublishPort={{ audiobookshelf_port }}:13378
      {% endif %}

      # BitTorrent Peer Ports (Must be Public/Ingress)
      # Apply port offset for multi-tenancy support
      PublishPort={{ transmission_port_peer | int + media_port_offset | int }}:51413
      PublishPort={{ transmission_port_peer | int + media_port_offset | int }}:51413/udp
      {% else %}
      # Networking - Host Mode for VPS compatibility
      Network=host

      # Published Ports are implicit in Network=host mode and invalid to specify explicitly
      # {% if not media_gatekeeper_mode %}
      # PublishPort={{ jellyfin_port_http }}:8096
      # PublishPort={{ plex_port_http }}:32400
      # PublishPort={{ radarr_port }}:7878
      # PublishPort={{ sonarr_port }}:8989
      # PublishPort={{ lidarr_port }}:8686
      # PublishPort={{ readarr_port }}:8787
      # PublishPort={{ prowlarr_port }}:9696
      # PublishPort={{ jellyseerr_port }}:5055
      # PublishPort={{ navidrome_port }}:4533
      # PublishPort={{ transmission_port_web }}:9091
      # PublishPort={{ bazarr_port }}:6767
      # PublishPort={{ kavita_port }}:5000
      # PublishPort={{ audiobookshelf_port }}:13378
      # {% endif %}

      # BitTorrent Peer Ports (Must be Public/Ingress)
      # Apply port offset for multi-tenancy support
      # PublishPort={{ transmission_port_peer | int + media_port_offset | int }}:51413
      # PublishPort={{ transmission_port_peer | int + media_port_offset | int }}:51413/udp
      {% endif %}

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: media_pod_enable
  notify: reload systemd

- name: Deploy Media Caddy Configuration
  ansible.builtin.copy:
    dest: "/srv/containers/caddy/conf.d/media_stack_{{ media_instance_name }}.caddy"
    content: |
      # Media Stack Reverse Proxy Configuration
      # Instance: {{ media_instance_name }}
      # Assumes Caddy and Media Pod share the same network (deploy-net)
      # and can resolve container names.

      # Jellyfin
      jellyfin.{{ media_domain }} {
        {% if media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        reverse_proxy jellyfin-{{ media_instance_name }}:8096
      }

      # Radarr
      radarr.{{ media_domain }} {
        {% if media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        reverse_proxy radarr-{{ media_instance_name }}:7878
      }

      # Sonarr
      sonarr.{{ media_domain }} {
        {% if media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        reverse_proxy sonarr-{{ media_instance_name }}:8989
      }

      # Lidarr
      lidarr.{{ media_domain }} {
        {% if media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        reverse_proxy lidarr-{{ media_instance_name }}:8686
      }

      # Readarr
      readarr.{{ media_domain }} {
        {% if media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        reverse_proxy readarr-{{ media_instance_name }}:8787
      }

      # Prowlarr
      prowlarr.{{ media_domain }} {
        {% if media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        reverse_proxy prowlarr-{{ media_instance_name }}:9696
      }

      # Jellyseerr
      jellyseerr.{{ media_domain }} {
        {% if media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        reverse_proxy jellyseerr-{{ media_instance_name }}:5055
      }

      # Navidrome
      navidrome.{{ media_domain }} {
        {% if media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        reverse_proxy navidrome-{{ media_instance_name }}:4533
      }

      # Plex
      # Plex typically handles its own auth and remote access, but we can proxy it.
      plex.{{ media_domain }} {
        reverse_proxy plex-{{ media_instance_name }}:32400
      }

      # Transmission
      transmission.{{ media_domain }} {
        {% if media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        reverse_proxy transmission-{{ media_instance_name }}:9091
      }

      # Bazarr
      bazarr.{{ media_domain }} {
        {% if media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        reverse_proxy bazarr-{{ media_instance_name }}:6767
      }

      # Kavita
      kavita.{{ media_domain }} {
        {% if media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        reverse_proxy kavita-{{ media_instance_name }}:5000
      }

      # Audiobookshelf
      audiobookshelf.{{ media_domain }} {
        {% if media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        reverse_proxy audiobookshelf-{{ media_instance_name }}:13378
      }
    mode: '0644'
  become: true
  when: media_gatekeeper_mode
  notify: restart caddy

- name: Create Jellyfin Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/jellyfin-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Jellyfin Media Server ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ jellyfin_image }}
      ContainerName=jellyfin-{{ media_instance_name }}

      # Hardware Acceleration
      {% if media_hw_accel %}
      AddDevice=/dev/dri
      {% endif %}

      # Resource Limits
      MemoryMax={{ jellyfin_memory_max }}

      # Volumes
      Volume={{ media_config_dir }}/jellyfin:/config:Z
      Volume={{ media_root_dir }}:/data:Z

      # Environment
      Environment=TZ={{ media_timezone }}

      [Service]
      Restart=always
      TimeoutStartSec=300

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: jellyfin_enable
  notify: reload systemd

- name: Create Radarr Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/radarr-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Radarr Movie Manager ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ radarr_image }}
      ContainerName=radarr-{{ media_instance_name }}

      Volume={{ media_config_dir }}/radarr:/config:Z
      Volume={{ media_root_dir }}:/data:Z

      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}
      Environment=TZ={{ media_timezone }}

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: radarr_enable
  notify: reload systemd

- name: Create Sonarr Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/sonarr-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Sonarr TV Series Manager ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ sonarr_image }}
      ContainerName=sonarr-{{ media_instance_name }}

      Volume={{ media_config_dir }}/sonarr:/config:Z
      Volume={{ media_root_dir }}:/data:Z

      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}
      Environment=TZ={{ media_timezone }}

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: sonarr_enable
  notify: reload systemd

- name: Create Prowlarr Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/prowlarr-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Prowlarr Indexer Manager ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ prowlarr_image }}
      ContainerName=prowlarr-{{ media_instance_name }}

      Volume={{ media_config_dir }}/prowlarr:/config:Z

      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}
      Environment=TZ={{ media_timezone }}

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: prowlarr_enable
  notify: reload systemd

- name: Enforce CHANGE_ME policy for media stack
  ansible.builtin.include_tasks: "{{ role_path }}/../tasks/policy_change_me.yml"
  vars:
    change_me_policy_items:
      - name: "transmission_user"
        value: "{{ transmission_user | default('admin') }}"
        bad_values: ["admin", "CHANGE_ME_IN_VAULT", "CHANGE_ME_IN_SOPS", ""]
      - name: "transmission_pass"
        value: "{{ transmission_pass | default('admin') }}"
        bad_values: ["admin", "CHANGE_ME_IN_VAULT", "CHANGE_ME_IN_SOPS", ""]
  when: transmission_enable

- name: Create Transmission Secrets File
  ansible.builtin.copy:
    dest: "{{ containers_secrets_dir }}/transmission-{{ media_instance_name }}.env"
    content: |
      USER={{ transmission_user }}
      PASS={{ transmission_pass }}
    mode: '0600'
    owner: "{{ containers_secrets_owner }}"
    group: "{{ containers_secrets_group }}"
  become: true
  when: transmission_enable
  notify: reload systemd

- name: Create Transmission Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/transmission-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Transmission Download Client ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ transmission_image }}
      ContainerName=transmission-{{ media_instance_name }}

      Volume={{ media_config_dir }}/transmission:/config:Z
      Volume={{ media_root_dir }}/downloads:/downloads:Z

      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}
      Environment=TZ={{ media_timezone }}

      # Secure Secrets Injection
      EnvironmentFile={{ containers_secrets_dir }}/transmission-{{ media_instance_name }}.env

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_secrets_owner }}"
    group: "{{ containers_secrets_group }}"
  become: true
  when: transmission_enable
  notify: reload systemd

- name: Create Lidarr Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/lidarr-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Lidarr Music Manager ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ lidarr_image }}
      ContainerName=lidarr-{{ media_instance_name }}

      Volume={{ media_config_dir }}/lidarr:/config:Z
      Volume={{ media_root_dir }}:/data:Z

      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}
      Environment=TZ={{ media_timezone }}

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: lidarr_enable
  notify: reload systemd

- name: Create Readarr Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/readarr-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Readarr Book Manager ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ readarr_image }}
      ContainerName=readarr-{{ media_instance_name }}

      Volume={{ media_config_dir }}/readarr:/config:Z
      Volume={{ media_root_dir }}:/data:Z

      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}
      Environment=TZ={{ media_timezone }}

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: readarr_enable
  notify: reload systemd

- name: Create Jellyseerr Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/jellyseerr-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Jellyseerr Media Requests ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ jellyseerr_image }}
      ContainerName=jellyseerr-{{ media_instance_name }}

      Volume={{ media_config_dir }}/jellyseerr:/app/config:Z

      Environment=LOG_LEVEL=info
      Environment=TZ={{ media_timezone }}

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: jellyseerr_enable
  notify: reload systemd

- name: Create Navidrome Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/navidrome-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Navidrome Music Server ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ navidrome_image }}
      ContainerName=navidrome-{{ media_instance_name }}

      Volume={{ media_config_dir }}/navidrome:/data:Z
      Volume={{ media_root_dir }}/music:/music:ro,Z

      Environment=ND_SCANSCHEDULE=1h
      Environment=ND_LOGLEVEL=info
      Environment=ND_SESSIONTIMEOUT=24h
      Environment=ND_BASEURL=

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: navidrome_enable
  notify: reload systemd

- name: Create Plex Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/plex-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Plex Media Server ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ plex_image }}
      ContainerName=plex-{{ media_instance_name }}

      # Hardware Acceleration
      {% if media_hw_accel %}
      AddDevice=/dev/dri
      {% endif %}

      Volume={{ media_config_dir }}/plex:/config:Z
      Volume={{ media_root_dir }}:/data:Z

      Environment=TZ={{ media_timezone }}
      Environment=PLEX_CLAIM={{ plex_claim_token }}
      Environment=PLEX_UID={{ media_puid }}
      Environment=PLEX_GID={{ media_pgid }}

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: plex_enable
  notify: reload systemd

- name: Create Bazarr Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/bazarr-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Bazarr Subtitle Manager ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ bazarr_image }}
      ContainerName=bazarr-{{ media_instance_name }}

      Volume={{ media_config_dir }}/bazarr:/config:Z
      Volume={{ media_root_dir }}:/data:Z

      Environment=TZ={{ media_timezone }}
      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: bazarr_enable | default(false)
  notify: reload systemd

- name: Create Kavita Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/kavita-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Kavita Manga Server ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ kavita_image }}
      ContainerName=kavita-{{ media_instance_name }}

      Volume={{ media_config_dir }}/kavita:/kavita/config:Z
      Volume={{ media_root_dir }}:/data:Z

      Environment=TZ={{ media_timezone }}

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: kavita_enable | default(false)
  notify: reload systemd

- name: Create Audiobookshelf Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/audiobookshelf-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Audiobookshelf Server ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ audiobookshelf_image }}
      ContainerName=audiobookshelf-{{ media_instance_name }}

      Volume={{ media_config_dir }}/audiobookshelf:/config:Z
      Volume={{ media_root_dir }}/audiobooks:/audiobooks:Z
      Volume={{ media_root_dir }}/podcasts:/podcasts:Z

      Environment=TZ={{ media_timezone }}

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: audiobookshelf_enable | default(false)
  notify: reload systemd
