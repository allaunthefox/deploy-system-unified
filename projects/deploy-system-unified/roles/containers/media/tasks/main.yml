---
# Tasks for containers/media

- name: Create Media Directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ media_puid }}"
    group: "{{ media_pgid }}"
  loop:
    - "{{ media_root_dir }}"
    - "{{ media_root_dir}}/movies"
    - "{{ media_root_dir}}/tv"
    - "{{ media_root_dir}}/downloads"
    - "{{ media_config_dir }}"
    - "{{ media_config_dir }}/jellyfin"
    - "{{ media_config_dir }}/radarr"
    - "{{ media_config_dir }}/sonarr"
    - "{{ media_config_dir }}/prowlarr"
    - "{{ media_config_dir }}/transmission"
  become: true

- name: Create Media Pod Quadlet
  ansible.builtin.copy:
    dest: /etc/containers/systemd/{{ media_pod_name }}.pod
    content: |
      [Pod]
      PodName={{ media_pod_name }}
      
      # Networking - Use Shared Bridge for Caddy Communication
      Network={{ media_pod_network | default('deploy-net') }}.network
      
      # Only publish ports if Gatekeeper is OFF (Direct Access)
      # If Gatekeeper is ON, we rely on internal DNS (e.g., localhost or pod IP) inside the bridge.
      # However, since Caddy is in a separate container/pod, we must ensure they can talk.
      # If they are on the same bridge (deploy-net), Caddy can reach "media_pod" or specific container IPs.
      
      {% if not media_gatekeeper_mode %}
      PublishPort={{ jellyfin_port_http }}:8096
      PublishPort={{ radarr_port }}:7878
      PublishPort={{ sonarr_port }}:8989
      PublishPort={{ prowlarr_port }}:9696
      PublishPort={{ transmission_port_web }}:9091
      {% endif %}

      # BitTorrent Peer Ports (Must be Public/Ingress)
      PublishPort={{ transmission_port_peer }}:51413
      PublishPort={{ transmission_port_peer }}:51413/udp
      
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
  become: true
  when: media_pod_enable
  notify: reload systemd

- name: Deploy Media Caddy Configuration
  ansible.builtin.copy:
    dest: /srv/containers/caddy/conf.d/media_stack.caddy
    content: |
      # Media Stack Reverse Proxy Configuration
      # Assumes Caddy and Media Pod share the same network (deploy-net)
      # and can resolve container names.
      
      # Jellyfin
      jellyfin.{{ media_domain }} {
        reverse_proxy jellyfin:8096
      }

      # Radarr
      radarr.{{ media_domain }} {
        reverse_proxy radarr:7878
      }

      # Sonarr
      sonarr.{{ media_domain }} {
        reverse_proxy sonarr:8989
      }

      # Prowlarr
      prowlarr.{{ media_domain }} {
        reverse_proxy prowlarr:9696
      }

      # Transmission
      transmission.{{ media_domain }} {
        reverse_proxy transmission:9091
      }
    mode: '0644'
  become: true
  when: media_gatekeeper_mode
  notify: reload systemd

- name: Create Jellyfin Container Quadlet
  ansible.builtin.copy:
    dest: /etc/containers/systemd/jellyfin.container
    content: |
      [Unit]
      Description=Jellyfin Media Server
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ jellyfin_image }}
      ContainerName=jellyfin
      
      # Resource Limits
      MemoryMax={{ jellyfin_memory_max }}
      
      # Volumes
      Volume={{ media_config_dir }}/jellyfin:/config:Z
      Volume={{ media_root_dir }}:/data:Z
      
      # Environment
      Environment=TZ={{ media_timezone }}
      
      [Service]
      Restart=always
      TimeoutStartSec=300

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
  become: true
  when: jellyfin_enable
  notify: reload systemd

- name: Create Radarr Container Quadlet
  ansible.builtin.copy:
    dest: /etc/containers/systemd/radarr.container
    content: |
      [Unit]
      Description=Radarr Movie Manager
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ radarr_image }}
      ContainerName=radarr
      
      Volume={{ media_config_dir }}/radarr:/config:Z
      Volume={{ media_root_dir }}:/data:Z
      
      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}
      Environment=TZ={{ media_timezone }}
      
      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
  become: true
  when: radarr_enable
  notify: reload systemd

- name: Create Sonarr Container Quadlet
  ansible.builtin.copy:
    dest: /etc/containers/systemd/sonarr.container
    content: |
      [Unit]
      Description=Sonarr TV Series Manager
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ sonarr_image }}
      ContainerName=sonarr
      
      Volume={{ media_config_dir }}/sonarr:/config:Z
      Volume={{ media_root_dir }}:/data:Z
      
      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}
      Environment=TZ={{ media_timezone }}
      
      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
  become: true
  when: sonarr_enable
  notify: reload systemd

- name: Create Prowlarr Container Quadlet
  ansible.builtin.copy:
    dest: /etc/containers/systemd/prowlarr.container
    content: |
      [Unit]
      Description=Prowlarr Indexer Manager
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ prowlarr_image }}
      ContainerName=prowlarr
      
      Volume={{ media_config_dir }}/prowlarr:/config:Z
      
      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}
      Environment=TZ={{ media_timezone }}
      
      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
  become: true
  when: prowlarr_enable
  notify: reload systemd

- name: Create Transmission Container Quadlet
  ansible.builtin.copy:
    dest: /etc/containers/systemd/transmission.container
    content: |
      [Unit]
      Description=Transmission Download Client
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod

      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ transmission_image }}
      ContainerName=transmission
      
      Volume={{ media_config_dir }}/transmission:/config:Z
      Volume={{ media_root_dir }}/downloads:/downloads:Z
      
      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}
      Environment=TZ={{ media_timezone }}
      Environment=USER=admin
      Environment=PASS=admin
      
      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
  become: true
  when: transmission_enable
  notify: reload systemd
