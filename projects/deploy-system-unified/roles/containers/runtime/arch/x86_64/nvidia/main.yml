---
- name: Install GPU drivers and container toolkit (NVIDIA/x86_64)
  ansible.builtin.package:
    name: "{{ containers_gpu_profiles['nvidia']['driver_packages'][ansible_facts['os_family'] | lower] }}"
    state: present
  failed_when: false

- name: Configure NVIDIA container toolkit
  ansible.builtin.command:
    cmd: nvidia-ctk runtime configure --runtime=crun
  register: nvidia_config_result
  changed_when: false
  failed_when: false

- name: Configure container runtime for GPU support (NVIDIA)
  ansible.builtin.lineinfile:
    path: /etc/containers/containers.conf
    regexp: "^#?default_capabilities ="
    line: 'default_capabilities = ["CAP_CHOWN", "CAP_DAC_OVERRIDE", "CAP_FSETID", "CAP_FOWNER", "CAP_MKNOD", "CAP_NET_RAW", "CAP_SETGID", "CAP_SETUID", "CAP_SETFCAP", "CAP_SETPCAP", "CAP_NET_BIND_SERVICE", "CAP_SYS_CHROOT", "CAP_KILL", "CAP_AUDIT_WRITE", "gpu"]'
