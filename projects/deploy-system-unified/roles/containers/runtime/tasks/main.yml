---
# Tasks for containers/runtime role
- name: Install Podman on Debian/Ubuntu
  ansible.builtin.apt:
    name:
      - podman
      - slirp4netns
      - fuse-overlayfs
      - apparmor-utils
    state: present
    update_cache: true
  when: ansible_facts['os_family'] == 'Debian'
  become: true
- name: Install Podman on RedHat/CentOS
  ansible.builtin.dnf:
    name:
      - podman
      - slirp4netns
      - fuse-overlayfs
      - selinux-policy-targeted
    state: present
  when: ansible_facts['os_family'] == 'RedHat'
  become: true
- name: Install Podman on Arch
  community.general.pacman:
    name:
      - podman
      - slirp4netns
      - fuse-overlayfs
    state: present
  when: ansible_facts['distribution'] | lower == 'archlinux'
  become: true
- name: Configure container security settings
  ansible.builtin.copy:
    dest: /etc/containers/containers.conf
    content: |
      [containers]
      log_driver = "journald"
      log_size_max = 10485760
      pids_limit = 2048
      userns = "auto"
      signature_policy = "/etc/containers/policy.json"
      [network]
      network_backend = "netavark"
      [engine]
      runtime = "crun"
      cgroup_manager = "systemd"
      events_logger = "journald"
    mode: '0644'
  become: true
- name: Configure container signature policy
  ansible.builtin.copy:
    dest: /etc/containers/policy.json
    content: |
      {
        "default": [{
            "type": "reject"
          }],
        "transports": {
          "docker": {
            "docker.io/library": [{
                "type": "insecureAcceptAnything"
              }],
            "quay.io": [{
                "type": "insecureAcceptAnything"
              }],
            "ghcr.io": [{
                "type": "insecureAcceptAnything"
              }]
          },
          "docker-daemon": {
            "": [{
                "type": "insecureAcceptAnything"
              }]
          }
        }
      }
    mode: '0644'
  become: true
- name: Enable AppArmor for containers (Debian/Ubuntu)
  ansible.builtin.command:
    cmd: aa-enforce /etc/apparmor.d/containers/*
  register: apparmor_result
  changed_when: true
  failed_when: false
  become: true
  when: ansible_facts['os_family'] == 'Debian'
- name: Enable SELinux for containers (RedHat/CentOS)
  ansible.builtin.command:
    cmd: setsebool -P container_use_cephfs 1 container_use_nfs 1
  register: selinux_result
  changed_when: true
  failed_when: false
  become: true
  when: ansible_facts['os_family'] == 'RedHat'
- name: Create podman configuration directory
  ansible.builtin.file:
    path: /etc/containers
    state: directory
    mode: '0755'
  become: true
- name: Configure container registries
  ansible.builtin.copy:
    dest: /etc/containers/registries.conf
    content: |
      # Container registries configuration
      unqualified-search-registries = ["docker.io", "quay.io", "ghcr.io"]
      [[registry]]
      prefix = "docker.io"
      location = "docker.io"
      [[registry.mirror]]
      location = "mirror.gcr.io"
    mode: '0644'
  become: true
- name: Enable podman socket for rootless containers
  ansible.builtin.systemd:
    name: podman.socket
    enabled: true
    state: started
    scope: user
  become: false
  failed_when: false
- name: Install GPU drivers and container toolkit (NVIDIA)
  ansible.builtin.package:
    name: "{{ containers_gpu_profiles[containers_gpu_vendor]['driver_packages'][ansible_facts['os_family'] | lower] }}"
    state: present
  when: containers_enable_gpu_support and containers_gpu_vendor == "nvidia"
  become: true
  failed_when: false
- name: Install GPU drivers and container toolkit (AMD)
  ansible.builtin.package:
    name: "{{ containers_gpu_profiles[containers_gpu_vendor]['driver_packages'][ansible_facts['os_family'] | lower] }}"
    state: present
  when: containers_enable_gpu_support and containers_gpu_vendor == "amd"
  become: true
  failed_when: false
- name: Install GPU drivers and container toolkit (Intel)
  ansible.builtin.package:
    name: "{{ containers_gpu_profiles[containers_gpu_vendor]['driver_packages'][ansible_facts['os_family'] | lower] }}"
    state: present
  when: containers_enable_gpu_support and containers_gpu_vendor == "intel"
  become: true
  failed_when: false
- name: Configure NVIDIA container toolkit
  ansible.builtin.command:
    cmd: nvidia-ctk runtime configure --runtime=crun
  register: nvidia_config_result
  changed_when: true
  failed_when: false
  become: true
  when: containers_enable_gpu_support and containers_gpu_vendor == "nvidia"
- name: Configure container runtime for GPU support (NVIDIA)
  ansible.builtin.lineinfile:
    path: /etc/containers/containers.conf
    regexp: "^#?default_capabilities ="
    line: 'default_capabilities = ["CAP_CHOWN", "CAP_DAC_OVERRIDE", "CAP_FSETID", "CAP_FOWNER", "CAP_MKNOD", "CAP_NET_RAW", "CAP_SETGID", "CAP_SETUID", "CAP_SETFCAP", "CAP_SETPCAP", "CAP_NET_BIND_SERVICE", "CAP_SYS_CHROOT", "CAP_KILL", "CAP_AUDIT_WRITE", "gpu"]'
  become: true
  when: containers_enable_gpu_support and containers_gpu_vendor == "nvidia"
- name: Configure container runtime for GPU support (AMD/Intel)
  ansible.builtin.lineinfile:
    path: /etc/containers/containers.conf
    regexp: "^#?default_capabilities ="
    line: 'default_capabilities = ["CAP_CHOWN", "CAP_DAC_OVERRIDE", "CAP_FSETID", "CAP_FOWNER", "CAP_MKNOD", "CAP_NET_RAW", "CAP_SETGID", "CAP_SETUID", "CAP_SETFCAP", "CAP_SETPCAP", "CAP_NET_BIND_SERVICE", "CAP_SYS_CHROOT", "CAP_KILL", "CAP_AUDIT_WRITE", "gpu"]'
  become: true
  when: containers_enable_gpu_support and containers_gpu_vendor in ["amd", "intel"]
- name: Discover GPU devices and capabilities
  ansible.builtin.include_tasks: gpu_discovery.yml
  when: containers_enable_gpu_support
- name: Validate GPU slicing configuration
  ansible.builtin.include_tasks: gpu_validation.yml
  when: containers_enable_gpu_support
- name: Configure GPU slicing
  ansible.builtin.include_tasks: gpu_slicing.yml
  when: containers_enable_gpu_support
- name: Report GPU configuration status
  ansible.builtin.debug:
    msg: |
      {% if containers_enable_gpu_support %}
      GPU support enabled:
        Vendor: {{ containers_gpu_vendor_detected | upper }}
        Strategy: {{ containers_gpu_slicing_strategy | default('passthrough') }}
        Count: {{ containers_gpu_count_detected }}
        Device Info: {{ containers_gpu_device_info }}
      {% else %}
      GPU support disabled. Set containers_enable_gpu_support: true to enable.
      {% endif %}
- name: Set containers runtime completion flag
  ansible.builtin.set_fact:
    containers_runtime_complete: true
