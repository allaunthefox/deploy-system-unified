---
- hosts: instance
  connection: local
  gather_facts: false
  vars:
    containers_secrets_dir: "{{ playbook_dir }}/molecule_shared"
    containers_secrets_owner: "{{ lookup('env','USER') }}"
    authentik_enable: true
    authentik_secrets_fail_secure: true
  tasks:
    - name: Ensure molecule_shared exists
      ansible.builtin.file:
        path: "{{ containers_secrets_dir }}"
        state: directory
        mode: '0700'
    
    # Test Case 1: Missing authentik.env file (should fail)
    - name: Create missing authentik.env for test
      ansible.builtin.file:
        path: "{{ containers_secrets_dir }}/authentik.env"
        state: absent
      when: test_case == 'missing_file'
    
    # Test Case 2: Wrong permissions on authentik.env (should fail)
    - name: Create authentik.env with wrong permissions for test
      ansible.builtin.copy:
        dest: "{{ containers_secrets_dir }}/authentik.env"
        content: |
          AUTHENTIK_SECRET_KEY=real_secret_key_here
          AUTHENTIK_POSTGRESQL_PASSWORD=real_db_password
          AUTHENTIK_BOOTSTRAP_PASSWORD=real_bootstrap_password
        mode: '0644'  # Wrong permissions
        owner: "{{ containers_secrets_owner }}"
      when: test_case == 'wrong_permissions'
    
    # Test Case 3: Placeholder values in authentik.env (should fail)
    - name: Create authentik.env with placeholder values for test
      ansible.builtin.copy:
        dest: "{{ containers_secrets_dir }}/authentik.env"
        content: |
          AUTHENTIK_SECRET_KEY=CHANGE_ME_IN_VAULT_TO_HASH
          AUTHENTIK_POSTGRESQL_PASSWORD=CHANGE_ME_IN_VAULT_TO_HASH
          AUTHENTIK_BOOTSTRAP_PASSWORD=CHANGE_ME_IN_VAULT_TO_HASH
        mode: '0600'
        owner: "{{ containers_secrets_owner }}"
      when: test_case == 'placeholder_values'
    
    # Test Case 4: Wrong owner on authentik.env (should fail)
    - name: Create authentik.env with wrong owner for test
      ansible.builtin.copy:
        dest: "{{ containers_secrets_dir }}/authentik.env"
        content: |
          AUTHENTIK_SECRET_KEY=real_secret_key_here
          AUTHENTIK_POSTGRESQL_PASSWORD=real_db_password
          AUTHENTIK_BOOTSTRAP_PASSWORD=real_bootstrap_password
        mode: '0600'
        owner: "root"  # Wrong owner
      when: test_case == 'wrong_owner'
    
    # Test Case 5: Missing Redis password file (should fail)
    - name: Create missing redis.env for test
      ansible.builtin.file:
        path: "{{ containers_secrets_dir }}/redis.env"
        state: absent
      when: test_case == 'missing_redis_file'
    
    # Test Case 6: Empty authentik.env file (should fail)
    - name: Create empty authentik.env for test
      ansible.builtin.copy:
        dest: "{{ containers_secrets_dir }}/authentik.env"
        content: ""
        mode: '0600'
        owner: "{{ containers_secrets_owner }}"
      when: test_case == 'empty_file'
    
    - name: Run verify_secrets directly (expecting failure)
      ansible.builtin.include_tasks: "../../tasks/verify_secrets.yml"
      ignore_errors: true  # We expect this to fail in negative tests