---
- hosts: localhost
  connection: local
  gather_facts: false
  vars:
    molecule_runner_user: "{{ lookup('env','USER') }}"
  tasks:
    - name: Check podman access
      ansible.builtin.command: podman info
      register: podman_info
      ignore_errors: true

    - name: Add user to podman socket group if podman access denied
      ansible.builtin.user:
        name: "{{ molecule_runner_user }}"
        groups: podman
        append: true
      when: podman_info is failed
      become: true

    - name: Re-check podman access after group change
      ansible.builtin.command: podman info
      register: podman_info_after
      failed_when: podman_info_after.rc != 0
      ignore_errors: false

    - name: Fail with actionable message if podman access still fails
      ansible.builtin.fail:
        msg: |
          Podman access could not be established for user '{{ molecule_runner_user }}'.
          You may need to log out and log back in (or restart your session) after being
          added to the appropriate socket group, or run Molecule with elevated privileges (sudo).
          To add the user manually: sudo usermod -aG podman {{ molecule_runner_user }}
      when: podman_info_after.rc != 0
