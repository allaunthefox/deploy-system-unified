---
- hosts: localhost
  connection: local
  gather_facts: false
  vars:
    molecule_runner_user: "{{ lookup('env','USER') }}"
  tasks:
    - name: Check docker access
      ansible.builtin.command: docker info
      register: docker_info
      ignore_errors: true

    - name: Add user to docker group if docker access denied
      ansible.builtin.user:
        name: "{{ molecule_runner_user }}"
        groups: docker
        append: yes
      when: docker_info is failed
      become: true

    - name: Re-check docker access after group change
      ansible.builtin.command: docker info
      register: docker_info_after
      failed_when: docker_info_after.rc != 0
      ignore_errors: false

    - name: Fail with actionable message if docker access still fails
      ansible.builtin.fail:
        msg: |
          Docker access could not be established for user '{{ molecule_runner_user }}'.
          You may need to log out and log back in (or restart your session) after being
          added to the 'docker' group, or run Molecule with elevated privileges (sudo).
          To add the user manually: sudo usermod -aG docker {{ molecule_runner_user }}
      when: docker_info_after.rc != 0
