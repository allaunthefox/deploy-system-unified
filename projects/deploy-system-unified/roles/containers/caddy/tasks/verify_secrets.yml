---
# Verify Caddy secrets (caddy.env) and CrowdSec key when fail-secure is enabled
- name: Check Caddy secrets file exists
  ansible.builtin.stat:
    path: "{{ containers_secrets_dir }}/caddy.env"
  register: caddy_env
  changed_when: false
  failed_when: false
  when:
    - containers_caddy_fail_secure | default(true) | bool

- name: Assert Caddy secrets file exists and is secure
  ansible.builtin.assert:
    that:
      - caddy_env.stat.exists
      - caddy_env.stat.mode == '0600'
      - caddy_env.stat.pw_name == containers_secrets_owner
  fail_msg: "Caddy secrets file missing or insecure: {{ containers_secrets_dir }}/caddy.env. Create the file with mode 0600 and owner {{ containers_secrets_owner }} or set containers_caddy_fail_secure=false to bypass."
  when:
    - containers_caddy_fail_secure | default(true) | bool

- name: Assert CrowdSec firewall bouncer key is not default
  ansible.builtin.assert:
    that:
      - containers_crowdsec_firewall_bouncer_key | default('CHANGE_ME') != 'CHANGE_ME'
  fail_msg: "CrowdSec firewall bouncer key is default (CHANGE_ME). Set crowdsec_firewall_bouncer_key or set containers_caddy_fail_secure=false to bypass."
  when:
    - crowdsec_enable | default(false)
    - containers_caddy_fail_secure | default(true) | bool

- name: Check caddy.env does not contain placeholder token
  ansible.builtin.shell: |
    grep -E "CHANGE_ME_IN_VAULT|CHANGE_ME|CHANGE_ME_IN_SOPS" "{{ containers_secrets_dir }}/caddy.env" >/dev/null 2>&1 || true
  register: caddy_env_grep
  changed_when: false
  failed_when: false
  when:
    - containers_caddy_fail_secure | default(true) | bool

- name: Assert caddy.env does not contain placeholder token
  ansible.builtin.assert:
    that:
      - caddy_env_grep.rc == 1
  fail_msg: "Caddy secrets file contains placeholder values (CHANGE_ME). Replace with real secrets or set containers_caddy_fail_secure=false to bypass."
  when:
    - containers_caddy_fail_secure | default(true) | bool
