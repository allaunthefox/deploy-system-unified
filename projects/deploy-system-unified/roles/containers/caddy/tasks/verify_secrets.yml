---
# Verify secrets file integrity and security
# This task ensures that secrets files meet security requirements
# before containers are deployed

- name: Verify secrets directory exists
  ansible.builtin.stat:
    path: "{{ containers_secrets_dir }}"
  register: secrets_dir_stat

- name: Fail if secrets directory does not exist
  ansible.builtin.fail:
    msg: "Secrets directory {{ containers_secrets_dir }} does not exist"
  when: not secrets_dir_stat.stat.exists

- name: Check if caddy secrets file exists
  ansible.builtin.stat:
    path: "{{ containers_secrets_dir }}/caddy.env"
  register: caddy_secret_file_stat

- name: Fail if caddy secret file does not exist
  ansible.builtin.fail:
    msg: "Secret file caddy.env does not exist in {{ containers_secrets_dir }}"
  when: not caddy_secret_file_stat.stat.exists

- name: Verify caddy secret file permissions (should be 0600)
  ansible.builtin.fail:
    msg: "Secret file caddy.env has incorrect permissions: {{ caddy_secret_file_stat.stat.mode }}. Expected 0600"
  when: caddy_secret_file_stat.stat.mode != '0600'
  ignore_errors: true

- name: Verify caddy secret file owner
  ansible.builtin.fail:
    msg: "Secret file caddy.env is owned by {{ caddy_secret_file_stat.stat.pw_name }}. Expected {{ containers_secrets_owner }}"
  when: caddy_secret_file_stat.stat.pw_name != containers_secrets_owner
  ignore_errors: true

- name: Check for placeholder values in caddy secret file
  ansible.builtin.shell: |
    grep -q "CHANGE_ME_IN_VAULT_TO_HASH" "{{ containers_secrets_dir }}/caddy.env" && echo "placeholder_found" || echo "ok"
  register: placeholder_check
  ignore_errors: true

- name: Fail if placeholder values found in caddy secret file
  ansible.builtin.fail:
    msg: "Secret file caddy.env contains placeholder values. Please replace with actual secrets."
  when: placeholder_check.stdout == "placeholder_found"

- name: Check for placeholder values in Caddyfile (configuration placeholders)
  ansible.builtin.shell: |
    grep -q "CHANGE_ME_IN_VAULT_TO_EMAIL" "{{ containers_secrets_dir }}/Caddyfile" && echo "placeholder_found" || echo "ok"
  register: caddyfile_placeholder_check
  ignore_errors: true

- name: Fail if placeholder values found in Caddyfile
  ansible.builtin.fail:
    msg: "Caddyfile contains placeholder values. Please replace with actual values."
  when: caddyfile_placeholder_check.stdout == "placeholder_found"

- name: Verify caddy secret file content is not empty
  ansible.builtin.fail:
    msg: "Secret file caddy.env is empty"
  when: caddy_secret_file_stat.stat.size == 0

- name: Display success message for caddy secrets
  ansible.builtin.debug:
    msg: "Secret file caddy.env passed all security checks"
  when: caddy_secret_file_stat.stat.exists and caddy_secret_file_stat.stat.mode == '0600' and caddy_secret_file_stat.stat.pw_name == containers_secrets_owner
