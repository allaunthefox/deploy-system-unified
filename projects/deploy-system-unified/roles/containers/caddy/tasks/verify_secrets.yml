---
# Verify secrets file integrity and security
# This task ensures that secrets files meet security requirements
# before containers are deployed

- name: Verify secrets directory exists
  ansible.builtin.stat:
    path: "{{ containers_secrets_dir }}"
  register: secrets_dir_stat

- name: Initialize caddy secret validation errors
  ansible.builtin.set_fact:
    caddy_secret_violations: []

- name: Check if caddy secrets file exists
  ansible.builtin.stat:
    path: "{{ containers_secrets_dir }}/caddy.env"
  register: caddy_secret_file_stat

- name: Check if Caddyfile exists
  ansible.builtin.stat:
    path: "{{ containers_secrets_dir }}/Caddyfile"
  register: caddyfile_stat

- name: Record secrets directory missing
  ansible.builtin.set_fact:
    caddy_secret_violations: "{{ caddy_secret_violations + ['Secrets directory ' ~ containers_secrets_dir ~ ' does not exist'] }}"
  when: not secrets_dir_stat.stat.exists

- name: Record caddy secret file missing
  ansible.builtin.set_fact:
    caddy_secret_violations: "{{ caddy_secret_violations + ['Secret file caddy.env does not exist in ' ~ containers_secrets_dir] }}"
  when:
    - secrets_dir_stat.stat.exists
    - not caddy_secret_file_stat.stat.exists

- name: Record caddy secret file permission mismatch
  ansible.builtin.set_fact:
    caddy_secret_violations: "{{ caddy_secret_violations + ['Secret file caddy.env has incorrect permissions: ' ~ caddy_secret_file_stat.stat.mode ~ ' (expected 0600)'] }}"
  when:
    - caddy_secret_file_stat.stat.exists
    - caddy_secret_file_stat.stat.mode != '0600'

- name: Record caddy secret file owner mismatch
  ansible.builtin.set_fact:
    caddy_secret_violations: "{{ caddy_secret_violations + ['Secret file caddy.env is owned by ' ~ caddy_secret_file_stat.stat.pw_name ~ ' (expected ' ~ containers_secrets_owner ~ ')'] }}"
  when:
    - caddy_secret_file_stat.stat.exists
    - caddy_secret_file_stat.stat.pw_name != containers_secrets_owner

- name: Check for placeholder values in caddy secret file
  ansible.builtin.command:
    argv:
      - grep
      - -q
      - CHANGE_ME_IN_VAULT_TO_HASH
      - "{{ containers_secrets_dir }}/caddy.env"
  register: placeholder_check
  changed_when: false
  failed_when: false
  when: caddy_secret_file_stat.stat.exists

- name: Check for placeholder values in Caddyfile (configuration placeholders)
  ansible.builtin.command:
    argv:
      - grep
      - -q
      - CHANGE_ME_IN_VAULT_TO_EMAIL
      - "{{ containers_secrets_dir }}/Caddyfile"
  register: caddyfile_placeholder_check
  changed_when: false
  failed_when: false
  when: caddyfile_stat.stat.exists

- name: Record caddy secret placeholders
  ansible.builtin.set_fact:
    caddy_secret_violations: "{{ caddy_secret_violations + ['Secret file caddy.env contains placeholder values. Replace with actual secrets.'] }}"
  when:
    - placeholder_check is defined
      - (placeholder_check.rc | default(1)) == 0

- name: Record Caddyfile placeholders
  ansible.builtin.set_fact:
    caddy_secret_violations: "{{ caddy_secret_violations + ['Caddyfile contains placeholder values. Replace with actual values.'] }}"
  when:
    - caddyfile_placeholder_check is defined
      - (caddyfile_placeholder_check.rc | default(1)) == 0

- name: Record caddy secret file is empty
  ansible.builtin.set_fact:
    caddy_secret_violations: "{{ caddy_secret_violations + ['Secret file caddy.env is empty'] }}"
  when:
    - caddy_secret_file_stat.stat.exists
    - caddy_secret_file_stat.stat.size | int == 0

- name: Fail if caddy secret validation failed
  ansible.builtin.assert:
    that:
      - caddy_secret_violations | length == 0
    fail_msg: |-
      Caddy secret validation failed:
      - {{ caddy_secret_violations | join('\n- ') }}

- name: Display success message for caddy secrets
  ansible.builtin.debug:
    msg: "Secret file caddy.env passed all security checks"
  when: caddy_secret_violations | length == 0
