---
# Container Caddy role - Caddy reverse proxy configuration
- name: Create Caddy directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  loop:
    - /srv/containers/caddy
    - /srv/containers/caddy/config
    - /srv/containers/caddy/data
    - /srv/containers/caddy/logs
    - /srv/containers/caddy/conf.d
  become: true
- name: Create Caddyfile
  ansible.builtin.copy:
    dest: /srv/containers/caddy/Caddyfile
    content: |
      # Caddyfile - Managed by Deploy-System-Unified
      {
        admin off
        email {{ caddy_acme_email | default('admin@example.com') }}
        log {
          output file /var/log/caddy/access.log {
            roll_size 10mb
            roll_keep 5
            roll_keep_for 720h
          }
          format json
        }
      }
      
      # Import additional configurations
      import /etc/caddy/conf.d/*.caddy

      # Default catch-all
      :80 {
        respond "Hello from Deploy-System-Unified" 200
      }
    mode: '0644'
    owner: root
    group: root
  become: true
  when: caddy_generate_config | default(true)
- name: Create Caddy container quadlet
  ansible.builtin.copy:
    dest: /etc/containers/systemd/caddy.container
    content: |
      [Unit]
      Description=Caddy Reverse Proxy
      After=network-online.target
      Wants=network-online.target
      [Container]
      Image=docker.io/library/caddy:latest
      ContainerName=caddy
      PublishPort=80:80
      PublishPort=443:443
      PublishPort=443:443/udp
      Volume=/srv/containers/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      Volume=/srv/containers/caddy/data:/data:Z
      Volume=/srv/containers/caddy/config:/config:Z
      Volume=/srv/containers/caddy/logs:/var/log/caddy:Z
      Volume=/srv/containers/caddy/conf.d:/etc/caddy/conf.d:ro
      {% if quadlet_enable_gpu_support %}
      # GPU support configuration
      Capabilities={{ quadlet_gpu_capabilities | join(' ') }}
      {% for device in quadlet_gpu_devices | default(quadlet_gpu_default_configs[quadlet_gpu_vendor]['devices']) %}
      Device={{ device }}
      {% endfor %}
      {% for mount in quadlet_gpu_default_configs[quadlet_gpu_vendor]['mounts'] %}
      Volume={{ mount }}
      {% endfor %}
      {% endif %}
      [Service]
      Restart=always
      TimeoutStartSec=300
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
  become: true
  notify: reload systemd
- name: Enable HTTP/3 support in Caddyfile
  ansible.builtin.lineinfile:
    path: /srv/containers/caddy/Caddyfile
    regexp: '^        admin off'
    line: '        admin off\n        servers :443 {\n            protocols h1 h2 h3\n        }'
  become: true
  when: caddy_generate_config | default(true)
- name: Set containers caddy completion flag
  ansible.builtin.set_fact:
    containers_caddy_complete: true
