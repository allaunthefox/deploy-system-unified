---
# Container quadlets role - Systemd quadlet management

- name: Ensure checkpoint directory exists
  ansible.builtin.file:
    path: /var/lib/deploy-system/checkpoints
    state: directory
    mode: '0700'
  become: true

- name: Check for Quadlet checkpoint
  ansible.builtin.stat:
    path: /var/lib/deploy-system/checkpoints/quadlets_checkpoint.json
  register: quadlet_checkpoint_stat
  become: true

- name: Read existing checkpoint
  ansible.builtin.slurp:
    src: /var/lib/deploy-system/checkpoints/quadlets_checkpoint.json
  register: checkpoint_content
  when: quadlet_checkpoint_stat.stat.exists
  become: true

- name: Restore object UUID from checkpoint
  ansible.builtin.set_fact:
    object_uuid: "{{ (checkpoint_content.content | b64decode | from_json).uuid }}"
  when: quadlet_checkpoint_stat.stat.exists

- name: Generate new Network UUID (if no checkpoint)
  ansible.builtin.import_role:
    name: core/identity
  when: not quadlet_checkpoint_stat.stat.exists

- name: Ensure quadlet directory exists
  ansible.builtin.file:
    path: "{{ containers_systemd_dir }}"
    state: directory
    mode: '0755'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
- name: Create quadlet network configuration
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/{{ quadlet_network_name }}.network"
    content: |
      [Network]
      Label=org.deploy-system.uuid={{ object_uuid }}
      NetworkName={{ quadlet_network_name }}
      Driver=bridge
      Subnet={{ quadlet_network_subnet | default('10.89.0.0/24') }}
      Gateway={{ quadlet_network_gateway | default('10.89.0.1') }}
      IPRange={{ quadlet_network_iprange | default('10.89.0.0/24') }}
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: quadlet_create_network | default(true)
- name: Deploy custom quadlet files
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "{{ containers_systemd_dir }}/{{ item | basename }}"
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  loop: "{{ quadlet_custom_files | default([]) }}"
  become: true
  when: quadlet_custom_files is defined and quadlet_custom_files | length > 0
  notify: reload systemd
- name: Reload systemd to pick up quadlets
  ansible.builtin.systemd:
    daemon_reload: true
    scope: "{{ containers_systemd_scope }}"
  environment: "{{ containers_systemd_env }}"
  become: true
  become_user: "{{ containers_systemd_owner }}"
  when: ansible_facts['service_mgr'] == 'systemd'
  failed_when: false
- name: List generated quadlet services
  ansible.builtin.shell:
    cmd: >-
      {{ (podman_rootless_enabled | bool)
         | ternary('systemctl --user list-unit-files --type=service | grep -E \"\\\\.container|\\\\.pod\"',
                   'systemctl list-unit-files --type=service | grep -E \"\\\\.container|\\\\.pod\"') }}
  register: quadlet_services
  changed_when: false
  failed_when: false
  environment: "{{ containers_systemd_env }}"
  become: true
  become_user: "{{ containers_systemd_owner }}"
  when: ansible_facts['service_mgr'] == 'systemd'
- name: Display available quadlet services
  ansible.builtin.debug:
    msg: "Available quadlet services: {{ quadlet_services.stdout_lines | default([]) }}"
  when: ansible_facts['service_mgr'] == 'systemd'
- name: Set containers quadlets completion flag
  ansible.builtin.set_fact:
    containers_quadlets_complete: true

- name: Save Quadlet checkpoint
  ansible.builtin.copy:
    dest: /var/lib/deploy-system/checkpoints/quadlets_checkpoint.json
    content: |
      {
        "uuid": "{{ object_uuid }}",
        "last_updated": "{{ ansible_date_time.iso8601 }}",
        "role": "containers/quadlets",
        "deployment_variables": {
          "network_name": "{{ quadlet_network_name }}",
          "subnet": "{{ quadlet_network_subnet | default('10.89.0.0/24') }}"
        }
      }
    mode: '0600'
  changed_when: false
  become: true
