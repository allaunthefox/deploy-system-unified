---
# Container configuration role - General container configuration
- name: Create container storage directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  loop:
    - /srv/containers
    - /srv/containers/volumes
    - /srv/containers/configs
    - /var/lib/containers
  become: true
- name: Configure container storage
  ansible.builtin.copy:
    dest: /etc/containers/storage.conf
    content: |
      [storage]
      driver = "overlay"
      runroot = "/run/containers/storage"
      graphroot = "/var/lib/containers/storage"
      [storage.options]
      additionalimagestores = []
      size = ""
      [storage.options.overlay]
      mountopt = "nodev,metacopy=on"
    mode: '0644'
  become: true
- name: Configure container networking
  ansible.builtin.copy:
    dest: /etc/containers/containers.conf
    content: |
      [containers]
      log_driver = "journald"
      log_size_max = 10485760
      pids_limit = 2048
      [network]
      network_backend = "netavark"
      [engine]
      runtime = "crun"
      cgroup_manager = "systemd"
      events_logger = "journald"
    mode: '0644'
  become: true
- name: Enable container lingering for service users
  ansible.builtin.command:
    cmd: "loginctl enable-linger {{ item }}"
  loop: "{{ container_linger_users | default([]) }}"
  changed_when: true
  become: true
  when: container_linger_users is defined and container_linger_users | length > 0
- name: Set containers config completion flag
  ansible.builtin.set_fact:
    containers_config_complete: true

- ansible.builtin.include_tasks: secrets_setup.yml
