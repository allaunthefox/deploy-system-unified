---
# Memcached Container Role using Podman Quadlets

- name: Create Memcached directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  loop:
    - /srv/containers/memcached
  become: true

- name: Create Memcached Quadlet
  ansible.builtin.copy:
    dest: /etc/containers/systemd/memcached.container
    content: |
      [Unit]
      Description=Memcached Distributed Memory Object Caching System
      After=network-online.target
      Wants=network-online.target

      [Container]
      Image={{ memcached_image }}
      ContainerName=memcached
      PublishPort={{ memcached_port }}:11211
      
      # Pass memory limit to executable (-m <MB>)
      Exec=memcached -m {{ memcached_memory_mb }} -o modern

      # Cgroup Memory Limits
      # Ensure the container doesn't exceed 125% of the application limit 
      # to prevent OOM kills while allowing for overhead.
      MemoryWithSwap=false
      MemoryMax={{ (memcached_memory_mb | int * 1.25) | int }}M

      [Service]
      Restart=always
      TimeoutStartSec=300

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
  become: true
  notify: reload systemd
