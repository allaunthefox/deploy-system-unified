---
# SSHD configuration role - Advanced SSH daemon configuration
- name: Backup original sshd_config
  ansible.builtin.copy:
    src: /etc/ssh/sshd_config
    dest: /etc/ssh/sshd_config.backup
    remote_src: true
    mode: '0600'
  become: true
  when: sshd_backup_config | default(true)

- name: Configure SSH protocol and algorithms
  ansible.builtin.blockinfile:
    path: /etc/ssh/sshd_config
    marker: "# {mark} ANSIBLE MANAGED - SECURITY ALGORITHMS"
    block: |
      # Use only strong ciphers
      Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com
      # Use only strong MACs
      MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com
      # Use only strong key exchange algorithms
      KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group16-sha512
      # Use only strong host key algorithms
      HostKeyAlgorithms ssh-ed25519,rsa-sha2-512,rsa-sha2-256
    validate: '/usr/sbin/sshd -t -f %s'
  become: true
  notify: restart sshd

- name: Disable weak SSH host keys
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/ssh/ssh_host_dsa_key
    - /etc/ssh/ssh_host_dsa_key.pub
    - /etc/ssh/ssh_host_ecdsa_key
    - /etc/ssh/ssh_host_ecdsa_key.pub
  become: true
  when: sshd_disable_weak_keys | default(false)

- name: Generate strong Ed25519 host key if missing
  ansible.builtin.command:
    cmd: ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N ""
    creates: /etc/ssh/ssh_host_ed25519_key
  become: true

- name: Set correct permissions on SSH host keys
  ansible.builtin.file:
    path: "{{ item.path }}"
    mode: "{{ item.mode }}"
    owner: root
    group: root
  loop:
    - { path: '/etc/ssh/ssh_host_ed25519_key', mode: '0600' }
    - { path: '/etc/ssh/ssh_host_ed25519_key.pub', mode: '0644' }
    - { path: '/etc/ssh/ssh_host_rsa_key', mode: '0600' }
    - { path: '/etc/ssh/ssh_host_rsa_key.pub', mode: '0644' }
  become: true
  failed_when: false

- name: Set SSHD configuration completion flag
  ansible.builtin.set_fact:
    security_sshd_complete: true
