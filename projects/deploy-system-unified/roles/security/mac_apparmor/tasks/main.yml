---
# Tasks for security/mac_apparmor - Mandatory Access Control
- name: Install AppArmor packages (Debian/Ubuntu)
  ansible.builtin.package:
    name:
      - apparmor
      - apparmor-utils
      - apparmor-profiles
    state: present
  when: ansible_os_family == 'Debian'
  become: true

- name: Enable and start AppArmor service
  ansible.builtin.systemd:
    name: apparmor
    enabled: true
    state: started
  when:
    - ansible_os_family == 'Debian'
    - not (is_virtualized | default(false))
  become: true

- name: Enforce AppArmor at boot via GRUB
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    # Regex negative lookahead to ensure parameters are added only if not present
    regexp: '^GRUB_CMDLINE_LINUX_DEFAULT="((?!.*apparmor=1 security=apparmor).*)"$'
    line: 'GRUB_CMDLINE_LINUX_DEFAULT="\1 apparmor=1 security=apparmor"'
    backrefs: true
  register: apparmor_grub
  when:
    - ansible_os_family == 'Debian'
    - not (is_virtualized | default(false))
  become: true
  notify: update-grub
