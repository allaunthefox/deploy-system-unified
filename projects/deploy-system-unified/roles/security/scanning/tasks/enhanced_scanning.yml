---
# Enhanced security scanning for Deploy-System-Unified
- name: Run comprehensive security scan (idempotent)
  ansible.builtin.shell: |
    scan_results=""
    # Run Trivy vulnerability scan
    if command -v trivy >/dev/null 2>&1; then
      trivy_results=$(trivy filesystem / --security-checks vuln,config,secret --format json 2>/dev/null || echo '{"Results": []}')
      # Enhanced scanning with required tools and portable service management
      # Enhanced scanning with required tools and portable service management
    else
      scan_results="$scan_results TRIVY_CRITICAL:0"
    fi
    # Run Checkov infrastructure scan
    if command -v checkov >/dev/null 2>&1; then
      checkov_results=$(checkov --directory /etc --compact --output json 2>/dev/null || echo '{"results": {"failed_checks": []}}')
      checkov_critical=$(echo "$checkov_results" | jq -r '.results.failed_checks[] | select(.severity=="HIGH" or .severity=="CRITICAL")' | wc -l)
      scan_results="$scan_results CHECKOV_CRITICAL:$checkov_critical"
    else
      scan_results="$scan_results CHECKOV_CRITICAL:0"
    fi
    # Run TruffleHog secret scan
    if command -v trufflehog >/dev/null 2>&1; then
      secret_results=$(trufflehog git . --since-commit HEAD~1 --only-verified 2>&1 | grep -i "found" | wc -l)
      scan_results="$scan_results TRUFFLEHOG_SECRETS:$secret_results"
    else
      scan_results="$scan_results TRUFFLEHOG_SECRETS:0"
    fi
    echo "$scan_results"
  register: comprehensive_scan
  changed_when: false
  no_log: true
- name: Parse security scan results (idempotent)
  ansible.builtin.set_fact:
    trivy_critical_vulns: >-
      {{ comprehensive_scan.stdout | regex_search('TRIVY_CRITICAL:([0-9]+)', '\1') | first | default('0') | int
         if 'TRIVY_CRITICAL:' in comprehensive_scan.stdout else 0 }}
    checkov_critical_issues: >-
      {{ comprehensive_scan.stdout | regex_search('CHECKOV_CRITICAL:([0-9]+)', '\1') | first | default('0') | int
         if 'CHECKOV_CRITICAL:' in comprehensive_scan.stdout else 0 }}
    trufflehog_secrets_found: >-
      {{ comprehensive_scan.stdout | regex_search('TRUFFLEHOG_SECRETS:([0-9]+)', '\1') | first | default('0') | int
         if 'TRUFFLEHOG_SECRETS:' in comprehensive_scan.stdout else 0 }}
- name: Validate security scan results (idempotent)
  ansible.builtin.assert:
    that:
      - trivy_critical_vulns == 0
      - checkov_critical_issues == 0
      - trufflehog_secrets_found == 0
    fail_msg: |
      Security scan detected critical issues:
      - Trivy critical vulnerabilities: {{ trivy_critical_vulns }}
      - Checkov critical issues: {{ checkov_critical_issues }}
      - TruffleHog secrets found: {{ trufflehog_secrets_found }}
      - Deployment halted for security review
