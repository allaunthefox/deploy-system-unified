---
# Tasks for security/resource_protection - DoS and Resource Exhaustion Mitigation

- name: Validate minimum resource requirements
  ansible.builtin.assert:
    that:
      - ansible_memtotal_mb >= resource_min_ram_mb[virt_type] | default(resource_min_ram_mb['default'])
    fail_msg: "Insufficient RAM for {{ virt_type | upper }} environment. Required: {{ resource_min_ram_mb[virt_type] | default(resource_min_ram_mb['default']) }}MB"

- name: Configure system-wide ulimits for process isolation
  ansible.builtin.copy:
    content: |
      * soft core 0
      * hard core 0
      * soft nproc 2048
      * hard nproc 4096
      * soft nofile 8192
      * hard nofile 16384
    dest: /etc/security/limits.d/99-resource-protection.conf
    mode: '0644'
  become: true

- name: Enforce Systemd global resource limits
  ansible.builtin.lineinfile:
    path: /etc/systemd/system.conf
    regexp: "^#?Default{{ item.key }}="
    line: "Default{{ item.key }}={{ item.value }}"
  loop:
    - { key: 'TasksMax', value: "{{ resource_default_tasks_max }}" }
    - { key: 'MemoryMax', value: "{{ resource_default_memory_max }}" }
    - { key: 'MemoryAccounting', value: 'yes' }
    - { key: 'CPUAccounting', value: 'yes' }
  become: true
  notify: reload systemd
