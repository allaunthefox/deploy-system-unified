---
# Tasks for security/endlessh - SSH Tarpit
- name: Install Endlessh
  ansible.builtin.package:
    name: endlessh
    state: present
  become: true
- name: Create Endlessh configuration directory
  ansible.builtin.file:
    path: /etc/endlessh
    state: directory
    mode: '0755'
  become: true
- name: Configure Endlessh
  ansible.builtin.template:
    src: config.j2
    dest: /etc/endlessh/config
    mode: '0644'
  become: true
  notify: restart endlessh
- name: Allow Endlessh to bind to privileged ports
  community.general.capabilities:
    path: /usr/bin/endlessh
    capability: cap_net_bind_service+ep
    state: present
  become: true
  ignore_errors: true
- name: Ensure Endlessh systemd override directory exists
  ansible.builtin.file:
    path: /etc/systemd/system/endlessh.service.d
    state: directory
    mode: '0755'
  become: true
- name: Configure Endlessh to run on port {{ endlessh_port }} (systemd override)
  ansible.builtin.copy:
    content: |
      [Service]
      AmbientCapabilities=CAP_NET_BIND_SERVICE
      ExecStart=
      ExecStart=/usr/bin/endlessh -p {{ endlessh_port }}
    dest: /etc/systemd/system/endlessh.service.d/override.conf
    mode: '0644'
  become: true
  notify:
    - reload systemd
    - restart endlessh
- name: Enable and start Endlessh service
  ansible.builtin.systemd:
    name: endlessh
    enabled: true
    state: started
  become: true
