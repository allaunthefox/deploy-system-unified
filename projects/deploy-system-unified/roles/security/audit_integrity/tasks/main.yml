---
# Tasks for security/audit_integrity role - Cryptographic Log Immutability
- name: Check if journal FSS keys are already initialized
  ansible.builtin.stat:
    path: /var/log/journal/fss.pub
  register: journal_fss_stat
  become: true
- name: Initialize Forward Secure Sealing (FSS) keys
  ansible.builtin.shell: |
    set -o pipefail
    journalctl --setup-keys --force | grep "verification key" | awk '{print $NF}'
  register: fss_verification_key_output
  become: true
  when:
    - not journal_fss_stat.stat.exists
    - ansible_virtualization_type not in ['docker', 'podman', 'container']
  notify: restart journald
  no_log: true
- name: Create secure temporary file for FSS key capture
  ansible.builtin.tempfile:
    state: file
    prefix: "fss_key_{{ inventory_hostname }}_"
    suffix: ".txt"
  register: fss_temp_file
  delegate_to: localhost
  run_once: true
  when: fss_verification_key_output.changed
  no_log: true
- name: Store FSS verification key on controller
  ansible.builtin.copy:
    content: |
      TARGET: {{ inventory_hostname }}
      TIMESTAMP: {{ ansible_date_time.iso8601 }}
      VERIFICATION_KEY: {{ fss_verification_key_output.stdout }}
    dest: "{{ fss_temp_file.path }}"
    mode: '0600'
  delegate_to: localhost
  when:
    - fss_verification_key_output.changed
    - fss_temp_file.path is defined
  no_log: true
- name: Encrypt FSS key with Ansible Vault
  ansible.builtin.shell: |
    ansible-vault encrypt "{{ fss_temp_file.path }}"
  delegate_to: localhost
  when:
    - fss_verification_key_output.changed
    - fss_temp_file.path is defined
  run_once: true
- name: Move encrypted FSS key to final destination
  ansible.builtin.copy:
    src: "{{ fss_temp_file.path }}"
    dest: "/tmp/fss_v_{{ inventory_hostname }}_{{ deployment_id }}.vault"
    mode: '0600'
  delegate_to: localhost
  when:
    - fss_verification_key_output.changed
    - fss_temp_file.path is defined
- name: Ensure Seal is enabled in journald configuration
  ansible.builtin.lineinfile:
    path: /etc/systemd/journald.conf
    regexp: '^#?Seal='
    line: 'Seal=yes'
  become: true
  notify: restart journald
