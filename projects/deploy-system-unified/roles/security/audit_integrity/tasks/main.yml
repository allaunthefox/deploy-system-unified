---
# Tasks for security/audit_integrity role - Cryptographic Log Immutability
- name: Check if journal FSS keys are already initialized
  ansible.builtin.find:
    paths: /var/log/journal
    patterns: fss.pub
    file_type: file
  register: journal_fss_stat
  become: true
- name: Initialize Forward Secure Sealing (FSS) keys
  ansible.builtin.shell: |
    set -o pipefail
    journalctl --setup-keys --force 2>&1 | grep -E "[0-9a-f]{6}-[0-9a-f]{6}" | tail -n 1
  args:
    executable: /bin/bash
  register: fss_verification_key_output
  become: true
  when:
    - (journal_fss_stat.matched | default(0) | int) == 0
    - ansible_virtualization_type not in ['docker', 'podman', 'container']
  notify: restart journald
  no_log: true
- name: Create secure temporary file for FSS key capture
  ansible.builtin.tempfile:
    state: file
    prefix: "fss_key_{{ inventory_hostname }}_"
    suffix: ".txt"
  register: fss_temp_file
  delegate_to: localhost
  become: false
  run_once: true
  when: fss_verification_key_output.changed
  no_log: true
- name: Store FSS verification key on controller
  ansible.builtin.copy:
    content: |
      TARGET: {{ inventory_hostname }}
      TIMESTAMP: {{ ansible_date_time.iso8601 }}
      VERIFICATION_KEY: {{ fss_verification_key_output.stdout }}
    dest: "{{ fss_temp_file.path }}"
    mode: '0600'
  delegate_to: localhost
  become: false
  when:
    - fss_verification_key_output.changed
    - fss_temp_file.path is defined
  no_log: true
- name: Encrypt FSS key with Ansible Vault
  ansible.builtin.shell: |
    ansible-vault encrypt --vault-password-file "{{ playbook_dir }}/../.vault_pass" "{{ fss_temp_file.path }}"
  delegate_to: localhost
  become: false
  when:
    - fss_verification_key_output.changed
    - fss_temp_file.path is defined
  run_once: true
- name: Move encrypted FSS key to final destination
  ansible.builtin.copy:
    src: "{{ fss_temp_file.path }}"
    dest: "/tmp/fss_v_{{ inventory_hostname }}_{{ deployment_id }}.vault"
    mode: '0600'
  delegate_to: localhost
  become: false
  when:
    - fss_verification_key_output.changed
    - fss_temp_file.path is defined
- name: Ensure Seal is enabled in journald configuration
  ansible.builtin.lineinfile:
    path: /etc/systemd/journald.conf
    regexp: '^#?Seal='
    line: 'Seal=yes'
  become: true
  notify: restart journald
