---
# Advanced security hardening with secure patterns for security/advanced role
# - name: Validate advanced security hardening prerequisites (idempotent)
#   ansible.builtin.assert:
#     that:
#       - advanced_security_hardening_enabled | default(false)
#     msg: "Advanced security hardening not enabled - skipping configuration"
- name: Update SSH configuration with random port (idempotent)
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^Port '
    line: "Port {{ advanced_security_hardening_random_ssh_port }}"
    validate: '/usr/sbin/sshd -t -f %s'
  when:
    - ssh_randomize_port | bool
    - advanced_security_hardening_random_ssh_port is defined
  become: true
  notify: restart sshd
  no_log: true
- name: Enable SSH key rotation if enabled (idempotent)
  ansible.builtin.debug:
    msg: "SSH key rotation is enabled and will rotate keys every {{ ssh_key_rotation_interval_days }} days"
  when: ssh_key_rotation_enabled | bool
- name: Schedule SSH key rotation task (idempotent)
  ansible.builtin.cron:
    name: "Rotate SSH host keys"
    minute: "0"
    hour: "2"
    day: "*/{{ ssh_key_rotation_interval_days }}"
    job: "/usr/local/bin/rotate_ssh_keys.sh"
    state: present
  when: ssh_key_rotation_enabled | bool
- name: Create SSH key rotation script with secure permissions (idempotent)
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      # Script to rotate SSH host keys securely
      # Backup current keys
      backup_dir="/etc/ssh/backup/$(date +%Y%m%d_%H%M%S)"
      mkdir -p "$backup_dir"
      cp /etc/ssh/ssh_host_* "$backup_dir/" 2>/dev/null || true
      # Remove old keys
      rm -f /etc/ssh/ssh_host_*
      # Generate new keys with secure permissions
      if command -v dpkg-reconfigure >/dev/null 2>&1; then
        dpkg-reconfigure openssh-server 2>/dev/null || {
          ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key -N "" -C "Generated by Deploy-System-Unified"
          ssh-keygen -t ecdsa -b 256 -f /etc/ssh/ssh_host_ecdsa_key -N "" -C "Generated by Deploy-System-Unified"
          ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N "" -C "Generated by Deploy-System-Unified"
        }
      else
        ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key -N "" -C "Generated by Deploy-System-Unified"
        ssh-keygen -t ecdsa -b 256 -f /etc/ssh/ssh_host_ecdsa_key -N "" -C "Generated by Deploy-System-Unified"
        ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N "" -C "Generated by Deploy-System-Unified"
      fi
      # Set proper permissions
      chmod 600 /etc/ssh/ssh_host_*
      chmod 644 /etc/ssh/ssh_host_*.pub
      # Restart SSH service
      systemctl restart sshd
    dest: /usr/local/bin/rotate_ssh_keys.sh
    mode: '0700'
    owner: root
    group: root
  when: ssh_key_rotation_enabled | bool
