---
# Security hardening role - Core security configurations
- name: Ensure security-related packages are installed (Debian/Ubuntu)
  ansible.builtin.apt:
    name:
      - ufw
      - fail2ban
      - unattended-upgrades
      - apt-listchanges
    state: present
  when: ansible_facts['os_family'] == 'Debian'
  become: true

- name: Ensure security-related packages are installed (RedHat/CentOS)
  ansible.builtin.dnf:
    name:
      - firewalld
      - fail2ban
      - dnf-automatic
    state: present
  when: ansible_facts['os_family'] == 'RedHat'
  become: true

- name: Enable and start UFW (Debian/Ubuntu)
  community.general.ufw:
    state: enabled
    policy: deny
    direction: incoming
  when: ansible_facts['os_family'] == 'Debian'
  become: true

- name: Allow SSH through UFW
  community.general.ufw:
    rule: allow
    port: "{{ access_sshd_port | default('22') }}"
    proto: tcp
  when: ansible_facts['os_family'] == 'Debian'
  become: true

- name: Enable fail2ban service
  ansible.builtin.systemd:
    name: fail2ban
    enabled: true
    state: started
  become: true
  when: ansible_service_mgr == 'systemd'

- name: Configure automatic security updates (Debian/Ubuntu)
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
      APT::Periodic::AutocleanInterval "7";
    mode: '0644'
  when: ansible_facts['os_family'] == 'Debian'
  become: true

- name: Set kernel hardening parameters
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: true
  loop:
    - { name: 'net.ipv4.tcp_syncookies', value: '1' }
    - { name: 'net.ipv4.conf.all.rp_filter', value: '1' }
    - { name: 'net.ipv4.conf.default.rp_filter', value: '1' }
    - { name: 'net.ipv4.icmp_echo_ignore_broadcasts', value: '1' }
    - { name: 'net.ipv4.conf.all.accept_redirects', value: '0' }
    - { name: 'net.ipv4.conf.default.accept_redirects', value: '0' }
    - { name: 'kernel.randomize_va_space', value: '2' }
  become: true

- name: Set security hardening completion flag
  ansible.builtin.set_fact:
    security_hardening_complete: true
