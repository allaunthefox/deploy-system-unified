---
# Security hardening role - Enhanced core security configurations
- name: Ensure security-related packages are installed (Debian/Ubuntu)
  ansible.builtin.apt:
    name:
      - ufw
      - fail2ban
      - unattended-upgrades
      - apt-listchanges
      - libpam-tmpdir
      - auditd
    state: present
  when: ansible_facts['os_family'] == 'Debian'
  become: true
- name: Ensure security-related packages are installed (RedHat/CentOS)
  ansible.builtin.dnf:
    name:
      - firewalld
      - fail2ban
      - dnf-automatic
      - audit
    state: present
  when: ansible_facts['os_family'] == 'RedHat'
  become: true
- name: Enable and start UFW (Debian/Ubuntu)
  community.general.ufw:
    state: enabled
    policy: deny
    direction: incoming
  when: ansible_facts['os_family'] == 'Debian'
  become: true
- name: Allow SSH through UFW
  community.general.ufw:
    rule: allow
    port: "{{ access_sshd_port | default('22') }}"
    proto: tcp
  when: ansible_facts['os_family'] == 'Debian'
  become: true
- name: Enable fail2ban service
  ansible.builtin.systemd:
    name: fail2ban
    enabled: true
    state: started
  become: true
  when: ansible_facts['service_mgr'] == 'systemd'
- name: Configure automatic security updates (Debian/Ubuntu)
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
      APT::Periodic::AutocleanInterval "7";
      APT::Periodic::Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
      APT::Periodic::Unattended-Upgrade::Remove-Unused-Dependencies "true";
      APT::Periodic::Unattended-Upgrade::Automatic-Reboot "false";
    mode: '0644'
  when: ansible_facts['os_family'] == 'Debian'
  become: true
- name: Configure auditd service
  ansible.builtin.systemd:
    name: auditd
    enabled: true
    state: started
  become: true
  when: ansible_facts['service_mgr'] == 'systemd'
- name: Harden file system permissions
  block:
    - name: Set secure permissions on sensitive files
      ansible.builtin.file:
        path: "{{ item.path }}"
        mode: "{{ item.mode }}"
        owner: root
        group: root
      loop:
        - { path: '/etc/shadow', mode: '0600' }
        - { path: '/etc/passwd', mode: '0644' }
        - { path: '/etc/group', mode: '0644' }
        - { path: '/etc/sudoers', mode: '0440' }
        - { path: '/etc/ssh', mode: '0755' }
        - { path: '/etc/ssh/sshd_config', mode: '0644' }
      become: true
      failed_when: false
    - name: Set sticky bit on world-writable directories
      ansible.builtin.command:
        cmd: find / -type d -perm -0002 ! -path '/proc' ! -path '/sys' ! -path '/dev' ! -path '/run' -exec chmod +t {} \;
      become: true
      register: sticky_result
      changed_when: sticky_result.rc == 0
      failed_when: false
- name: Harden user accounts
  block:
    - name: Lock system accounts that should not login
      ansible.builtin.command:
        cmd: usermod -L {{ item }}
      loop:
        - bin
        - daemon
        - adm
        - lp
        - sync
        - shutdown
        - halt
        - mail
      become: true
      register: lock_result
      changed_when: lock_result.rc == 0
      failed_when: false
    - name: Set minimum password age to 7 days
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: '^PASS_MIN_DAYS'
        line: 'PASS_MIN_DAYS   7'
      become: true
    - name: Set maximum password age to 90 days
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: '^PASS_MAX_DAYS'
        line: 'PASS_MAX_DAYS   90'
      become: true
    - name: Set password warning period to 14 days
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: '^PASS_WARN_AGE'
        line: 'PASS_WARN_AGE   14'
      become: true
- name: Harden PAM configuration
  block:
    - name: Configure PAM to use strong password policies
      ansible.builtin.lineinfile:
        path: /etc/pam.d/common-password
        regexp: '^password.*pam_unix.so'
        line: 'password        [success=1 default=ignore]      pam_unix.so obscure sha512 rounds=65536'
      when: ansible_facts['os_family'] == 'Debian'
      become: true
    - name: Enable PAM tmpdir module
      ansible.builtin.lineinfile:
        path: /etc/pam.d/common-session
        regexp: '^session.*pam_tmpdir.so'
        line: 'session optional        pam_tmpdir.so'
      when: ansible_facts['os_family'] == 'Debian'
      become: true
- name: Set security hardening completion flag
  ansible.builtin.set_fact:
    security_hardening_complete: true
