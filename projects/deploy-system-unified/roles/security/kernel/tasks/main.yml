---
# Tasks for security/kernel role - Mandatory Sysctl Hardening

- name: Detect Virtualization Environment (Internal)
  ansible.builtin.set_fact:
    _sec_is_container: "{{ (ansible_virtualization_type | default('unknown') in ['docker', 'podman', 'container', 'lxc']) or (ansible_is_chroot | default(false)) }}"

- name: Apply kernel hardening parameters
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/99-hardened.conf
    reload: true
  loop:
    # Network Hardening
    - { name: 'net.ipv4.conf.all.accept_redirects', value: '0' }
    - { name: 'net.ipv4.conf.all.secure_redirects', value: '0' }
    - { name: 'net.ipv4.conf.all.send_redirects', value: '0' }
    - { name: 'net.ipv4.conf.all.accept_source_route', value: '0' }
    - { name: 'net.ipv4.conf.all.log_martians', value: '1' }
    - { name: 'net.ipv4.tcp_syncookies', value: '1' }
    - { name: 'net.ipv4.tcp_rfc1337', value: '1' }
    # System Hardening
    - { name: 'kernel.kptr_restrict', value: '2' }
    - { name: 'kernel.dmesg_restrict', value: '1' }
    - { name: 'kernel.printk', value: '3 3 3 3' }
    - { name: 'kernel.unprivileged_bpf_disabled', value: '1' }
    - { name: 'net.core.bpf_jit_harden', value: '2' }
    - { name: 'dev.tty.ldisc_autoload', value: '0' }
    - { name: 'vm.unprivileged_userfaultfd', value: '0' }
    # Memory Hardening & Purging
    - { name: 'kernel.panic_on_oops', value: '1' }
    - { name: 'vm.swappiness', value: '1' } # Minimize swapping of sensitive memory to disk
  become: true
  when: not _sec_is_container
  tags: [security, kernel]

- name: Register Kernel Security Parameters for GRUB
  ansible.builtin.set_fact:
    core_grub_security_params: >-
      {{
        core_grub_security_params | default([]) +
        ['init_on_free=1', 'page_poison=1', 'slab_nomerge']
      }}
  when: not _sec_is_container
  tags: [security, kernel]
