---
# Tasks for security/hardware_isolation - PCIe and DMA Protection
- name: Enable IOMMU for PCIe Isolation (Intel/AMD)
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    regexp: '^(GRUB_CMDLINE_LINUX_DEFAULT=".*)(intel_iommu=on|amd_iommu=on) iommu=pt(.*")$'
    line: '\1intel_iommu=on iommu=pt\2' # Defaulting to Intel, common for servers
    backrefs: true
  register: iommu_grub
  become: true
  when: not (is_virtualized | default(false))
  notify: update grub
- name: Blacklist dangerous DMA-capable modules
  ansible.builtin.copy:
    content: |
      blacklist firewire-ohci
      blacklist thunderbolt
    dest: /etc/modprobe.d/99-dma-isolation.conf
    mode: '0644'
  become: true
  when: not (is_virtualized | default(false))
