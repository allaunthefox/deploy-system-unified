---
# Tasks for ops/monitoring

- name: Load platform-specific variables
  ansible.builtin.include_vars:
    file: "{{ item }}"
  with_first_found:
    - files:
        - "{{ ansible_os_family | lower }}.yml"
        - "main.yml"
      paths:
        - "../vars"
      skip: true

# --- Package Installation ---

- name: Install monitoring packages (Debian/Ubuntu)
  ansible.builtin.apt:
    name:
      - prometheus-node-exporter
      - smartmontools
      - nvme-cli
    state: present
    update_cache: true
  when: 
    - ansible_os_family == "Debian"
    - monitoring_enable_node_exporter or monitoring_enable_smartmon

- name: Install monitoring packages (RHEL/Rocky)
  ansible.builtin.dnf:
    name:
      - node_exporter  # Note: Requires EPEL usually
      - smartmontools
      - nvme-cli
    state: present
  when: 
    - ansible_os_family == "RedHat"
    - monitoring_enable_node_exporter or monitoring_enable_smartmon

- name: Install monitoring packages (Arch Linux)
  ansible.builtin.pacman:
    name:
      - prometheus-node-exporter
      - smartmontools
      - nvme-cli
    state: present
  when: 
    - ansible_os_family == "Archlinux"
    - monitoring_enable_node_exporter or monitoring_enable_smartmon

# --- Service Configuration ---

- name: Enable and start Node Exporter
  ansible.builtin.systemd:
    name: prometheus-node-exporter  # Service name can vary, handled in vars if strictly needed, but usually consistent enough or aliased
    state: started
    enabled: true
  when: monitoring_enable_node_exporter
  ignore_errors: true # Service name might differ on some distros (e.g. node_exporter vs prometheus-node-exporter)

- name: Configure Smartd (Basic)
  ansible.builtin.lineinfile:
    path: /etc/smartd.conf
    regexp: '^DEVICESCAN'
    line: 'DEVICESCAN -a -o on -S on -n standby,q -s (S/../.././02|L/../../6/03) -W 4,35,40 -m root'
    create: true
  notify: restart smartd
  when: monitoring_enable_smartmon
  become: true

- name: Enable and start Smartd
  ansible.builtin.service:
    name: smartd
    state: started
    enabled: true
  when: 
    - monitoring_enable_smartmon
    - ansible_virtualization_type != "docker"
    - ansible_virtualization_type != "podman"
    - ansible_virtualization_type != "container"
