---
- name: Encrypt SSH connection info with Ansible Vault (idempotent)
  ansible.builtin.shell: |
    encrypted_file="{{ connection_info_temp_file.path }}.vault.yml"
    ansible-vault encrypt "{{ connection_info_temp_file.path }}" --output="$encrypted_file"
  register: vault_encryption
  changed_when: false
  failed_when: vault_encryption.rc != 0
  delegate_to: localhost
  when: connection_info_temp_file is defined
  no_log: true
  run_once: true

- name: Verify Vault encryption succeeded and set path (idempotent)
  ansible.builtin.stat:
    path: "{{ connection_info_temp_file.path }}.vault.yml"
  register: vault_encrypted_stat
  delegate_to: localhost
  changed_when: false
  run_once: true

- name: Set encrypted SSH info path for vault (idempotent)
  ansible.builtin.set_fact:
    encrypted_ssh_info_path: "{{ connection_info_temp_file.path }}.vault.yml"
  when:
    - vault_encrypted_stat is defined
    - vault_encrypted_stat.stat.exists
  delegate_to: localhost
  run_once: true
