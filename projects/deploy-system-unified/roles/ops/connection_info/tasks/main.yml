---
# Tasks for ops/connection_info role
- name: Determine SSH port for connection info
  ansible.builtin.set_fact:
    connection_info_port: >-
      {{ system_ssh_port | default(22) }}
- name: Create SSH connection info (idempotent)
  ansible.builtin.set_fact:
    ssh_connection_info:
      deployment_id: "{{ deployment_id }}"
      hostname: "{{ inventory_hostname }}"
      port: "{{ connection_info_port }}"
      username: "{{ ansible_user | default(ansible_ssh_user) | default(lookup('env', 'USER')) }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
  run_once: true
- name: Create secure temporary file on controller for SSH connection info (idempotent)
  ansible.builtin.tempfile:
    state: file
    prefix: "ssh_connection_info_{{ inventory_hostname | regex_replace('[^A-Za-z0-9_-]', '_') }}_"
    suffix: ".yml"
  register: connection_info_temp_file
  delegate_to: localhost
  run_once: true
  no_log: true
  changed_when: false
  when: not ansible_check_mode
- name: Set secure permissions on temporary file (idempotent)
  ansible.builtin.file:
    path: "{{ connection_info_temp_file.path }}"
    mode: '0600'
  delegate_to: localhost
  when:
    - connection_info_temp_file.path is defined
    - not ansible_check_mode
  run_once: true
- name: Copy SSH connection info to secure temp file (idempotent)
  ansible.builtin.copy:
    dest: "{{ connection_info_temp_file.path }}"
    content: |
      ---
      ssh_connection:
        hostname: "{{ ssh_connection_info.hostname }}"
        port: "{{ ssh_connection_info.port }}"
        username: "{{ ssh_connection_info.username }}"
        timestamp: "{{ ssh_connection_info.timestamp }}"
    mode: '0600'
    owner: root
    group: root
  delegate_to: localhost
  register: temp_file_written
  changed_when: false
  no_log: true
  run_once: true
  when: not ansible_check_mode

- name: Handle SOPS Encryption
  ansible.builtin.include_tasks: encryption/sops.yml
  when:
    - encryption_method == 'sops'
    - not ansible_check_mode

- name: Handle Ansible Vault Encryption
  ansible.builtin.include_tasks: encryption/vault.yml
  when:
    - encryption_method == 'vault'
    - not ansible_check_mode

- name: Set path for plaintext SSH info (insecure/dev only)
  ansible.builtin.set_fact:
    encrypted_ssh_info_path: "{{ connection_info_temp_file.path }}"
  when:
    - encryption_method == 'plain'
    - not ansible_check_mode
  delegate_to: localhost
  run_once: true

- name: Verify encryption succeeded (idempotent)
  ansible.builtin.assert:
    that:
      - encrypted_ssh_info_path is defined
      - encrypted_ssh_info_path | length > 0
    msg: "Encryption of temporary SSH info failed - deployment halted"
  run_once: true
  when: not ansible_check_mode
- name: Clean up plaintext temporary SSH file (idempotent)
  ansible.builtin.file:
    path: "{{ connection_info_temp_file.path }}"
    state: absent
  delegate_to: localhost
  run_once: true
  changed_when: false
  when: not ansible_check_mode
- name: Rsync encrypted SSH connection info to specified destination (idempotent)
  ansible.posix.synchronize:
    src: "{{ encrypted_ssh_info_path }}"
    dest: "{{ ssh_rsync_destination }}"
    mode: pull
  when:
    - ssh_rsync_destination != ""
    - ops_rsync_enable | default(false) | bool
    - ssh_rsync_destination in (ops_rsync_allowlist | default([]) | map(attribute='dest') | list)
    - encrypted_ssh_info_path is defined
    - encrypted_ssh_info_path | length > 0
    - not ansible_check_mode
  run_once: true
  delegate_to: localhost
