---
# Tasks for ops/pre_connection role
# This role runs on the CONTROLLER to ensure connectivity and determine facts.
- name: Check for existing custom SSH port on target (idempotent)
  ansible.builtin.shell: |
    # Find the configured port and ensure it is not the default 22
    # Use sshd -T to respect included configs and overrides
    CURRENT_PORT=$(sshd -T 2>/dev/null | awk '/^port /{print $2; exit}')
    if [ "$CURRENT_PORT" != "22" ] && [ -n "$CURRENT_PORT" ]; then
      echo "$CURRENT_PORT"
    else
      echo ""
    fi
  register: existing_ssh_port
  changed_when: false
  args:
    pipefail: true
  when: ssh_randomize_port | default(false) | bool
  become: true
- name: Compute SSH port range bounds (idempotent)
  ansible.builtin.set_fact:
    advanced_security_hardening_ssh_range_start: "{{ ssh_random_port_range_start | default(10000) | int }}"
    advanced_security_hardening_ssh_range_end: "{{ ssh_random_port_range_end | default(20000) | int }}"
  when:
    - ssh_randomize_port | default(false) | bool
    - existing_ssh_port.stdout | default('') == "" or existing_ssh_port.stdout | default('') == "22"
  delegate_to: localhost
  run_once: true
- name: Generate random SSH port if enabled (idempotent)
  ansible.builtin.set_fact:
    advanced_security_hardening_random_ssh_port: >-
      {{ ((advanced_security_hardening_ssh_range_start | int) + (999999 | random)) %
         ((advanced_security_hardening_ssh_range_end | int) - (advanced_security_hardening_ssh_range_start | int) + 1)
         + (advanced_security_hardening_ssh_range_start | int) }}
  when:
    - ssh_randomize_port | default(false) | bool
    - existing_ssh_port.stdout | default('') == "" or existing_ssh_port.stdout | default('') == "22"
  delegate_to: localhost
  run_once: true
- name: Set final SSH port fact (idempotent)
  ansible.builtin.set_fact:
    advanced_security_hardening_random_ssh_port: "{{ existing_ssh_port.stdout }}"
  when:
    - ssh_randomize_port | default(false) | bool
    - existing_ssh_port.stdout | default('') != ""
    - existing_ssh_port.stdout | default('') != "22"
- name: Set effective SSH port fact (idempotent)
  ansible.builtin.set_fact:
    ssh_effective_port: >-
      {{ advanced_security_hardening_random_ssh_port
         | default(system_ssh_port)
         | default(22) }}
- name: Warn when randomization overrides Endlessh port conventions
  ansible.builtin.debug:
    msg: >-
      SSH port randomization is enabled; ssh_effective_port={{ ssh_effective_port }} takes
      precedence over system_ssh_port={{ system_ssh_port | default(22) }} even if Endlessh
      is enabled. Ensure firewall access is aligned with the randomized port.
  when:
    - ssh_randomize_port | default(false) | bool
    - system_enable_endlessh | default(false) | bool
  changed_when: false
- name: Check connectivity to target SSH port
  ansible.builtin.wait_for:
    host: "{{ inventory_hostname }}"
    port: "{{ ssh_effective_port | default(22) }}"
    timeout: 5
    state: started
  delegate_to: localhost
  register: ssh_port_check
  failed_when: false
- name: Inform operator if SSH port is closed (Anticipating Knocking)
  ansible.builtin.debug:
    msg: "SSH port appears closed. If Port Knocking is enabled, ensure you have knocked before running this playbook."
  when: ssh_port_check.failed
