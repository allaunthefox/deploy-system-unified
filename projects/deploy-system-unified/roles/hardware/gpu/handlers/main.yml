---
# Handlers for gpu_stack

- name: Update initramfs (placeholder)
  ansible.builtin.debug:
    msg: "Updating initramfs..."
  listen: "Update initramfs"
  notify:
    - Update Initramfs Debian
    - Update Initramfs RedHat
    - Update Initramfs Alpine
    - Update Initramfs Archlinux

- name: Restart Display Manager (Placeholder)
  ansible.builtin.debug:
    msg: "Would restart Display Manager (gdm/lightdm/sddm) if present."
  listen: "Restart Display Manager (Placeholder)"

- name: Update Grub (Placeholder)
  ansible.builtin.command: update-grub
  become: true
  ignore_errors: true
  listen: "Update Grub (Placeholder)"
  when: ansible_os_family == 'Debian'

- name: Update Initramfs Debian
  ansible.builtin.command: update-initramfs -u
  become: true
  when:
    - ansible_facts['os_family'] == 'Debian'
    - not _gpu_is_container | default(false)

- name: Update Initramfs RedHat
  ansible.builtin.command: dracut --force
  become: true
  when:
    - ansible_facts['os_family'] == 'RedHat'
    - not _gpu_is_container | default(false)

- name: Update Initramfs Alpine
  ansible.builtin.command: mkinitfs
  become: true
  when:
    - ansible_facts['os_family'] == 'Alpine'
    - not _gpu_is_container | default(false)

- name: update_grub
  ansible.builtin.shell: |
    if command -v update-grub >/dev/null 2>&1; then
      update-grub
    elif [-f /boot/grub2/grub.cfg]; then
      grub2-mkconfig -o /boot/grub2/grub.cfg
    fi
  become: true
  when: not _gpu_is_container | default(false)

- name: reload_udev
  ansible.builtin.shell: udevadm control --reload-rules && udevadm trigger
  become: true
  when: not _gpu_is_container | default(false)

- name: Update Initramfs Archlinux
  ansible.builtin.command: mkinitcpio -P
  become: true
  when:
    - ansible_facts['os_family'] == 'Archlinux'
    - not _gpu_is_container | default(false)
