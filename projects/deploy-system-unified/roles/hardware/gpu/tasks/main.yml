---
# Main entry point for hardware/gpu

- name: Check if GPU Stack is enabled
  ansible.builtin.debug:
    msg: "GPU Stack is {{ 'enabled' if gpu_stack_enable else 'disabled' }}"

- name: End play if GPU Stack is disabled
  ansible.builtin.meta: end_play
  when: not gpu_stack_enable

- name: Check for EFI Environment
  ansible.builtin.stat:
    path: /sys/firmware/efi
  register: efi_sysfs

- name: Set EFI Fact
  ansible.builtin.set_fact:
    gpu_stack_efi_present: "{{ efi_sysfs.stat.exists }}"

- name: Normalize Architecture
  ansible.builtin.set_fact:
    _gpu_norm_arch: >-
      {{
        'x86_64' if gpu_stack_arch in ['amd64', 'x86_64'] else
        'aarch64' if gpu_stack_arch in ['arm64', 'aarch64', 'armv8b', 'armv8l'] else
        'riscv64' if gpu_stack_arch in ['riscv64', 'risc64', 'riscv'] else
        gpu_stack_arch
      }}

- name: Normalize Vendor List (Single or Multi-Vendor)
  ansible.builtin.set_fact:
    _gpu_vendor_list: "{{ [gpu_stack_vendor] if gpu_stack_vendor is string else gpu_stack_vendor }}"

- name: Detect Virtualization Environment
  ansible.builtin.set_fact:
    _gpu_is_container: "{{ (ansible_facts['virtualization_type'] | default('unknown') in ['docker', 'podman', 'container', 'lxc']) or (ansible_facts['is_chroot'] | default(false)) }}"
    _gpu_is_vm: "{{ (ansible_facts['virtualization_role'] | default('unknown') == 'guest') and (ansible_facts['virtualization_type'] | default('unknown') not in ['docker', 'podman', 'container', 'lxc']) }}"

- name: Validate Global Config
  ansible.builtin.assert:
    that:
      - gpu_stack_mode in ['server', 'desktop', 'hybrid']
    fail_msg: "Invalid GPU mode: {{ gpu_stack_mode }}"

- name: Auto-Detect Video Hardware (If Vendor is Auto/Generic)
  ansible.builtin.include_tasks: detect_video.yml
  when: gpu_stack_vendor in ['auto', 'generic']
  ignore_errors: true

- name: Normalize Vendor List (Re-eval after detection)
  ansible.builtin.set_fact:
    _gpu_vendor_list: "{{ [gpu_stack_vendor] if gpu_stack_vendor is string else gpu_stack_vendor }}"

- name: Iterate over defined vendors
  ansible.builtin.include_tasks: vendor_setup.yml
  loop: "{{ _gpu_vendor_list }}"
  loop_control:
    loop_var: current_vendor

- name: Optional - Configure Hybrid Graphics (Prime/Optimus)
  ansible.builtin.include_tasks: features/hybrid_setup.yml
  when: gpu_stack_mode in ['hybrid', 'desktop'] and _gpu_vendor_list | length > 1

- name: Optional - Configure Desktop Environment Features
  ansible.builtin.include_tasks: features/desktop_setup.yml
  when: gpu_stack_mode in ['desktop', 'hybrid']

- name: Optional - Configure eGPU Support
  ansible.builtin.include_tasks: features/egpu.yml
  when: gpu_stack_enable_egpu | default(false)

- name: Optional - Configure RDMA Support
  ansible.builtin.include_tasks: features/rdma.yml
  when: gpu_stack_enable_rdma | default(false)

- name: Optional - Configure DP Alt Mode
  ansible.builtin.include_tasks: features/dp_alt_mode.yml
  when: gpu_stack_enable_dp_alt_mode | default(false)
