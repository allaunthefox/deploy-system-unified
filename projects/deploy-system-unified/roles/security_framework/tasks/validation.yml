---
# Complete system validation for Deploy-System-Unified

- name: Verify all security components are configured (idempotent)
  ansible.builtin.assert:
    that:
      - security_framework_applied | default(false)
      - enhanced_security_scanning_complete | default(false)
      - encryption_configured | default(false)
      - entropy_management_configured | default(false)
      - secure_process_naming_configured | default(false)
      - rootkit_prevention_configured | default(false)
      - entropy_enhancement_configured | default(false)
      - secure_ssh_info_configured | default(false)
      - portable_services_configured | default(false)
      - distribution_aware_packages_configured | default(false)
      - secure_temp_files_configured | default(false)
      - enhanced_security_tools_configured | default(false)
      - advanced_security_hardening_configured | default(false)
      - time_sync_configured | default(false)
      - security_scanning_configured | default(false)
    fail_msg: "Not all security components properly configured - deployment incomplete"

- name: Verify directory precreation was successful (idempotent)
  ansible.builtin.assert:
    that:
      - directories_precreated | default(false)
    fail_msg: "Directory precreation failed - system may be in inconsistent state"

- name: Verify all required directories exist (idempotent)
  ansible.builtin.stat:
    path: "{{ item }}"
  register: final_dir_check
  loop:
    - /var/lib/deploy-system/checkpoints
    - /var/lib/deploy-system/backups
    - /etc/chrony
    - /etc/trivy
    - /etc/checkov

- name: Validate all required directories exist (idempotent)
  ansible.builtin.assert:
    that:
      - item.stat.exists
      - item.stat.isdir
    fail_msg: "Required directory {{ item.path }} does not exist"
  loop: "{{ final_dir_check.results }}"

- name: Set final security compliance flag (idempotent)
  ansible.builtin.set_fact:
    security_compliance_verified: true
    deployment_complete: true
    system_ready_for_use: true