---
# Enhanced security with required tools and proper validation for Deploy-System-Unified

- name: Check if security tools are installed (idempotent)
  ansible.builtin.command: "{{ item }} --version"
  register: tool_check
  loop: ["trivy", "trufflehog", "bubblewrap", "firejail", "endlessh", "chronyd", "checkov"]
  failed_when: false
  changed_when: false

- name: Install missing security tools including enhanced tooling (idempotent)
  ansible.builtin.package:
    name: "{{ distro_package_mapping[ansible_distribution | lower].security_packages + ['chrony'] }}"
    state: present
  become: true
  when: 
    - ansible_distribution | lower in distro_package_mapping.keys()

- name: Verify security tools are functional (idempotent)
  ansible.builtin.command: "{{ item }} --version"
  register: tool_verification
  loop: ["trivy", "trufflehog", "bubblewrap", "firejail", "endlessh"]
  changed_when: false

- name: Run comprehensive security scan with proper validation (idempotent)
  ansible.builtin.shell: |
    scan_results=""
    if command -v chkrootkit >/dev/null 2>&1; then
      chkrootkit_output=$(chkrootkit 2>&1)
      infections=$(echo "$chkrootkit_output" | grep -i "INFECTED\|Warning" | wc -l)
      scan_results="$scan_results CHKROOTKIT:$infections"
    fi
    if command -v rkhunter >/dev/null 2>&1; then
      rkhunter_output=$(rkhunter --check --sk --report-warnings-only 2>&1)
      warnings=$(echo "$rkhunter_output" | grep -i "Warning\|Suspicious" | wc -l)
      scan_results="$scan_results RKHUNTER:$warnings"
    fi
    if command -v aide >/dev/null 2>&1; then
      aide_output=$(aide --check 2>&1)
      changes=$(echo "$aide_output" | grep -i "found\|changed\|deleted\|added" | wc -l)
      scan_results="$scan_results AIDE:$changes"
    fi
    if command -v lynis >/dev/null 2>&1; then
      lynis_output=$(lynis audit system --quick-scan 2>&1)
      issues=$(echo "$lynis_output" | grep -i "warning\|suggestion" | wc -l)
      scan_results="$scan_results LYNIS:$issues"
    fi
    if command -v checkov >/dev/null 2>&1; then
      checkov_output=$(checkov --directory /etc --compact 2>&1)
      checkov_issues=$(echo "$checkov_output" | grep -i "HIGH\|CRITICAL" | wc -l)
      scan_results="$scan_results CHECKOV:$checkov_issues"
    fi
    echo "$scan_results"
  register: comprehensive_scan
  changed_when: false
  no_log: true

- name: Parse comprehensive security scan results (idempotent)
  ansible.builtin.set_fact:
    chkrootkit_infections: "{{ comprehensive_scan.stdout.split('CHKROOTKIT:')[1].split()[0] | default('0') | int if 'CHKROOTKIT:' in comprehensive_scan.stdout else 0 }}"
    rkhunter_warnings: "{{ comprehensive_scan.stdout.split('RKHUNTER:')[1].split()[0] | default('0') | int if 'RKHUNTER:' in comprehensive_scan.stdout else 0 }}"
    aide_changes: "{{ comprehensive_scan.stdout.split('AIDE:')[1].split()[0] | default('0') | int if 'AIDE:' in comprehensive_scan.stdout else 0 }}"
    lynis_issues: "{{ comprehensive_scan.stdout.split('LYNIS:')[1].split()[0] | default('0') | int if 'LYNIS:' in comprehensive_scan.stdout else 0 }}"
    checkov_issues: "{{ comprehensive_scan.stdout.split('CHECKOV:')[1].split()[0] | default('0') | int if 'CHECKOV:' in comprehensive_scan.stdout else 0 }}"

- name: Validate comprehensive security scan results (idempotent)
  ansible.builtin.assert:
    that:
      - chkrootkit_infections == 0
      - rkhunter_warnings <= 5  # Allow minor warnings but not major issues
      - aide_changes == 0
      - lynis_issues <= 10  # Allow minor issues but not major security problems
      - checkov_issues == 0  # No critical infrastructure issues allowed
    fail_msg: |
      Comprehensive security scan detected issues:
      - Chkrootkit infections: {{ chkrootkit_infections }}
      - RKHunter warnings: {{ rkhunter_warnings }}
      - AIDE changes: {{ aide_changes }}
      - Lynis issues: {{ lynis_issues }}
      - Checkov issues: {{ checkov_issues }}
      - Deployment halted for security review