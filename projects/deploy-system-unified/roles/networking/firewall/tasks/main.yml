---
# Tasks for networking/firewall role
# Multi-distro support: UFW (Debian/Arch) | Firewalld (RedHat)

- name: Install UFW (Debian/Ubuntu/Arch)
  ansible.builtin.package:
    name: ufw
    state: present
  when: ansible_os_family == 'Debian' or ansible_distribution == 'Archlinux'
  become: true

- name: Install Firewalld (RedHat/CentOS)
  ansible.builtin.package:
    name: firewalld
    state: present
  when: ansible_os_family == 'RedHat'
  become: true

- name: Set UFW Default Forward Policy
  ansible.builtin.lineinfile:
    path: /etc/default/ufw
    regexp: '^DEFAULT_FORWARD_POLICY='
    line: 'DEFAULT_FORWARD_POLICY="{{ firewall_forward_policy }}"'
  when: ansible_os_family == 'Debian' or ansible_distribution == 'Archlinux'
  become: true
  notify: Reload UFW

- name: Configure UFW defaults
  community.general.ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - { direction: 'incoming', policy: 'deny' }
    - { direction: 'outgoing', policy: 'allow' }
  when: ansible_os_family == 'Debian' or ansible_distribution == 'Archlinux'
  become: true

- name: Import UFW Rules
  ansible.builtin.include_tasks: rules_ufw.yml
  when: ansible_os_family == 'Debian' or ansible_distribution == 'Archlinux'

- name: Import Firewalld Rules
  ansible.builtin.include_tasks: rules_firewalld.yml
  when: ansible_os_family == 'RedHat'

- name: Enable UFW Final State
  community.general.ufw:
    state: enabled
  when:
    - (ansible_os_family == 'Debian' or ansible_distribution == 'Archlinux')
    - firewall_enabled | bool
  become: true
