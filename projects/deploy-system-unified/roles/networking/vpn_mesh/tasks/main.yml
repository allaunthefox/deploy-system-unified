---
# Tasks for networking/vpn_mesh - Kernel Readiness for Encrypted Traffic

- name: Detect Virtualization Environment (Internal)
  ansible.builtin.set_fact:
    _sec_is_container: "{{ (ansible_virtualization_type | default('unknown') in ['docker', 'podman', 'container', 'lxc']) or (ansible_is_chroot | default(false)) }}"

- name: Ensure Wireguard kernel module is available
  community.general.modprobe:
    name: wireguard
    state: present
  become: true
  ignore_errors: true # Kernel might correspond to non-modular build or container
  when: not _sec_is_container

- name: Verify IPsec/ESP kernel modules for inter-node security
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - af_key
    - xfrm_user
  become: true
  ignore_errors: true
  when: not _sec_is_container

- name: Report encryption readiness
  ansible.builtin.debug:
    msg: "System is ready for Wireguard/IPSec based inter-pod encryption"
