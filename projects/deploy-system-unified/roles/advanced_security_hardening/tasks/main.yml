---
# Main tasks file for advanced_security_hardening role

- name: Generate random SSH port if enabled
  set_fact:
    random_ssh_port: "{{ ((ssh_random_port_range_start | int) + (999999 | random)) % ((ssh_random_port_range_end | int) - (ssh_random_port_range_start | int) + 1) + (ssh_random_port_range_start | int) }}"
  when: ssh_randomize_port | bool
  delegate_to: localhost
  run_once: true

- name: Update SSH configuration with random port
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^Port '
    line: "Port {{ random_ssh_port }}"
    validate: '/usr/sbin/sshd -t -f %s'
  when: ssh_randomize_port | bool
  notify: Restart sshd
  no_log: true

- name: Create SSH connection info
  set_fact:
    ssh_connection_info:
      hostname: "{{ inventory_hostname }}"
      port: "{{ random_ssh_port if ssh_randomize_port | bool else access_sshd_port }}"
      username: "{{ ansible_user | default(ansible_ssh_user) | default(lookup('env', 'USER')) }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
  when: ssh_randomize_port | bool
  run_once: true

- name: Create temporary file with SSH connection info
  copy:
    content: |
      ---
      ssh_connection:
        hostname: "{{ ssh_connection_info.hostname }}"
        port: "{{ ssh_connection_info.port }}"
        username: "{{ ssh_connection_info.username }}"
        timestamp: "{{ ssh_connection_info.timestamp }}"
    dest: "/tmp/ssh_connection_info_{{ inventory_hostname }}.yml"
  when: ssh_randomize_port | bool
  run_once: true
  delegate_to: localhost

- name: Encrypt SSH connection info with SOPS
  command: sops -e /tmp/ssh_connection_info_{{ inventory_hostname }}.yml > /tmp/ssh_connection_info_{{ inventory_hostname }}.sops.yml
  when: ssh_randomize_port | bool and encryption_method == 'sops'
  run_once: true
  delegate_to: localhost
  failed_when: false  # Continue even if sops is not available

- name: Encrypt SSH connection info with Ansible Vault
  command: ansible-vault encrypt /tmp/ssh_connection_info_{{ inventory_hostname }}.yml --output=/tmp/ssh_connection_info_{{ inventory_hostname }}.vault.yml
  when: ssh_randomize_port | bool and encryption_method == 'vault'
  run_once: true
  delegate_to: localhost
  failed_when: false  # Continue even if vault is not available

- name: Rsync encrypted SSH connection info to specified destination
  synchronize:
    src: "/tmp/ssh_connection_info_{{ inventory_hostname }}.sops.yml"
    dest: "{{ ssh_rsync_destination }}"
    mode: pull
  when: 
    - ssh_randomize_port | bool
    - ssh_rsync_destination != ""
    - encryption_method == 'sops'
  run_once: true
  delegate_to: localhost

- name: Rsync encrypted SSH connection info to specified destination (vault)
  synchronize:
    src: "/tmp/ssh_connection_info_{{ inventory_hostname }}.vault.yml"
    dest: "{{ ssh_rsync_destination }}"
    mode: pull
  when: 
    - ssh_randomize_port | bool
    - ssh_rsync_destination != ""
    - encryption_method == 'vault'
  run_once: true
  delegate_to: localhost

- name: Clean up temporary files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "/tmp/ssh_connection_info_{{ inventory_hostname }}.yml"
    - "/tmp/ssh_connection_info_{{ inventory_hostname }}.sops.yml"
    - "/tmp/ssh_connection_info_{{ inventory_hostname }}.vault.yml"
  when: ssh_randomize_port | bool
  run_once: true
  delegate_to: localhost

- name: Enable SSH key rotation if enabled
  debug:
    msg: "SSH key rotation is enabled and will rotate keys every {{ ssh_key_rotation_interval_days }} days"
  when: ssh_key_rotation_enabled | bool

- name: Schedule SSH key rotation task
  cron:
    name: "Rotate SSH host keys"
    minute: "0"
    hour: "2"
    day: "*/{{ ssh_key_rotation_interval_days }}"
    job: "/usr/local/bin/rotate_ssh_keys.sh"
    state: present
  when: ssh_key_rotation_enabled | bool

- name: Create SSH key rotation script
  copy:
    content: |
      #!/bin/bash
      # Script to rotate SSH host keys
      
      # Backup current keys
      mkdir -p /etc/ssh/backup/$(date +%Y%m%d_%H%M%S)
      cp /etc/ssh/ssh_host_* /etc/ssh/backup/$(date +%Y%m%d_%H%M%S)/
      
      # Remove old keys
      rm -f /etc/ssh/ssh_host_*
      
      # Generate new keys
      dpkg-reconfigure openssh-server 2>/dev/null || {
        ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key -N ""
        ssh-keygen -t ecdsa -b 256 -f /etc/ssh/ssh_host_ecdsa_key -N ""
        ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N ""
      }
      
      # Set proper permissions
      chmod 600 /etc/ssh/ssh_host_*
      chmod 644 /etc/ssh/ssh_host_*.pub
      
      # Restart SSH service
      systemctl restart sshd
    dest: /usr/local/bin/rotate_ssh_keys.sh
    mode: '0700'
  when: ssh_key_rotation_enabled | bool

- name: Ensure TMUX session is available for deployment
  shell: |
    if ! tmux has-session -t {{ tmux_session_name }} 2>/dev/null; then
      tmux new-session -d -s {{ tmux_session_name }}
    fi
  when: tmux_session_for_deployment | bool
  ignore_errors: true  # Don't fail if tmux isn't available