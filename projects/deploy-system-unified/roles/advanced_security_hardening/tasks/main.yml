---
# Advanced security hardening with secure patterns for Deploy-System-Unified

- name: Validate advanced security hardening prerequisites (idempotent)
  ansible.builtin.assert:
    that:
      - advanced_security_hardening_enabled | default(false)
    fail_msg: "Advanced security hardening not enabled - skipping configuration"

- name: Create secure temporary directory for advanced security operations (idempotent)
  ansible.builtin.tempfile:
    state: directory
    suffix: advanced_security
  register: advanced_security_temp_dir
  become: true

- name: Set secure permissions on advanced security temporary directory (idempotent)
  ansible.builtin.file:
    path: "{{ advanced_security_temp_dir.path }}"
    mode: '0700'
    owner: root
    group: root
  become: true

- name: Generate random SSH port if enabled (idempotent)
  ansible.builtin.set_fact:
    random_ssh_port: "{{ ((ssh_random_port_range_start | int) + (999999 | random)) % ((ssh_random_port_range_end | int) - (ssh_random_port_range_start | int) + 1) + (ssh_random_port_range_start | int) }}"
  when: ssh_randomize_port | bool
  delegate_to: localhost
  run_once: true

- name: Update SSH configuration with random port (idempotent)
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^Port '
    line: "Port {{ random_ssh_port }}"
    validate: '/usr/sbin/sshd -t -f %s'
  when: ssh_randomize_port | bool
  notify: restart sshd
  no_log: true

- name: Create SSH connection info (idempotent)
  ansible.builtin.set_fact:
    ssh_connection_info:
      hostname: "{{ inventory_hostname }}"
      port: "{{ random_ssh_port if ssh_randomize_port | bool else access_sshd_port }}"
      username: "{{ ansible_user | default(ansible_ssh_user) | default(lookup('env', 'USER')) }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
  when: ssh_randomize_port | bool
  run_once: true

- name: Create secure temporary file with SSH connection info (idempotent)
  ansible.builtin.shell: |
    # Create secure temporary file with restrictive permissions in secure temp directory
    temp_file=$(mktemp -p "{{ secure_temp_dir.path | default(advanced_security_temp_dir.path | default('/tmp')) }}" -t "ssh_connection_info_{{ inventory_hostname }}_XXXXXX")
    chmod 600 "$temp_file"
    
    # Write connection info to secure temporary file
    cat > "$temp_file" << 'EOF'
    ---
    ssh_connection:
      hostname: "{{ ssh_connection_info.hostname }}"
      port: "{{ ssh_connection_info.port }}"
      username: "{{ ssh_connection_info.username }}"
      timestamp: "{{ ssh_connection_info.timestamp }}"
EOF
    
    # Encrypt the file using SOPS if available, otherwise Vault
    if command -v sops >/dev/null 2>&1; then
      encrypted_file="${temp_file}.sops.yml"
      sops -e "$temp_file" > "$encrypted_file"
    elif command -v ansible-vault >/dev/null 2>&1; then
      encrypted_file="${temp_file}.vault.yml"
      ansible-vault encrypt "$temp_file" --output="$encrypted_file"
    else
      echo "ERROR: No encryption tool available"
      exit 1
    fi
    
    # Verify encryption succeeded
    if [ -f "$encrypted_file" ] && [ -s "$encrypted_file" ]; then
      echo "ENCRYPTED_FILE:$encrypted_file"
    else
      echo "ERROR: Encryption failed"
      exit 1
    fi
    
    # Clean up temporary file
    rm -f "$temp_file"
  register: temp_file_creation
  changed_when: false
  failed_when: temp_file_creation.rc != 0 or 'TEMP_FILE:' not in temp_file_creation.stdout
  when: ssh_randomize_port | bool
  run_once: true
  delegate_to: localhost
  no_log: true

- name: Verify secure temp file creation (idempotent)
  ansible.builtin.assert:
    that:
      - "'TEMP_FILE:' in temp_file_creation.stdout"
    fail_msg: "Secure temporary file creation failed"
  when: ssh_randomize_port | bool
  run_once: true

- name: Verify encryption of secure temp file (idempotent)
  ansible.builtin.assert:
    that:
      - "'ENCRYPTED_FILE:' in temp_file_creation.stdout"
    fail_msg: "Encryption of temporary SSH info failed - deployment halted"
  when: ssh_randomize_port | bool
  run_once: true

- name: Rsync encrypted SSH connection info to specified destination (idempotent)
  ansible.builtin.synchronize:
    src: "{{ temp_file_creation.stdout.split('ENCRYPTED_FILE:')[1].strip() }}"
    dest: "{{ ssh_rsync_destination }}"
    mode: pull
  when: 
    - ssh_randomize_port | bool
    - ssh_rsync_destination != ""
    - temp_file_creation.stdout.split('ENCRYPTED_FILE:')[1].strip() is defined
  run_once: true
  delegate_to: localhost

- name: Enable SSH key rotation if enabled (idempotent)
  ansible.builtin.debug:
    msg: "SSH key rotation is enabled and will rotate keys every {{ ssh_key_rotation_interval_days }} days"
  when: ssh_key_rotation_enabled | bool

- name: Schedule SSH key rotation task (idempotent)
  ansible.builtin.cron:
    name: "Rotate SSH host keys"
    minute: "0"
    hour: "2"
    day: "*/{{ ssh_key_rotation_interval_days }}"
    job: "/usr/local/bin/rotate_ssh_keys.sh"
    state: present
  when: ssh_key_rotation_enabled | bool

- name: Create SSH key rotation script with secure permissions (idempotent)
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      # Script to rotate SSH host keys securely
      
      # Backup current keys
      backup_dir="/etc/ssh/backup/$(date +%Y%m%d_%H%M%S)"
      mkdir -p "$backup_dir"
      cp /etc/ssh/ssh_host_* "$backup_dir/" 2>/dev/null || true
      
      # Remove old keys
      rm -f /etc/ssh/ssh_host_*
      
      # Generate new keys with secure permissions
      if command -v dpkg-reconfigure >/dev/null 2>&1; then
        dpkg-reconfigure openssh-server 2>/dev/null || {
          ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key -N "" -C "Generated by Deploy-System-Unified"
          ssh-keygen -t ecdsa -b 256 -f /etc/ssh/ssh_host_ecdsa_key -N "" -C "Generated by Deploy-System-Unified"
          ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N "" -C "Generated by Deploy-System-Unified"
        }
      else
        ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key -N "" -C "Generated by Deploy-System-Unified"
        ssh-keygen -t ecdsa -b 256 -f /etc/ssh/ssh_host_ecdsa_key -N "" -C "Generated by Deploy-System-Unified"
        ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N "" -C "Generated by Deploy-System-Unified"
      fi
      
      # Set proper permissions
      chmod 600 /etc/ssh/ssh_host_*
      chmod 644 /etc/ssh/ssh_host_*.pub
      
      # Restart SSH service
      systemctl restart sshd
    dest: /usr/local/bin/rotate_ssh_keys.sh
    mode: '0700'
    owner: root
    group: root
  when: ssh_key_rotation_enabled | bool

- name: Ensure TMUX session is available for deployment (idempotent)
  ansible.builtin.shell: |
    if command -v tmux >/dev/null 2>&1; then
      if ! tmux has-session -t "{{ tmux_session_name }}" 2>/dev/null; then
        tmux new-session -d -s "{{ tmux_session_name }}"
        echo "SESSION_CREATED:true"
      else
        echo "SESSION_EXISTS:true"
      fi
    else
      echo "TMUX_AVAILABLE:false"
    fi
  register: tmux_session_check
  changed_when: "'SESSION_CREATED:true' in tmux_session_check.stdout"
  when: tmux_session_for_deployment | bool

- name: Validate TMUX session creation (idempotent)
  ansible.builtin.assert:
    that:
      - "'SESSION_CREATED:true' in tmux_session_check.stdout or 'SESSION_EXISTS:true' in tmux_session_check.stdout or 'TMUX_AVAILABLE:false' in tmux_session_check.stdout"
    fail_msg: "TMUX session creation failed - deployment may have reduced functionality"
  when: tmux_session_for_deployment | bool

- name: Clean up advanced security temporary directory (idempotent)
  ansible.builtin.file:
    path: "{{ advanced_security_temp_dir.path }}"
    state: absent
  become: true
  when: advanced_security_temp_dir.path is defined