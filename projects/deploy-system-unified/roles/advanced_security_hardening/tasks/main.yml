---
# Advanced security hardening with secure patterns for Deploy-System-Unified

- name: Validate advanced security hardening prerequisites (idempotent)
  ansible.builtin.assert:
    that:
      - advanced_security_hardening_enabled | default(false)
    msg: "Advanced security hardening not enabled - skipping configuration"

- name: Create secure temporary directory for advanced security operations (idempotent)
  ansible.builtin.tempfile:
    state: directory
    suffix: advanced_security
  register: advanced_security_hardening_temp_dir
  become: true

- name: Set secure permissions on advanced security temporary directory (idempotent)
  ansible.builtin.file:
    path: "{{ advanced_security_temp_dir.path }}"
    mode: '0700'
    owner: root
    group: root
  become: true

- name: Compute SSH port range bounds (idempotent)
  ansible.builtin.set_fact:
    advanced_security_hardening_ssh_range_start: "{{ ssh_random_port_range_start | int }}"
    advanced_security_hardening_ssh_range_end: "{{ ssh_random_port_range_end | int }}"
  when: ssh_randomize_port | bool
  delegate_to: localhost
  run_once: true

- name: Generate random SSH port if enabled (idempotent)
  ansible.builtin.set_fact:
    advanced_security_hardening_random_ssh_port: >-
      {{ ((advanced_security_hardening_ssh_range_start | int) + (999999 | random)) %
         ((advanced_security_hardening_ssh_range_end | int) - (advanced_security_hardening_ssh_range_start | int) + 1)
         + (advanced_security_hardening_ssh_range_start | int) }}
  when: ssh_randomize_port | bool
  delegate_to: localhost
  run_once: true

- name: Update SSH configuration with random port (idempotent)
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^Port '
    line: "Port {{ advanced_security_hardening_random_ssh_port }}"
    validate: '/usr/sbin/sshd -t -f %s' 
  when: ssh_randomize_port | bool
  notify: restart sshd
  no_log: true

- name: Create SSH connection info (idempotent)
  ansible.builtin.set_fact:
    advanced_security_hardening_ssh_connection_info:
      hostname: "{{ inventory_hostname }}"
      port: "{{ advanced_security_hardening_random_ssh_port if ssh_randomize_port | bool else access_sshd_port }}"
      username: "{{ ansible_user | default(ansible_ssh_user) | default(lookup('env', 'USER')) }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
  when: ssh_randomize_port | bool
  run_once: true

- name: Create secure temporary file on controller for SSH connection info (idempotent)
  ansible.builtin.tempfile:
    state: file
    prefix: "ssh_connection_info_{{ inventory_hostname | regex_replace('[^A-Za-z0-9_-]', '_') }}_"
    suffix: ".yml"
  register: advanced_security_hardening_temp_file
  delegate_to: localhost
  run_once: true
  no_log: true

- name: Set secure permissions on advanced security temporary file (idempotent)
  ansible.builtin.file:
    path: "{{ advanced_security_hardening_temp_file.path }}"
    mode: '0600'
    owner: root
    group: root
  delegate_to: localhost
  when: ssh_randomize_port | bool
  run_once: true

- name: Copy SSH connection info to secure temp file (idempotent)
  ansible.builtin.copy:
    dest: "{{ advanced_security_hardening_temp_file.path }}"
    content: |
      ---
      ssh_connection:
        hostname: "{{ advanced_security_hardening_ssh_connection_info.hostname }}"
        port: "{{ advanced_security_hardening_ssh_connection_info.port }}"
        username: "{{ advanced_security_hardening_ssh_connection_info.username }}"
        timestamp: "{{ advanced_security_hardening_ssh_connection_info.timestamp }}"
    mode: '0600'
    owner: root
    group: root
  delegate_to: localhost
  register: advanced_security_hardening_temp_file_written
  changed_when: false
  no_log: true
  when: ssh_randomize_port | bool
  run_once: true

- name: Encrypt SSH connection info with SOPS (idempotent)
  ansible.builtin.shell: |
    encrypted_file="{{ advanced_security_hardening_temp_file.path }}.sops.yml"
    sops -e "{{ advanced_security_hardening_temp_file.path }}" > "$encrypted_file"
  register: advanced_security_hardening_sops_encryption
  changed_when: false
  failed_when: advanced_security_hardening_sops_encryption.rc != 0
  delegate_to: localhost
  when:
    - ssh_randomize_port | bool
    - encryption_method == 'sops'
    - advanced_security_hardening_temp_file is defined
  no_log: true
  run_once: true

- name: Verify SOPS encryption succeeded and set path (idempotent)
  ansible.builtin.stat:
    path: "{{ advanced_security_hardening_temp_file.path }}.sops.yml"
  register: advanced_security_hardening_sops_encrypted_stat
  delegate_to: localhost
  changed_when: false
  when: encryption_method == 'sops' and ssh_randomize_port | bool
  run_once: true

- name: Set encrypted SSH info path for sops (idempotent)
  ansible.builtin.set_fact:
    advanced_security_hardening_encrypted_ssh_info_path: "{{ advanced_security_hardening_temp_file.path }}.sops.yml"
  when:
    - encryption_method == 'sops'
    - advanced_security_hardening_sops_encrypted_stat is defined
    - advanced_security_hardening_sops_encrypted_stat.stat.exists
  delegate_to: localhost
  run_once: true

- name: Encrypt SSH connection info with Ansible Vault (idempotent)
  ansible.builtin.shell: |
    encrypted_file="{{ advanced_security_hardening_temp_file.path }}.vault.yml"
    ansible-vault encrypt "{{ advanced_security_hardening_temp_file.path }}" --output="$encrypted_file"
  register: advanced_security_hardening_vault_encryption
  changed_when: false
  failed_when: advanced_security_hardening_vault_encryption.rc != 0
  delegate_to: localhost
  when:
    - ssh_randomize_port | bool
    - encryption_method == 'vault'
    - advanced_security_hardening_temp_file is defined
  no_log: true
  run_once: true

- name: Verify Vault encryption succeeded and set path (idempotent)
  ansible.builtin.stat:
    path: "{{ advanced_security_hardening_temp_file.path }}.vault.yml"
  register: advanced_security_hardening_vault_encrypted_stat
  delegate_to: localhost
  changed_when: false
  when: encryption_method == 'vault' and ssh_randomize_port | bool
  run_once: true

- name: Set encrypted SSH info path for vault (idempotent)
  ansible.builtin.set_fact:
    advanced_security_hardening_encrypted_ssh_info_path: "{{ advanced_security_hardening_temp_file.path }}.vault.yml"
  when:
    - encryption_method == 'vault'
    - advanced_security_hardening_vault_encrypted_stat is defined
    - advanced_security_hardening_vault_encrypted_stat.stat.exists
  delegate_to: localhost
  run_once: true

- name: Verify encryption succeeded (idempotent)
  ansible.builtin.assert:
    that:
      - advanced_security_hardening_encrypted_ssh_info_path is defined
      - advanced_security_hardening_encrypted_ssh_info_path | length > 0
    msg: "Encryption of temporary SSH info failed - deployment halted"
  when: ssh_randomize_port | bool
  run_once: true

- name: Clean up plaintext temporary SSH file (idempotent)
  ansible.builtin.file:
    path: "{{ advanced_security_hardening_temp_file.path }}"
    state: absent
  delegate_to: localhost
  when: ssh_randomize_port | bool
  run_once: true


- name: Rsync encrypted SSH connection info to specified destination (idempotent)
  ansible.posix.synchronize:
    src: "{{ advanced_security_hardening_encrypted_ssh_info_path }}"
    dest: "{{ ssh_rsync_destination }}"
    mode: pull
  when: 
    - ssh_randomize_port | bool
    - ssh_rsync_destination != ""
    - advanced_security_hardening_encrypted_ssh_info_path is defined
    - advanced_security_hardening_encrypted_ssh_info_path | length > 0
  run_once: true
  delegate_to: localhost

- name: Enable SSH key rotation if enabled (idempotent)
  ansible.builtin.debug:
    msg: "SSH key rotation is enabled and will rotate keys every {{ ssh_key_rotation_interval_days }} days"
  when: ssh_key_rotation_enabled | bool

- name: Schedule SSH key rotation task (idempotent)
  ansible.builtin.cron:
    name: "Rotate SSH host keys"
    minute: "0"
    hour: "2"
    day: "*/{{ ssh_key_rotation_interval_days }}"
    job: "/usr/local/bin/rotate_ssh_keys.sh"
    state: present
  when: ssh_key_rotation_enabled | bool

- name: Create SSH key rotation script with secure permissions (idempotent)
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      # Script to rotate SSH host keys securely
      
      # Backup current keys
      backup_dir="/etc/ssh/backup/$(date +%Y%m%d_%H%M%S)"
      mkdir -p "$backup_dir"
      cp /etc/ssh/ssh_host_* "$backup_dir/" 2>/dev/null || true
      
      # Remove old keys
      rm -f /etc/ssh/ssh_host_*
      
      # Generate new keys with secure permissions
      if command -v dpkg-reconfigure >/dev/null 2>&1; then
        dpkg-reconfigure openssh-server 2>/dev/null || {
          ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key -N "" -C "Generated by Deploy-System-Unified"
          ssh-keygen -t ecdsa -b 256 -f /etc/ssh/ssh_host_ecdsa_key -N "" -C "Generated by Deploy-System-Unified"
          ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N "" -C "Generated by Deploy-System-Unified"
        }
      else
        ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key -N "" -C "Generated by Deploy-System-Unified"
        ssh-keygen -t ecdsa -b 256 -f /etc/ssh/ssh_host_ecdsa_key -N "" -C "Generated by Deploy-System-Unified"
        ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N "" -C "Generated by Deploy-System-Unified"
      fi
      
      # Set proper permissions
      chmod 600 /etc/ssh/ssh_host_*
      chmod 644 /etc/ssh/ssh_host_*.pub
      
      # Restart SSH service
      systemctl restart sshd
    dest: /usr/local/bin/rotate_ssh_keys.sh
    mode: '0700'
    owner: root
    group: root
  when: ssh_key_rotation_enabled | bool

- name: Ensure TMUX session is available for deployment (idempotent)
  ansible.builtin.shell: |
    if command -v tmux >/dev/null 2>&1; then
      if ! tmux has-session -t "{{ tmux_session_name }}" 2>/dev/null; then
        tmux new-session -d -s "{{ tmux_session_name }}"
        echo "SESSION_CREATED:true"
      else
        echo "SESSION_EXISTS:true"
      fi
    else
      echo "TMUX_AVAILABLE:false"
    fi
  register: advanced_security_hardening_tmux_session_check
  changed_when: "'SESSION_CREATED:true' in advanced_security_hardening_tmux_session_check.stdout"
  when: tmux_session_for_deployment | bool

- name: Set TMUX session validity fact (idempotent)
  ansible.builtin.set_fact:
    advanced_security_hardening_tmux_session_ok: >-
      {{ ('SESSION_CREATED:true' in advanced_security_hardening_tmux_session_check.stdout)
         or ('SESSION_EXISTS:true' in advanced_security_hardening_tmux_session_check.stdout)
         or ('TMUX_AVAILABLE:false' in advanced_security_hardening_tmux_session_check.stdout) }}
  when: tmux_session_for_deployment | bool

- name: Validate TMUX session creation (idempotent)
  ansible.builtin.assert:
    that:
      - advanced_security_hardening_tmux_session_ok | bool
    msg: "TMUX session creation failed - deployment may have reduced functionality"
  when: tmux_session_for_deployment | bool

- name: Clean up advanced security temporary directory (idempotent)
  ansible.builtin.file:
    path: "{{ advanced_security_temp_dir.path }}"
    state: absent
  become: true
  when: advanced_security_temp_dir.path is defined
