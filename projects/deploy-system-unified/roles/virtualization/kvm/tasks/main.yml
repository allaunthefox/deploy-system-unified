---
# Tasks for virtualization/kvm - Virtualization Layer
- name: Assign Hypervisor Instance UUID
  ansible.builtin.import_role:
    name: core/identity
- name: Install QEMU and KVM virtualization packages
  ansible.builtin.package:
    name:
      - qemu-kvm
      - qemu-utils # Provides qemu-img and qemu-nbd
      - libvirt-daemon-system
      - libvirt-clients
      - bridge-utils
      - virt-manager
      - ovmf # UEFI support for VMs
      - libguestfs-tools # Provides guestfish for disk manipulation
      - swtpm # Software TPM emulator
      - swtpm-tools
    state: present
  become: true
- name: Report TPM Status
  ansible.builtin.debug:
    msg: |
      {% if has_hardware_tpm | default(false) %}
      Hardware TPM detected. Physical pass-through is available for guests.
      {% else %}
      Hardware TPM not detected. QEMU will use software emulation (swtpm) for guests.
      {% endif %}
- name: Ensure NBD kernel module is loaded (Disk Mounting)
  community.general.modprobe:
    name: nbd
    params: 'max_part=8'
    state: present
  become: true
- name: Ensure KVM kernel modules are loaded
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - kvm
    - kvm_intel # Assumes Intel, role logic could branch for AMD
    - vhost_net
  become: true
  ignore_errors: true
- name: Enable and start libvirtd service
  ansible.builtin.systemd:
    name: libvirtd
    enabled: true
    state: started
  become: true
- name: Configure QEMU security settings (Restrictive)
  ansible.builtin.lineinfile:
    path: /etc/libvirt/qemu.conf
    regexp: "^#?{{ item.key }} ="
    line: '{{ item.key }} = "{{ item.value }}"'
  loop:
    - { key: 'user', value: 'libvirt-qemu' }
    - { key: 'group', value: 'libvirt-qemu' }
    - { key: 'dynamic_ownership', value: '0' }
  become: true
  notify: restart libvirtd
