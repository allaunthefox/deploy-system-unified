---
# Security-first main playbook for Deploy-System-Unified with directory precreation first

- name: Deploy secure unified system with directory precreation first
  hosts: all
  become: true
  
  pre_tasks:
    - name: Precreate required directories (idempotent)
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        mode: "{{ item.mode | default('0755') }}"
        owner: "{{ item.owner | default('root') }}"
        group: "{{ item.group | default('root') }}"
      loop:
        - { path: "/var/lib/deploy-system", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/var/lib/deploy-system/checkpoints", mode: '0700', owner: 'root', group: 'root' }
        - { path: "/var/lib/deploy-system/backups", mode: '0700', owner: 'root', group: 'root' }
        - { path: "/var/lib/deploy-system/logs", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/etc/landlock", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/etc/bubblewrap", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/etc/firejail", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/etc/chrony", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/etc/trivy", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/etc/trufflehog", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/etc/checkov", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/tmp/deploy-system", mode: '1777', owner: 'root', group: 'root' }
        - { path: "/srv/containers", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/srv/containers/config", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/srv/containers/data", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/srv/containers/secrets", mode: '0700', owner: 'root', group: 'root' }
        - { path: "/etc/security", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/etc/ssh", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/etc/ufw", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/etc/fail2ban", mode: '0755', owner: 'root', group: 'root' }
      become: true
      tags: [bootstrap, directories]

    - name: Set directory precreation flag (idempotent)
      ansible.builtin.set_fact:
        directories_precreated: true

    - name: Check if preflight validation already completed (idempotent)
      ansible.builtin.stat:
        path: /tmp/preflight_completed.flag
      register: preflight_flag

    - name: Include preflight checks if not already completed (idempotent)
      ansible.builtin.import_role:
        name: preflight
      when: not preflight_flag.stat.exists
      tags: [preflight]

    - name: Create preflight completion flag (idempotent)
      ansible.builtin.file:
        path: /tmp/preflight_completed.flag
        state: touch
        mode: '0644'
      when: not preflight_flag.stat.exists

  roles:
    - role: security_framework
      when: security_compliance_verified | default(false)

  post_tasks:
    - name: Enhanced security verification with proper syntax (idempotent)
      ansible.builtin.debug:
        msg: "System deployed with enhanced security posture including secure temp files, proper error handling, portable services, FQCN compliance, distribution-aware packages, and syntax-fixed tasks"
      when: security_framework_secure_temp_files_configured | default(false)

    - name: Final security verification (idempotent)
      ansible.builtin.debug:
        msg: "System deployed with verified security posture"
      when: security_compliance_verified