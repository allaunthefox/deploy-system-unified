---
# Base layer playbook for Deploy-System-Unified
# This provides the foundational setup that branches can extend

- name: Deploy base system foundation
  hosts: all
  become: true

  pre_tasks:
    - name: Precreate essential directories (idempotent)
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        mode: "{{ item.mode | default('0755') }}"
        owner: "{{ item.owner | default('root') }}"
        group: "{{ item.group | default('root') }}"
      loop:
        - { path: "/var/lib/deploy-system", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/var/lib/deploy-system/checkpoints", mode: '0700', owner: 'root', group: 'root' }
        - { path: "/var/lib/deploy-system/backups", mode: '0700', owner: 'root', group: 'root' }
        - { path: "/var/lib/deploy-system/logs", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/tmp/deploy-system", mode: '1777', owner: 'root', group: 'root' }
        - { path: "/etc/security", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/etc/ssh", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/etc/ufw", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/etc/fail2ban", mode: '0755', owner: 'root', group: 'root' }
      become: true
      tags: [bootstrap, directories]

    - name: Set directory precreation flag (idempotent)
      ansible.builtin.set_fact:
        directories_precreated: true

    - name: Check if preflight validation already completed (idempotent)
      ansible.builtin.stat:
        path: /tmp/preflight_completed.flag
      register: preflight_flag

    - name: Include preflight checks if not already completed (idempotent)
      ansible.builtin.import_role:
        name: preflight
      when: not preflight_flag.stat.exists
      tags: [preflight]

    - name: Create preflight completion flag (idempotent)
      ansible.builtin.file:
        path: /tmp/preflight_completed.flag
        state: touch
        mode: '0644'
      when: not preflight_flag.stat.exists

  # No roles in the base layer - these are added in branches

  post_tasks:
    - name: Base system verification (idempotent)
      ansible.builtin.debug:
        msg: "Base system deployed with essential directories and preflight validation completed"
      tags: [verification]
