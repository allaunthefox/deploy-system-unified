---
# Media Streaming Server - High Performance Media Configuration
# Based on: Contabo Cloud VPS 30 SSD (8 vCPU, 24 GB RAM, 800 GB SSD)
# Features: Full Media Stack (Jellyfin, *Arr), ZRAM/ZSwap Hybrid Tuning, Btrfs Optimization

- name: Sync with Cloud Provider (Contabo)
  hosts: all
  become: true
  roles:
    - role: ops/cloud_init
- ansible.builtin.import_playbook: base_hardened.yml

- name: System Hardware Validation
  hosts: all
  gather_facts: false
  roles:
    - role: hardware/firmware

- name: Deploy Media Streaming Workload
  hosts: all
  become: true
  vars:
    # VPS Provider Identification
    vps_provider: "contabo"
    sshd_allow_tcp_forwarding: false
    sshd_enable_trusted_group_exceptions: true
    sshd_trusted_groups: ['ssh-trusted']
    system_ssh_port: 2222

    # Rootless Podman (Bridge Networking Model)
    podman_rootless_enabled: true
    podman_rootless_user: "{{ system_admin_user | default('admin') }}"
    podman_rootless_user_home: "/home/{{ system_admin_user | default('admin') }}"
    podman_rootless_allow_privileged_ports: true
    podman_rootless_privileged_port_start: 80

    # Memory Tuning - Database Profile for SQLite (Jellyfin/Arr) Performance
    memory_workload_profile: "database"
    # Ensure ZRAM isn't choked by database profile's low swappiness (handled by auto-resolution, but explicit is good)
    # The 'database' profile defaults swappiness to 10. Auto-resolution bumps it to 60 if NO disk swap.
    # This server DOES have disk swap (default Contabo images usually do or we don't know).
    # If no disk swap, the role handles it. If disk swap exists, 10 is perfect to prefer RAM.

    # VM Tuning for Media Buffers
    vm_dirty_ratio: "10"
    vm_dirty_background_ratio: "5"
    vm_dirty_bytes: 4294967296          # 4GB Dirty Limit for massive file moves
    vm_dirty_background_bytes: 1073741824 # 1GB Background starting point

    # Btrfs Subvolume Configuration
    btrfs_subvolumes:
      - { path: "/@", mount_options: "rw,relatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvol=@" }
      - { path: "/@home", mount_options: "rw,relatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvol=@home" }
      - { path: "/@var", mount_options: "rw,relatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvol=@var" }
      - { path: "/@srv", mount_options: "rw,relatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvol=@srv" }

    # Firewall Configuration
    # We use a strict ingress policy (deny by default) but MUST allow forwarding for containers.
    firewall_enabled: true
    firewall_forward_policy: "ACCEPT" # Required for Podman CNI/Bridge functionality
    firewall_allowed_tcp_ports:
      - "{{ ssh_effective_port | default(system_ssh_port) | default(2222) }}"
      - 80
      - 443
      - 51413 # Transmission Peer
      # Internal ports (commented out as they are reverse-proxied)
      # - 8096  # Jellyfin
      # - 7878  # Radarr
      # - 8989  # Sonarr
      # - 9696  # Prowlarr
      # - 9091  # Transmission Web
    firewall_allowed_udp_ports:
      - 443
      - 51413 # Transmission Peer

  roles:
    # Container Runtime & Orchestration
    - role: containers/runtime
    - role: containers/quadlets
      vars:
        quadlet_network_name: "deploy-net"

    # Gateway & Application Stack
    - role: containers/caddy
      vars:
        caddy_acme_email: "admin@my-media-server.com"
        caddy_network: "deploy-net" # Caddy must join the same network

    - role: containers/authentik
      vars:
        authentik_network_name: "deploy-net"
        # SECURITY WARNING: These must be changed in production!
        authentik_secret_key: "change_me_to_random_string"
        authentik_pg_pass: "change_me_to_random_string"

    - role: containers/media
      vars:
        jellyfin_memory_max: 12G
        media_root_dir: /srv/media
        media_gatekeeper_mode: true
        media_hw_accel: false # Set to true if GPU/iGPU is available (/dev/dri)
        media_auth_provider: "authentik" # Enable Forward Auth
        media_domain: "home.lab"  # Replace with actual domain
        media_pod_network: "deploy-net" # Explicit matching required

    - role: containers/ops
      vars:
        ops_enable: true
        ops_domain: "home.lab"
        ops_pod_network: "deploy-net"
        # Enable Dashboard and Password Manager
        homarr_enable: true
        vaultwarden_enable: true
