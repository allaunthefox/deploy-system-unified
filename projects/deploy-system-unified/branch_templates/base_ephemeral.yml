---
# Base Ephemeral Infrastructure - The Volatile Foundation
# This playbook handles zero-footprint infrastructure setup.

- name: Prepare Volatile Environment
  hosts: all
  become: true
  pre_tasks:
    - name: Create RAM-backed volatile storage for secrets (Ephemeral only)
      ansible.builtin.mount:
        path: /var/lib/deploy-system/secrets
        src: tmpfs
        fstype: tmpfs
        opts: "size=64M,mode=0700"
        state: mounted
      tags: [security, ephemeral]

- ansible.builtin.import_playbook: base_hardened.yml

- name: Ephemeral Post-Processing
  hosts: all
  become: true
  post_tasks:
    - name: Create persistent deployment heartbeat (Audit Trail)
      ansible.builtin.shell: |
        # Log the deployment event with a chrony-verified timestamp and global ID
        logger -t "DEPLOY_SYSTEM_AUDIT" \
          "EVENT:EPHEMERAL_DEPLOY_START | ID:{{ deployment_id }} | STATUS:TIME_SYNC_VERIFIED_BY_CHRONY | TARGET:{{ inventory_hostname }}"
      become: true
      tags: [audit, ephemeral]

    - name: Securely shred temporary deployment artifacts (Ephemeral only)
      ansible.builtin.shell: |
        find /tmp/deploy_secrets* -type f -exec shred -u {} \; 2>/dev/null || true
        find /tmp/ssh_connection_info* -type f -exec shred -u {} \; 2>/dev/null || true
      delegate_to: localhost
      run_once: true
      tags: [cleanup, ephemeral]
