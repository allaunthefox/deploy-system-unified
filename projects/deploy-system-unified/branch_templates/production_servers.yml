---
# Production servers (balanced approach)
# When to use: Production environments where both security and stability are critical
# Example: Web servers, database servers, application servers

- import_playbook: ../main.yml

- name: Deploy secure production server
  hosts: all
  become: true
  vars:
    # Standard security hardening for production
    advanced_security_hardening_enabled: true

    # Don't randomize SSH port in production (complicates monitoring and access)
    ssh_randomize_port: false
    access_sshd_port: 2222  # Standard non-default port for production

    # Enable key rotation for long-running production systems
    ssh_key_rotation_enabled: true
    ssh_key_rotation_interval_days: 90

    # Ensure TMUX session is available during deployment
    tmux_session_for_deployment: true
    tmux_session_name: "prod-deployment"

    # Use SOPS for encryption
    encryption_method: "sops"

  roles:
    # Core system setup
    - role: core/bootstrap

    # Security hardening (main security measures)
    - role: security/hardening

    # SSH and access configuration
    - role: security/access
      access_sshd_port: "{{ access_sshd_port }}"

    # Container runtime setup (Podman)
    - role: containers/containers_runtime

    # Container configuration (Quadlet)
    - role: containers/containers_config

    # Container quadlet definitions
    - role: containers/containers_quadlets

    # Caddy reverse proxy for container services
    - role: containers/containers_caddy

    # Optional advanced security hardening (without port randomization)
    - role: advanced_security_hardening

  post_tasks:
    - name: Create production container directories
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        mode: "{{ item.mode }}"
        owner: "{{ item.owner | default('root') }}"
        group: "{{ item.group | default('root') }}"
      loop:
        - { path: "/srv/containers", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/srv/containers/config", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/srv/containers/data", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/srv/containers/secrets", mode: '0700', owner: 'root', group: 'root' }

  handlers:
    - name: Restart sshd
      systemd:
        name: sshd
        state: restarted
      listen: "restart sshd"

    - name: Restart caddy
      systemd:
        name: caddy
        state: restarted
      listen: "restart caddy"
