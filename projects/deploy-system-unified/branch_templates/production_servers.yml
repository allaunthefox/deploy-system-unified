---
# Production Container Host - Secure Solution Stack
# Solution: Base Hardened Infrastructure + Container Workload
- ansible.builtin.import_playbook: base_hardened.yml
- name: Deploy Production Container Workload
  hosts: all
  become: true
  roles:
    # Container Infrastructure Workload
    - role: hardware/sas
    - role: containers/runtime
    - role: containers/config
    - role: containers/quadlets
    - role: containers/caddy
    # Backup & Disaster Recovery
    - role: storage/backup/restic
    - role: storage/backup/rclone
    # Final Solution Integrity Verification
    - role: security/scanning
  post_tasks:
    - name: Create production container directories
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        mode: "{{ item.mode }}"
        owner: "{{ item.owner | default('root') }}"
        group: "{{ item.group | default('root') }}"
      loop:
        - { path: "/srv/containers", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/srv/containers/config", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/srv/containers/data", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/srv/containers/secrets", mode: '0700', owner: 'root', group: 'root' }
  handlers:
    - name: Restart caddy
      ansible.builtin.systemd:
        name: caddy
        state: restarted
      listen: "restart caddy"
