---
# Kubernetes GPU Node Deployment Template
# For Kubernetes nodes with GPU device plugin support (AI/ML, data processing)
# Features: GPU driver installation, Kubernetes device plugin deployment, node labeling

- ansible.builtin.import_playbook: base_hardened.yml
- name: Deploy Kubernetes GPU Node
  hosts: all
  become: true
  vars:
    k8s_gpu_roles:
      # Core system setup
      - core/bootstrap
      - core/identity
      - networking/firewall
      - security/hardening
      - security/access
      - ops/monitoring
      - core/logging

      # Hardware Support
      - hardware/firmware
      - role: hardware/gpu
        vars:
          gpu_stack_enable: true
          gpu_stack_vendor: "{{ containers_gpu_vendor | default('nvidia') }}"
          gpu_stack_mode: server

      # Kubernetes node setup
      - role: orchestration/k8s_node
        vars:
          k8s_gpu_device_plugins_enabled: true
          k8s_gpu_nvidia_device_plugin:
            enabled: true
            version: "v0.13.0"
            image: "nvcr.io/nvidia/k8s-device-plugin:v0.13.0"
          k8s_gpu_amd_device_plugin:
            enabled: false
            version: "v0.10.0"
            image: "rocm/k8s-device-plugin:v0.10.0"
          k8s_gpu_intel_device_plugin:
            enabled: false
            version: "v0.23.0"
            image: "intel/intel-gpu-plugin:v0.23.0"

      # GPU-specific configuration
      - role: containers/runtime
        vars:
          containers_enable_gpu_support: true
          containers_gpu_vendor: "nvidia"  # Set to "amd" or "intel" if needed
          containers_gpu_count: 1
          containers_gpu_slicing:
            strategy: "auto"
            auto_strategy:
              bare_metal: "mig"
              virtual_host: "sriov"
              virtual_guest: "passthrough"
            mig: { enabled: false, profiles: ["1g.5gb"] }
            time_slicing: { enabled: false, max_instances: 4 }
            sriov: { enabled: false, vf_count: 4 }
            level_zero: { enabled: false, partitions: [] }
            oneapi: { enabled: false, toolkit: "base", components: ["compiler", "mpi", "tbb"] }
            passthrough: { devices: [] }

  tasks:
    - name: Execute Kubernetes GPU Roles with Granular Checkpoints
      ansible.builtin.include_tasks: "{{ playbook_dir }}/../tasks/run_role.yml"
      loop: "{{ k8s_gpu_roles }}"
      loop_control:
        loop_var: role_item

  post_tasks:
    - name: Verify Kubernetes GPU device plugin status
      ansible.builtin.command:
        cmd: kubectl get daemonsets -n kube-system
      register: kube_device_plugins
      changed_when: false
      failed_when: false
      become: false

    - name: Verify GPU resources in Kubernetes
      ansible.builtin.shell:
        cmd: kubectl describe node {{ ansible_facts['hostname'] }} | grep -A 10 "Capacity"
      register: node_capacity
      changed_when: false
      failed_when: false
      become: false

    - name: Display GPU node information
      ansible.builtin.debug:
        msg: |
          Kubernetes GPU Node Deployment Complete
          Vendor: {{ containers_gpu_vendor | upper }}
          Device Plugins: {{ kube_device_plugins.stdout | default('No device plugins found') }}
          GPU Resources: {{ node_capacity.stdout | default('No GPU resources detected') }}
          Container Runtime: Podman with GPU support enabled
          Kubernetes GPU Support: {{ k8s_gpu_device_plugins_enabled }}
