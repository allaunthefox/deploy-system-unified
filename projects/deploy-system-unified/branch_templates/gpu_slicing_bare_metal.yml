---
# GPU Slicing Bare Metal Deployment Template
# For physical servers with GPU hardware slicing capabilities (A100, A30, H100)
# Features: NVIDIA MIG configuration, hardware isolation, high-performance GPU access
- ansible.builtin.import_playbook: main.yml

- name: Deploy GPU Slicing (Bare Metal)
  hosts: all
  become: true
  vars:
    gpu_roles:
      # Core system setup
      - core/bootstrap
      - core/identity
      - role: networking/physical
      - networking/firewall
      - security/hardening
      - security/access
      - ops/monitoring
      - core/logging

      # GPU Driver Stack (Must run before container runtime)
      - hardware/sas
      - role: hardware/gpu
        vars:
          gpu_stack_enable: true
          gpu_stack_vendor: nvidia
          gpu_stack_mode: server

      # GPU-specific configuration with MIG slicing
      - role: containers/runtime
        vars:
          containers_enable_gpu_support: true
          containers_gpu_vendor: "nvidia"  # Must be NVIDIA for MIG
          containers_gpu_count: 1
          containers_gpu_slicing:
            strategy: "mig"  # Use MIG for bare metal GPU slicing
            auto_strategy:
              bare_metal: "mig"
              virtual_host: "sriov"
              virtual_guest: "passthrough"
            mig: { enabled: true, profiles: ["1g.5gb"] }
            time_slicing: { enabled: false, max_instances: 4 }
            sriov: { enabled: false, vf_count: 4 }
            level_zero: { enabled: false, partitions: [] }
            oneapi: { enabled: false, toolkit: "base", components: ["compiler", "mpi", "tbb"] }
            passthrough: { devices: [] }

      - role: containers/quadlets
        vars:
          quadlet_enable_gpu_support: true
          quadlet_gpu_vendor: "nvidia"  # Must be NVIDIA for MIG
          quadlet_gpu_slicing:
            strategy: "mig"
            auto_strategy:
              bare_metal: "mig"
              virtual_host: "sriov"
              virtual_guest: "passthrough"
            mig: { enabled: true, profiles: ["1g.5gb"] }
            time_slicing: { enabled: false, max_instances: 4 }
            sriov: { enabled: false, vf_count: 4 }
            level_zero: { enabled: false, partitions: [] }
            oneapi: { enabled: false, toolkit: "base", components: ["compiler", "mpi", "tbb"] }
            passthrough: { devices: [] }
          quadlet_gpu_capabilities: []
          quadlet_container_gpu_config:
            ai_workload:
              devices: ["/dev/nvidia0"]
            data_processing:
              devices: ["/dev/nvidia0"]

  tasks:
    - name: Execute GPU Roles with Granular Checkpoints
      ansible.builtin.include_tasks: tasks/run_role.yml
      loop: "{{ gpu_roles }}"
      loop_control:
        loop_var: role_item


  post_tasks:
    - name: Verify MIG configuration
      ansible.builtin.command:
        cmd: nvidia-smi mig -lgi
      register: nvidia_mig_config
      changed_when: false
      failed_when: false
      become: true
      when: containers_gpu_vendor == "nvidia"

    - name: Verify GPU functionality
      ansible.builtin.command:
        cmd: nvidia-smi
      register: nvidia_smi_output
      changed_when: false
      failed_when: false
      become: false
      when: containers_gpu_vendor == "nvidia"

    - name: Display GPU slicing information
      ansible.builtin.debug:
        msg: |
          GPU Slicing (Bare Metal) Deployment Complete
          Vendor: {{ containers_gpu_vendor | upper }}
          Slicing Strategy: {{ containers_gpu_slicing.strategy }}
          MIG Profiles: {{ containers_gpu_slicing.mig.profiles }}
          MIG Configuration: {{ nvidia_mig_config.stdout | default('MIG not configured') }}
          GPU Device: {{ nvidia_smi_output.stdout | default('No GPU device detected') }}
          Container Runtime: Podman with GPU support enabled
          Quadlet GPU Support: {{ quadlet_enable_gpu_support }}
