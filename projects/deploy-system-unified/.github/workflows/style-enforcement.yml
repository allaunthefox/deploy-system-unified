---
name: Style Guide Enforcement
on:
  push:
    branches:
      - main
      - "ci/**"
  pull_request:
    branches:
      - main
  workflow_dispatch:
jobs:
  style-enforcement:
    name: Run style guide enforcement
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make script executable
        run: chmod +x dev_tools/tools/style-guide-enforcement/enforce_style_guide.sh
      - name: Install style tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint ripgrep fd-find shellcheck || true
          python -m pip install --upgrade pip || true
          python -m pip install --upgrade ansible-lint || true
      - name: Run style tooling unit tests
        run: |
          # Ensure pytest is available and run the new style tooling tests
          python -m pip install --upgrade pytest || true
          pytest -q dev_tools/tools/style-guide-enforcement/tests -q
      - name: Run enforcement (generate report)
        run: |
          set -o pipefail
          # Run in a way that always allows subsequent steps to run so we can upload the report
          ./dev_tools/tools/style-guide-enforcement/enforce_style_guide.sh --report || echo $? > .enforce_status
        continue-on-error: true
      - name: List reports
        run: ls -l dev_tools/tools/style-guide-enforcement || true

      - name: Upload compliance report
        uses: actions/upload-artifact@v4
        with:
          name: style-compliance-report
          path: dev_tools/tools/style-guide-enforcement/compliance_report_*.md
          retention-days: 30
      - name: Comment on PR with compliance report
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          report_file=$(ls -t dev_tools/tools/style-guide-enforcement/compliance_report_*.md 2>/dev/null | head -n1)
          if [ -z "$report_file" ]; then
            echo "No report found to post"
            exit 0
          fi

          # Extract summary info
          total_issues=$(grep -m1 "Total Issues:" "$report_file" | awk '{print $NF}' || echo "Unknown")
          fixed_issues=$(grep -m1 "Fixed:" "$report_file" | awk '{print $NF}' || echo "0")
          
          # Sanitize backticks
          report_content=$(sed 's/```/` ` `/g' "$report_file")
          
          status_icon="❌"
          if [ ! -f .enforce_status ]; then
            status_icon="✅"
          fi

          body=$(jq -Rs -n \
            --arg icon "$status_icon" \
            --arg total "$total_issues" \
            --arg fixed "$fixed_issues" \
            --arg content "$report_content" \
            --arg run_id "$GITHUB_RUN_ID" \
            '
            {
              body: (
                "### Style Guide Enforcement Summary " + $icon + "\n\n" +
                "- **Total Issues Detected:** " + $total + "\n" +
                "- **Automatically Fixed:** " + $fixed + "\n" +
                "- **Report Artifact:** [Download here](https://github.com/\(env.GITHUB_REPOSITORY)/actions/runs/\($run_id))\n\n" +
                "<details><summary>Click to expand full report</summary>\n\n" +
                "```\n" + $content + "\n```\n" +
                "</details>\n\n" +
                "Reply with `--fix` for auto-fix PR."
              )
            }
            ')
          curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/json" \
            --data "$body" "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/$PR_NUMBER/comments"
      - name: Fail if enforcement found issues
        run: |
          if [ -f .enforce_status ]; then
            echo "Style enforcement detected issues; failing job with code $(cat .enforce_status)"
            exit $(cat .enforce_status)
          fi
