name: Style Guide Enforcement

on:
  push:
    branches: [ main, 'ci/**' ]
  pull_request:
    branches: [ main ]

jobs:
  style-enforcement:
    name: Run style guide enforcement
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make script executable
        run: chmod +x dev_tools/tools/style-guide-enforcement/enforce_style_guide.sh

      - name: Run enforcement (generate report)
        run: |
          set -o pipefail
          # Run in a way that always allows subsequent steps to run so we can upload the report
          ./dev_tools/tools/style-guide-enforcement/enforce_style_guide.sh --report || echo $? > .enforce_status
        continue-on-error: true

      - name: List reports
        run: ls -l dev_tools/tools/style-guide-enforcement || true

      - name: Upload compliance report
        uses: actions/upload-artifact@v4
        with:
          name: style-compliance-report
          path: dev_tools/tools/style-guide-enforcement/compliance_report_*.md

      - name: Fail if enforcement found issues
        run: |
          if [ -f .enforce_status ]; then
            echo "Style enforcement detected issues; failing job with code $(cat .enforce_status)"
            exit $(cat .enforce_status)
          fi
