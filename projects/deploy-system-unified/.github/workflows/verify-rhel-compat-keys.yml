---
name: Verify RHEL-Compatible (AlmaLinux) GPG Keys
# Trigger: run_id=20260204T081737Z

# Manual trigger note:
# Run this workflow from Actions → "Verify RHEL-Compatible (AlmaLinux) GPG Keys" → Run workflow.
# Use for ad-hoc verification of NVIDIA & AMD ROCm GPG key checksum/fingerprint checks (AlmaLinux 9).

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
  push:
    paths:
      - 'roles/hardware/gpu/**'
      - 'tests/**'
      - '.github/workflows/verify-rhel-compat-keys.yml'
  pull_request:
    paths:
      - 'roles/hardware/gpu/**'
      - 'tests/**'
      - '.github/workflows/verify-rhel-compat-keys.yml'

jobs:
  verify-rhel-compat-keys:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Start AlmaLinux container
        run: |
          docker run -d --name rhel-test --privileged --cgroupns=host \
            -v "$PWD":/repo \
            -w /repo \
            almalinux:9 \
            /sbin/init

      - name: Install test deps in container
        run: |
          docker exec rhel-test bash -lc "dnf -y install python3 python3-pip gpg gpgme && python3 -m pip install --upgrade pip ansible"

      - name: Run key verification playbook (expected pass)
        run: |
          docker exec rhel-test bash -lc "set -euo pipefail; \
            curl -fsSL '${NVIDIA_KEY_URL}' -o /tmp/nvidia.pub; \
            curl -fsSL '${ROCM_KEY_URL}' -o /tmp/rocm.pub; \
            NVIDIA_SHA256=$(sha256sum /tmp/nvidia.pub | awk '{print $1}'); \
            ROCM_SHA256=$(sha256sum /tmp/rocm.pub | awk '{print $1}'); \
            NVIDIA_FPR=$(gpg --show-keys --with-colons /tmp/nvidia.pub | awk -F: '/^fpr:/ {print $10; exit}'); \
            ROCM_FPR=$(gpg --show-keys --with-colons /tmp/rocm.pub | awk -F: '/^fpr:/ {print $10; exit}'); \
            ansible-playbook -i tests/inventory/ci_rhel_compat.ini tests/validate_rhel_compat_gpg_keys.yml \
              -e test_verify_enabled=true \
              -e test_nvidia_key_url='${NVIDIA_KEY_URL}' \
              -e test_nvidia_key_sha256=$NVIDIA_SHA256 \
              -e test_nvidia_key_fingerprint=$NVIDIA_FPR \
              -e test_rocm_key_url='${ROCM_KEY_URL}' \
              -e test_rocm_key_sha256=$ROCM_SHA256 \
              -e test_rocm_key_fingerprint=$ROCM_FPR"
        env:
          NVIDIA_KEY_URL: https://developer.download.nvidia.com/compute/cuda/repos/rhel9/x86_64/D42D0685.pub
          ROCM_KEY_URL: https://repo.radeon.com/rocm/rocm.gpg.key

      - name: Run key verification playbook (expected fail with bad checksum)
        run: |
          set +e
          docker exec rhel-test bash -lc "ansible-playbook -i tests/inventory/ci_rhel_compat.ini tests/validate_rhel_compat_gpg_keys.yml \
            -e test_verify_enabled=true \
            -e test_nvidia_key_url='${NVIDIA_KEY_URL}' \
            -e test_nvidia_key_sha256='deadbeef' \
            -e test_nvidia_key_fingerprint='deadbeef' \
            -e test_rocm_key_url='${ROCM_KEY_URL}' \
            -e test_rocm_key_sha256='deadbeef' \
            -e test_rocm_key_fingerprint='deadbeef'"
          status=$?
          if [ $status -eq 0 ]; then
            echo "Expected failure but playbook succeeded"
            exit 1
          fi
          exit 0
        env:
          NVIDIA_KEY_URL: https://developer.download.nvidia.com/compute/cuda/repos/rhel9/x86_64/D42D0685.pub
          ROCM_KEY_URL: https://repo.radeon.com/rocm/rocm.gpg.key

      - name: Cleanup
        if: always()
        run: |
          docker rm -f rhel-test
