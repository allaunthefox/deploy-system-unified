# =============================================================================
# Audit Event Identifier: DSU-PLY-100839
# Last Updated: 2026-02-28
# =============================================================================
---
# ISO 27001 | Security Standard
- name: Validate secrets file permissions
  hosts: all
  become: true
  vars:
    secrets_services:
      - name: caddy
        unit_path: "{{ containers_systemd_dir }}/caddy.container"
        env_path: "{{ containers_secrets_dir }}/caddy.env"
      - name: authentik
        unit_path: "{{ containers_systemd_dir }}/authentik-server.container"
        env_path: "{{ containers_secrets_dir }}/authentik.env"
      - name: grafana
        unit_path: "{{ containers_systemd_dir }}/grafana.container"
        env_path: "{{ containers_secrets_dir }}/grafana.env"
  tasks:
    - name: Show secrets path resolution
      ansible.builtin.debug:
        msg:
          - "podman_rootless_enabled={{ podman_rootless_enabled | default('undefined') }}"
          - "containers_secrets_dir={{ containers_secrets_dir | default('undefined') }}"

    - name: Stat unit files
      ansible.builtin.stat:
        path: "{{ item.unit_path }}"
      loop: "{{ secrets_services }}"
      register: unit_stats

    - name: Stat secrets files
      ansible.builtin.stat:
        path: "{{ item.env_path }}"
      loop: "{{ secrets_services }}"
      register: secrets_stats

    - name: Assert secrets files exist and are 0600 for deployed services
      vars:
        unit_stat: "{{ (unit_stats.results | selectattr('item.name', 'equalto', item.name) | first).stat }}"
        env_stat: "{{ (secrets_stats.results | selectattr('item.name', 'equalto', item.name) | first).stat }}"
      ansible.builtin.assert:
        that:
          - env_stat.exists
          - env_stat.mode == "0600"
        fail_msg: "Secrets file {{ item.env_path }} is missing or not 0600 (mode={{ env_stat.mode | default('missing') }})"
        success_msg: "Secrets file {{ item.env_path }} is 0600"
      loop: "{{ secrets_services }}"
      when: unit_stat.exists
