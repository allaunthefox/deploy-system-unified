# =============================================================================
# Audit Event Identifier: DSU-PLY-100459
# Last Updated: 2026-02-28
# =============================================================================
---
# Tasks for core/memory - Intelligent Memory Compression
# CIS 3.4.x | STIG V-230310 | NIST SC-4, SC-28 | ISO 27001 §8.20

- name: "CIS 3.4.1 | STIG V-230310 | NIST SC-4 | Audit Code 810300 | Detect Physical Swap"
  ansible.builtin.shell: swapon --show=NAME --noheadings | wc -l
  register: physical_swap_count
  changed_when: false
  become: true
  tags:
    - cis_3_4_1
    - stig_v_230310
    - nist_sc_4
    - memory
    - detect
    - action_810300

- name: "CIS 3.4.1 | STIG V-230310 | NIST SC-4 | Audit Code 810300 | Determine Memory Strategy (Auto-Selection)"
  ansible.builtin.set_fact:
    active_memory_strategy: >-
      {{
        'zram' if (
           core_memory_compression_strategy == 'zram'  or
           (core_memory_compression_strategy == 'auto' and core_memory_shared_vram == true) or
           (core_memory_compression_strategy == 'auto' and core_memory_shared_vram == 'auto' and uma_detection.stdout == 'true') or
           (core_memory_compression_strategy == 'auto' and ansible_memtotal_mb < 8192) or
           (core_memory_compression_strategy == 'auto' and physical_swap_count.stdout | int == 0)
        ) else
        'zswap' if (
           core_memory_compression_strategy == 'zswap'  or
           (core_memory_compression_strategy == 'auto' and ansible_memtotal_mb >= 8192 and physical_swap_count.stdout | int > 0)
        ) else
        'none'
      }}
  tags:
    - cis_3_4_1
    - stig_v_230310
    - nist_sc_4
    - memory
    - strategy
    - action_810300

- name: "CIS 3.4.1 | STIG V-230310 | Audit Code 840030 | Report Selected Strategy"
  ansible.builtin.debug:
    msg: "System Memory: {{ ansible_memtotal_mb }}MB. Strategy Selected: {{ active_memory_strategy | upper }}"
  tags:
    - cis_3_4_1
    - stig_v_230310
    - memory
    - info
    - action_840030

- name: "CIS 3.4.1 | STIG V-230310 | NIST SC-4 | Audit Code 810300 | Resolve Configuration Conflicts (Intelligent Resolution)"
  ansible.builtin.set_fact:
    core_memory_swappiness: >-
      {{
        60 if (active_memory_strategy == 'zram' and physical_swap_count.stdout | int == 0 and core_memory_swappiness | int < 60)
        else core_memory_swappiness
      }}
    core_memory_thp_state: >-
      {{
        'madvise' if (core_memory_workload_profile == 'database' and core_memory_thp_state == 'always')
        else core_memory_thp_state
      }}
  tags:
    - cis_3_4_1
    - stig_v_230310
    - nist_sc_4
    - memory
    - configuration
    - action_810300

- name: "CIS 3.4.1 | STIG V-230310 | Audit Code 840030 | Validate Final Configuration"
  ansible.builtin.debug:
    msg: >-
      Conflict Resolution Applied:
      Swappiness set to {{ core_memory_swappiness }} (Reason: {{ 'ZRAM-OOM-Protection' if active_memory_strategy == 'zram' and physical_swap_count.stdout|int == 0 else 'Profile-Default' }}).
      THP set to {{ core_memory_thp_state }} (Reason: {{ 'Database-Latency-Protection' if core_memory_workload_profile == 'database' else 'User-Configured' }}).
  tags:
    - cis_3_4_1
    - stig_v_230310
    - memory
    - validate
    - action_840030

- name: "CIS 3.4.2 | STIG V-230310 | NIST SC-4, SC-28 | ISO 27001 §8.20 | Audit Code 450002 | Configure ZRAM (zram-generator)"
  when:
    - active_memory_strategy == 'zram'
    - (virt_type | default('container')) in ['bare-metal', 'virtual', 'vps']
  block:
    - name: "CIS 3.4.2 | STIG V-230310 | NIST SC-4 | Audit Code 530000 | Install zram-generator"
      ansible.builtin.package:
        name: zram-generator
        state: present
      become: true
      tags:
        - cis_3_4_2
        - stig_v_230310
        - nist_sc_4
        - memory
        - zram
        - remediate
        - action_530000

    - name: "CIS 3.4.2 | STIG V-230310 | NIST SC-28 | ISO 27001 §8.20 | Audit Code 450002 | Configure zram-generator.conf"
      ansible.builtin.copy:
        content: |
          [zram0]
          zram-size = {{ (ansible_memtotal_mb * (core_memory_zram_size_percent | float / 100)) | int }}
          compression-algorithm = {{ core_memory_zram_algorithm }}
          swap-priority = {{ core_memory_zram_priority }}
          fs-type = swap
        dest: /etc/systemd/zram-generator.conf
        mode: '0644'
      become: true
      notify: restart_systemd_zram_setup
      tags:
        - cis_3_4_2
        - stig_v_230310
        - nist_sc_28
        - iso_27001_8_20
        - memory
        - zram
        - remediate
        - action_450002
  tags:
    - cis_3_4_2
    - stig_v_230310
    - nist_sc_4
    - nist_sc_28
    - iso_27001_8_20
    - memory
    - remediate
    - action_450002

- name: "CIS 3.4.2 | STIG V-230310 | NIST SC-4, SC-28 | ISO 27001 §8.20 | Audit Code 450002 | Configure ZSwap (Kernel Modules)"
  when:
    - active_memory_strategy == 'zswap'
    - (virt_type | default('container')) in ['bare-metal', 'virtual', 'vps']
  block:
    - name: "CIS 3.4.2 | STIG V-230310 | NIST SC-4 | Audit Code 810300 | Enable ZSwap Kernel Parameters"
      ansible.builtin.set_fact:
        core_grub_performance_params: >-
          {{
            core_grub_performance_params | default([]) +
            [
              'zswap.enabled=1',
              'zswap.compressor=' ~ core_memory_zswap_compressor,
              'zswap.max_pool_percent=' ~ core_memory_zswap_max_pool_percent
            ]
          }}
      tags:
        - cis_3_4_2
        - stig_v_230310
        - nist_sc_4
        - memory
        - zswap
        - action_810300

    - name: "CIS 3.4.2 | STIG V-230310 | NIST SC-4 | Audit Code 810300 | Disable ZRAM (Conflict Avoidance)"
      ansible.builtin.systemd:
        name: systemd-zram-setup@zram0.service
        state: stopped
        enabled: false
      failed_when: false
      become: true
      tags:
        - cis_3_4_2
        - stig_v_230310
        - nist_sc_4
        - memory
        - zram
        - action_810300
  tags:
    - cis_3_4_2
    - stig_v_230310
    - nist_sc_4
    - nist_sc_28
    - iso_27001_8_20
    - memory
    - remediate
    - action_450002

- name: "CIS 3.4.2 | STIG V-230310 | NIST SC-4, SC-28 | ISO 27001 §8.20 | Audit Code 450002 | Tune Virtual Memory for Compression"
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: true
    sysctl_file: /etc/sysctl.d/99-memory-tuning.conf
  loop:
    - { key: 'vm.swappiness', value: '{{ core_memory_swappiness }}' }
    - { key: 'vm.vfs_cache_pressure', value: '{{ core_memory_cache_pressure }}' }
    - { key: 'vm.page-cluster', value: '0' }
    - { key: 'vm.dirty_bytes', value: '{{ core_memory_dirty_bytes }}', condition: "{{ core_memory_dirty_bytes | int > 0 }}" }
    - { key: 'vm.dirty_background_bytes', value: '{{ core_memory_dirty_background_bytes }}', condition: "{{ core_memory_dirty_background_bytes | int > 0 }}" }
  when:
    - (virt_type | default('container')) in ['bare-metal', 'virtual', 'vps']
    - active_memory_strategy != 'none' or core_memory_workload_profile == 'database'
  become: true
  tags:
    - cis_3_4_2
    - stig_v_230310
    - nist_sc_4
    - nist_sc_28
    - iso_27001_8_20
    - memory
    - remediate
    - action_450002

- name: "CIS 3.4.2 | STIG V-230310 | NIST SC-4 | Audit Code 810300 | Configure Transparent Huge Pages (THP)"
  ansible.builtin.shell: |
    if ! grep -q '\[{{ core_memory_thp_state }}\]' /sys/kernel/mm/transparent_hugepage/enabled; then
      echo {{ core_memory_thp_state }} > /sys/kernel/mm/transparent_hugepage/enabled
      echo {{ core_memory_thp_state }} > /sys/kernel/mm/transparent_hugepage/defrag
      echo "changed"
    fi
  register: thp_result
  changed_when: "'changed' in thp_result.stdout"
  become: true
  when:
    - core_memory_workload_profile != 'standard'
    - (virt_type | default('container')) in ['bare-metal', 'virtual', 'vps']
  tags:
    - cis_3_4_2
    - stig_v_230310
    - nist_sc_4
    - memory
    - thp
    - remediate
    - action_810300
