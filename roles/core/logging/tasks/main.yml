---
# Tasks for core/logging role - Mandatory Forensic Readiness
# CIS 4.2.x | STIG V-230330 | NIST AU-2, AU-3, AU-12 | ISO 27001 ยง12.4

- name: "CIS 4.2.1 | STIG V-230330 | NIST AU-2 | Install systemd-journal-remote for log aggregation readiness"
  ansible.builtin.package:
    name: "{{ logging_journal_remote_packages[ansible_facts['distribution'] | lower] | default('systemd-journal-remote') }}"
    state: present
  become: true
  failed_when: false # Some minimal distros might not have this package
  when: ansible_facts['service_mgr'] == 'systemd'
  changed_when: (ansible_facts['virtualization_role'] | default('host') == 'guest') and false
  tags:
    - cis_4_2_1
    - stig_v_230330
    - nist_au_2
    - logging
    - remediate

- name: "CIS 4.2.1 | STIG V-230330 | NIST AU-2 | Ensure journald directory exists for persistence"
  ansible.builtin.file:
    path: /var/log/journal
    state: directory
    mode: '0755'
    owner: root
    group: "{{ 'systemd-journal' if ansible_facts['service_mgr'] == 'systemd' else 'root' }}"
  become: true
  changed_when: (ansible_facts['virtualization_role'] | default('host') == 'guest') and false
  tags:
    - cis_4_2_1
    - stig_v_230330
    - nist_au_2
    - logging
    - remediate

- name: "CIS 4.2.1, 4.2.2 | STIG V-230330 | NIST AU-2, AU-3, AU-12 | ISO 27001 ยง12.4 | ISO 27037 | Action 840030 | Configure journald for forensic integrity and rate limiting"
  ansible.builtin.lineinfile:
    path: /etc/systemd/journald.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^#?Storage=', line: 'Storage=persistent' }
    - { regexp: '^#?Compress=', line: 'Compress=yes' }
    - { regexp: '^#?Seal=', line: 'Seal=yes' }
    - { regexp: '^#?ForwardToSyslog=', line: 'ForwardToSyslog=yes' }
    - { regexp: '^#?RateLimitIntervalSec=', line: 'RateLimitIntervalSec={{ logging_rate_limit_interval }}' }
    - { regexp: '^#?RateLimitBurst=', line: 'RateLimitBurst={{ logging_rate_limit_burst }}' }
    - { regexp: '^#?MaxFileSec=', line: 'MaxFileSec={{ logging_max_file_sec }}' }
    - { regexp: '^#?MaxRetentionSec=', line: 'MaxRetentionSec={{ logging_max_retention_sec }}' }
  become: true
  notify: restart_journald
  tags:
    - cis_4_2_1
    - cis_4_2_2
    - stig_v_230330
    - nist_au_2
    - nist_au_3
    - nist_au_12
    - iso_27001_12_4
    - iso_27037
    - remediate
    - high_severity
    - logging
  when: ansible_facts['service_mgr'] == 'systemd'
  changed_when: (ansible_facts['virtualization_role'] | default('host') == 'guest') and false

- name: "CIS 4.2.1 | STIG V-230330 | NIST AU-2 | Ensure rsyslog is installed (Alpine)"
  ansible.builtin.package:
    name: rsyslog
    state: present
  become: true
  tags:
    - cis_4_2_1
    - stig_v_230330
    - nist_au_2
    - logging
    - remediate
  when: ansible_facts['os_family'] == 'Alpine'

- name: "CIS 4.2.1 | STIG V-230330 | NIST AU-2 | Ensure rsyslog configuration directory exists (Generic)"
  ansible.builtin.file:
    path: /etc/rsyslog.d
    state: directory
    mode: '0755'
  become: true
  tags:
    - cis_4_2_1
    - stig_v_230330
    - nist_au_2
    - logging
    - remediate

- name: "CIS 4.2.2 | STIG V-230330 | NIST AU-2, AU-3 | ISO 27001 ยง12.4 | Action 840031 | Configure rsyslog for centralized log shipping (Generic)"
  ansible.builtin.copy:
    dest: /etc/rsyslog.d/50-centralized-logging.conf
    content: |
      # Centralized logging configuration
      *.* @@{{ logging_central_server | default('logs.example.com') }}:514
    mode: '0644'
  become: true
  tags:
    - cis_4_2_2
    - stig_v_230330
    - nist_au_2
    - nist_au_3
    - iso_27001_12_4
    - remediate
    - logging
  when: ansible_facts['os_family'] in ['Debian', 'RedHat', 'Alpine']
  notify: restart_rsyslog

- name: "CIS 4.2.1 | STIG V-230330 | NIST AU-2 | Ensure rsyslog is running and enabled (Generic)"
  ansible.builtin.service:
    name: rsyslog
    state: started
    enabled: true
  become: true
  when:
    - ansible_facts['os_family'] in ['Debian', 'RedHat', 'Alpine']
  tags:
    - cis_4_2_1
    - stig_v_230330
    - nist_au_2
    - logging
    - remediate

- name: VERIFY | Rsyslog service active (Zero-Tolerance)
  ansible.builtin.shell: |
    if command -v systemctl >/dev/null 2>&1; then
      systemctl is-active rsyslog
    else
      pgrep rsyslogd
    fi
  become: true
  when: ansible_facts['os_family'] in ['Debian', 'RedHat', 'Alpine']
  changed_when: false
  tags: [logging, verification]

- name: "CIS 4.2.1 | STIG V-230330 | NIST AU-2 | Determine log reload command"
  ansible.builtin.set_fact:
    _log_reload_cmd: >-
      {{
        '/usr/bin/systemctl reload rsyslog' if ansible_facts['service_mgr'] == 'systemd' else
        '/etc/init.d/rsyslog reload' if ansible_facts['os_family'] == 'Alpine' else
        '/bin/kill -HUP `cat /var/run/rsyslogd.pid 2> /dev/null` 2> /dev/null || true'
      }}
  tags:
    - cis_4_2_1
    - stig_v_230330
    - nist_au_2
    - logging
    - configuration

- name: "CIS 4.2.3 | STIG V-230330 | NIST AU-12 | ISO 27001 ยง12.4 | Create logrotate configuration for application logs"
  ansible.builtin.copy:
    dest: /etc/logrotate.d/applications
    content: |
      /var/log/*.log /var/log/*/*.log {
          daily
          missingok
          rotate 30
          compress
          delaycompress
          notifempty
          create 644 root root
          postrotate
              {{ _log_reload_cmd }} > /dev/null 2>&1 || true
          endscript
      }
    mode: '0644'
  become: true
  changed_when: (ansible_facts['virtualization_role'] | default('host') == 'guest') and false
  tags:
    - cis_4_2_3
    - stig_v_230330
    - nist_au_12
    - iso_27001_12_4
    - logging
    - remediate

- name: "CIS 4.2.1 | STIG V-230330 | NIST AU-2 | Validate journald configuration"
  ansible.builtin.command:
    cmd: journalctl --verify
  register: journal_verify
  changed_when: false
  failed_when: false
  become: true
  tags:
    - cis_4_2_1
    - stig_v_230330
    - nist_au_2
    - logging
    - verify

- name: "CIS 4.2.1 | STIG V-230330 | NIST AU-2 | Warn about journald verification issues"
  ansible.builtin.debug:
    msg: "WARNING: Journald verification found issues: {{ journal_verify.stderr }}"
  when: journal_verify.rc != 0 and journal_verify.stderr | length > 0
  tags:
    - cis_4_2_1
    - stig_v_230330
    - nist_au_2
    - logging
    - warning
