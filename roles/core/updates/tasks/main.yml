# =============================================================================
# Audit Event Identifier: DSU-PLY-100499
# Last Updated: 2026-02-28
# =============================================================================
---
# Tasks for core/updates - Automatic Security Patching
# CIS 3.3.x | STIG V-230280 | NIST SI-2, CM-2 | ISO 27001 §8.8, §8.9

- name: "CIS 3.3.1 | STIG V-230280 | NIST SI-2, CM-2 | ISO 27001 §8.8, §8.9 | Audit Code 530020 | Configure Unattended-Upgrades (Debian/Ubuntu)"
  block:
    - name: "CIS 3.3.1 | STIG V-230280 | NIST SI-2 | Install unattended-upgrades"
      ansible.builtin.apt:
        name: unattended-upgrades
        state: present
        update_cache: true
      register: apt_uu_result
      until: apt_uu_result is success
      retries: 5
      delay: 10
      tags:
        - cis_3_3_1
        - stig_v_230280
        - nist_si_2
        - updates
        - remediate
    - name: "CIS 3.3.1 | STIG V-230280 | NIST CM-2 | Ensure unattended-upgrades is enabled"
      ansible.builtin.copy:
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Unattended-Upgrade "1";
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        mode: '0644'
      tags:
        - cis_3_3_1
        - stig_v_230280
        - nist_cm_2
        - updates
        - remediate
  when: ansible_os_family == 'Debian'
  become: true
  tags:
    - cis_3_3_1
    - stig_v_230280
    - nist_si_2
    - nist_cm_2
    - iso_27001_8_8
    - iso_27001_8_9
    - updates
    - remediate

- name: "CIS 3.3.1 | STIG V-230280 | NIST SI-2, CM-2 | ISO 27001 §8.8, §8.9 | Audit Code 530020 | Configure DNF-Automatic (RedHat/Fedora)"
  block:
    - name: "CIS 3.3.1 | STIG V-230280 | NIST SI-2 | Install dnf-automatic"
      ansible.builtin.package:
        name: dnf-automatic
        state: present
      register: dnf_auto_result
      until: dnf_auto_result is success
      retries: 5
      delay: 10
      tags:
        - cis_3_3_1
        - stig_v_230280
        - nist_si_2
        - updates
        - remediate
    - name: "CIS 3.3.1 | STIG V-230280 | NIST CM-2 | Enable dnf-automatic timer"
      ansible.builtin.systemd:
        name: dnf-automatic.timer
        enabled: true
        state: started
      tags:
        - cis_3_3_1
        - stig_v_230280
        - nist_cm_2
        - updates
        - remediate
  when: ansible_os_family == 'RedHat'
  become: true
  tags:
    - cis_3_3_1
    - stig_v_230280
    - nist_si_2
    - nist_cm_2
    - iso_27001_8_8
    - iso_27001_8_9
    - updates
    - remediate

- name: "CIS 3.3.1 | STIG V-230280 | NIST SI-2 | ISO 27001 §8.9 | Configure Updates (Arch Linux)"
  block:
    - name: "CIS 3.3.1 | Ensure keyring is up to date (Arch)"
      community.general.pacman:
        name: archlinux-keyring
        state: latest
        update_cache: true
      when: not ansible_check_mode
      tags:
        - cis_3_3_1
        - stig_v_230280
        - updates
        - supply_chain
    - name: "CIS 3.3.1 | Warn about automatic updates on Rolling Release"
      ansible.builtin.debug:
        msg: "Skipping automatic system updates on Arch Linux. Rolling releases require manual intervention (pacman -Syu)."
      tags:
        - cis_3_3_1
        - stig_v_230280
        - updates
        - info
  when: ansible_distribution == 'Archlinux'
  become: true
  tags:
    - cis_3_3_1
    - stig_v_230280
    - nist_si_2
    - iso_27001_8_9
    - updates

- name: "CIS 3.3.1 | STIG V-230280 | NIST SI-2 | ISO 27001 §8.9 | Configure Updates (Alpine)"
  block:
    - name: "CIS 3.3.1 | Update package cache (Alpine)"
      community.general.apk:
        update_cache: true
      tags:
        - cis_3_3_1
        - stig_v_230280
        - updates
    - name: "CIS 3.3.1 | Run system upgrade (Alpine)"
      community.general.apk:
        upgrade: true
      tags:
        - cis_3_3_1
        - stig_v_230280
        - updates
  when: ansible_os_family == 'Alpine'
  become: true
  tags:
    - cis_3_3_1
    - stig_v_230280
    - nist_si_2
    - iso_27001_8_9
    - updates
    - remediate
