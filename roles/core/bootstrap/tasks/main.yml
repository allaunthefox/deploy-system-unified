---
# Core bootstrap role - System initialization and base configuration
- name: Gather system facts
  ansible.builtin.setup:
    gather_subset:
      - '!all'
      - '!min'
      - date_time
      - distribution
      - os_family
      - pkg_mgr
      - virtual
- name: Set distribution-specific variables
  ansible.builtin.set_fact:
    core_pkg_manager: "{{ ansible_facts['pkg_mgr'] }}"
    core_os_family: "{{ ansible_facts['os_family'] }}"
    core_distribution: "{{ ansible_facts['distribution'] | lower }}"

- name: Load Architecture Specific Variables
  ansible.builtin.include_vars:
    file: "arch_{{ ansible_architecture }}.yml"
  failed_when: false

- name: Construct Base Package List
  ansible.builtin.set_fact:
    _bootstrap_packages: >-
      {{
        system_base_packages.common
        + (system_base_packages[core_os_family] | default([]))
        + (bootstrap_arch_packages[core_os_family] | default([]))
      }}

- name: Ensure base packages are installed (Debian/Ubuntu)
  ansible.builtin.apt:
    name: "{{ _bootstrap_packages }}"
    state: present
    update_cache: true
  when: core_os_family == 'Debian'
  become: true
  register: apt_install_result
  until: apt_install_result is success
  retries: 5
  delay: 10

- name: Ensure base packages are installed (RedHat/CentOS)
  ansible.builtin.dnf:
    name: "{{ _bootstrap_packages }}"
    state: present
  when: core_os_family == 'RedHat'
  become: true
  register: dnf_install_result
  until: dnf_install_result is success
  retries: 5
  delay: 10

- name: Ensure base packages are installed (Arch)
  community.general.pacman:
    name: "{{ _bootstrap_packages }}"
    state: present
  when: core_distribution == 'archlinux'
  become: true

- name: Ensure base packages are installed (Alpine)
  community.general.apk:
    name: "{{ _bootstrap_packages }}"
    state: present
  when: core_os_family == 'Alpine'
  become: true
- name: Create standard system directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop: "{{ system_standard_directories }}"
  become: true

- name: Detect Virtualization Environment
  ansible.builtin.set_fact:
    detected_virtualization_role: "{{ ansible_facts['virtualization_role'] | default('host') | lower }}"
    detected_virtualization_type: "{{ ansible_facts['virtualization_type'] | default('none') | lower }}"
    is_virtualized: "{{ (ansible_facts['virtualization_role'] | default('host') | lower) == 'guest' }}"
  changed_when: false

- name: Determine virt_type (bootstrap fallback)
  ansible.builtin.set_fact:
    virt_type: >-
      {{
        'bare-metal'
        if not (is_virtualized | bool)
        else (
          'container'
          if detected_virtualization_type in ['docker', 'podman', 'container', 'lxc']
          else (
            'vps'
            if (deployment_profile | default('') == 'vps')
            else 'virtual'
          )
        )
      }}
  when: virt_type is not defined
  changed_when: false

- name: Assert virt_type is a valid ontology value
  ansible.builtin.assert:
    that:
      - virt_type is defined
      - virt_type is string
      - virt_type in ['bare-metal', 'virtual', 'vps', 'container']
    fail_msg: >-
      Invalid virt_type '{{ virt_type | default('UNDEFINED') }}'. Expected one of:
      bare-metal, virtual, vps, container.
      Detected: virtualization_role={{ detected_virtualization_role | default('unknown') }},
      virtualization_type={{ detected_virtualization_type | default('unknown') }}.

- name: Report Virtualization Profile
  ansible.builtin.debug:
    msg: >-
      Environment detected as {{ virt_type | upper }}
      (Guest: {{ is_virtualized }}, Detected: {{ detected_virtualization_type | default('unknown') }}).

- name: Generate high-entropy Deployment ID (Forensic Primary Key)
  ansible.builtin.set_fact:
    deployment_id: "{{ ansible_facts['date_time'].iso8601_micro | hash('sha256') | truncate(16, True, '') }}"

- name: Set bootstrap completion flag
  ansible.builtin.set_fact:
    core_bootstrap_complete: true
