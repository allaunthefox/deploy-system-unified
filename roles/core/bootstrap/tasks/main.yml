# =============================================================================
# Audit Event Identifier: DSU-PLY-100407
# Last Updated: 2026-02-28
# =============================================================================
---
# Core bootstrap role - System initialization and base configuration
# CIS 1.1.x | STIG V-230240 | NIST CM-2, SC-12 | ISO 27001 §8.9 | ISO 9001 | ISO 8000-110

- name: "CIS 1.1.1 | STIG V-230240 | NIST CM-2 | ISO 9001 | Audit Code 300010 | Gather system facts"
  ansible.builtin.setup:
    gather_subset:
      - '!all'
      - '!min'
      - date_time
      - distribution
      - os_family
      - pkg_mgr
      - virtual
  tags:
    - cis_1_1_1
    - stig_v_230240
    - nist_cm_2
    - iso_9001
    - bootstrap
    - initialization

- name: "CIS 1.1.2 | STIG V-230240 | NIST CM-2 | ISO 9001 | 600013 | Set distribution-specific variables"
  ansible.builtin.set_fact:
    core_pkg_manager: "{{ ansible_facts['pkg_mgr'] }}"
    core_os_family: "{{ ansible_facts['os_family'] }}"
    core_distribution: "{{ ansible_facts['distribution'] | lower }}"
  tags:
    - cis_1_1_2
    - stig_v_230240
    - nist_cm_2
    - bootstrap
    - initialization

- name: "CIS 1.1.3 | STIG V-230240 | NIST CM-2 | ISO 9001 | 600013 | Load Architecture Specific Variables"
  ansible.builtin.include_vars:
    file: "arch_{{ ansible_architecture }}.yml"
  failed_when: false
  tags:
    - cis_1_1_3
    - stig_v_230240
    - nist_cm_2
    - bootstrap
    - initialization

- name: "CIS 1.1.4 | STIG V-230240 | NIST CM-2 | ISO 9001 | 600013 | Construct Base Package List"
  ansible.builtin.set_fact:
    _bootstrap_packages: >-
      {{
        system_base_packages.common
        + (system_base_packages[core_os_family] | default([]))
        + (bootstrap_arch_packages[core_os_family] | default([]))
      }}
  tags:
    - cis_1_1_4
    - stig_v_230240
    - nist_cm_2
    - bootstrap
    - initialization

- name: "CIS 1.4.1 | STIG V-230240 | NIST CM-2 | ISO 27001 §8.9 | Audit Code 530000 | Ensure base packages are installed (Debian/Ubuntu)"
  ansible.builtin.apt:
    name: "{{ _bootstrap_packages }}"
    state: present
    update_cache: true
  when: core_os_family == 'Debian'
  become: true
  register: apt_install_result
  until: apt_install_result is success
  retries: 5
  delay: 10
  tags:
    - cis_1_4_1
    - stig_v_230240
    - nist_cm_2
    - iso_27001_8_9
    - bootstrap
    - packages
    - remediate

- name: "CIS 1.4.1 | STIG V-230240 | NIST CM-2 | ISO 27001 §8.9 | Audit Code 530000 | Ensure base packages are installed (RedHat/CentOS)"
  ansible.builtin.dnf:
    name: "{{ _bootstrap_packages }}"
    state: present
  when: core_os_family == 'RedHat'
  become: true
  register: dnf_install_result
  until: dnf_install_result is success
  retries: 5
  delay: 10
  tags:
    - cis_1_4_1
    - stig_v_230240
    - nist_cm_2
    - iso_27001_8_9
    - bootstrap
    - packages
    - remediate

- name: "CIS 1.4.1 | STIG V-230240 | NIST CM-2 | ISO 27001 §8.9 | Audit Code 530000 | Ensure base packages are installed (Arch)"
  community.general.pacman:
    name: "{{ _bootstrap_packages }}"
    state: present
  when: core_distribution == 'archlinux'
  become: true
  tags:
    - cis_1_4_1
    - stig_v_230240
    - nist_cm_2
    - iso_27001_8_9
    - bootstrap
    - packages
    - remediate

- name: "CIS 1.4.1 | STIG V-230240 | NIST CM-2 | ISO 27001 §8.9 | Audit Code 530000 | Ensure base packages are installed (Alpine)"
  community.general.apk:
    name: "{{ _bootstrap_packages }}"
    state: present
  when: core_os_family == 'Alpine'
  become: true
  tags:
    - cis_1_4_1
    - stig_v_230240
    - nist_cm_2
    - iso_27001_8_9
    - bootstrap
    - packages
    - remediate

- name: "CIS 1.1.5 | STIG V-230240 | NIST CM-2 | Audit Code 600113 | Create standard system directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop: "{{ system_standard_directories }}"
  become: true
  tags:
    - cis_1_1_5
    - stig_v_230240
    - nist_cm_2
    - bootstrap
    - initialization
    - remediate

- name: "CIS 1.1.6 | STIG V-230240 | NIST SC-12 | Audit Code 800000 | Detect Virtualization Environment"
  ansible.builtin.set_fact:
    detected_virtualization_role: "{{ ansible_facts['virtualization_role'] | default('host') | lower }}"
    detected_virtualization_type: "{{ ansible_facts['virtualization_type'] | default('none') | lower }}"
    is_virtualized: "{{ (ansible_facts['virtualization_role'] | default('host') | lower) == 'guest' }}"
  changed_when: false
  tags:
    - cis_1_1_6
    - stig_v_230240
    - nist_sc_12
    - bootstrap
    - initialization

- name: "CIS 1.1.7 | STIG V-230240 | NIST SC-12 | ISO 9001 | 600013 | Determine virt_type (bootstrap fallback)"
  ansible.builtin.set_fact:
    virt_type: >-
      {{
        'bare-metal'
        if not (is_virtualized | bool)
        else (
          'container'
          if detected_virtualization_type in ['docker', 'podman', 'container', 'lxc']
          else (
            'vps'
            if (deployment_profile | default('') == 'vps')
            else 'virtual'
          )
        )
      }}
  when: virt_type is not defined
  changed_when: false
  tags:
    - cis_1_1_7
    - stig_v_230240
    - nist_sc_12
    - bootstrap
    - initialization

- name: "CIS 1.1.8 | STIG V-230240 | NIST CM-2 | ISO 9001 | 600013 | Assert virt_type is a valid ontology value"
  ansible.builtin.assert:
    that:
      - virt_type is defined
      - virt_type is string
      - virt_type in ['bare-metal', 'virtual', 'vps', 'container']
    fail_msg: >-
      Invalid virt_type '{{ virt_type | default('UNDEFINED') }}'. Expected one of:
      bare-metal, virtual, vps, container.
      Detected: virtualization_role={{ detected_virtualization_role | default('unknown') }},
      virtualization_type={{ detected_virtualization_type | default('unknown') }}.
  tags:
    - cis_1_1_8
    - stig_v_230240
    - nist_cm_2
    - bootstrap
    - initialization

- name: "ISO 9001 | 800001 | Report Virtualization Profile"
  ansible.builtin.debug:
    msg: >-
      Environment detected as {{ virt_type | upper }}
      (Guest: {{ is_virtualized }}, Detected: {{ detected_virtualization_type | default('unknown') }}).
  tags:
    - bootstrap
    - initialization

- name: "CIS 1.1.9 | STIG V-230240 | NIST SC-12 | ISO 8000-110 | Audit Code 300011 | Generate high-entropy Deployment ID (Forensic Primary Key)"
  ansible.builtin.set_fact:
    deployment_id: "{{ ansible_facts['date_time'].iso8601_micro | hash('sha256') | truncate(16, True, '') }}"
  tags:
    - cis_1_1_9
    - stig_v_230240
    - nist_sc_12
    - iso_8000
    - bootstrap
    - forensics

- name: "ISO 9001 | 300011 | Set bootstrap completion flag"
  ansible.builtin.set_fact:
    core_bootstrap_complete: true
  tags:
    - bootstrap
    - initialization
