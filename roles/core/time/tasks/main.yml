---
# Tasks for core/time role
# CIS 5.4.1, 5.4.2 | STIG V-230270 | NIST AU-8, SC-12 | ISO 27001 ยง8.17

- name: "CIS 5.4.1 | STIG V-230270 | NIST AU-8 | Refresh package cache for time synchronization dependencies (Debian/Ubuntu)"
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  become: true
  when: ansible_os_family == 'Debian'
  tags:
    - cis_5_4_1
    - stig_v_230270
    - nist_au_8
    - time
    - prerequisite

- name: "CIS 5.4.1 | STIG V-230270 | NIST AU-8 | Install time synchronization service (idempotent)"
  ansible.builtin.package:
    name: "{{ core_time_service_mapping[ansible_distribution | lower].package }}"
    state: present
  become: true
  when: ansible_distribution | lower in core_time_service_mapping.keys()
  tags:
    - cis_5_4_1
    - stig_v_230270
    - nist_au_8
    - time
    - remediate

- name: "CIS 5.4.1 | STIG V-230270 | NIST AU-8, SC-12 | ISO 27001 ยง8.17 | Action 300001 | Configure secure time synchronization (idempotent)"
  ansible.builtin.template:
    src: chrony.conf.j2
    dest: "{{ core_time_service_mapping[ansible_distribution | lower].conf_dir }}/chrony.conf"
    mode: '0644'
    owner: root
    group: root
  become: true
  tags:
    - cis_5_4_1
    - stig_v_230270
    - nist_au_8
    - nist_sc_12
    - iso_27001_8_17
    - core
    - time
  notify: restart_chrony
  when:
    - ansible_distribution | lower in core_time_service_mapping.keys()
    - (virt_type | default('container')) != "container" # Containers typically share host clock

- name: "CIS 5.4.2 | STIG V-230270 | NIST AU-8 | ISO 27001 ยง8.17 | Action 300006 | Enable and start time synchronization service (idempotent)"
  ansible.builtin.service:
    name: "{{ core_time_service_mapping[ansible_distribution | lower].service }}"
    enabled: true
    state: started
  become: true
  tags:
    - cis_5_4_2
    - stig_v_230270
    - nist_au_8
    - iso_27001_8_17
    - core
    - time
  when:
    - ansible_distribution | lower in core_time_service_mapping.keys()
    - (virt_type | default('container')) != "container"

- name: "CIS 5.4.2 | STIG V-230270 | NIST AU-8 | Verify time synchronization is working (idempotent)"
  ansible.builtin.command: chronyc tracking
  register: core_time_sync_status
  changed_when: false
  become: true
  failed_when: false
  check_mode: false
  retries: 5
  delay: 5
  until: time_sync_status.rc == 0
  when: (virt_type | default('container')) != "container"
  tags:
    - cis_5_4_2
    - stig_v_230270
    - nist_au_8
    - time
    - verify

- name: "CIS 5.4.2 | STIG V-230270 | NIST AU-8 | ISO 27001 ยง8.17 | Validate time synchronization quality (idempotent)"
  ansible.builtin.assert:
    that:
      - time_sync_status.rc == 0
      - >-
        ('System time' in time_sync_status.stdout) or
        ('Reference ID' in time_sync_status.stdout) or
        ('Leap status' in time_sync_status.stdout)
    fail_msg: >-
      Time synchronization not properly configured - checkpoint functionality may be unreliable.
      chronyc tracking output:
      {{ time_sync_status.stdout | default('NO OUTPUT') }}
      {{ time_sync_status.stderr | default('NO ERROR OUTPUT') }}
  when:
    - (virt_type | default('container')) != "container"
    - not time_sync_status.failed
  tags:
    - cis_5_4_2
    - stig_v_230270
    - nist_au_8
    - iso_27001_8_17
    - time
    - validate
