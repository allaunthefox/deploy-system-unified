---
# Tasks for core/hardware_support

- name: "ISO 9001 | Audit Code 800000 | Load Architecture Specific Hardware Tasks"
  ansible.builtin.include_tasks: "arch/{{ ansible_architecture }}.yml"
  ignore_errors: true
  tags:
    - iso_9001
    - hardware
    - discovery

- name: "NIST SP 800-193 | 800000 | Discover Boot and Firmware Security State"
  ansible.builtin.include_tasks: boot_mode_discovery.yml
  tags: [hardware, discovery, boot, 800000]

- name: "ISO 27037 | 520030 | Generate and Verify Hardware Fingerprint"
  ansible.builtin.include_tasks: hardware_fingerprint.yml
  tags: [hardware, discovery, fingerprint, 520030]

- name: "ISO 27001 ยง12.4 | 840020 | Perform Hardware Health and Failure Audit"
  ansible.builtin.include_tasks: health_audit.yml
  tags: [hardware, health, audit, 840020]

- name: Report Hardware Capabilities
  ansible.builtin.debug:
    msg:
      - "AVX Support: {{ host_cpu_has_avx | default(false) }}"
      - "AVX2 Support: {{ host_cpu_has_avx2 | default(false) }}"
      - "AES-NI Support (Crypto): {{ host_cpu_has_aes | default(false) }}"
      - "SHA Extensions (Crypto): {{ host_cpu_has_sha | default(false) }}"
      - "Hardware RNG (RDRAND): {{ host_cpu_has_rdrand | default(false) }}"
      - "Intel QAT Detected: {{ host_has_qat | default(false) }}"
  tags:
    - hardware
    - discovery

- name: Validate AVX Requirement (Generic Media/DB)
  ansible.builtin.fail:
    msg: "Host CPU lacks AVX instructions required for modern Multimedia/Database workloads."
  when: (require_avx | default(false)) and not (host_cpu_has_avx | default(false))
  tags:
    - hardware
    - discovery

- name: Warn on missing AVX (Soft Check)
  ansible.builtin.debug:
    msg: "WARNING: Host CPU lacks AVX. Performance for MongoDB/Jellyfin may be severely degraded or fail."
  when: (warn_on_missing_avx | default(false)) and not host_cpu_has_avx
  tags:
    - hardware
    - discovery

- name: Get timedatectl status
  ansible.builtin.command: timedatectl show
  register: timedatectl_show
  changed_when: false
  check_mode: false
  failed_when: false
  when: ansible_service_mgr == 'systemd'
  tags:
    - hardware
    - time

- name: "ISO 27001 ยง8.17 | Audit Code 300007 | Configure Hardware Clock (RTC) to UTC"
  ansible.builtin.command: timedatectl set-local-rtc 0
  become: true
  failed_when: false
  tags:
    - iso_27001_8_17
    - hardware
    - time
  when:
    - ansible_service_mgr == 'systemd'
    - "'LocalRTC=yes' in timedatectl_show.stdout_lines"

- name: "ISO 27001 ยง8.17 | Audit Code 300007 | Enable NTP-based RTC synchronization"
  ansible.builtin.command: timedatectl set-ntp true
  become: true
  failed_when: false
  tags:
    - iso_27001_8_17
    - hardware
    - time
  when:
    - ansible_service_mgr == 'systemd'
    - "'NTP=no' in timedatectl_show.stdout_lines"

- name: "ISO 27001 ยง10.1 | Audit Code 800001 | Validate Crypto Acceleration (Secure Nodes)"
  ansible.builtin.fail:
    msg: "Host CPU lacks critical Crypto Extensions (AES-NI or SHA)."
  when: (require_crypto_extensions | default(false)) and (not host_cpu_has_aes)
  tags:
    - iso_27001_10_1
    - hardware
    - crypto

- name: Warn on missing Crypto extensions
  ansible.builtin.debug:
    msg: "WARNING: Host lacks AES-NI. VPN/SSL performance will be poor."
  when: (warn_on_missing_crypto | default(false)) and not host_cpu_has_aes
  tags:
    - hardware
    - crypto
