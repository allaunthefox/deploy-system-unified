# =============================================================================
# Audit Event Identifier: DSU-PLY-100475
# Last Updated: 2026-02-28
# =============================================================================
---
# Secret Archival Integrity Checks (ISO 27001 §10.1 / ISO 27040 §13)

- name: "ISO 27001 §10.1 | Audit Code 400015 | Check for SOPS Age Master Key"
  ansible.builtin.stat:
    path: "{{ lookup('env', 'HOME') }}/.config/sops/age/keys.txt"
  register: sops_age_key_stat
  delegate_to: localhost
  run_once: true
  tags: [secrets, archival, audit]

- name: "ISO 27001 §10.1 | Audit Code 400015 | Validate Key Archival Readiness"
  ansible.builtin.assert:
    that:
      - sops_age_key_stat.stat.exists
    fail_msg: |-
      CRITICAL: SOPS Age Master Key not found on controller.
      Archives using SOPS will be undecryptable if this controller is lost.
      Standard: ISO 27001 §10.1 (Key Management)
  delegate_to: localhost
  run_once: true
  when: deployment_profile in ['hardened', 'production']
  tags: [secrets, archival, audit]

- name: "ISO 27040 §13 | Audit Code 520011 | Verify Secret Integrity in Archival Repos"
  ansible.builtin.debug:
    msg: "Checking secret re-encryption status for long-term archival..."
  when: restic_archival_mode | default(false) | bool
  tags: [secrets, archival, audit]

- name: "ISO 27001 §10.1 | Audit Code 400103 | Audit PQC Readiness for Secrets (Age 1.3+)"
  ansible.builtin.shell: |
    
    age --version | grep -oP 'v\K[0-9.]+'
  register: age_version_raw
  delegate_to: localhost
  run_once: true
  changed_when: false
  failed_when: false
  tags: [secrets, archival, pqc, audit]

- name: "Audit Code 400103 | Warn if Secrets are not Quantum-Resistant"
  ansible.builtin.debug:
    msg: "WARNING: Age version {{ age_version_raw.stdout | default('unknown') }} does not natively support ML-KEM. Archival secrets are NOT quantum-resistant."
  when: 
    - not ansible_check_mode
    - (age_version_raw.stdout | default('') | length) > 0
    - age_version_raw.stdout is version('1.3.0', '<')
    - deployment_profile in ['hardened', 'production']
  tags: [secrets, archival, pqc, audit]

