# =============================================================================
# Audit Event Identifier: DSU-PLY-100477
# Last Updated: 2026-02-28
# =============================================================================
---
# Track 8: Volatile Secret Infrastructure - tmpfs mount for secrets
# NIST SC-28 | ISO 27001 ยง10.1 | Audit Code 400010

- name: "VOLATILE | Create secrets mount point"
  ansible.builtin.file:
    path: /run/secrets/dsu
    state: directory
    mode: '0700'
    owner: root
    group: root
  become: true
  tags: [secrets, volatile, security]

- name: "VOLATILE | Mount RAM-disk for secrets"
  ansible.posix.mount:
    path: /run/secrets/dsu
    src: tmpfs
    fstype: tmpfs
    opts: "size=64M,mode=0700,nosuid,nodev,noexec"
    state: mounted
  become: true
  when: 
    - not _kvm_is_container | default(false)
    - (ephemeral_volatile_secrets | default(false) | bool) or (deployment_profile in ['hardened', 'production'])
  tags: [secrets, volatile, security]

- name: VERIFY | Secrets mount is volatile (tmpfs)
  ansible.builtin.shell: findmnt -n -o FSTYPE /run/secrets/dsu
  register: _mount_type
  failed_when: _mount_type.stdout != "tmpfs"
  become: true
  when: 
    - not _kvm_is_container | default(false)
    - (ephemeral_volatile_secrets | default(false) | bool) or (deployment_profile in ['hardened', 'production'])
  changed_when: false
  tags: [secrets, volatile, verification]
