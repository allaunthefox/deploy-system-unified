# =============================================================================
# Audit Event Identifier: DSU-PLY-100747
# Last Updated: 2026-03-01
# =============================================================================
---
# Tasks for virtualization/kvm - Virtualization Layer
# Compliance: CIS 3.x, STIG V-230530, NIST SC-39/AC-6, ISO 27001 §8.20/§8.23

- name: "ISO 9001 | 600013 | CIS 3.9.1 | STIG V-230640 | NIST SC-39 | Detect Virtualization Environment (Internal)"
  ansible.builtin.set_fact:
    _kvm_is_container: "{{ (ansible_virtualization_type | default('unknown') in ['docker', 'podman', 'container', 'lxc']) or (ansible_is_chroot | default(false)) }}"
  tags: [cis_3_9_1, stig_v_230640, nist_sc_39, virtualization, kvm, initialization, 600013]

- name: "ISO 9001 | 600013 | CIS 3.9.2 | STIG V-230640 | NIST SC-39 | Assign Hypervisor Instance UUID"
  ansible.builtin.import_role:
    name: core/identity
  tags: [cis_3_9_2, stig_v_230640, nist_sc_39, virtualization, kvm, initialization, 600013]

- name: "ISO 27001 §8.26 | 830100 | CIS 3.9.2 | STIG V-230641 | NIST AC-6 | Install QEMU and KVM virtualization packages"
  ansible.builtin.package:
    name: [qemu-kvm, qemu-utils, libvirt-daemon-system, libvirt-clients, bridge-utils, virt-manager, ovmf, libguestfs-tools, swtpm, swtpm-tools]
    state: present
  become: true
  tags: [cis_3_9_2, stig_v_230641, nist_ac_6, iso_27001_8_26, virtualization, kvm, deploy, 830100]

- name: "ISO 9001 | 600013 | CIS 3.9.3 | STIG V-230642 | NIST SC-39 | Report TPM Status"
  ansible.builtin.debug:
    msg: |
      {% if has_hardware_tpm | default(false) %}
      Hardware TPM detected. Physical pass-through is available for guests.
      {% else %}
      Hardware TPM not detected. QEMU will use software emulation (swtpm) for guests.
      {% endif %}
  tags: [cis_3_9_3, stig_v_230642, nist_sc_39, virtualization, kvm, verification, 600013]

- name: "ISO 27001 §8.23 | 800410 | CIS 3.9.5 | STIG V-230643 | NIST SC-39 | Ensure NBD kernel module is loaded (Disk Mounting)"
  community.general.modprobe:
    name: nbd
    params: 'max_part=8'
    state: present
  become: true
  when: not _kvm_is_container
  tags: [cis_3_9_5, stig_v_230643, nist_sc_39, virtualization, kvm, deploy, 800410]

- name: "ISO 27001 §8.23 | 800410 | CIS 3.9.6 | STIG V-230644 | NIST SC-39 | Ensure KVM kernel modules are loaded"
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop: [kvm, kvm_intel, vhost_net]
  become: true
  when: not _kvm_is_container
  tags: [cis_3_9_6, stig_v_230644, nist_sc_39, virtualization, kvm, deploy, 800410]

- name: "ISO 9001 | 600013 | VERIFY | KVM modules are active (Zero-Tolerance)"
  ansible.builtin.shell: lsmod | grep -q "{{ item }}"
  loop: [kvm, vhost_net]
  become: true
  when: not _kvm_is_container
  changed_when: false
  tags: [virtualization, kvm, verification, 600013]

- name: "ISO 27001 §8.26 | 830200 | CIS 3.9.7 | STIG V-230645 | NIST AC-6 | Enable and start libvirtd service"
  ansible.builtin.systemd:
    name: libvirtd
    enabled: true
    state: started
  become: true
  when: not _kvm_is_container
  tags: [cis_3_9_7, stig_v_230645, nist_ac_6, iso_27001_8_26, virtualization, kvm, deploy, 830200]

- name: "ISO 9001 | 600013 | VERIFY | libvirtd is functional"
  ansible.builtin.shell: virsh uri
  register: _virsh_uri
  failed_when: _virsh_uri.rc != 0
  become: true
  when: not _kvm_is_container
  changed_when: false
  tags: [virtualization, kvm, verification, 600013]

- name: "ISO 27001 §8.26 | 830000 | CIS 3.9.8 | STIG V-230646 | NIST AC-6 | Configure QEMU security settings (Restrictive)"
  ansible.builtin.lineinfile:
    path: /etc/libvirt/qemu.conf
    regexp: "^#?{{ item.key }} ="
    line: '{{ item.key }} = "{{ item.value }}"'
  loop:
    - { key: 'user', value: 'libvirt-qemu' }
    - { key: 'group', value: 'libvirt-qemu' }
    - { key: 'dynamic_ownership', value: '0' }
  become: true
  notify: restart_libvirtd
  tags: [cis_3_9_8, stig_v_230646, nist_ac_6, iso_27001_8_26, virtualization, kvm, remediate, 830000]
