# =============================================================================
# Audit Event Identifier: DSU-PLY-100221
# Last Updated: 2026-02-28
# =============================================================================
---
# Tasks for ops/pre_connection role
# This role runs on the CONTROLLER to ensure connectivity and determine facts.
# Compliance: CIS 4.x, STIG V-230540, NIST AU-2/CA-7/IR-4/SI-4, ISO 27001 ยง8.15/ยง8.16/ยง16.1

- name: "CIS 4.11.1 | STIG V-230770 | NIST SC-7 | Check for existing custom SSH port on target (idempotent)"
  ansible.builtin.shell: |
    # Find the configured port and ensure it is not the default 22
    # Use sshd -T to respect included configs and overrides
    CURRENT_PORT=$(sshd -T 2>/dev/null | awk '/^port /{print $2; exit}')
    if [ "$CURRENT_PORT" != "22" ] && [ -n "$CURRENT_PORT" ]; then
      echo "$CURRENT_PORT"
    else
      echo ""
    fi
  register: existing_ssh_port
  changed_when: false
  args:
    
  when: ssh_randomize_port | default(false) | bool
  become: true
  tags:
    - cis_4_11_1
    - stig_v_230770
    - nist_sc_7
    - ops
    - connection

- name: "CIS 4.11.2 | STIG V-230771 | NIST SC-7 | Compute SSH port range bounds (idempotent)"
  ansible.builtin.set_fact:
    advanced_security_hardening_ssh_range_start: "{{ ssh_random_port_range_start | default(10000) | int }}"
    advanced_security_hardening_ssh_range_end: "{{ ssh_random_port_range_end | default(20000) | int }}"
  when:
    - ssh_randomize_port | default(false) | bool
    - existing_ssh_port.stdout | default('') == "" or existing_ssh_port.stdout | default('') == "22"
  delegate_to: localhost
  run_once: true
  tags:
    - cis_4_11_2
    - stig_v_230771
    - nist_sc_7
    - ops
    - connection

- name: "CIS 4.11.3 | STIG V-230772 | NIST SC-7 | Generate random SSH port if enabled (idempotent)"
  ansible.builtin.set_fact:
    advanced_security_hardening_random_ssh_port: >-
      {{ ((advanced_security_hardening_ssh_range_start | int) + (999999 | random)) %
         ((advanced_security_hardening_ssh_range_end | int) - (advanced_security_hardening_ssh_range_start | int) + 1)
         + (advanced_security_hardening_ssh_range_start | int) }}
  when:
    - ssh_randomize_port | default(false) | bool
    - existing_ssh_port.stdout | default('') == "" or existing_ssh_port.stdout | default('') == "22"
  delegate_to: localhost
  run_once: true
  tags:
    - cis_4_11_3
    - stig_v_230772
    - nist_sc_7
    - ops
    - connection

- name: "CIS 4.11.4 | STIG V-230773 | NIST SC-7 | Set final SSH port fact (idempotent)"
  ansible.builtin.set_fact:
    advanced_security_hardening_random_ssh_port: "{{ existing_ssh_port.stdout }}"
  when:
    - ssh_randomize_port | default(false) | bool
    - existing_ssh_port.stdout | default('') != ""
    - existing_ssh_port.stdout | default('') != "22"
  tags:
    - cis_4_11_4
    - stig_v_230773
    - nist_sc_7
    - ops
    - connection

- name: "CIS 4.11.5 | STIG V-230774 | NIST SC-7 | Set effective SSH port fact (idempotent)"
  ansible.builtin.set_fact:
    ssh_effective_port: >-
      {{ advanced_security_hardening_random_ssh_port
         | default(system_ssh_port)
         | default(22) }}
  tags:
    - cis_4_11_5
    - stig_v_230774
    - nist_sc_7
    - ops
    - connection

- name: "CIS 4.11.6 | STIG V-230775 | NIST SC-7 | Warn when randomization overrides Endlessh port conventions"
  ansible.builtin.debug:
    msg: >-
      SSH port randomization is enabled; ssh_effective_port={{ ssh_effective_port }} takes
      precedence over system_ssh_port={{ system_ssh_port | default(22) }} even if Endlessh
      is enabled. Ensure firewall access is aligned with the randomized port.
  when:
    - ssh_randomize_port | default(false) | bool
    - system_enable_endlessh | default(false) | bool
  changed_when: false
  tags:
    - cis_4_11_6
    - stig_v_230775
    - nist_sc_7
    - ops
    - connection

- name: "CIS 4.11.7 | STIG V-230776 | NIST SC-7 | ISO 9001 | Audit Code 600013 | Check connectivity to target SSH port"
  ansible.builtin.wait_for:
    host: "{{ inventory_hostname }}"
    port: "{{ ssh_effective_port | default(22) }}"
    timeout: 5
    state: started
  delegate_to: localhost
  register: ssh_port_check
  failed_when: false
  tags:
    - cis_4_11_7
    - stig_v_230776
    - nist_sc_7
    - iso_9001
    - ops
    - connection

- name: "CIS 4.11.8 | STIG V-230777 | NIST IR-4 | Inform operator if SSH port is closed (Anticipating Knocking)"
  ansible.builtin.debug:
    msg: "SSH port appears closed. If Port Knocking is enabled, ensure you have knocked before running this playbook."
  when: ssh_port_check.failed
  tags:
    - cis_4_11_8
    - stig_v_230777
    - nist_ir_4
    - ops
    - connection
