---
# Tasks for ops/connection_info role
- name: Determine SSH port for connection info
  ansible.builtin.set_fact:
    connection_info_port: >-
      {{ ssh_effective_port | default(system_ssh_port) | default(22) }}
- name: Create SSH connection info (idempotent)
  ansible.builtin.set_fact:
    ssh_connection_info:
      deployment_id: "{{ deployment_id }}"
      hostname: "{{ inventory_hostname }}"
      port: "{{ connection_info_port }}"
      username: "{{ ansible_user | default(ansible_ssh_user) | default(lookup('env', 'USER')) }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
  run_once: true
- name: Determine SSH port cache directory (controller)
  ansible.builtin.set_fact:
    ssh_port_cache_dir_effective: >-
      {{ (ssh_port_cache_dir | default('') | trim | length > 0)
         | ternary(ssh_port_cache_dir, (inventory_dir | default(playbook_dir)) ~ '/.ssh_port_cache') }}
  delegate_to: localhost
  changed_when: false
- name: Ensure SSH port cache directory exists (controller)
  ansible.builtin.file:
    path: "{{ ssh_port_cache_dir_effective }}"
    state: directory
    mode: '0700'
  delegate_to: localhost
  run_once: true
  changed_when: false
  when: not ansible_check_mode
- name: "ISO 9001 | Action 600014 | Cache SSH port for host (controller)"
  ansible.builtin.copy:
    dest: "{{ ssh_port_cache_dir_effective }}/{{ inventory_hostname | regex_replace('[^A-Za-z0-9_.-]', '_') }}.port"
    content: "{{ connection_info_port }}"
    mode: '0600'
  delegate_to: localhost
  changed_when: false
  tags:
    - iso_9001
    - connection_info
  when: not ansible_check_mode

- name: Create secure temporary file on controller for SSH connection info (idempotent)
  ansible.builtin.tempfile:
    state: file
    prefix: "ssh_connection_info_{{ inventory_hostname | regex_replace('[^A-Za-z0-9_-]', '_') }}_"
    suffix: ".yml"
  register: connection_info_temp_file
  delegate_to: localhost
  run_once: true
  no_log: true
  changed_when: false
  tags:
    - security
    - connection_info
  when: not ansible_check_mode

- name: Set secure permissions on temporary file (idempotent)
  ansible.builtin.file:
    path: "{{ connection_info_temp_file.path }}"
    mode: '0600'
  delegate_to: localhost
  tags:
    - security
    - connection_info
  when:
    - connection_info_temp_file.path is defined
    - not ansible_check_mode
  run_once: true

- name: "ISO 27001 ยง10.1 | Action 400011 | Handle SOPS Encryption"
  ansible.builtin.include_tasks: encryption/sops.yml
  tags:
    - iso_27001_10_1
    - security
    - connection_info
    - remediate
  when:
    - encryption_method == 'sops'
    - not ansible_check_mode

- name: "ISO 27001 ยง10.1 | Action 400011 | Handle Ansible Vault Encryption"
  ansible.builtin.include_tasks: encryption/vault.yml
  tags:
    - iso_27001_10_1
    - security
    - connection_info
    - remediate
  when:
    - encryption_method == 'vault'
    - not ansible_check_mode

- name: Set path for plaintext SSH info (insecure/dev only)
  ansible.builtin.set_fact:
    encrypted_ssh_info_path: "{{ connection_info_temp_file.path }}"
  when:
    - encryption_method == 'plain'
    - not ansible_check_mode
  delegate_to: localhost
  run_once: true

- name: Verify encryption succeeded (idempotent)
  ansible.builtin.assert:
    that:
      - encrypted_ssh_info_path is defined
      - encrypted_ssh_info_path | length > 0
    msg: "Encryption of temporary SSH info failed - deployment halted"
  run_once: true
  when: not ansible_check_mode
- name: Clean up plaintext temporary SSH file (idempotent)
  ansible.builtin.file:
    path: "{{ connection_info_temp_file.path }}"
    state: absent
  delegate_to: localhost
  run_once: true
  changed_when: false
  when: not ansible_check_mode
- name: Rsync encrypted SSH connection info to specified destination (idempotent)
  ansible.posix.synchronize:
    src: "{{ encrypted_ssh_info_path }}"
    dest: "{{ ssh_rsync_destination }}"
    mode: pull
  when:
    - ssh_rsync_destination != ""
    - ops_rsync_enable | default(false) | bool
    - ssh_rsync_destination in (ops_rsync_allowlist | default([]) | map(attribute='dest') | list)
    - encrypted_ssh_info_path is defined
    - encrypted_ssh_info_path | length > 0
    - not ansible_check_mode
  run_once: true
  delegate_to: localhost
