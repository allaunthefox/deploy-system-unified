---
# Tasks for ops/connection_info role
# Compliance: CIS 4.x, STIG V-230540, NIST AU-2/CA-7/IR-4/SI-4, ISO 27001 §8.15/§8.16/§16.1

- name: "CIS 4.8.1 | STIG V-230730 | NIST SC-7 | Determine SSH port for connection info"
  ansible.builtin.set_fact:
    connection_info_port: >-
      {{ ssh_effective_port | default(system_ssh_port) | default(22) }}
  tags:
    - cis_4_8_1
    - stig_v_230730
    - nist_sc_7
    - ops
    - connection_info

- name: "CIS 4.8.2 | STIG V-230731 | NIST SC-7 | Create SSH connection info (idempotent)"
  ansible.builtin.set_fact:
    ssh_connection_info:
      deployment_id: "{{ deployment_id }}"
      hostname: "{{ inventory_hostname }}"
      port: "{{ connection_info_port }}"
      username: "{{ ansible_user | default(ansible_ssh_user) | default(lookup('env', 'USER')) }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
  run_once: true
  tags:
    - cis_4_8_2
    - stig_v_230731
    - nist_sc_7
    - ops
    - connection_info

- name: "CIS 4.8.3 | STIG V-230732 | NIST SC-7 | Determine SSH port cache directory (controller)"
  ansible.builtin.set_fact:
    ssh_port_cache_dir_effective: >-
      {{ (ssh_port_cache_dir | default('') | trim | length > 0)
         | ternary(ssh_port_cache_dir, (inventory_dir | default(playbook_dir)) ~ '/.ssh_port_cache') }}
  delegate_to: localhost
  changed_when: false
  tags:
    - cis_4_8_3
    - stig_v_230732
    - nist_sc_7
    - ops
    - connection_info

- name: "CIS 4.8.4 | STIG V-230733 | NIST SC-7 | Ensure SSH port cache directory exists (controller)"
  ansible.builtin.file:
    path: "{{ ssh_port_cache_dir_effective }}"
    state: directory
    mode: '0700'
  delegate_to: localhost
  run_once: true
  changed_when: false
  when: not ansible_check_mode
  tags:
    - cis_4_8_4
    - stig_v_230733
    - nist_sc_7
    - ops
    - connection_info

- name: "CIS 4.8.5 | STIG V-230734 | NIST SC-7 | ISO 9001 | Audit Code 600014 | Cache SSH port for host (controller)"
  ansible.builtin.copy:
    dest: "{{ ssh_port_cache_dir_effective }}/{{ inventory_hostname | regex_replace('[^A-Za-z0-9_.-]', '_') }}.port"
    content: "{{ connection_info_port }}"
    mode: '0600'
  delegate_to: localhost
  changed_when: false
  tags:
    - cis_4_8_5
    - stig_v_230734
    - nist_sc_7
    - iso_9001
    - connection_info
  when: not ansible_check_mode

- name: "CIS 4.8.6 | STIG V-230735 | NIST SC-12 | Create secure temporary file on controller for SSH connection info (idempotent)"
  ansible.builtin.tempfile:
    state: file
    prefix: "ssh_connection_info_{{ inventory_hostname | regex_replace('[^A-Za-z0-9_-]', '_') }}_"
    suffix: ".yml"
  register: connection_info_temp_file
  delegate_to: localhost
  run_once: true
  no_log: true
  changed_when: false
  tags:
    - cis_4_8_6
    - stig_v_230735
    - nist_sc_12
    - security
    - connection_info
  when: not ansible_check_mode

- name: "CIS 4.8.7 | STIG V-230736 | NIST SC-12 | Set secure permissions on temporary file (idempotent)"
  ansible.builtin.file:
    path: "{{ connection_info_temp_file.path }}"
    mode: '0600'
  delegate_to: localhost
  tags:
    - cis_4_8_7
    - stig_v_230736
    - nist_sc_12
    - security
    - connection_info
  when:
    - connection_info_temp_file.path is defined
    - not ansible_check_mode
  run_once: true

- name: "CIS 4.8.8 | STIG V-230737 | NIST SC-12 | ISO 27001 §10.1 | Audit Code 400011 | Handle SOPS Encryption"
  ansible.builtin.include_tasks: encryption/sops.yml
  tags:
    - cis_4_8_8
    - stig_v_230737
    - nist_sc_12
    - iso_27001_10_1
    - security
    - connection_info
    - remediate
  when:
    - encryption_method == 'sops'
    - not ansible_check_mode

- name: "CIS 4.8.9 | STIG V-230738 | NIST SC-12 | ISO 27001 §10.1 | Audit Code 400011 | Handle Ansible Vault Encryption"
  ansible.builtin.include_tasks: encryption/vault.yml
  tags:
    - cis_4_8_9
    - stig_v_230738
    - nist_sc_12
    - iso_27001_10_1
    - security
    - connection_info
    - remediate
  when:
    - encryption_method == 'vault'
    - not ansible_check_mode

- name: "CIS 4.8.10 | STIG V-230739 | NIST SC-12 | Set path for plaintext SSH info (insecure/dev only)"
  ansible.builtin.set_fact:
    encrypted_ssh_info_path: "{{ connection_info_temp_file.path }}"
  when:
    - encryption_method == 'plain'
    - not ansible_check_mode
  delegate_to: localhost
  run_once: true
  tags:
    - cis_4_8_10
    - stig_v_230739
    - nist_sc_12
    - ops
    - connection_info

- name: "CIS 4.8.11 | STIG V-230740 | NIST SC-12 | Verify encryption succeeded (idempotent)"
  ansible.builtin.assert:
    that:
      - encrypted_ssh_info_path is defined
      - encrypted_ssh_info_path | length > 0
    msg: "Encryption of temporary SSH info failed - deployment halted"
  run_once: true
  when: not ansible_check_mode
  tags:
    - cis_4_8_11
    - stig_v_230740
    - nist_sc_12
    - ops
    - connection_info

- name: "CIS 4.8.12 | STIG V-230741 | NIST SC-12 | Clean up plaintext temporary SSH file (idempotent)"
  ansible.builtin.file:
    path: "{{ connection_info_temp_file.path }}"
    state: absent
  delegate_to: localhost
  run_once: true
  changed_when: false
  when: not ansible_check_mode
  tags:
    - cis_4_8_12
    - stig_v_230741
    - nist_sc_12
    - ops
    - connection_info

- name: "CIS 4.8.13 | STIG V-230742 | NIST SC-7 | Rsync encrypted SSH connection info to specified destination (idempotent)"
  ansible.posix.synchronize:
    src: "{{ encrypted_ssh_info_path }}"
    dest: "{{ ssh_rsync_destination }}"
    mode: pull
  when:
    - ssh_rsync_destination != ""
    - ops_rsync_enable | default(false) | bool
    - ssh_rsync_destination in (ops_rsync_allowlist | default([]) | map(attribute='dest') | list)
    - encrypted_ssh_info_path is defined
    - encrypted_ssh_info_path | length > 0
    - not ansible_check_mode
  run_once: true
  delegate_to: localhost
  tags:
    - cis_4_8_13
    - stig_v_230742
    - nist_sc_7
    - ops
    - connection_info
