# =============================================================================
# Audit Event Identifier: DSU-PLY-100193
# Last Updated: 2026-02-28
# =============================================================================
---
# Goss tests for ops/connection_info role
# This role handles SSH connection information management
#
# Compliance: CIS 4.8.x, STIG V-230730-V-230742, NIST SC-7/SC-12, ISO 27001 ยง10.1
#
# These tests verify:
# - SSH configuration is present
# - SSH commands are available
# - SSH service is configured
# - Encryption tools are available

# Command availability checks
command:
  # Check SSH command is available
  ssh -V:
    exit-status: 0
    stderr: []
    timeout: 10000

  # Check SSH config exists
  test -f /etc/ssh/ssh_config:
    exit-status: 0
    stderr: []
    timeout: 5000

  # Check sshd config exists
  test -f /etc/ssh/sshd_config:
    exit-status: 0
    stderr: []
    timeout: 5000

  # Check rsync is available (optional feature)
  rsync --version:
    exit-status: 0
    stderr: []
    timeout: 10000
    skip: true  # Optional feature

  # Check ansible-vault is available (for encryption)
  ansible-vault --version:
    exit-status: 0
    stderr: []
    timeout: 10000
    skip: true  # May not be in PATH

# File checks for SSH configuration
file:
  /etc/ssh/ssh_config:
    exists: true
    mode: "0644"
    owner: root
    group: root

  /etc/ssh/sshd_config:
    exists: true
    mode: "0644"
    owner: root
    group: root

  # SSH host keys should exist
  /etc/ssh/ssh_host_rsa_key:
    exists: true
    mode: "0600"
    owner: root
    group: root
    skip: true  # Keys may be generated during SSH install

  /etc/ssh/ssh_host_ecdsa_key:
    exists: true
    mode: "0600"
    owner: root
    group: root
    skip: true

  /etc/ssh/ssh_host_ed25519_key:
    exists: true
    mode: "0600"
    owner: root
    group: root
    skip: true

# Service checks
service:
  sshd:
    enabled: true
    running: true
    skip: true  # Service name may vary (ssh vs sshd)

# Package checks
package:
  openssh-client:
    installed: true

  openssh-server:
    installed: true

  rsync:
    installed: true
    skip: true  # Optional feature
