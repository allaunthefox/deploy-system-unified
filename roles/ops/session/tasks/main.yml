# =============================================================================
# Audit Event Identifier: DSU-PLY-100241
# Last Updated: 2026-02-28
# =============================================================================
---
# Tasks for ops/session role
# Compliance: CIS 4.x, STIG V-230540, NIST AU-2/CA-7/IR-4/SI-4, ISO 27001 ยง8.15/ยง8.16/ยง16.1

- name: "CIS 4.7.1 | STIG V-230720 | NIST AU-2 | ISO 9001 | Audit Code 400006 | Ensure TMUX session is available for deployment (idempotent)"
  ansible.builtin.shell: |
    if command -v tmux >/dev/null 2>&1; then
      if ! tmux has-session -t "{{ tmux_session_name }}" 2>/dev/null; then
        tmux new-session -d -s "{{ tmux_session_name }}"
        echo "SESSION_CREATED:true"
      else
        echo "SESSION_EXISTS:true"
      fi
    else
      echo "TMUX_AVAILABLE:false"
    fi
  register: tmux_session_check
  changed_when: "'SESSION_CREATED:true' in tmux_session_check.stdout"
  failed_when: false
  tags:
    - cis_4_7_1
    - stig_v_230720
    - nist_au_2
    - iso_9001
    - ops
    - session
  when: tmux_session_for_deployment | bool

- name: "CIS 4.7.2 | STIG V-230721 | NIST AU-2 | Set TMUX session validity fact (idempotent)"
  ansible.builtin.set_fact:
    tmux_session_ok: >-
      {{ ('SESSION_CREATED:true' in tmux_session_check.stdout)
         or ('SESSION_EXISTS:true' in tmux_session_check.stdout)
         or ('TMUX_AVAILABLE:false' in tmux_session_check.stdout) }}
  tags:
    - cis_4_7_2
    - stig_v_230721
    - nist_au_2
    - ops
    - session
  when: tmux_session_for_deployment | bool

- name: "CIS 4.7.3 | STIG V-230722 | NIST AU-2 | Validate TMUX session creation (idempotent)"
  ansible.builtin.assert:
    that:
      - tmux_session_ok | bool
    msg: "TMUX session creation failed - deployment may have reduced functionality"
  tags:
    - cis_4_7_3
    - stig_v_230722
    - nist_au_2
    - ops
    - session
  when:
    - tmux_session_for_deployment | bool
    - not ansible_check_mode
