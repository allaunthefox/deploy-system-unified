---
# Tasks for hardware/firmware - Bare Metal Foundation
# Compliance: CIS 3.x, STIG V-230510, NIST SC-39/SC-43/SC-28, ISO 27001 §8.20/§8.26

- name: "CIS 3.5.1 | STIG V-230580 | NIST SC-39 | Detect Virtualization Environment (Internal)"
  ansible.builtin.set_fact:
    _hw_is_container: "{{ (ansible_virtualization_type | default('unknown') in ['docker', 'podman', 'container', 'lxc']) or (ansible_is_chroot | default(false)) }}"
  tags:
    - cis_3_5_1
    - stig_v_230580
    - nist_sc_39
    - hardware
    - firmware

- name: "CIS 3.5.2 | STIG V-230581 | NIST SC-43 | Detect CPU Tier (Server vs Consumer)"
  ansible.builtin.set_fact:
    hardware_cpu_tier: "{{ 'server' if (ansible_processor | join(' ') | regex_search('Xeon|EPYC', ignorecase=True)) else 'consumer' }}"
    hardware_is_server_cpu: "{{ true if (ansible_processor | join(' ') | regex_search('Xeon|EPYC', ignorecase=True)) else false }}"
  tags:
    - cis_3_5_2
    - stig_v_230581
    - nist_sc_43
    - hardware
    - firmware

- name: "CIS 3.5.3 | STIG V-230582 | NIST SC-39 | Report CPU Profile"
  ansible.builtin.debug:
    msg: "Hardware detected as {{ hardware_cpu_tier | upper }} tier CPU."
  tags:
    - cis_3_5_3
    - stig_v_230582
    - nist_sc_39
    - hardware
    - firmware

- name: "CIS 3.5.4 | STIG V-230583 | NIST SC-28 | Install Hardware Security Tools"
  ansible.builtin.package:
    name:
      - tpm2-tools
      - tpm2-abrmd # TPM2 Access Broker & Resource Manager
    state: present
  become: true
  tags:
    - cis_3_5_4
    - stig_v_230583
    - nist_sc_28
    - hardware
    - firmware

- name: "CIS 3.5.5 | STIG V-230584 | NIST SC-39 | ISO 27001 §8.9 | Audit Code 800500 | Detect Hardware TPM support"
  ansible.builtin.stat:
    path: /dev/tpmrm0
  register: hardware_tpm_stat
  tags:
    - cis_3_5_5
    - stig_v_230584
    - nist_sc_39
    - iso_27001_8_9
    - hardware
    - firmware
    - security

- name: "CIS 3.5.6 | STIG V-230585 | NIST SC-39 | Set TPM fact"
  ansible.builtin.set_fact:
    has_hardware_tpm: "{{ hardware_tpm_stat.stat.exists }}"
  tags:
    - cis_3_5_6
    - stig_v_230585
    - nist_sc_39
    - hardware
    - firmware
    - security

- name: "CIS 3.5.7 | STIG V-230586 | NIST SC-39 | Report TPM Status"
  ansible.builtin.debug:
    msg: "Hardware TPM detected: {{ has_hardware_tpm }}"
  tags:
    - cis_3_5_7
    - stig_v_230586
    - nist_sc_39
    - hardware
    - firmware
    - security

- name: "CIS 3.5.8 | STIG V-230587 | NIST SC-43 | ISO 27001 §8.17 | Audit Code 300007 | Configure Hardware Clock (RTC) to UTC"
  ansible.builtin.command: timedatectl set-local-rtc 0
  become: true
  changed_when: false
  tags:
    - cis_3_5_8
    - stig_v_230587
    - nist_sc_43
    - iso_27001_8_17
    - hardware
    - firmware
    - time
  when: not _hw_is_container

- name: "CIS 3.5.9 | STIG V-230588 | NIST SC-43 | ISO 27001 §8.17 | Audit Code 300007 | Enable NTP-based RTC synchronization"
  ansible.builtin.command: timedatectl set-ntp true
  become: true
  changed_when: false
  tags:
    - cis_3_5_9
    - stig_v_230588
    - nist_sc_43
    - iso_27001_8_17
    - hardware
    - firmware
    - time
  when: not _hw_is_container

- name: "CIS 3.5.10 | STIG V-230589 | NIST SC-43 | Report Hardware Clock status"
  ansible.builtin.command: timedatectl status
  register: timedate_status
  changed_when: false
  become: true
  when: not _hw_is_container
  tags:
    - cis_3_5_10
    - stig_v_230589
    - nist_sc_43
    - hardware
    - firmware
    - time

- name: VERIFY | RTC and NTP status (Zero-Tolerance)
  ansible.builtin.shell: |
    timedatectl show | grep -q "RTCInLocalTime=no" && \
    timedatectl show | grep -q "NTP=yes"
  become: true
  when: not _hw_is_container
  changed_when: false
  tags: [hardware, time, verification]

- name: "CIS 3.5.11 | STIG V-230590 | NIST SC-43 | NIST SP 800-193 | Audit Code 800510 | Verify Secure Boot Status"
  ansible.builtin.shell: |
    
    if command -v mokutil >/dev/null 2>&1; then
      mokutil --sb-state
    elif [ -d /sys/firmware/efi ]; then
      echo "SecureBoot unknown (mokutil missing)"
      exit 1
    else
      echo "SecureBoot disabled (Legacy BIOS)"
      exit 1
    fi
  args:
    executable: /bin/sh
  register: hardware_secure_boot_status
  changed_when: false
  become: true
  tags:
    - cis_3_5_11
    - stig_v_230590
    - nist_sc_43
    - hardware
    - firmware
    - security
    - boot_integrity

- name: "CIS 3.5.12 | STIG V-230591 | NIST SC-43 | Audit Code 800511 | Enforce Boot Integrity (Hardened Profile)"
  ansible.builtin.assert:
    that:
      - not (deployment_profile == 'hardened' and 'SecureBoot enabled' not in hardware_secure_boot_status.stdout)
    fail_msg: "CRITICAL: Secure Boot is DISABLED on a hardened node. Boot integrity cannot be guaranteed."
  when: not _hw_is_container
  tags:
    - cis_3_5_12
    - stig_v_230591
    - nist_sc_43
    - hardware
    - firmware
    - security
    - boot_integrity
    - audit

- name: "CIS 3.5.13 | STIG V-230592 | NIST CM-6 | Load Architecture Specific Firmware Tasks"
  ansible.builtin.include_tasks: "arch/{{ ansible_architecture }}.yml"
  tags:
    - cis_3_5_13
    - stig_v_230592
    - nist_cm_6
    - hardware
    - firmware

- name: "CIS 3.5.14 | STIG V-230593 | NIST SI-4 | Install hardware monitoring and watchdog tools"
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  loop: "{{ monitoring_packages | default([]) }}"
  become: true
  when: not _hw_is_container
  tags:
    - cis_3_5_14
    - stig_v_230593
    - nist_si_4
    - hardware
    - firmware

- name: "CIS 3.5.15 | STIG V-230594 | NIST SI-4 | Configure hardware watchdog"
  ansible.builtin.lineinfile:
    path: /etc/watchdog.conf
    regexp: "^#?watchdog-device"
    line: "watchdog-device = /dev/watchdog"
  become: true
  notify: restart_watchdog
  when:
    - not _hw_is_container
    - ansible_os_family != 'Archlinux'
  tags:
    - cis_3_5_15
    - stig_v_230594
    - nist_si_4
    - hardware
    - firmware

- name: "CIS 3.5.16 | STIG V-230595 | NIST SI-4 | Enable and start hardware services"
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  loop: "{{ ['smartmontools'] + watchdog_service }}"
  become: true
  when: not _hw_is_container
  tags:
    - cis_3_5_16
    - stig_v_230595
    - nist_si_4
    - hardware
    - firmware

- name: VERIFY | Hardware services active (Zero-Tolerance)
  ansible.builtin.shell: systemctl is-active {{ item }}
  loop: "{{ ['smartmontools'] + watchdog_service }}"
  become: true
  when: not _hw_is_container
  changed_when: false
  tags: [hardware, verification]
