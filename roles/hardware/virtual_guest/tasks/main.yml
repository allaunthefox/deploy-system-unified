# =============================================================================
# Audit Event Identifier: DSU-PLY-100563
# Last Updated: 2026-02-28
# =============================================================================
---
# Tasks for hardware/virtual_guest - Cloud Instance Tuning
# Compliance: CIS 3.x, STIG V-230530, NIST SC-39/AC-6, ISO 27001 ยง8.20/ยง8.23

- name: "CIS 3.4.1 | STIG V-230570 | NIST SC-39 | Detect Virtualization Environment (Internal)"
  ansible.builtin.set_fact:
    _vps_is_container: "{{ (ansible_virtualization_type | default('unknown') in ['docker', 'podman', 'container', 'lxc']) or (ansible_is_chroot | default(false)) }}"
  tags:
    - cis_3_4_1
    - stig_v_230570
    - nist_sc_39
    - hardware
    - virtualization

- name: "CIS 3.4.2 | STIG V-230571 | NIST SC-39 | Set I/O scheduler for virtual block devices (none/noop)"
  ansible.builtin.copy:
    content: |
      # Set none scheduler for network-backed/virtual disks
      ACTION=="add|change", KERNEL=="vd[a-z]*|xvd[a-z]*", ATTR{queue/scheduler}="none"
    dest: /etc/udev/rules.d/60-vps-disk-scheduler.rules
    mode: '0644'
  become: true
  notify: reload_udev
  when: not _vps_is_container
  tags:
    - cis_3_4_2
    - stig_v_230571
    - nist_sc_39
    - hardware
    - virtualization

- name: "CIS 3.4.3 | STIG V-230572 | NIST AC-6 | ISO 27001 ยง8.26 | Audit Code 450002 | Optimize Virtual Memory for shared cloud resources"
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/99-vps-optimization.conf
    reload: true
  loop:
    - { name: 'vm.dirty_ratio', value: '10' }
    - { name: 'vm.dirty_background_ratio', value: '5' }
  become: true
  tags:
    - cis_3_4_3
    - stig_v_230572
    - nist_ac_6
    - iso_27001_8_26
    - hardware
    - virtualization
    - remediate
  when: not _vps_is_container

- name: "CIS 3.4.4 | STIG V-230573 | NIST SC-39 | Identify VPS Provider for specific optimizations"
  ansible.builtin.set_fact:
    detected_provider: "{{ vps_provider | default(ansible_system_vendor) | lower }}"
  tags:
    - cis_3_4_4
    - stig_v_230573
    - nist_sc_39
    - hardware
    - virtualization

- name: "CIS 3.4.5 | STIG V-230574 | NIST SC-39 | Apply High-Fidelity Provider Optimizations"
  ansible.builtin.include_tasks: "providers/{{ item }}.yml"
  loop:
    - "{{ detected_provider }}"
  when:
    - not _vps_is_container
    - detected_provider is defined
    - query('first_found', 'providers/' + item + '.yml', errors='ignore') | length > 0
  tags:
    - cis_3_4_5
    - stig_v_230574
    - nist_sc_39
    - hardware
    - virtualization

- name: "CIS 3.4.6 | STIG V-230575 | NIST SC-39 | Apply Generic Cloud Optimizations (Fallback)"
  ansible.builtin.include_tasks: "providers/generic_cloud.yml"
  when: query('first_found', 'providers/' + (vps_provider | default(ansible_system_vendor) | lower) + '.yml', errors='ignore') | length == 0
  tags:
    - cis_3_4_6
    - stig_v_230575
    - nist_sc_39
    - hardware
    - virtualization