# =============================================================================
# Audit Event Identifier: DSU-PLY-100530
# Last Updated: 2026-03-01
# =============================================================================
---
# ISO 27001 ยง11.1 | Physical Security
# Per-Vendor Setup Logic (Included by tasks/main.yml)

- name: "ISO 9001 | 600013 | Normalize vendor name (current iteration)"
  ansible.builtin.set_fact:
    _gpu_iter_vendor: "{{ current_vendor | lower }}"
  tags: [hardware, gpu, initialization, 600013]

- name: "ISO 9001 | 600013 | Validate GPU vendor"
  ansible.builtin.assert:
    that:
      - _gpu_iter_vendor in ['nvidia', 'amd', 'intel', 'mali', 'adreno', 'img', 'generic']
    fail_msg: "Invalid GPU vendor string: {{ _gpu_iter_vendor }}."
  tags: [hardware, gpu, verification, 600013]

- name: "ISO 9001 | 600013 | Define architecture path for vendor"
  ansible.builtin.set_fact:
    _gpu_arch_path: "{{ role_path }}/arch/{{ _gpu_norm_arch }}/{{ _gpu_iter_vendor }}/main.yml"
  tags: [hardware, gpu, initialization, 600013]

- name: "ISO 9001 | 600013 | Debug Architecture Path"
  ansible.builtin.debug:
    var: _gpu_arch_path
  tags: [hardware, gpu, verification, 600013]

- name: "ISO 9001 | 600013 | Check for Architecture/Vendor specific tasks"
  ansible.builtin.stat:
    path: "{{ _gpu_arch_path }}"
  register: gpu_arch_tasks
  delegate_to: localhost
  tags: [hardware, gpu, verification, 600013]

- name: "ISO 27001 ยง8.9 | 800410 | Include Architecture/Vendor specific tasks"
  ansible.builtin.include_tasks:
    file: "{{ _gpu_arch_path }}"
  when: gpu_arch_tasks.stat.exists
  tags: [hardware, gpu, deploy, remediate, 800410]

- name: "ISO 9001 | 600013 | Fail if no specialized support found and not generic"
  ansible.builtin.fail:
    msg: "No GPU support found for Arch: {{ _gpu_norm_arch }} / Vendor: {{ _gpu_iter_vendor }}"
  when:
    - not gpu_arch_tasks.stat.exists
    - _gpu_iter_vendor != 'generic'
  tags: [hardware, gpu, verification, 600013]

- name: "ISO 9001 | 600013 | Run generic GPU setup if specific vendor not found or generic requested"
  ansible.builtin.debug:
    msg: "Running generic GPU setup (Placeholder for logic)"
  when: not gpu_arch_tasks.stat.exists or _gpu_iter_vendor == 'generic'
  tags: [hardware, gpu, deploy, 600013]
