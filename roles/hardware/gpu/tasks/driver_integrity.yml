---
# GPU Driver Integrity and Conflict Resolution

- name: Initialize Conflict Facts
  tags: [hardware, gpu, audit]
  ansible.builtin.set_fact:
    gpu_driver_conflicts_found: false
    gpu_conflicting_modules: []

- name: Detect Active Kernel Modules
  tags: [hardware, gpu, audit]
  ansible.builtin.shell: "lsmod | awk '{print $1}'"
  register: _active_modules
  changed_when: false
  failed_when: false

- name: Check for NVIDIA/Nouveau Conflict
  tags: [hardware, gpu, audit]
  ansible.builtin.set_fact:
    gpu_conflicting_modules: "{{ gpu_conflicting_modules + ['nouveau'] }}"
  when: 
    - "'nvidia' in _gpu_vendor_list"
    - "'nouveau' in _active_modules.stdout_lines"

- name: Check for AMD Legacy/Modern Conflict
  tags: [hardware, gpu, audit]
  ansible.builtin.set_fact:
    gpu_conflicting_modules: "{{ gpu_conflicting_modules + ['radeon'] }}"
  when: 
    - "'amd' in _gpu_vendor_list"
    - "'radeon' in _active_modules.stdout_lines"

- name: Report Driver Conflicts
  tags: [hardware, gpu, audit]
  ansible.builtin.debug:
    msg: "WARNING: Conflicting GPU drivers detected: {{ gpu_conflicting_modules | join(', ') }}"
  when: gpu_conflicting_modules | length > 0

- name: Enforce Driver Isolation (Blacklist Conflicts)
  tags: [hardware, gpu, audit]
  block:
    - name: Ensure modprobe.d directory exists
  tags: [hardware, gpu, audit]
      ansible.builtin.file:
        path: /etc/modprobe.d
        state: directory
        mode: '0755'
      become: true

    - name: Apply Module Blacklists
  tags: [hardware, gpu, audit]
      ansible.builtin.template:
        src: gpu-blacklist.conf.j2
        dest: "/etc/modprobe.d/dsu-gpu-blacklist.conf"
        mode: '0644'
        owner: root
        group: root
      become: true
      notify: "update_initramfs"

    - name: Notify Reboot Requirement
  tags: [hardware, gpu, audit]
      ansible.builtin.debug:
        msg: "CRITICAL: GPU driver blacklist applied. A reboot is REQUIRED to unload conflicting modules."
  when: 
    - gpu_conflicting_modules | length > 0
    - (gpu_force_driver_isolation | default(false) or core_security_fail_secure | default(false))