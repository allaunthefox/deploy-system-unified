---
# RDMA (Remote Direct Memory Access) Support
# Installs core userspace verbs and diagnostic tools

- name: Define RDMA packages (Debian/Ubuntu)
  tags: [hardware, gpu, remediate]
  ansible.builtin.set_fact:
    rdma_packages:
      - rdma-core
      - ibverbs-providers
      - infiniband-diags
      - rdmacm-utils
  when: ansible_facts['os_family'] == 'Debian'

- name: Define RDMA packages (RedHat/Fedora)
  tags: [hardware, gpu, remediate]
  ansible.builtin.set_fact:
    rdma_packages:
      - rdma-core
      - libibverbs
      - infiniband-diags
      - libibverbs-utils
  when: ansible_facts['os_family'] == 'RedHat'

- name: Define RDMA packages (Alpine)
  tags: [hardware, gpu, remediate]
  ansible.builtin.set_fact:
    rdma_packages:
      - rdma-core
      - libibverbs
  when: ansible_facts['os_family'] == 'Alpine'

- name: Install RDMA Core Stack
  tags: [hardware, gpu, remediate]
  ansible.builtin.package:
    name: "{{ rdma_packages }}"
  tags: [hardware, gpu, remediate]
    state: present
  become: true
  when: rdma_packages is defined

- name: Load essential RDMA kernel modules
  tags: [hardware, gpu, remediate]
  community.general.modprobe:
    name: "{{ item }}"
  tags: [hardware, gpu, remediate]
    state: present
  loop:
    - ib_core
    - ib_uverbs
    - rdma_cm
  become: true
  when: not _gpu_is_container | default(false)
  failed_when: false # Kernel might not support RDMA modules

- name: Enable RDMA service (RedHat/Debian)
  tags: [hardware, gpu, remediate]
  ansible.builtin.systemd:
    name: rdma
  tags: [hardware, gpu, remediate]
    enabled: true
    state: started
  become: true
  when: ansible_facts['os_family'] == 'RedHat'
  failed_when: false
