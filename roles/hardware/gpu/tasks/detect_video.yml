# =============================================================================
# Audit Event Identifier: DSU-PLY-100527
# Last Updated: 2026-03-01
# =============================================================================
---
# Hardware Detection Logic
# Detects Installed GPU Vendors to override generic defaults

- name: "[{{ (gpu_mock_lspci_output is defined) | ternary('SIM', 'PHYS') }}] Ensure Discovery Dependencies are Present (pciutils)"
  ansible.builtin.package:
    name: pciutils
    state: present
  register: _pciutils_install
  until: _pciutils_install is success
  retries: 3
  delay: 5
  when: not _gpu_is_container | default(false)
  tags: [hardware, gpu, audit]

- name: "[{{ (gpu_mock_lspci_output is defined) | ternary('SIM', 'PHYS') }}] VERIFY | pciutils is functional"
  ansible.builtin.command: lspci --version
  register: _lspci_ver
  failed_when: _lspci_ver.rc != 0
  when: not _gpu_is_container | default(false)
  changed_when: false
  tags: [hardware, gpu, verification]

- name: "[{{ (gpu_mock_lspci_output is defined) | ternary('SIM', 'PHYS') }}] Run Advanced GPU Discovery Script"
  tags: [hardware, gpu, audit]
  ansible.builtin.script: gpu_discovery.py
  environment:
    DSU_MOCK_LSPCI_OUTPUT: "{{ gpu_mock_lspci_output | default(omit) }}"
    DSU_MOCK_NVIDIA_SMI_OUTPUT: "{{ gpu_mock_nvidia_smi_output | default(omit) }}"
    DSU_MOCK_ROCM_SMI_OUTPUT: "{{ gpu_mock_rocm_smi_output | default(omit) }}"
    DSU_MOCK_INTEL_GPU_TOP_OUTPUT: "{{ gpu_mock_intel_gpu_top_output | default(omit) }}"
  register: gpu_discovery_raw
  changed_when: false

- name: "⚠️ [SIM] MOCK DATA WARNING"
  ansible.builtin.debug:
    msg: "⚠️ CRITICAL: GPU hardware detection is running in SIMULATION MODE using mock data. Physical hardware has NOT been verified."
  when: gpu_mock_lspci_output is defined
  tags: [hardware, gpu, audit, warning]

- name: "[{{ (gpu_mock_lspci_output is defined) | ternary('SIM', 'PHYS') }}] Parse GPU Discovery Output"
  tags: [hardware, gpu, audit]
  ansible.builtin.set_fact:
    _gpu_discovery_results: "{{ gpu_discovery_raw.stdout | from_json }}"

- name: "[{{ (gpu_mock_lspci_output is defined) | ternary('SIM', 'PHYS') }}] Apply Detected Vendors (Internal Facts)"
  tags: [hardware, gpu, audit]
  ansible.builtin.set_fact:
    _gpu_detected_vendor_list: "{{ _gpu_discovery_results.detected_vendor_list }}"
    _gpu_primary_detected_vendor: "{{ _gpu_discovery_results.primary_detected_vendor }}"
    _gpu_detected_devices: "{{ _gpu_discovery_results.detected_devices }}"
    _gpu_count: "{{ _gpu_discovery_results.gpu_count }}"
    _gpu_is_multi_gpu: "{{ _gpu_discovery_results.is_multi_gpu }}"
    _gpu_is_multi_vendor: "{{ _gpu_discovery_results.is_multi_vendor }}"

- name: "[{{ (gpu_mock_lspci_output is defined) | ternary('SIM', 'PHYS') }}] Save GPU Discovery Evidence"
  tags: [hardware, gpu, audit]
  ansible.builtin.copy:
    content: |
      {
        "timestamp": "{{ ansible_date_time.iso8601 }}",
        "verification_method": "{{ (gpu_mock_lspci_output is defined) | ternary('SIMULATION', 'PHYSICAL') }}",
        "discovery_results": {{ _gpu_discovery_results | to_json }}
      }
    dest: "/var/lib/deploy-system/evidence/gpu/discovery_{{ ansible_date_time.iso8601_basic_short }}.json"
    mode: '0644'
  become: true
  changed_when: false
  register: _dsu_gpu_evidence_file
