---
- name: Verify
  hosts: all
  gather_facts: true
  tasks:

    - name: Check generic package installation (Mesa)
      ansible.builtin.shell: dpkg -l | grep mesa-utils
      register: mesa_check
      failed_when: false
      args:
        
      when: ansible_facts['os_family'] == 'Debian'

    - name: Check generic package installation (Vulkan)
      ansible.builtin.shell: dpkg -l | grep mesa-vulkan-drivers
      register: vulkan_check
      failed_when: false
      args:
        
      when: ansible_facts['os_family'] == 'Debian'

    - name: Assert mesa-utils is installed (Generic Profile)
      ansible.builtin.assert:
        that: mesa_check.rc == 0
        fail_msg: "Generic GPU stack (mesa-utils) failed to install."
      when: ansible_facts['os_family'] == 'Debian'

    - name: Check OCuLink rescan script
      ansible.builtin.stat:
        path: /usr/local/bin/gpu-rescan
      register: rescan_script
      when:
        - gpu_stack_enable_egpu | default(false)
        - gpu_stack_egpu_interface | default('') == 'oculink'

    - name: Assert OCuLink script exists
      ansible.builtin.assert:
        that: rescan_script.stat.exists
        fail_msg: "OCuLink gpu-rescan script was not created."
      when:
        - gpu_stack_enable_egpu | default(false)
        - gpu_stack_egpu_interface | default('') == 'oculink'
