---
# Tasks for hardware/sas
# Compliance: CIS 3.x, STIG V-230510, NIST SC-39/SC-43/SC-28, ISO 27001 ยง8.20/ยง8.26

- name: "CIS 3.2.1 | STIG V-230540 | NIST CM-6 | Set SAS packages for Arch Linux"
  ansible.builtin.set_fact:
    hardware_sas_packages:
      - lsscsi
      - sg3_utils
      - sdparm
      - smartmontools
      - sysfsutils
  when: ansible_os_family == 'Archlinux'
  tags:
    - cis_3_2_1
    - stig_v_230540
    - nist_cm_6
    - hardware
    - sas

- name: "CIS 3.2.2 | STIG V-230541 | NIST SC-39 | Install SAS management utilities"
  ansible.builtin.package:
    name: "{{ hardware_sas_packages }}"
    state: present
  when: hardware_sas_install_tools
  become: true
  tags:
    - cis_3_2_2
    - stig_v_230541
    - nist_sc_39
    - hardware
    - sas

- name: "CIS 3.2.3 | STIG V-230542 | NIST SC-39 | ISO 27001 ยง8.9 | Action 800001 | Load SAS Kernel Modules"
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop: "{{ hardware_sas_drivers }}"
  when: hardware_sas_load_drivers
  become: true
  register: sas_modprobe
  failed_when: false
  tags:
    - cis_3_2_3
    - stig_v_230542
    - nist_sc_39
    - iso_27001_8_9
    - hardware
    - sas

- name: "CIS 3.2.4 | STIG V-230543 | NIST SC-43 | Read kernel module lockdown state"
  ansible.builtin.slurp:
    src: /proc/sys/kernel/modules_disabled
  register: sas_modules_disabled
  changed_when: false
  failed_when: false
  tags:
    - cis_3_2_4
    - stig_v_230543
    - nist_sc_43
    - hardware
    - sas
  when: hardware_sas_load_drivers

- name: "CIS 3.2.5 | STIG V-230544 | NIST SC-28 | Warn when kernel modules are locked down"
  ansible.builtin.debug:
    msg: "Kernel modules are locked down (kernel.modules_disabled=1); skipping SAS module load."
  tags:
    - cis_3_2_5
    - stig_v_230544
    - nist_sc_28
    - hardware
    - sas
  when:
    - hardware_sas_load_drivers
    - (sas_modules_disabled.content | default('MA==') | b64decode | trim) == '1'

- name: "CIS 3.2.6 | STIG V-230545 | NIST CM-6 | ISO 27001 ยง8.9 | Action 800001 | Ensure SAS modules are loaded on boot"
  ansible.builtin.copy:
    content: |
      {% for driver in hardware_sas_drivers %}
      {{ driver }}
      {% endfor %}
    dest: /etc/modules-load.d/sas-drivers.conf
    mode: '0644'
  when: hardware_sas_load_drivers
  become: true
  tags:
    - cis_3_2_6
    - stig_v_230545
    - nist_cm_6
    - iso_27001_8_9
    - hardware
    - sas
    - remediate

- name: "CIS 3.2.7 | STIG V-230546 | NIST SC-39 | Detect SAS Devices"
  ansible.builtin.shell: lsscsi -g
  register: sas_devices_output
  changed_when: false
  failed_when: false
  tags:
    - cis_3_2_7
    - stig_v_230546
    - nist_sc_39
    - hardware
    - sas
  when: hardware_sas_install_tools

- name: "CIS 3.2.8 | STIG V-230547 | NIST SC-39 | Display Detected SAS Devices"
  ansible.builtin.debug:
    var: sas_devices_output.stdout_lines
  tags:
    - cis_3_2_8
    - stig_v_230547
    - nist_sc_39
    - hardware
    - sas
  when: hardware_sas_install_tools and not sas_devices_output.failed

# HBA Specific Tuning
- name: "CIS 3.2.9 | STIG V-230548 | NIST SC-28 | tune sas queue depth (Adaptive)"
  ansible.builtin.shell: |
    # Find all SD devices that are actual disks (not enclosures/cdroms)
    for dev in /sys/block/sd*; do
      if [ -e "$dev/device/queue_depth" ]; then
        # Check current vs target to avoid unnecessary writes
        current=$(cat "$dev/device/queue_depth")
        # Only tune if device allows deeper queues (hardware limit check)
        max=$(cat "$dev/device/queue_depth_max" 2>/dev/null || echo 128)

        target={{ hardware_sas_queue_depth }}

        # Clamp target to hardware max
        if [ "$target" -gt "$max" ]; then
          target=$max
        fi

        if [ "$current" -lt "$target" ]; then
          echo "$target" > "$dev/device/queue_depth"
          echo "tuned $dev"
        fi
      fi
    done
  register: sas_queue_tuning
  changed_when: "'tuned' in sas_queue_tuning.stdout"
  become: true
  tags:
    - cis_3_2_9
    - stig_v_230548
    - nist_sc_28
    - hardware
    - sas
    - performance
  when: hardware_sas_install_tools

- name: "CIS 3.2.10 | STIG V-230549 | NIST SC-28 | Check Write Caching (WCE) status on SAS SSDs"
  ansible.builtin.shell: "sdparm --get=WCE /dev/{{ item }} | grep -q 'WCE.*1'"
  loop: "{{ sas_devices_output.stdout_lines | default([]) | select('search', 'disk') | map('regex_replace', '^.*(/dev/sd[a-z]+).*$', '\\1') | list }}"
  register: sas_wce_check
  changed_when: false
  failed_when: false
  args:
    
  become: true
  tags:
    - cis_3_2_10
    - stig_v_230549
    - nist_sc_28
    - hardware
    - sas
  when:
    - hardware_sas_install_tools
    - hardware_sas_enable_write_cache | default(false)

- name: "CIS 3.2.11 | STIG V-230550 | NIST SC-28 | ISO 27040 | Action 500051 | Enable Write Caching (WCE) on SAS SSDs (Careful - Requires Battery/UPS)"
  ansible.builtin.command: "sdparm --set=WCE --save /dev/{{ item.item }}"
  loop: "{{ sas_wce_check.results }}"
  when:
    - hardware_sas_install_tools
    - hardware_sas_enable_write_cache | default(false)
    - item.rc != 0 # rc != 0 meant grep failed to find WCE 1 (so it's 0 or off)
  become: true
  tags:
    - cis_3_2_11
    - stig_v_230550
    - nist_sc_28
    - iso_27040
    - hardware
    - sas
    - remediate
