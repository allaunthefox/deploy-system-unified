---
# Tasks for networking/physical
# Compliance: CIS 3.1.x, 3.2.x | STIG V-230350, V-230351 | NIST SC-7, SC-8 | ISO 27001 §8.20, §8.23

- name: "CIS 3.1.1 | STIG V-230350 | Install networking tools (ethtool, lshw, irqbalance)"
  ansible.builtin.package:
    name:
      - ethtool
      - lshw
      - irqbalance # Essential for multi-queue NICs (Bare Metal), skipped for VMs
    state: present
  when: networking_physical_install_tools
  become: true
  tags:
    - cis_3_1_1
    - stig_v_230350
    - nist_sc_7
    - iso_27001_8_20
    - networking
    - physical

- name: "CIS 3.1.2 | STIG V-230351 | Disable IRQBalance in Virtualized Environments"
  ansible.builtin.systemd:
    name: irqbalance
    state: stopped
    enabled: false
  when:
    - is_virtualized
    - networking_physical_install_tools
  failed_when: false
  tags:
    - cis_3_1_2
    - stig_v_230351
    - nist_cm_6
    - iso_27001_8_20
    - networking
    - physical

- name: "CIS 3.1.3 | NIST SC-7 | Detect physical interfaces (ether type)"
  ansible.builtin.set_fact:
    physical_interfaces: >-
      {{
        ansible_interfaces
        | map('regex_replace', '^', 'ansible_')
        | map('extract', ansible_facts)
        | select('defined')
        | selectattr('type', 'defined')
        | selectattr('type', 'equalto', 'ether')
        | map(attribute='device')
        | list
      }}
  tags:
    - cis_3_1_3
    - nist_sc_7
    - networking
    - physical

- name: "CIS 3.1.4 | NIST SC-7 | Gather ethtool facts for physical interfaces"
  ansible.builtin.command: "ethtool {{ item }}"
  register: ethtool_output
  changed_when: false
  loop: "{{ physical_interfaces }}"
  tags:
    - cis_3_1_4
    - nist_sc_7
    - networking
    - physical

- name: VERIFY | ethtool data gathered
  ansible.builtin.assert:
    that: 
      - ethtool_output.results | selectattr('rc', 'equalto', 0) | list | length == physical_interfaces | length
    fail_msg: "Failed to gather ethtool data for all physical interfaces."
  tags: [networking, physical, verification]

- name: "CIS 3.1.5 | STIG V-230350 | Parse Interface Types and Capabilities"
  vars:
    # Standardize all speeds to Megabits per second (Mbps)
    # Supports SI (decimal) and IEC (binary) prefixes, as well as Byte-based units
    # Scales from Nibble (insane) to Exabit (future-proof)
    _speed_conversion_map:
      'b': 0.000001     # Bits
      'B': 0.000008     # Bytes (x8)
      'nb': 0.000004    # Nibbles (x4) - The "Insane Admin" Special
      'Kb': 0.001       # Kilobits
      'KB': 0.008       # Kilobytes (x8)
      'Kib': 0.001024   # Kibibits
      'KiB': 0.008192   # Kibibytes
      'Mb': 1.0         # Megabits (Base)
      'MB': 8.0         # Megabytes (x8)
      'Mib': 1.048576   # Mebibits
      'MiB': 8.388608   # Mebibytes
      'Gb': 1000.0      # Gigabits
      'GB': 8000.0      # Gigabytes (x8)
      'Gib': 1073.742   # Gibibits
      'GiB': 8589.935   # Gibibytes
      'Tb': 1000000.0   # Terabits
      'TB': 8000000.0   # Terabytes (x8)
      'Tib': 1099511.6  # Tebibits
      'TiB': 8796093.0  # Tebibytes
      'Pb': 1000000000.0      # Petabits
      'PB': 8000000000.0      # Petabytes (x8)
      'Pib': 1125899906.84    # Pebibits
      'PiB': 9007199254.74    # Pebibytes
      'Eb': 1000000000000.0   # Exabits
      'EB': 8000000000000.0   # Exabytes (x8)
      'Eib': 1152921504606.85 # Exbibits
      'EiB': 9223372036854.78 # Exbibytes
  ansible.builtin.set_fact:
    interface_capabilities: "{{ interface_capabilities | default({}) | combine({ item.item: {
      'port_type': (item.stdout | regex_search('Port: ([a-zA-Z]+)', '\\1') | first | default('Unknown') | trim),
      'link_detected': (item.stdout | regex_search('Link detected: ([a-zA-Z]+)', '\\1') | first | default('no') | trim),
      'speed_mbps': ((item.stdout | regex_search('Speed: ([0-9]+)', '\\1') | first | default('0') | int) * (_speed_conversion_map.get((item.stdout | regex_search('Speed: [0-9]+\\s*([a-zA-Z]+)/s', '\\1') | first | default('Mb')), 1.0))) | int,
      'mtu': (ansible_facts['ansible_' ~ item.item].mtu | default(0))
    }}) }}"
  loop: "{{ ethtool_output.results }}"
  when: item.rc == 0
  tags:
    - cis_3_1_5
    - stig_v_230350
    - nist_sc_7
    - iso_27001_8_20
    - networking
    - physical

- name: "CIS 3.1.6 | NIST SC-7 | Debug Interface Capabilities"
  ansible.builtin.debug:
    var: interface_capabilities
    verbosity: 1
  tags:
    - cis_3_1_6
    - nist_sc_7
    - networking
    - physical

- name: "CIS 3.2.1 | NIST SC-7 | Gather ring buffer settings"
  ansible.builtin.command: "ethtool -g {{ item }}"
  register: ethtool_ring_output
  changed_when: false
  loop: "{{ physical_interfaces }}"
  when: networking_physical_ring_tuning_enabled
  tags:
    - cis_3_2_1
    - nist_sc_7
    - networking
    - physical

- name: "CIS 3.2.2 | NIST SC-7 | Parse ring buffer settings"
  ansible.builtin.set_fact:
    interface_ring_settings: "{{ interface_ring_settings | default({}) | combine({ item.item: {
      'current_rx': (item.stdout | regex_search('Current hardware settings:[\\s\\S]*?RX:\\s*([0-9]+)', '\\1') | default('-1') | int),
      'current_tx': (item.stdout | regex_search('Current hardware settings:[\\s\\S]*?TX:\\s*([0-9]+)', '\\1') | default('-1') | int)
    }}) }}"
  loop: "{{ ethtool_ring_output.results | default([]) }}"
  when:
    - networking_physical_ring_tuning_enabled
    - item.rc == 0
  tags:
    - cis_3_2_2
    - nist_sc_7
    - networking
    - physical

- name: "CIS 3.2.3 | NIST SC-7 | Gather offload settings"
  ansible.builtin.command: "ethtool -k {{ item }}"
  register: ethtool_offload_output
  changed_when: false
  loop: "{{ physical_interfaces }}"
  when: networking_physical_offload_tuning_enabled
  tags:
    - cis_3_2_3
    - nist_sc_7
    - networking
    - physical

- name: "CIS 3.2.4 | NIST SC-7 | Parse offload settings (TSO/GSO)"
  ansible.builtin.set_fact:
    interface_offload_settings: "{{ interface_offload_settings | default({}) | combine({ item.item: {
      'tso': (item.stdout | regex_search('tcp-segmentation-offload:\\s*(on|off)', '\\1') | default('unknown')),
      'gso': (item.stdout | regex_search('generic-segmentation-offload:\\s*(on|off)', '\\1') | default('unknown'))
    }}) }}"
  loop: "{{ ethtool_offload_output.results | default([]) }}"
  when:
    - networking_physical_offload_tuning_enabled
    - item.rc == 0
  tags:
    - cis_3_2_4
    - nist_sc_7
    - networking
    - physical

# --- System-Wide Kernel Tuning (Based on Fastest Interface) ---

- name: "CIS 3.2.5 | NIST SC-7 | Determine Max Interface Speed"
  ansible.builtin.set_fact:
    max_interface_speed: "{{ interface_capabilities.values() | map(attribute='speed_mbps') | map('int') | max | default(1000) }}"
    jumbo_frames_eligible: "{{ interface_capabilities.values() | selectattr('speed_mbps', 'defined') | selectattr('speed_mbps', 'ge', 1000) | list | length > 0 }}"
  tags:
    - cis_3_2_5
    - nist_sc_7
    - networking
    - physical

- name: "CIS 3.2.6 | NIST SC-7 | Select Performance Profile"
  ansible.builtin.set_fact:
    active_profile: "{{ networking_physical_profiles[max_interface_speed|string] | default(networking_physical_profiles[networking_physical_default_profile]) }}"
  tags:
    - cis_3_2_6
    - nist_sc_7
    - networking
    - physical

- name: "CIS 3.2.7 | NIST SC-7 | Load Architecture Specific Networking Tasks"
  ansible.builtin.include_tasks: "arch/{{ ansible_architecture }}.yml"
  tags:
    - cis_3_2_7
    - nist_sc_7
    - networking
    - physical

- name: VERIFY | Network tuning data gathered
  ansible.builtin.assert:
    that:
      - (not networking_physical_ring_tuning_enabled | default(false)) or (ethtool_ring_output.results | selectattr('rc', 'equalto', 0) | list | length == physical_interfaces | length)
      - (not networking_physical_offload_tuning_enabled | default(false)) or (ethtool_offload_output.results | selectattr('rc', 'equalto', 0) | list | length == physical_interfaces | length)
    fail_msg: "Failed to gather mandatory tuning data for physical interfaces."
  tags: [networking, physical, verification]

# --- Per-Interface Tuning (Jumbo Frames & Ring Buffers) ---

- name: "CIS 3.2.8 | STIG V-230351 | ISO 27001 §8.20 | Audit Code 810201 | Apply Jumbo Frames to High Speed/Fiber Interfaces"
  ansible.builtin.command: "ip link set dev {{ item.key }} mtu {{ networking_physical_jumbo_mtu }}"
  loop: "{{ interface_capabilities | dict2items }}"
  tags:
    - cis_3_2_8
    - stig_v_230351
    - nist_sc_7
    - iso_27001_8_20
    - networking
    - physical
    - remediate
  when:
    - networking_physical_manage_mtu
    - networking_physical_jumbo_frames_enabled
    - item.value.link_detected == 'yes'
    - (item.value.speed_mbps | int) >= 10000 or item.value.port_type in ['FIBRE', 'Direct Attach Copper', 'DA']
    - item.value.mtu | int != networking_physical_jumbo_mtu | int
  notify: restart_networkmanager

- name: "CIS 3.2.9 | STIG V-230351 | ISO 27001 §8.23 | Audit Code 810201 | Tune Ring Buffers (Adaptive per Interface Speed)"
  vars:
    desired_ring_rx: "{{ (networking_physical_profiles[item.value.speed_mbps|string] | default(networking_physical_profiles[networking_physical_default_profile]) Worthing).ring_rx }}"
    desired_ring_tx: "{{ (networking_physical_profiles[item.value.speed_mbps|string] | default(networking_physical_profiles[networking_physical_default_profile])).ring_tx }}"
  ansible.builtin.command: >-
    ethtool -G {{ item.key }}
    rx {{ desired_ring_rx }}
    tx {{ desired_ring_tx }}
  loop: "{{ interface_capabilities | dict2items }}"
  tags:
    - cis_3_2_9
    - stig_v_230351
    - nist_sc_7
    - iso_27001_8_23
    - networking
    - physical
    - remediate
  when:
    - networking_physical_ring_tuning_enabled
    - item.value.link_detected == 'yes'
    # Skip Ring Tuning on Virtual Interfaces (VirtIO/VmxNet3 often has fixed rings)
    - not is_virtualized
    - interface_ring_settings is defined
    - interface_ring_settings[item.key] is defined
    - interface_ring_settings[item.key].current_rx | int != desired_ring_rx | int or interface_ring_settings[item.key].current_tx | int != desired_ring_tx | int
  failed_when: false # Hardware might not support specific ring sizes

- name: "CIS 3.2.10 | STIG V-230351 | ISO 27001 §8.23 | Audit Code 810201 | Apply Offload Settings (TSO/GSO)"
  vars:
    desired_tso: "{{ 'on' if networking_physical_enable_tso else 'off' }}"
    desired_gso: "{{ 'on' if networking_physical_enable_gso else 'off' }}"
  ansible.builtin.command: >
    ethtool -K {{ item.key }}
    tso {{ desired_tso }}
    gso {{ desired_gso }}
  loop: "{{ interface_capabilities | dict2items }}"
  tags:
    - cis_3_2_10
    - stig_v_230351
    - nist_sc_7
    - iso_27001_8_23
    - networking
    - physical
    - remediate
  when:
    - networking_physical_offload_tuning_enabled
    - item.value.link_detected == 'yes'
    - interface_offload_settings is defined
    - interface_offload_settings[item.key] is defined
    - interface_offload_settings[item.key].tso in ['on', 'off']
    - interface_offload_settings[item.key].gso in ['on', 'off']
    - interface_offload_settings[item.key].tso != desired_tso or interface_offload_settings[item.key].gso != desired_gso
  become: true

