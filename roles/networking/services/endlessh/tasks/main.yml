---
# Tasks for networking/services/endlessh - SSH Tarpit
# Compliance: CIS 5.2.x | STIG V-230390 | NIST SC-7, SI-4 | ISO 27001 §8.16, §8.23

- name: "CIS 5.2.1 | STIG V-230390 | Install Endlessh (SSH Tarpit)"
  block:
    - name: Try installing Endlessh from package manager
      ansible.builtin.package:
        name: endlessh
        state: present
  rescue:
    - name: Install build dependencies for Endlessh fallback
      ansible.builtin.package:
        name:
          - git
          - gcc
          - make
          - "{{ 'glibc' if ansible_os_family == 'Archlinux' else 'libc-dev' }}"
        state: present
    - name: Clone Endlessh repository
      ansible.builtin.git:
        repo: 'https://github.com/skeeto/endlessh.git'
        dest: /usr/local/src/endlessh
        version: "{{ endlessh_version }}"
    - name: Build Endlessh
      ansible.builtin.command:
        cmd: make
        chdir: /usr/local/src/endlessh
        creates: /usr/local/src/endlessh/endlessh
      changed_when: true
    - name: Install Endlessh binary
      ansible.builtin.copy:
        src: /usr/local/src/endlessh/endlessh
        dest: /usr/bin/endlessh
        mode: '0755'
        remote_src: true
  become: true
  when: not ansible_check_mode
  tags:
    - cis_5_2_1
    - stig_v_230390
    - nist_si_4
    - iso_27001_8_16
    - networking
    - security

- name: "CIS 5.2.2 | NIST SC-7 | Create Endlessh configuration directory"
  ansible.builtin.file:
    path: /etc/endlessh
    state: directory
    mode: '0755'
  become: true
  tags:
    - cis_5_2_2
    - nist_sc_7
    - networking
    - security

- name: "CIS 5.2.3 | STIG V-230390 | ISO 27001 §9.4 | Action 540001 | Configure Endlessh"
  ansible.builtin.template:
    src: config.j2
    dest: /etc/endlessh/config
    mode: '0644'
  become: true
  tags:
    - cis_5_2_3
    - stig_v_230390
    - nist_si_4
    - iso_27001_9_4
    - networking
    - security
    - remediate
  notify: restart_endlessh

- name: "CIS 5.2.4 | STIG V-230390 | Allow Endlessh to bind to privileged ports (capabilities)"
  community.general.capabilities:
    path: /usr/bin/endlessh
    capability: cap_net_bind_service+ep
    state: present
  become: true
  failed_when: false
  tags:
    - cis_5_2_4
    - stig_v_230390
    - nist_sc_7
    - networking
    - security
  when: not (is_virtualized | default(false))

- name: "CIS 5.2.5 | NIST SC-7 | Ensure Endlessh systemd override directory exists"
  ansible.builtin.file:
    path: /etc/systemd/system/endlessh.service.d
    state: directory
    mode: '0755'
    owner: root
    group: root
  become: true
  changed_when: false
  tags:
    - cis_5_2_5
    - nist_sc_7
    - networking
    - security

- name: "CIS 5.2.6 | STIG V-230390 | ISO 27001 §9.4 | Configure Endlessh to run on port {{ endlessh_port }} (systemd override)"
  ansible.builtin.copy:
    content: |
      [Service]
      AmbientCapabilities=CAP_NET_BIND_SERVICE
      ExecStart=
      ExecStart=/usr/bin/endlessh -p {{ endlessh_port }}
    dest: /etc/systemd/system/endlessh.service.d/override.conf
    mode: '0644'
  become: true
  tags:
    - cis_5_2_6
    - stig_v_230390
    - nist_sc_7
    - iso_27001_9_4
    - networking
    - security
    - remediate
  notify:
    - reload_systemd
    - restart_endlessh
  when: system_enable_endlessh | default(false)

- name: "CIS 5.2.7 | STIG V-230390 | ISO 27001 §8.16 | Action 540000 | Manage Endlessh service state"
  ansible.builtin.systemd:
    name: endlessh
    enabled: "{{ system_enable_endlessh | default(false) }}"
    state: "{{ 'started' if system_enable_endlessh | default(false) else 'stopped' }}"
  become: true
  tags:
    - cis_5_2_7
    - stig_v_230390
    - nist_si_4
    - iso_27001_8_16
    - networking
    - security