---
# Tasks for networking/vpn_mesh - Kernel Readiness for Encrypted Traffic
# Compliance: CIS 3.5.x | STIG V-230360, V-230361 | NIST SC-8, SC-12, SC-13 | ISO 27001 ยง8.24, ยง8.28

- name: "CIS 3.5.1 | NIST SC-7 | Detect Virtualization Environment (Internal)"
  ansible.builtin.set_fact:
    _sec_is_container: "{{ (ansible_virtualization_type | default('unknown') in ['docker', 'podman', 'container', 'lxc']) or (ansible_is_chroot | default(false)) }}"
  tags:
    - cis_3_5_1
    - nist_sc_7
    - networking
    - vpn

- name: "CIS 3.5.2 | NIST SC-12 | Read kernel module lockdown state"
  ansible.builtin.command:
    cmd: cat /proc/sys/kernel/modules_disabled
  register: _vpn_kernel_modules_disabled
  changed_when: false
  failed_when: false
  check_mode: false
  become: true
  tags:
    - cis_3_5_2
    - nist_sc_12
    - networking
    - vpn

- name: "CIS 3.5.3 | STIG V-230360 | ISO 27001 ยง8.24 | Action 540100 | Ensure Wireguard kernel module is available"
  community.general.modprobe:
    name: wireguard
    state: present
  become: true
  failed_when: false # Kernel might correspond to non-modular build or container
  tags:
    - cis_3_5_3
    - stig_v_230360
    - nist_sc_8
    - nist_sc_12
    - iso_27001_8_24
    - networking
    - vpn
    - remediate
  when:
    - not _sec_is_container
    - not ansible_check_mode
    - _vpn_kernel_modules_disabled.stdout | default('0') | trim != '1'

- name: "CIS 3.5.4 | STIG V-230361 | ISO 27001 ยง8.28 | Action 540100 | Verify IPsec/ESP kernel modules for inter-node security"
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - af_key
    - xfrm_user
  become: true
  failed_when: false
  tags:
    - cis_3_5_4
    - stig_v_230361
    - nist_sc_8
    - nist_sc_13
    - iso_27001_8_28
    - networking
    - vpn
    - remediate
  when:
    - not _sec_is_container
    - not ansible_check_mode
    - _vpn_kernel_modules_disabled.stdout | default('0') | trim != '1'

- name: "CIS 3.5.5 | NIST SC-13 | Report encryption readiness"
  ansible.builtin.debug:
    msg: "System is ready for Wireguard/IPSec based inter-pod encryption"
  tags:
    - cis_3_5_5
    - nist_sc_13
    - networking
    - vpn
