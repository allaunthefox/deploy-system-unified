# =============================================================================
# Audit Event Identifier: DSU-PLY-100627
# Last Updated: 2026-02-28
# =============================================================================
---
# Port-specific access rules for networking/firewall role
# Compliance: CIS 4.4.x | STIG V-230271 | NIST SC-7, AC-4 | ISO 27001 §8.20, §8.23

- name: "CIS 4.4.1.12 | STIG V-230271 | ISO 27001 §9.4 | Audit Code 540002 | Allow configured TCP ports (UFW)"
  community.general.ufw:
    rule: allow
    port: "{{ item | string }}"
    proto: tcp
  loop: "{{ networking_firewall_allowed_tcp_ports_effective | default(networking_firewall_allowed_tcp_ports) }}"
  when:
    - ansible_os_family == 'Debian' or ansible_distribution == 'Archlinux'
    - >-
      networking_firewall_additional_rules | length == 0 or
      (item | string) not in (networking_firewall_additional_rules | map(attribute='port') | map('string') | list)
  become: true
  tags:
    - cis_4_4_1_12
    - stig_v_230271
    - nist_sc_7
    - iso_27001_9_4
    - networking
    - firewall
    - forensic

- name: "CIS 4.4.1.13 | STIG V-230271 | ISO 27001 §9.4 | Audit Code 540002 | Allow configured UDP ports (UFW)"
  community.general.ufw:
    rule: allow
    port: "{{ item | string }}"
    proto: udp
  loop: "{{ networking_firewall_allowed_udp_ports | default([]) }}"
  when:
    - ansible_os_family == 'Debian'
    - >-
      networking_firewall_additional_rules | length == 0 or
      (item | string) not in (networking_firewall_additional_rules | map(attribute='port') | map('string') | list)
  become: true
  tags:
    - cis_4_4_1_13
    - stig_v_230271
    - nist_sc_7
    - iso_27001_9_4
    - networking
    - firewall
    - forensic

- name: "CIS 4.4.1.14 | STIG V-230271 | ISO 27001 §9.4 | Audit Code 540002 | Apply granular IP-restricted firewall rules (UFW)"
  community.general.ufw:
    rule: allow
    port: "{{ item.port | string }}"
    proto: "{{ item.proto | default('tcp') }}"
    from_ip: "{{ item.src | default('any') }}"
    comment: "{{ item.comment | default('Managed by Deploy-System-Unified') }}"
  loop: "{{ networking_firewall_additional_rules }}"
  when: ansible_os_family == 'Debian'
  become: true
  tags:
    - cis_4_4_1_14
    - stig_v_230271
    - nist_ac_4
    - iso_27001_9_4
    - networking
    - firewall
    - forensic
