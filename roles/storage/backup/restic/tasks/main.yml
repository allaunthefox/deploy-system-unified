---
# Tasks for backup/restic - Deduplicated Encrypted Backups
# Compliance: CIS 3.x, STIG V-230520, NIST CP-9/SC-28/SC-12, ISO 27001 §8.11/§8.12

- name: "CIS 3.6.1 | STIG V-230600 | NIST SC-12 | Verify Restic secrets when fail-secure is enabled"
  ansible.builtin.include_tasks: verify_secrets.yml
  when:
    - restic_enable | bool
  tags:
    - cis_3_6_1
    - stig_v_230600
    - nist_sc_12
    - backup
    - restic

- name: "CIS 3.6.2 | STIG V-230601 | NIST CP-9 | ISO 9001 | Audit Code 600030 | Validate Archival Eligibility (Ephemeral Guard)"
  ansible.builtin.assert:
    that:
      - not (deployment_profile | default('') == 'ephemeral' and restic_archival_mode | bool and not system_storage_archival_ephemeral_allow | default(false) | bool)
    fail_msg: "CRITICAL: Archival-grade compression is restricted in ephemeral profiles. Use standard mode or set system_storage_archival_ephemeral_allow: true."
  tags:
    - cis_3_6_2
    - stig_v_230601
    - nist_cp_9
    - iso_9001
    - backup
    - restic
    - audit
    - profile_guard
  when: restic_enable | bool and restic_archival_mode | bool

- name: "CIS 3.6.3 | STIG V-230602 | NIST CP-9 | ISO 27040 §13 | Audit Code 600032 | Validate Integrity Testing Requirement (Hardened Profile)"
  ansible.builtin.assert:
    that:
      - not (deployment_profile | default('') == 'hardened' and not restic_restore_test_enabled | bool)
    fail_msg: "CRITICAL: Hardened profiles require mandatory restore testing (ISO 27040 §13). Set restic_restore_test_enabled: true."
  tags:
    - cis_3_6_3
    - stig_v_230602
    - nist_cp_9
    - iso_27040
    - backup
    - restic
    - audit
    - hardened_archival
  when: restic_enable | bool and restic_archival_mode | bool

- name: "CIS 3.6.4 | STIG V-230603 | NIST CP-9 | Install Restic"
  ansible.builtin.package:
    name: restic
    state: present
  tags:
    - cis_3_6_4
    - stig_v_230603
    - nist_cp_9
    - backup
    - restic
    - iso_27040
  when: restic_enable | bool

- name: "CIS 3.6.5 | STIG V-230604 | NIST SC-28 | Create Restic configuration directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ restic_user }}"
    group: "{{ restic_group }}"
    mode: '0700'
  loop:
    - "{{ restic_config_dir }}"
    - "{{ restic_log_dir }}"
    - "/var/cache/restic"
  tags:
    - cis_3_6_5
    - stig_v_230604
    - nist_sc_28
    - backup
    - restic
    - iso_27040
  when: restic_enable | bool

- name: "CIS 3.6.6 | STIG V-230605 | NIST SC-12 | ISO 27040 | ISO 27001 §10.1 | Audit Code 500070 | Deploy Restic password file"
  ansible.builtin.copy:
    content: "{{ restic_password }}"
    dest: "{{ restic_config_dir }}/password"
    owner: "{{ restic_user }}"
    group: "{{ restic_group }}"
    mode: '0600'
  tags:
    - cis_3_6_6
    - stig_v_230605
    - nist_sc_12
    - iso_27040
    - iso_27001_10_1
    - backup
    - archival
    - remediate
  when: restic_enable | bool

- name: "CIS 3.6.7 | STIG V-230606 | NIST CP-9 | Deploy Restic wrapper script"
  ansible.builtin.template:
    src: restic_wrapper.sh.j2
    dest: "{{ restic_script_dir }}/restic_wrapper.sh"
    owner: "{{ restic_user }}"
    group: "{{ restic_group }}"
    mode: '0750'
  tags:
    - cis_3_6_7
    - stig_v_230606
    - nist_cp_9
    - backup
    - restic
    - iso_27040
  when: restic_enable | bool

- name: "CIS 3.6.8 | STIG V-230607 | NIST CP-9 | Deploy Restic Systemd Service"
  ansible.builtin.template:
    src: restic-backup.service.j2
    dest: /etc/systemd/system/restic-backup.service
    owner: root
    group: root
    mode: '0644'
  tags:
    - cis_3_6_8
    - stig_v_230607
    - nist_cp_9
    - backup
    - restic
    - iso_27040
  notify: reload_systemd
  when: restic_enable | bool

- name: "CIS 3.6.9 | STIG V-230608 | NIST CP-9 | Deploy Restic Systemd Timer"
  ansible.builtin.template:
    src: restic-backup.timer.j2
    dest: /etc/systemd/system/restic-backup.timer
    owner: root
    group: root
    mode: '0644'
  tags:
    - cis_3_6_9
    - stig_v_230608
    - nist_cp_9
    - backup
    - restic
    - iso_27040
  notify: reload_systemd
  when: restic_enable | bool

- name: "CIS 3.6.10 | STIG V-230609 | NIST CP-9 | ISO 27040 | Audit Code 900000 | Enable and Start Restic Timer"
  ansible.builtin.systemd:
    name: restic-backup.timer
    state: started
    enabled: true
  tags:
    - cis_3_6_10
    - stig_v_230609
    - nist_cp_9
    - iso_27040
    - backup
    - restic
  when: restic_enable | bool

- name: "CIS 3.6.11 | STIG V-230610 | NIST CP-9 | Perform Automated Restore Testing"
  ansible.builtin.include_tasks: restore_test.yml
  when:
    - restic_enable | bool
    - restic_restore_test_enabled | bool
  tags:
    - cis_3_6_11
    - stig_v_230610
    - nist_cp_9
    - backup
    - restic
    - restore_test
    - iso_27040