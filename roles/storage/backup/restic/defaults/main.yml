---
# Defaults for backup/restic

restic_enable: true

# Repository Location
# Supports local path (/srv/backup) or rclone remote (rclone:drive:backup)
restic_repo: "/srv/backups/restic"

# Password Management
# Defaults to a placeholder. MUST be overridden securely (e.g. via SOPS/Vault).
restic_password: "CHANGE_ME_IN_VAULT"

# Hardening: fail-secure gating for restic checks
restic_fail_secure: "{{ core_security_fail_secure | default(true) }}"

# Configuration
restic_user: "root"
restic_group: "root"
restic_config_dir: "/etc/restic"
restic_log_dir: "/var/log/restic"
restic_script_dir: "/usr/local/bin"

# Backup Sources
# List of directories to back up
restic_backup_sources:
  - "{{ containers_secrets_dir | default('/etc/containers/secrets') }}"
  - "/srv/containers"
  - "/srv/ops"
  # - "/srv/media" # Warning: Large! Consider excluding or using a separate repo.

# Retention Policy (Pruning)
restic_keep_daily: 7
restic_keep_weekly: 4
restic_keep_monthly: 6

# Schedule (Systemd Timer)
restic_schedule_on_calendar: "daily"

# Automated Restore Testing (ISO 27040 Alignment)
# Periodically verify backup integrity by performing a sample restore.
restic_restore_test_enabled: false
restic_restore_test_path: "/tmp/restic-restore-test"
restic_restore_test_subset: "*" # Subset of files to restore for speed (e.g. "secrets/*")
restic_restore_test_cleanup: true # Shred and delete restore data after test

# Archival Standards (NoDupeLabs Alignment)
# If enabled, uses --compression max and optimized chunking
# Strict Logic: Archival mode is always 'false' in ephemeral unless explicitly allowed.
restic_archival_mode_effective: >-
  {{ false if (deployment_profile | default('') == 'ephemeral' and not system_storage_archival_ephemeral_allow | default(false) | bool) else system_storage_restic_archival | default(false) | bool }}

restic_archival_mode: "{{ restic_archival_mode_effective }}"
restic_compression_level: "{{ 'max' if restic_archival_mode | bool else 'auto' }}"

# Hash verification and backup security
# Enable: Include shared/tasks/backup_security.yml in your playbook
backup_security_enabled: true
backup_security_dir: "/var/backups/security"
backup_name: "restic"
backup_source_path: "{{ restic_repo }}"
