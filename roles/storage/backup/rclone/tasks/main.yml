# =============================================================================
# Audit Event Identifier: DSU-PLY-100697
# Last Updated: 2026-02-28
# =============================================================================
---
# Tasks for backup/rclone - Cloud Sync
# Compliance: CIS 3.x, STIG V-230520, NIST CP-9/SC-28/SC-12, ISO 27001 ยง8.11/ยง8.12

- name: "CIS 3.7.1 | STIG V-230620 | NIST CP-9 | Install rclone"
  ansible.builtin.package:
    name: rclone
    state: present
  tags:
    - cis_3_7_1
    - stig_v_230620
    - nist_cp_9
    - storage
    - backup
    - rclone
  when: rclone_enable | bool

- name: "CIS 3.7.2 | STIG V-230621 | NIST SC-28 | Create rclone configuration directory"
  ansible.builtin.file:
    path: "{{ rclone_config_dir }}"
    state: directory
    mode: '0700'
    owner: "{{ rclone_user }}"
    group: "{{ rclone_group }}"
  tags:
    - cis_3_7_2
    - stig_v_230621
    - nist_sc_28
    - storage
    - backup
    - rclone
  when: rclone_enable | bool

- name: "CIS 3.7.3 | STIG V-230622 | NIST SC-12 | ISO 27040 | ISO 27001 ยง10.1 | Audit Code 400011 | Deploy Rclone Configuration"
  ansible.builtin.copy:
    content: "{{ rclone_config_content }}"
    dest: "{{ rclone_conf_file }}"
    mode: '0600'
    owner: "{{ rclone_user }}"
    group: "{{ rclone_group }}"
  no_log: true
  tags:
    - cis_3_7_3
    - stig_v_230622
    - nist_sc_12
    - iso_27040
    - iso_27001_10_1
    - backup
    - rclone
    - remediate
  when:
    - rclone_enable | bool
    - rclone_config_content | length > 0
