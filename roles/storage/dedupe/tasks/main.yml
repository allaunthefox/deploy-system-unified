---
# Tasks for storage/dedupe - NoDupeLabs Archival Standards
# Compliance: CIS 3.x, STIG V-230520, NIST CP-9/SC-28/SC-12, ISO 27001 ยง8.11/ยง8.12

- name: "CIS 3.8.1 | STIG V-230630 | NIST CP-9 | ISO 9001 | Action 600030 | Validate Archival Eligibility (Ephemeral Guard)"
  ansible.builtin.assert:
    that:
      - not storage_dedupe_ephemeral_skip | bool
    fail_msg: "CRITICAL: Archival/Deduplication operations are forbidden in ephemeral profiles without 'system_storage_archival_ephemeral_allow: true'."
  tags:
    - cis_3_8_1
    - stig_v_230630
    - nist_cp_9
    - iso_9001
    - storage
    - dedupe
    - audit
    - profile_guard
  when: storage_dedupe_btrfs_enable | bool

- name: "CIS 3.8.2 | STIG V-230631 | NIST CP-9 | ISO 27040 ยง13 | Action 600032 | Validate Forensic Audit Requirement (Hardened Profile)"
  ansible.builtin.assert:
    that:
      - not (deployment_profile | default('') == 'hardened' and not storage_dedupe_btrfs_audit_mandatory | default(true))
    fail_msg: "CRITICAL: Hardened profiles require mandatory deduplication auditing (ISO 27040 ยง13)."
  tags:
    - cis_3_8_2
    - stig_v_230631
    - nist_cp_9
    - iso_27040
    - storage
    - dedupe
    - audit
    - hardened_archival
  when: storage_dedupe_btrfs_enable | bool

- name: "CIS 3.8.3 | STIG V-230632 | NIST SC-28 | ISO 27040 | Action 530001 | Install duperemove (Btrfs)"
  ansible.builtin.package:
    name: duperemove
    state: present
  become: true
  when: storage_dedupe_btrfs_enable | bool
  tags:
    - cis_3_8_3
    - stig_v_230632
    - nist_sc_28
    - iso_27040
    - storage
    - dedupe
    - btrfs

- name: "CIS 3.8.4 | STIG V-230633 | NIST SC-28 | ISO 27040 | Action 500060 | Create Btrplication Hash Directory"
  ansible.builtin.file:
    path: /var/lib/duperemove
    state: directory
    mode: '0700'
  become: true
  when: storage_dedupe_btrfs_enable | bool
  tags:
    - cis_3_8_4
    - stig_v_230633
    - nist_sc_28
    - iso_27040
    - storage
    - dedupe
    - btrfs

- name: "CIS 3.8.5 | STIG V-230634 | NIST CP-9 | ISO 27040 | Action 500060 | Schedule Weekly Btrfs Deduplication"
  ansible.builtin.cron:
    name: "Btrfs offline deduplication (duperemove)"
    minute: "0"
    hour: "3"
    weekday: "0"
    job: "/usr/bin/duperemove -dr --hashfile /var/lib/duperemove/hash.db {{ storage_dedupe_btrfs_paths | join(' ') }} > /var/log/duperemove.log 2>&1"
  become: true
  when: storage_dedupe_btrfs_enable | bool
  tags:
    - cis_3_8_5
    - stig_v_230634
    - nist_cp_9
    - iso_27040
    - storage
    - dedupe
    - btrfs
    - remediate

- name: "CIS 3.8.6 | STIG V-230635 | NIST SC-12 | ISO 27040 | Action 500023 | Audit Deduplication Potential (Dry Run)"
  ansible.builtin.shell: |
    duperemove -Ar {{ item }} | grep "Comparison of" | tail -n 1
  loop: "{{ storage_dedupe_btrfs_paths }}"
  register: dedupe_audit
  become: true
  changed_when: false
  failed_when: false
  tags:
    - cis_3_8_6
    - stig_v_230635
    - nist_sc_12
    - iso_27040
    - storage
    - dedupe
    - btrfs
    - audit
  when: storage_dedupe_btrfs_enable | bool

- name: "CIS 3.8.7 | STIG V-230636 | NIST SC-12 | ISO 27040 | Report Deduplication Audit"
  ansible.builtin.debug:
    msg: "Dedupe Audit for {{ item.item }}: {{ item.stdout | default('N/A') }}"
  loop: "{{ dedupe_audit.results }}"
  when: storage_dedupe_btrfs_enable | bool
  tags:
    - cis_3_8_7
    - stig_v_230636
    - nist_sc_12
    - iso_27040
    - storage
    - dedupe
    - btrfs
    - audit
