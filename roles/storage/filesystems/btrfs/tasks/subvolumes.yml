# =============================================================================
# Audit Event Identifier: DSU-PLY-100731
# Last Updated: 2026-02-28
# =============================================================================
---
# Btrfs subvolume management
- name: Check if path is on a Btrfs filesystem
  ansible.builtin.shell: |
    stat -f -c %T "{{ item.path | dirname }}"
  register: fs_type_check
  loop: "{{ btrfs_subvolumes | default([]) }}"
  changed_when: false
  failed_when: false
- name: Check if Btrfs subvolume exists
  ansible.builtin.shell: |
    if [ -d "{{ item.item.path }}" ] && btrfs subvolume list "{{ item.item.path | dirname }}" | grep -q "{{ item.item.path | basename }}"; then
      echo "exists"
    else
      echo "absent"
    fi
  register: btrfs_subvol_check
  loop: "{{ fs_type_check.results }}"
  changed_when: false
  failed_when: false
  args:
    
  become: true
  when: item.stdout == "btrfs"

- name: Create Btrfs subvolumes
  ansible.builtin.command:
    cmd: "btrfs subvolume create {{ item.item.item.path }}"
  loop: "{{ btrfs_subvol_check.results }}"
  when:
    - item.stdout is defined
    - item.stdout == "absent"
    - item.item.stdout == "btrfs"
  become: true
  tags:
    - storage
    - btrfs
    - subvolumes
    - iso_27040
