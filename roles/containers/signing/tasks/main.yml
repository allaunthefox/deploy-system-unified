---
# Containers - Cosign Image Signing Role
# WI-CONT | Work Instructions for Containers
# ISO 27001 §14.2 - Supply Chain Security
# Supports: keyless signing, verification policies, key management

- name: Check if cosign is already installed
  ansible.builtin.command:
    cmd: cosign version
  register: cosign_check
  failed_when: false
  changed_when: false

- name: Get system architecture
  ansible.builtin.set_fact:
    cosign_arch: "{{ 'amd64' if ansible_facts['architecture'] == 'x86_64' else 'arm64' }}"
  changed_when: false

- name: "ISO 27001 §14.2 | NIST SI-3 | CIS 4.5 | Action 700014 | Install cosign binary for container image signing"
  ansible.builtin.unarchive:
    src: "https://github.com/sigstore/cosign/releases/download/v{{ cosign_version }}/cosign-linux-{{ cosign_arch }}.tar.gz"
    dest: /usr/local/bin
    remote_src: true
    creates: /usr/local/bin/cosign
    checksum: "{{ cosign_checksums[cosign_version][cosign_arch] | default(omit) }}"
  become: true
  when: cosign_check.rc != 0
  tags:
    - iso_27001_14_2
    - nist_si_3
    - cis_4_5
    - action_700014
    - cosign
    - signing
    - containers
    - security
    - supply_chain
    - remediate

- name: VERIFY | Cosign binary is functional (Zero-Tolerance)
  ansible.builtin.command:
    cmd: /usr/local/bin/cosign version
  register: _cosign_ver
  failed_when: _cosign_ver.rc != 0
  changed_when: false
  become: true
  tags: [cosign, security, verification]

- name: "ISO 27001 §14.2 | ISO 27001 §10.1 | Action 400011 | Create cosign directories for secure key storage"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true
  loop:
    - /etc/cosign
    - /etc/cosign/keys
    - /etc/cosign/policies
    - /var/log/cosign
  tags:
    - iso_27001_14_2
    - iso_27001_10_1
    - action_400011
    - cosign
    - signing
    - containers
    - security

- name: "ISO 27001 §10.1 | NIST SC-13 | Action 400012 | Generate cosign key pair for image signing"
  ansible.builtin.command:
    cmd: >
      cosign generate-key-pair
      --key /etc/cosign/keys/cosign.key
  become: true
  changed_when: true
  when:
    - cosign_key_mode == 'keypair'
    - not cosign_skip_keygen
  tags:
    - iso_27001_10_1
    - nist_sc_13
    - action_400012
    - cosign
    - signing
    - keygen
    - cryptography

- name: "ISO 27001 §14.2 | NIST SI-3 | Action 700014 | Deploy verification policy for container images"
  ansible.builtin.template:
    src: verification-policy.yaml.j2
    dest: /etc/cosign/policies/{{ cosign_policy_name }}.yaml
    owner: root
    group: root
    mode: '0644'
  become: true
  when: cosign_enable_verification
  tags:
    - iso_27001_14_2
    - nist_si_3
    - action_700014
    - cosign
    - policy
    - signing
    - supply_chain

- name: "ISO 27001 §14.2 | NIST SI-3 | Action 700014 | Create keyless verification policy"
  ansible.builtin.copy:
    src: keyless-policy.yaml
    dest: /etc/cosign/policies/keyless-policy.yaml
    owner: root
    group: root
    mode: '0644'
  become: true
  when: cosign_keyless_mode
  tags:
    - iso_27001_14_2
    - nist_si_3
    - action_700014
    - cosign
    - keyless
    - policy

- name: "ISO 27001 §14.2 | ISO 27001 §10.1 | Action 400013 | Deploy cosign environment configuration"
  ansible.builtin.template:
    src: cosign.env.j2
    dest: /etc/cosign/cosign.env
    owner: root
    group: root
    mode: '0644'
  become: true
  tags:
    - iso_27001_14_2
    - iso_27001_10_1
    - action_400013
    - cosign
    - config
    - signing

- name: "ISO 27001 §10.1 | NIST SC-13 | Action 400013 | Store cosign root certificate"
  ansible.builtin.copy:
    content: "{{ cosign_root_cert }}"
    dest: /etc/cosign/cosign.crt
    owner: root
    group: root
    mode: '0644'
  become: true
  when: cosign_root_cert | default('', true) != ''
  tags:
    - iso_27001_10_1
    - nist_sc_13
    - action_400013
    - cosign
    - certificate
    - signing
    - cryptography

- name: "ISO 27001 §14.2 | NIST SI-3 | Action 700014 | Configure cosignful verification"
  ansible.builtin.copy:
    content: |
      # Cosignful configuration
      # This enables additional security checks for container images
      COSIGNFUL_ENABLED=true
      COSIGNFUL_POLICY_PATH=/etc/cosign/policies
      COSIGNFUL_LOG_LEVEL={{ cosign_log_level | default('info') }}
    dest: /etc/cosign/cosignful.conf
    owner: root
    group: root
    mode: '0644'
  become: true
  when: cosign_enable_cosignful
  tags:
    - iso_27001_14_2
    - nist_si_3
    - action_700014
    - cosign
    - cosignful
    - signing

- name: "ISO 27001 §14.2 | NIST SI-3 | Action 700014 | Verify image signature"
  ansible.builtin.command:
    cmd: >
      cosign verify
      {% if cosign_key_mode == 'keypair' %}
      --key /etc/cosign/keys/cosign.pub
      {% elif cosign_keyless_mode %}
      --fulcio-url {{ cosign_fulcio_url }}
      --rekor-url {{ cosign_rekor_url }}
      {% endif %}
      {% if cosign_enable_verification %}
      --policy /etc/cosign/policies/{{ cosign_policy_name }}.yaml
      {% endif %}
      {{ cosign_verify_image }}
  register: cosign_verify_result
  changed_when: false
  when: cosign_verify_image | default('', true) != ''
  tags:
    - iso_27001_14_2
    - nist_si_3
    - action_700014
    - cosign
    - verify
    - signing
    - supply_chain

- name: Display verification result
  ansible.builtin.debug:
    msg: "Image verification result: {{ cosign_verify_result.stdout }}"
  when: cosign_verify_image | default('', true) != ''
  tags:
    - iso_27001_14_2
    - nist_si_3
    - action_700014
    - cosign
    - verify
    - signing

- name: Set cosign signing complete flag
  ansible.builtin.set_fact:
    cosign_signing_complete: true
  tags:
    - iso_27001_14_2
    - action_700014
    - cosign
    - signing
