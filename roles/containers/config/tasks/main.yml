---
# Container configuration role - General container configuration
# Compliance: CIS Docker Benchmark 3.x, STIG V-230420, NIST SC-39/CM-6, ISO 27001 ยง8.20

- name: "CIS 3.1 | STIG V-230420 | NIST CM-6 | Create container storage directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  loop:
    - /srv/containers
    - /srv/containers/volumes
    - /srv/containers/configs
    - /var/lib/containers
  become: true
  tags:
    - cis_3_1
    - stg_v230420
    - nist_cm_6
    - containers
    - configuration

- name: "CIS 3.2 | STIG V-230420 | NIST SC-39 | ISO 27001 ยง8.20 | Action 500000 | Configure container storage"
  ansible.builtin.copy:
    dest: /etc/containers/storage.conf
    content: |
      [storage]
      driver = "overlay"
      runroot = "/run/containers/storage"
      graphroot = "/var/lib/containers/storage"
      [storage.options]
      additionalimagestores = []
      size = ""
      [storage.options.overlay]
      mountopt = "nodev,metacopy=on"
    mode: '0644'
  become: true
  tags:
    - cis_3_2
    - stg_v230420
    - nist_sc_39
    - iso_27001_8_20
    - iso_27001_8_26
    - containers
    - configuration
    - remediate

- name: "CIS 3.3 | STIG V-230420 | NIST CM-6 | Check container lingering status"
  ansible.builtin.command:
    cmd: "loginctl show-user {{ item }} -p Linger"
  loop: "{{ container_linger_users | default([]) }}"
  register: linger_status
  changed_when: false
  failed_when: false
  tags:
    - cis_3_3
    - stg_v230420
    - nist_cm_6
    - containers
    - configuration

- name: "CIS 3.4 | STIG V-230420 | NIST CM-6 | ISO 27001 ยง9.2 | Action 510002 | Enable container lingering for service users"
  ansible.builtin.command:
    cmd: "loginctl enable-linger {{ item.item }}"
  loop: "{{ linger_status.results }}"
  when:
    - container_linger_users is defined and container_linger_users | length > 0
    - item.rc == 0
    - "'Linger=no' in item.stdout"
  become: true
  changed_when: true
  tags:
    - cis_3_4
    - stg_v230420
    - nist_cm_6
    - iso_27001_9_2
    - containers
    - configuration
    - remediate

- name: "CIS 3.5 | STIG V-230420 | NIST SC-39 | Set containers config completion flag"
  ansible.builtin.set_fact:
    containers_config_complete: true
  tags:
    - cis_3_5
    - stg_v230420
    - nist_sc_39
    - containers
    - configuration

- name: "CIS 3.6 | STIG V-230420 | NIST IA-2 | Configure container secrets setup"
  ansible.builtin.include_tasks: secrets_setup.yml
  tags:
    - cis_3_6
    - stg_v230420
    - nist_ia_2
    - containers
    - configuration
