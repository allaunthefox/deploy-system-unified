---
# Container configuration role - General container configuration
- name: Create container storage directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  loop:
    - /srv/containers
    - /srv/containers/volumes
    - /srv/containers/configs
    - /var/lib/containers
  become: true
- name: "ISO 27001 ยง8.26 | Action 500000 | Configure container storage"
  ansible.builtin.copy:
    dest: /etc/containers/storage.conf
    content: |
      [storage]
      driver = "overlay"
      runroot = "/run/containers/storage"
      graphroot = "/var/lib/containers/storage"
      [storage.options]
      additionalimagestores = []
      size = ""
      [storage.options.overlay]
      mountopt = "nodev,metacopy=on"
    mode: '0644'
  become: true
  tags:
    - iso_27001_8_26
    - containers
    - configuration
    - remediate

- name: Check container lingering status
  ansible.builtin.command:
    cmd: "loginctl show-user {{ item }} -p Linger"
  loop: "{{ container_linger_users | default([]) }}"
  register: linger_status
  changed_when: false
  failed_when: false
  tags:
    - containers
    - configuration

- name: "ISO 27001 ยง9.2 | Action 510002 | Enable container lingering for service users"
  ansible.builtin.command:
    cmd: "loginctl enable-linger {{ item.item }}"
  loop: "{{ linger_status.results }}"
  when:
    - container_linger_users is defined and container_linger_users | length > 0
    - item.rc == 0
    - "'Linger=no' in item.stdout"
  become: true
  changed_when: true
  tags:
    - iso_27001_9_2
    - containers
    - configuration
    - remediate
- name: Set containers config completion flag
  ansible.builtin.set_fact:
    containers_config_complete: true

- ansible.builtin.include_tasks: secrets_setup.yml
