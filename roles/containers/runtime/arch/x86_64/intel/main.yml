# =============================================================================
# Audit Event Identifier: DSU-PLY-100124
# Last Updated: 2026-02-28
# =============================================================================
---
# CIS Docker Benchmark | Pod Security Standards
- name: Install GPU drivers and container toolkit (Intel/x86_64)
  ansible.builtin.package:
    name: "{{ containers_gpu_profiles['intel']['driver_packages'][ansible_facts['os_family'] | lower] }}"
    state: present
  failed_when: false

- name: Configure container runtime for GPU support (Intel)
  ansible.builtin.lineinfile:
    path: /etc/containers/containers.conf
    regexp: "^#?default_capabilities ="
    line: 'default_capabilities = ["CAP_CHOWN", "CAP_DAC_OVERRIDE", "CAP_FSETID", "CAP_FOWNER", "CAP_MKNOD", "CAP_NET_RAW", "CAP_SETGID", "CAP_SETUID", "CAP_SETFCAP", "CAP_SETPCAP", "CAP_NET_BIND_SERVICE", "CAP_SYS_CHROOT", "CAP_KILL", "CAP_AUDIT_WRITE"]'

- name: Validate default_capabilities contain only CAP_* entries (Intel)
  ansible.builtin.shell: |
    python3 - <<'PY'
    import re
    path = "/etc/containers/containers.conf"
    with open(path, "r", encoding="utf-8") as f:
      content = f.read()
    m = re.search(r'^default_capabilities\\s*=\\s*\\[(.*?)\\]$', content, re.MULTILINE)
    if not m:
      raise SystemExit("default_capabilities not found in containers.conf")
    items = [i.strip().strip('"').strip("'") for i in m.group(1).split(",") if i.strip()]
    invalid = [i for i in items if not i.startswith("CAP_")]
    if invalid:
      raise SystemExit("Invalid default_capabilities entries: " + ", ".join(invalid))
    PY
  changed_when: false
  become: true

- name: Ensure Intel Compute and Display devices are accessible
  ansible.builtin.lineinfile:
    path: /etc/containers/containers.conf
    regexp: "^#?default_device_groups ="
    # Add video/render groups for /dev/dri/card* (Display) and /dev/dri/renderD* (Compute)
    line: 'default_device_groups = ["video", "render"]'
    insertafter: "\\[containers\\]"
  notify: restart podman
