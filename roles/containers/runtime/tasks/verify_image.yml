# =============================================================================
# Audit Event Identifier: DSU-PLY-100143
# Last Updated: 2026-02-28
# =============================================================================
---
# Reusable task for verifying image signatures via Cosign
# Use: ansible.builtin.include_tasks: roles/containers/runtime/tasks/verify_image.yml
# vars: { image_to_verify: "docker.io/library/alpine:latest" }

- name: "ISO 27001 ยง14.2 | Audit Code 700014 | Verify Image Signature (Supply Chain)"
  ansible.builtin.shell: |
    
    # We use --allow-import-from-signer-repo for better registry compatibility
    cosign verify --key {{ containers_cosign_public_key | default('') }} {{ image_to_verify }}
  args:
    executable: /bin/sh
  register: image_signature_result
  changed_when: false
  become: true
  when: containers_cosign_enable | bool

- name: "Audit Code 700015 | Enforce Trusted Supply Chain"
  ansible.builtin.assert:
    that:
      - (not containers_cosign_enable | bool) or (image_signature_result.rc == 0)
    fail_msg: |-
      CRITICAL: Supply Chain Violation detected for image: {{ image_to_verify }}
      The image signature could not be verified via Cosign.
      Reason: {{ image_signature_result.stderr | default('Signature missing or invalid') }}
  tags: [containers, supply_chain, audit]
