# =============================================================================
# Audit Event Identifier: DSU-PLY-100137
# Last Updated: 2026-02-28
# =============================================================================
---
# Install Podman and Core Runtime Dependencies

- name: "ISO 27001 §8.26 | Audit Code 700000 | Install Podman on Debian/Ubuntu"
  ansible.builtin.apt:
    name:
      - podman
      - slirp4netns
      - fuse-overlayfs
      - apparmor-utils
      - uidmap
      - netavark
      - aardvark-dns
    state: present
  when: ansible_facts['os_family'] == 'Debian'
  become: true
  tags:
    - iso_27001_8_26
    - containers
    - runtime

- name: "ISO 27001 §8.26 | Audit Code 700000 | Install Podman on RedHat/CentOS"
  ansible.builtin.dnf:
    name:
      - podman
      - slirp4netns
      - fuse-overlayfs
      - selinux-policy-targeted
      - netavark
      - aardvark-dns
    state: present
  when: ansible_facts['os_family'] == 'RedHat'
  become: true
  tags:
    - iso_27001_8_26
    - containers
    - runtime

- name: "ISO 27001 §8.26 | Audit Code 700000 | Install Podman on Arch"
  community.general.pacman:
    name:
      - podman
      - slirp4netns
      - fuse-overlayfs
      - netavark
      - aardvark-dns
    state: present
  when: ansible_facts['distribution'] | lower == 'archlinux'
  become: true
  tags:
    - iso_27001_8_26
    - containers
    - runtime

- name: "ISO 27001 §8.26 | Audit Code 700000 | Install Podman on Alpine"
  community.general.apk:
    name:
      - podman
      - slirp4netns
      - fuse-overlayfs
      - netavark
      - aardvark-dns
    state: present
  when: ansible_facts['os_family'] == 'Alpine'
  become: true
  tags:
    - iso_27001_8_26
    - containers
    - runtime

- name: "ISO 27001 §8.26 | Audit Code 450002 | Enable IPv4 forwarding for container networking"
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    sysctl_file: /etc/sysctl.d/90-podman.conf
    state: present
    reload: true
  become: true
  tags:
    - iso_27001_8_26
    - containers
    - runtime
    - remediate

- name: "ISO 27001 §8.26 | Audit Code 410002 | Configure container security settings"
  ansible.builtin.copy:
    dest: /etc/containers/containers.conf
    content: |
      [containers]
      log_driver = "journald"
      log_size_max = 10485760
      pids_limit = 2048
      {% if containers_userns_auto | default(true) | bool %}
      userns = "auto"
      {% endif %}
      signature_policy = "/etc/containers/policy.json"
      default_capabilities = ["CAP_CHOWN", "CAP_DAC_OVERRIDE", "CAP_FSETID", "CAP_FOWNER", "CAP_MKNOD", "CAP_NET_RAW", "CAP_SETGID", "CAP_SETUID", "CAP_SETFCAP", "CAP_SETPCAP", "CAP_NET_BIND_SERVICE", "CAP_SYS_CHROOT", "CAP_KILL", "CAP_AUDIT_WRITE"]
      [network]
      network_backend = "netavark"
      [engine]
      runtime = "crun"
      cgroup_manager = "systemd"
      events_logger = "journald"
    mode: '0644'
  become: true
  tags:
    - iso_27001_8_26
    - containers
    - runtime
    - remediate

- name: Validate default_capabilities contain only CAP_* entries
  ansible.builtin.shell: |
    python3 - <<'PY'
    import re
    path = "/etc/containers/containers.conf"
    with open(path, "r", encoding="utf-8") as f:
      content = f.read()
    m = re.search(r'^default_capabilities\s*=\s*\[(.*?)\]', content, re.MULTILINE | re.DOTALL)
    if not m:
      raise SystemExit("default_capabilities not found in containers.conf")
    items = [i.strip().strip('"').strip("'") for i in m.group(1).split(",") if i.strip()]
    invalid = [i for i in items if not i.startswith("CAP_")]
    if invalid:
      raise SystemExit("Invalid default_capabilities entries: " + ", ".join(invalid))
    PY
  changed_when: false
  become: true
  tags:
    - security
    - containers

- name: "ISO 27001 §8.26 | Audit Code 410002 | Configure container signature policy"
  ansible.builtin.copy:
    dest: /etc/containers/policy.json
    content: |
      {
        "default": [{
            "type": "reject"
          }],
        "transports": {
          "docker": {
            "docker.io": [{
                "type": "signedBy",
                "keyType": "GPGKeys",
                "keyPath": "/etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-Official"
              }],
            "ghcr.io": [{
                "type": "signedBy",
                "keyType": "GPGKeys",
                "keyPath": "/etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-Official"
              }]
          }
        }
      }
    mode: '0644'
  become: true
  tags:
    - iso_27001_8_26
    - containers
    - runtime
    - remediate

- name: "ISO 27001 §8.26 | Audit Code 440001 | Enable AppArmor for containers (Debian/Ubuntu)"
  ansible.builtin.command:
    cmd: aa-enforce /etc/apparmor.d/containers/*
  register: apparmor_result
  changed_when: false
  become: true
  when: ansible_facts['os_family'] == 'Debian'
  tags:
    - iso_27001_8_26
    - containers
    - apparmor
    - remediate

- name: VERIFY | AppArmor enforcing for containers (Zero-Tolerance)
  ansible.builtin.shell: aa-status | grep -q "enforce mode"
  become: true
  when: ansible_facts['os_family'] == 'Debian'
  changed_when: false
  tags: [security, apparmor, verification]

- name: "ISO 27001 §8.26 | Audit Code 440001 | Enable SELinux for containers (RedHat/CentOS)"
  ansible.posix.seboolean:
    name: "{{ item }}"
    state: true
    persistent: true
  loop:
    - container_use_cephfs
    - container_use_nfs
  become: true
  when: ansible_facts['os_family'] == 'RedHat'
  tags:
    - iso_27001_8_26
    - containers
    - selinux
    - remediate

- name: VERIFY | SELinux enforcing (Zero-Tolerance)
  ansible.builtin.shell: getenforce | grep -q "Enforcing"
  become: true
  when: ansible_facts['os_family'] == 'RedHat'
  changed_when: false
  tags: [security, selinux, verification]

- name: Create podman configuration directory
  ansible.builtin.file:
    path: /etc/containers
    state: directory
    mode: '0755'
  become: true

- name: Configure container registries
  ansible.builtin.copy:
    dest: /etc/containers/registries.conf
    content: |
      # Container registries configuration
      unqualified-search-registries = ["docker.io", "quay.io", "ghcr.io"]
      [[registry]]
      prefix = "docker.io"
      location = "docker.io"
      [[registry.mirror]]
      location = "mirror.gcr.io"
    mode: '0644'
  become: true

- name: Check if systemd user instance is active
  ansible.builtin.command: systemctl --user is-system-running
  register: systemd_user_check
  failed_when: false
  changed_when: false
  environment: "{{ containers_systemd_env }}"
  become: "{{ podman_rootless_enabled | bool }}"
  become_user: "{{ podman_rootless_user }}"

- name: Enable podman socket for rootless containers
  ansible.builtin.systemd:
    name: podman.socket
    enabled: true
    state: started
    scope: user
  environment: "{{ containers_systemd_env }}"
  become: "{{ podman_rootless_enabled | bool }}"
  become_user: "{{ podman_rootless_user }}"
  when:
    - systemd_user_check.rc == 0
    - ansible_service_mgr == 'systemd'
    - not ansible_check_mode
