# =============================================================================
# Audit Event Identifier: DSU-PLY-100138
# Last Updated: 2026-02-28
# =============================================================================
---
# Tasks for containers/runtime role
# Compliance: CIS Docker/Podman Benchmark 2.x, STIG V-230410/V-230411, NIST SC-39/CM-7/AC-6, ISO 27001 §8.20/§8.23

- name: "Apply Common Container Patterns (Storage Lock Fix FIRST)"
  ansible.builtin.include_tasks: "{{ role_path }}/../common/tasks/main.yml"
  tags: [containers, runtime, internal]

- name: "Forensic Chain of Trust | Enforce Rule [B-02] (The Aggregator Wait)"
  ansible.builtin.include_tasks: "{{ role_path }}/../common/tasks/wait_for_aggregator.yml"
  tags: [forensic, audit, 840020]

- name: "CIS 2.1 | STIG V-230410 | NIST AC-6 | Apply rootless Podman prerequisites"
  ansible.builtin.include_tasks: rootless_prerequisites.yml
  when: podman_rootless_enabled | bool
  tags:
    - cis_2_1
    - stg_v230410
    - nist_ac_6
    - containers
    - runtime

- name: "CIS 2.1 | STIG V-230410 | NIST CM-7 | ISO 27001 §8.20 | Audit Code 700000 | Install Podman and Core Dependencies"
  ansible.builtin.include_tasks: install_podman.yml
  tags:
    - cis_2_1
    - stg_v230410
    - nist_cm_7
    - iso_27001_8_20
    - iso_27001_8_26
    - containers
    - runtime

- name: "CIS 2.1 | NIST AC-6 | ISO 27001 §8.20 | Audit Code 450002 | Manage User Namespaces"
  ansible.builtin.include_tasks: user_namespaces.yml
  tags:
    - cis_2_1
    - nist_ac_6
    - iso_27001_8_20
    - containers
    - runtime
    - security

- name: "ISO 27001 §8.26 | Audit Code 410002 | Automate Container Policy"
  ansible.builtin.include_tasks: policy_signature.yml
  tags:
    - iso_27001_8_26
    - containers
    - runtime
    - security

- name: "CIS 2.2 | STIG V-230411 | NIST SC-39 | Install Cosign for Supply Chain Integrity"
  ansible.builtin.include_tasks: install_cosign.yml
  when: containers_cosign_enable | bool
  tags:
    - cis_2_2
    - stg_v230411
    - nist_sc_39
    - containers
    - runtime
    - supply_chain

- name: "CIS 2.3 | STIG V-230410 | NIST CM-6 | Warn on weak/default credentials (container policy)"
  ansible.builtin.include_tasks: policy_default_passwords.yml
  tags:
    - cis_2_3
    - stg_v230410
    - nist_cm_6
    - security
    - containers

- name: "CIS 2.4 | STIG V-230410 | NIST AC-6 | ISO 27001 §8.23 | Audit Code 800410 | Setup GPU Container Support"
  ansible.builtin.include_tasks: gpu_setup_dispatcher.yml
  when: containers_enable_gpu_support
  tags:
    - cis_2_4
    - stg_v230410
    - nist_ac_6
    - iso_27001_8_23
    - iso_27001_8_26
    - containers
    - gpu
    - remediate

- name: "CIS 2.5 | STIG V-230410 | NIST SC-39 | ISO 27001 §8.20 | Audit Code 800400 | Discover GPU devices and capabilities"
  ansible.builtin.include_tasks: gpu_discovery.yml
  when: containers_enable_gpu_support
  tags:
    - cis_2_5
    - stg_v230410
    - nist_sc_39
    - iso_27001_8_20
    - iso_27001_8_26
    - containers
    - gpu

- name: "CIS 2.6 | STIG V-230411 | NIST CM-7 | Validate GPU slicing configuration"
  ansible.builtin.include_tasks: gpu_validation.yml
  when: containers_enable_gpu_support
  tags:
    - cis_2_6
    - stg_v230411
    - nist_cm_7
    - containers
    - gpu

- name: "CIS 2.7 | STIG V-230410 | NIST AC-6 | ISO 27001 §8.23 | Audit Code 800420 | Configure GPU slicing"
  ansible.builtin.include_tasks: gpu_slicing.yml
  when: containers_enable_gpu_support
  tags:
    - cis_2_7
    - stg_v230410
    - nist_ac_6
    - iso_27001_8_23
    - iso_27001_8_26
    - containers
    - gpu
    - remediate

- name: "CIS 2.8 | STIG V-230410 | NIST SC-39 | Report GPU configuration status"
  ansible.builtin.debug:
    msg: |
      {% if containers_enable_gpu_support %}
      GPU support enabled:
        Vendor: {{ containers_gpu_vendor_detected | default(containers_gpu_vendor) | upper }}
        Strategy: {{ containers_gpu_slicing_strategy | default('passthrough') }}
        Count: {{ containers_gpu_count_detected | default(containers_gpu_count) }}
        Device Info: {{ containers_gpu_device_info | default([]) }}
      {% else %}
      GPU support disabled. Set containers_enable_gpu_support: true to enable.
      {% endif %}
  tags:
    - cis_2_8
    - stg_v230410
    - nist_sc_39
    - containers
    - gpu

- name: "CIS 2.9 | STIG V-230410 | NIST CM-7 | Set containers runtime completion flag"
  ansible.builtin.set_fact:
    containers_runtime_complete: true
  tags:
    - cis_2_9
    - stg_v230410
    - nist_cm_7
    - containers
    - runtime

- name: "CIS 2.10 | STIG V-230411 | NIST AC-6 | Save Role Checkpoint"
  ansible.builtin.include_tasks: save_checkpoint.yml
  vars:
    additional_phases: ["containers/runtime"]
  tags:
    - cis_2_10
    - stg_v230411
    - nist_ac_6
    - containers
    - runtime
