---
# Tasks for containers/runtime role

- name: Apply rootless Podman prerequisites
  ansible.builtin.include_tasks: rootless_prerequisites.yml
  when: podman_rootless_enabled | bool

- name: "ISO 27001 ยง8.26 | Action 700000 | Install Podman and Core Dependencies"
  ansible.builtin.include_tasks: install_podman.yml
  tags:
    - iso_27001_8_26
    - containers
    - runtime

- name: Install Cosign for Supply Chain Integrity
  ansible.builtin.include_tasks: install_cosign.yml
  when: containers_cosign_enable | bool
  tags: [containers, runtime, supply_chain]

- name: Warn on weak/default credentials (container policy)
  ansible.builtin.include_tasks: policy_default_passwords.yml
  tags:
    - security
    - containers

- name: "ISO 27001 ยง8.26 | Action 800410 | Setup GPU Container Support"
  ansible.builtin.include_tasks: gpu_setup_dispatcher.yml
  when: containers_enable_gpu_support
  tags:
    - iso_27001_8_26
    - containers
    - gpu
    - remediate

- name: "ISO 27001 ยง8.26 | Action 800400 | Discover GPU devices and capabilities"
  ansible.builtin.include_tasks: gpu_discovery.yml
  when: containers_enable_gpu_support
  tags:
    - iso_27001_8_26
    - containers
    - gpu

- name: Validate GPU slicing configuration
  ansible.builtin.include_tasks: gpu_validation.yml
  when: containers_enable_gpu_support
  tags:
    - containers
    - gpu

- name: "ISO 27001 ยง8.26 | Action 800420 | Configure GPU slicing"
  ansible.builtin.include_tasks: gpu_slicing.yml
  when: containers_enable_gpu_support
  tags:
    - iso_27001_8_26
    - containers
    - gpu
    - remediate

- name: Report GPU configuration status
  ansible.builtin.debug:
    msg: |
      {% if containers_enable_gpu_support %}
      GPU support enabled:
        Vendor: {{ containers_gpu_vendor_detected | default(containers_gpu_vendor) | upper }}
        Strategy: {{ containers_gpu_slicing_strategy | default('passthrough') }}
        Count: {{ containers_gpu_count_detected | default(containers_gpu_count) }}
        Device Info: {{ containers_gpu_device_info | default([]) }}
      {% else %}
      GPU support disabled. Set containers_enable_gpu_support: true to enable.
      {% endif %}

- name: Set containers runtime completion flag
  ansible.builtin.set_fact:
    containers_runtime_complete: true

- name: Save Role Checkpoint
  ansible.builtin.include_tasks: save_checkpoint.yml
  vars:
    additional_phases: ["containers/runtime"]

