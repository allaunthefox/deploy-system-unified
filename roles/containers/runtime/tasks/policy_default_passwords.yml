---
# Container runtime policy checks.
# This file is intentionally "warn only" (no hard failures) to keep Molecule and
# development environments usable while still surfacing dangerous placeholders.

- name: Collect placeholder credential variables (container policy)
  ansible.builtin.set_fact:
    _container_policy_placeholder_vars: >-
      {{
        hostvars[inventory_hostname]
        | dict2items
        | selectattr('value', 'string')
        | selectattr('value', 'match', '^CHANGE_ME')
        | map(attribute='key')
        | list
      }}
  changed_when: false
  tags: [security, containers, runtime, audit]

- name: "Audit Code 400000 | Warn if placeholder credentials are present (container policy)"
  ansible.builtin.debug:
    msg: >-
      Container policy warning: placeholder credential values detected in variables:
      {{ _container_policy_placeholder_vars | join(', ') }}.
      Replace them in inventory/vault before production deployment.
  when: _container_policy_placeholder_vars | length > 0
  changed_when: false
  tags: [security, containers, runtime, audit]
