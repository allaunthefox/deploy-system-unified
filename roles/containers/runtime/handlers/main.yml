# =============================================================================
# Audit Event Identifier: DSU-PLY-100127
# Last Updated: 2026-03-01
# =============================================================================
---
# Handlers for containers/runtime role
# ISO 27001 §12.1 | NIST CM-7

- name: "ISO 27001 §12.1 | 600013 | reload_systemd"
  ansible.builtin.systemd:
    daemon_reload: true
  become: true
  listen: "reload systemd"

- name: "ISO 27001 §12.1 | 600013 | restart_podman"
  ansible.builtin.systemd:
    name: podman
    state: restarted
  become: true
  listen: "restart podman"
  when: ansible_service_mgr == 'systemd'

- name: "ISO 27001 §12.1 | 600013 | restart_podman_socket"
  ansible.builtin.systemd:
    name: podman.socket
    state: restarted
  become: true
  listen: "restart podman socket"
  when: ansible_service_mgr == 'systemd'

- name: "ISO 27001 §12.1 | 600013 | restart_podman_user_socket"
  ansible.builtin.systemd:
    name: podman.socket
    scope: user
    state: restarted
  become: true
  become_user: "{{ podman_rootless_user | default('root') }}"
  listen: "restart podman user socket"
  when:
    - ansible_service_mgr == 'systemd'
    - podman_rootless_enabled | default(false) | bool

- name: "ISO 27001 §12.1 | 600013 | reload_container_config"
  ansible.builtin.command: podman system migrate
  become: true
  listen: "reload container config"
  changed_when: false

- name: "ISO 27001 §12.1 | 600013 | restart_netavark"
  ansible.builtin.debug:
    msg: "Netavark configuration updated. Podman restart handles network reload."
  listen: "restart netavark"

- name: "ISO 27001 §12.1 | 600013 | restart_aardvark_dns"
  ansible.builtin.debug:
    msg: "Aardvark DNS configuration updated. Podman restart handles DNS reload."
  listen: "restart aardvark-dns"

- name: "ISO 27001 §12.1 | 600013 | migrate_podman_system"
  ansible.builtin.command: podman system migrate
  become: true
  listen: "migrate podman system"
  changed_when: true
