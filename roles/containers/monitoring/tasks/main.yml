---
- name: Check Monitoring Enable
  ansible.builtin.debug:
    msg: "Monitoring Stack deployment start (Instance: {{ monitoring_instance }})"
  when: monitoring_enable | bool

- name: Verify monitoring secrets when fail-secure is enabled
  ansible.builtin.include_tasks: verify_secrets.yml
  when:
    - monitoring_enable | bool

- name: Validate Grafana admin password is set
  ansible.builtin.assert:
    that:
      - monitoring_grafana_admin_password is defined
      - (monitoring_grafana_admin_password | default('') | length) > 0
    fail_msg: "Grafana admin password is not set or empty. Define 'monitoring_grafana_admin_password' in encrypted inventory."
  when: monitoring_enable | bool

- name: Enforce CHANGE_ME policy for monitoring stack
  ansible.builtin.include_tasks: "{{ role_path }}/../tasks/policy_change_me.yml"
  vars:
    change_me_policy_items:
      - name: "monitoring_grafana_admin_password"
        value: "{{ monitoring_grafana_admin_password | default('') }}"
        bad_values: ["CHANGE_ME_IN_VAULT", "CHANGE_ME_IN_SOPS", ""]
  when: monitoring_enable | bool

- name: "ISO 27001 §8.26 | Action 700030 | Create Monitoring Network Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/{{ monitoring_network }}.network"
    content: |
      [Network]
      NetworkName={{ monitoring_network }}
      Driver=bridge
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags:
    - iso_27001_8_26
    - containers
    - monitoring
    - remediate
  when:
    - monitoring_enable | bool
    - monitoring_network != "host"
  notify: reload_systemd

- name: Create Monitoring Directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "1000" # Approximate generic user, mostly for grafana
    group: "1000"
    mode: '0755'
  loop:
    - "{{ monitoring_root_dir }}"
    - "{{ monitoring_root_dir }}/prometheus"
    - "{{ monitoring_root_dir }}/grafana"
    - "{{ monitoring_config_dir }}"
    - "{{ monitoring_config_dir }}/prometheus"
  become: true
  tags:
    - containers
    - monitoring
  when: monitoring_enable | bool

- name: "ISO 27001 §10.1 | Action 400011 | Create Grafana secrets file"
  ansible.builtin.template:
    src: grafana.env.j2
    dest: "{{ containers_secrets_dir }}/grafana-{{ monitoring_instance }}.env"
    mode: '0600'
    owner: "{{ containers_secrets_owner }}"
    group: "{{ containers_secrets_group }}"
  become: true
  tags:
    - iso_27001_10_1
    - containers
    - monitoring
    - remediate
  when: monitoring_enable | bool

- name: "ISO 27001 §12.4 | Action 840000 | Deploy Prometheus Config"
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{ monitoring_config_dir }}/prometheus/prometheus.yml"
    mode: '0644'
  become: true
  tags:
    - iso_27001_12_4
    - containers
    - monitoring
    - remediate
  notify: restart_monitoring_pod
  when: monitoring_enable | bool

- name: "ISO 27001 §8.26 | Action 700000 | Deploy Monitoring Pod Quadlet"
  ansible.builtin.template:
    src: mon_pod.pod.j2
    dest: "{{ containers_systemd_dir }}/{{ monitoring_pod_name }}.pod"
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags:
    - iso_27001_8_26
    - containers
    - monitoring
    - remediate
  notify: reload_systemd
  when: monitoring_enable | bool

- name: "ISO 27001 §8.26 | Action 700000 | Deploy Prometheus Container Quadlet"
  ansible.builtin.template:
    src: prometheus.container.j2
    dest: "{{ containers_systemd_dir }}/prometheus-{{ monitoring_instance }}.container"
    mode: '0600'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags:
    - iso_27001_8_26
    - containers
    - monitoring
    - remediate
  notify: reload_systemd
  when: monitoring_enable | bool

- name: "ISO 27001 §8.26 | Action 700000 | Deploy Grafana Container Quadlet"
  ansible.builtin.template:
    src: grafana.container.j2
    dest: "{{ containers_systemd_dir }}/grafana-{{ monitoring_instance }}.container"
    mode: '0600'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags:
    - iso_27001_8_26
    - containers
    - monitoring
    - remediate
  notify: reload_systemd
  when: monitoring_enable | bool

- name: Deploy Forensic Intelligence Stack
  ansible.builtin.include_tasks: forensic_stack.yml
  when:
    - monitoring_enable | bool
    - monitoring_loki_enable | bool
  tags: [monitoring, loki, forensic]

- name: Provision Grafana Dashboard Framework
  ansible.builtin.include_tasks: grafana_provisioning.yml
  when:
    - monitoring_enable | bool
    - monitoring_forensic_dashboard_enabled | bool
  tags: [monitoring, grafana, forensic]

- name: Remove legacy generated systemd units (rootless)
  ansible.builtin.file:
    path: "{{ podman_rootless_user_home }}/.config/systemd/user/{{ item }}"
    state: absent
  loop:
    - "container-prometheus-{{ monitoring_instance }}.service"
    - "container-grafana-{{ monitoring_instance }}.service"
  become: true
  tags:
    - containers
    - monitoring
  when:
    - monitoring_enable | bool
    - podman_rootless_enabled | bool

- name: Reload rootless systemd to pick up quadlets
  ansible.builtin.systemd:
    daemon_reload: true
    scope: "{{ containers_systemd_scope }}"
  environment: "{{ containers_systemd_env }}"
  become: true
  become_user: "{{ containers_systemd_owner }}"
  tags:
    - containers
    - monitoring
  when:
    - monitoring_enable | bool
    - not ansible_check_mode

- name: "ISO 27001 §12.4 | Action 840000 | Start monitoring pod and services (quadlet units)"
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: started
    scope: "{{ containers_systemd_scope }}"
  loop:
    - "{{ monitoring_pod_name }}-pod"
    - "prometheus-{{ monitoring_instance }}"
    - "grafana-{{ monitoring_instance }}"
  environment: "{{ containers_systemd_env }}"
  become: true
  become_user: "{{ containers_systemd_owner }}"
  tags:
    - iso_27001_12_4
    - containers
    - monitoring
  when:
    - monitoring_enable | bool
    - not ansible_check_mode