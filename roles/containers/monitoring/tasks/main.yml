# =============================================================================
# Audit Event Identifier: DSU-PLY-100110
# Last Updated: 2026-03-01
# =============================================================================
---
# Tasks for containers/monitoring
# Compliance: CIS Docker Benchmark 6.x, STIG V-230450, NIST AU-2/AU-6/CA-7, ISO 27001 §8.15/§8.16

- name: "ISO 9001 | 600013 | CIS 6.1 | STIG V-230450 | NIST CA-7 | Check Monitoring Enable"
  ansible.builtin.debug:
    msg: "Monitoring Stack deployment start (Instance: {{ monitoring_instance }})"
  when: monitoring_enable | bool
  tags:
    - cis_6_1
    - stg_v230450
    - nist_ca_7
    - containers
    - monitoring
    - initialization

- name: "ISO 9001 | 600013 | CIS 6.2 | STIG V-230450 | NIST AU-2 | Verify monitoring secrets when fail-secure is enabled"
  ansible.builtin.include_tasks: verify_secrets.yml
  when:
    - monitoring_enable | bool
  tags:
    - cis_6_2
    - stg_v230450
    - nist_au_2
    - containers
    - monitoring
    - security
    - verify

- name: "ISO 9001 | 600013 | CIS 6.3 | STIG V-230450 | NIST IA-2 | Validate Grafana admin password is set"
  ansible.builtin.assert:
    that:
      - monitoring_grafana_admin_password is defined
      - (monitoring_grafana_admin_password | default('') | length) > 0
    fail_msg: "Grafana admin password is not set or empty. Define 'monitoring_grafana_admin_password' in encrypted inventory."
  when: monitoring_enable | bool
  tags:
    - cis_6_3
    - stg_v230450
    - nist_ia_2
    - containers
    - monitoring
    - security
    - verify

- name: "ISO 9001 | 600013 | CIS 6.4 | STIG V-230450 | NIST CM-6 | Enforce CHANGE_ME policy for monitoring stack"
  ansible.builtin.include_tasks: "{{ role_path }}/../common/tasks/policy_change_me.yml"
  vars:
    change_me_policy_items:
      - name: "monitoring_grafana_admin_password"
        value: "{{ monitoring_grafana_admin_password | default('') }}"
        bad_values: ["CHANGE_ME_IN_VAULT", "CHANGE_ME_IN_SOPS", ""]
  when: monitoring_enable | bool
  tags: [security, verify, 600013]

- name: "ISO 27001 §8.26 | 450002 | CIS 6.4 | STIG V-230450 | NIST CM-6 | Fix | Clear Podman Storage Lock"
  ansible.builtin.file:
    path: /var/lib/containers/storage/storage.lock
    state: absent
  become: true
  tags:
    - monitoring
    - security
    - storage
    - deploy
    - 450002
    - cis_6_4
    - stg_v230450
    - nist_cm_6
    - containers

- name: "ISO 27001 §8.20 | 700030 | CIS 6.5 | STIG V-230450 | NIST SC-8 | Create Monitoring Network Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/{{ monitoring_network }}.network"
    content: |
      [Network]
      NetworkName={{ monitoring_network }}
      Driver=bridge
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags:
    - cis_6_5
    - stg_v230450
    - nist_sc_8
    - iso_27001_8_20
    - containers
    - monitoring
    - network
  when:
    - monitoring_enable | bool
    - monitoring_network != "host"
  notify: reload_systemd

- name: "ISO 27040 | 900000 | CIS 6.6 | STIG V-230450 | NIST AU-2 | Create Monitoring Directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ containers_user_uid }}"
    group: "{{ containers_user_gid }}"
    mode: '0755'
  loop:
    - "{{ monitoring_root_dir }}"
    - "{{ monitoring_root_dir }}/prometheus"
    - "{{ monitoring_root_dir }}/grafana"
    - "{{ monitoring_root_dir }}/gatus"
    - "{{ monitoring_config_dir }}"
    - "{{ monitoring_config_dir }}/prometheus"
    - "{{ monitoring_config_dir }}/gatus"
  become: true
  tags:
    - cis_6_6
    - stg_v230450
    - nist_au_2
    - containers
    - monitoring
    - storage
  when: monitoring_enable | bool

- name: "ISO 27001 §12.4 | 840000 | Deploy Gatus Config"
  ansible.builtin.copy:
    dest: "{{ monitoring_config_dir }}/gatus/config.yaml"
    content: |
      storage:
        type: sqlite
        path: /data/data.db
      endpoints:
        - name: grafana
          url: "http://localhost:3000/api/health"
          interval: 30s
          conditions:
            - "[STATUS] == 200"
    mode: '0644'
  become: true
  when: monitoring_gatus_enable
  tags: [monitoring, gatus, 840000, config]

- name: "ISO 27001 §8.20 | 700000 | Create Gatus Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/gatus-{{ monitoring_instance }}.container"
    content: |
      [Unit]
      Description=Gatus Health Dashboard
      After=network-online.target {{ monitoring_pod_name }}.pod
      Requires={{ monitoring_pod_name }}.pod
      [Container]
      Pod={{ monitoring_pod_name }}.pod
      Image={{ monitoring_gatus_image }}
      ContainerName=gatus-{{ monitoring_instance }}
      Volume={{ monitoring_config_dir }}/gatus/config.yaml:/config/config.yaml:ro
      Volume={{ monitoring_root_dir }}/gatus:/data:Z
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ monitoring_gatus_image.split('@')[1] | default('none') }}
      [Service]
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
  become: true
  when: monitoring_gatus_enable
  notify: reload_systemd
  tags: [monitoring, gatus, 700000, deploy]

- name: "ISO 27001 §10.1 | 400011 | CIS 6.7 | STIG V-230450 | NIST IA-2 | Create Grafana secrets file"
  ansible.builtin.template:
    src: grafana.env.j2
    dest: "{{ containers_secrets_dir }}/grafana-{{ monitoring_instance }}.env"
    mode: '0600'
    owner: "{{ containers_secrets_owner }}"
    group: "{{ containers_secrets_group }}"
  become: true
  tags:
    - cis_6_7
    - stg_v230450
    - nist_ia_2
    - iso_27001_10_1
    - containers
    - monitoring
    - secrets
  when: monitoring_enable | bool

- name: "ISO 27001 §12.4 | 840000 | CIS 6.8 | STIG V-230450 | NIST AU-6 | Deploy Prometheus Config"
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{ monitoring_config_dir }}/prometheus/prometheus.yml"
    mode: '0644'
  become: true
  tags:
    - cis_6_8
    - stg_v230450
    - nist_au_6
    - iso_27001_12_4
    - containers
    - monitoring
    - config
  notify: restart_monitoring_pod
  when: monitoring_enable | bool

- name: "ISO 27001 §8.20 | 700000 | CIS 6.9 | STIG V-230450 | NIST CA-7 | Deploy Monitoring Pod Quadlet"
  ansible.builtin.template:
    src: mon_pod.pod.j2
    dest: "{{ containers_systemd_dir }}/{{ monitoring_pod_name }}.pod"
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags:
    - cis_6_9
    - stg_v230450
    - nist_ca_7
    - iso_27001_8_20
    - containers
    - monitoring
    - deploy
  notify: reload_systemd
  when: monitoring_enable | bool

- name: "ISO 27001 §8.20 | 700000 | CIS 6.10 | STIG V-230450 | NIST AU-2 | Deploy Prometheus Container Quadlet"
  ansible.builtin.template:
    src: prometheus.container.j2
    dest: "{{ containers_systemd_dir }}/prometheus-{{ monitoring_instance }}.container"
    mode: '0600'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags:
    - cis_6_10
    - stg_v230450
    - nist_au_2
    - iso_27001_8_20
    - containers
    - monitoring
    - deploy
  notify: reload_systemd
  when: monitoring_enable | bool

- name: "ISO 27001 §8.20 | 700000 | CIS 6.11 | STIG V-230450 | NIST AU-6 | Deploy Grafana Container Quadlet"
  ansible.builtin.template:
    src: grafana.container.j2
    dest: "{{ containers_systemd_dir }}/grafana-{{ monitoring_instance }}.container"
    mode: '0600'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags:
    - cis_6_11
    - stg_v230450
    - nist_au_6
    - iso_27001_8_20
    - containers
    - monitoring
    - deploy
  notify: reload_systemd
  when: monitoring_enable | bool

- name: "ISO 9001 | 600013 | CIS 6.12 | STIG V-230450 | NIST AU-2 | Deploy Forensic Intelligence Stack"
  ansible.builtin.include_tasks: forensic_stack.yml
  when:
    - monitoring_enable | bool
    - monitoring_loki_enable | bool
  tags:
    - cis_6_12
    - stg_v230450
    - nist_au_2
    - monitoring
    - loki
    - forensic
    - deploy

- name: "ISO 9001 | 600013 | CIS 6.13 | STIG V-230450 | NIST AU-6 | Provision Grafana Dashboard Framework"
  ansible.builtin.include_tasks: grafana_provisioning.yml
  when:
    - monitoring_enable | bool
    - monitoring_forensic_dashboard_enabled | bool
  tags:
    - cis_6_13
    - stg_v230450
    - nist_au_6
    - monitoring
    - grafana
    - forensic
    - config

- name: "ISO 9001 | 600013 | CIS 6.14 | STIG V-230450 | NIST CM-7 | Remove legacy generated systemd units (rootless)"
  ansible.builtin.file:
    path: "{{ podman_rootless_user_home }}/.config/systemd/user/{{ item }}"
    state: absent
  loop:
    - "container-prometheus-{{ monitoring_instance }}.service"
    - "container-grafana-{{ monitoring_instance }}.service"
  become: true
  tags:
    - cis_6_14
    - stg_v230450
    - nist_cm_7
    - containers
    - monitoring
    - cleanup
  when:
    - monitoring_enable | bool
    - podman_rootless_enabled | bool

- name: "ISO 27001 §12.1 | 600013 | CIS 6.15 | STIG V-230450 | NIST CM-7 | Reload rootless systemd to pick up quadlets"
  ansible.builtin.systemd:
    daemon_reload: true
    scope: "{{ containers_systemd_scope }}"
  environment: "{{ containers_systemd_env }}"
  become: true
  become_user: "{{ containers_systemd_owner }}"
  tags:
    - cis_6_15
    - stg_v230450
    - nist_cm_7
    - containers
    - monitoring
    - deploy
  when:
    - monitoring_enable | bool
    - not ansible_check_mode

- name: "ISO 27001 §12.4 | 840000 | CIS 6.16 | STIG V-230450 | NIST CA-7 | Start monitoring pod and services (quadlet units)"
  ansible.builtin.service:
    name: "{{ item }}"
    state: started
  loop:
    - "{{ monitoring_pod_name }}-pod.service"
    - "prometheus-{{ monitoring_instance }}.service"
    - "grafana-{{ monitoring_instance }}.service"
    - "loki-{{ monitoring_instance }}.service"
    - "promtail-{{ monitoring_instance }}.service"
  ignore_errors: true
  tags:
    - cis_6_16
    - stg_v230450
    - nist_ca_7
    - iso_27001_12_4
    - containers
    - monitoring
    - deploy
  when:
    - monitoring_enable | bool
    - not ansible_check_mode
