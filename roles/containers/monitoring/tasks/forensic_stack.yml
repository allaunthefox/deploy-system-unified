---
# Deployment of Loki/Promtail for Forensic Intelligence

- name: "ISO 27001 §12.4 | Action 840030 | Create Loki Directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: '0755'
  loop:
    - "{{ monitoring_root_dir }}/loki"
    - "{{ monitoring_config_dir }}/loki"
    - "{{ monitoring_config_dir }}/promtail"
  become: true

- name: "ISO 27001 §12.4 | Action 840030 | Deploy Loki Configuration"
  ansible.builtin.copy:
    dest: "{{ monitoring_config_dir }}/loki/loki-config.yml"
    content: |
      auth_enabled: false
      server:
        http_listen_port: 3100
      common:
        path_prefix: /loki
        storage:
          filesystem:
            chunks_directory: /loki/chunks
            rules_directory: /loki/rules
        replication_factor: 1
        ring:
          kvstore:
            store: inmemory
      schema_config:
        configs:
          - from: 2024-01-01
            store: tsdb
            object_store: filesystem
            schema: v13
            index:
              prefix: index_
              period: 24h
      ruler:
        storage:
          type: local
          local:
            directory: /loki/rules
        rule_path: /loki/rules-temp
        alertmanager_url: http://localhost:9093
        ring:
          kvstore:
            store: inmemory
        enable_api: true
    mode: '0644'
  become: true
  tags: [monitoring, loki, forensic]

- name: "ISO 27001 §12.4 | Action 840031 | Deploy Promtail Configuration (Forensic Aware)"
  ansible.builtin.copy:
    dest: "{{ monitoring_config_dir }}/promtail/promtail-config.yml"
    content: |
      server:
        http_listen_port: 9080
        grpc_listen_port: 0
      positions:
        filename: /tmp/positions.yaml
      clients:
        - url: http://localhost:3100/loki/api/v1/push
      scrape_configs:
        - job_name: system
          static_configs:
          - targets:
              - localhost
            labels:
              job: varlogs
              __path__: /var/log/*log
          pipeline_stages:
            - regex:
                expression: ".*Action (?P<action_code>\\d{6}).*"
            - regex:
                expression: ".*DSU_UUID=(?P<object_uuid>[a-f0-9-]{36}).*"
            - labels:
                action_code:
                object_uuid:
    mode: '0644'
  become: true
  tags: [monitoring, promtail, forensic]

- name: "ISO 27001 §8.26 | Action 700000 | Deploy Loki Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/loki-{{ monitoring_instance }}.container"
    content: |
      [Unit]
      Description=Loki Log Aggregator
      After=network-online.target {{ monitoring_pod_name }}.pod
      Requires={{ monitoring_pod_name }}.pod
      [Container]
      # Health Check
      HealthCmd=/usr/bin/curl -f http://localhost:3100/ready || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s

      Pod={{ monitoring_pod_name }}.pod
      Image={{ monitoring_loki_image }}
      CapDrop=ALL
      ContainerName=loki-{{ monitoring_instance }}
      CPUQuota=25%
      Volume={{ monitoring_config_dir }}/loki/loki-config.yml:/etc/loki/local-config.yaml:ro
      Volume={{ monitoring_config_dir }}/loki/forensic_alerts.yml:/loki/rules/fake/forensic_alerts.yml:ro
      Volume={{ monitoring_root_dir }}/loki:/loki:Z
      ReadOnlyFilesystem=true
      ReadWritePaths=/loki /var /tmp
      [Service]
      ProtectSystem=strict
      PrivateTmp=true
      PrivateDevices=true
      ProtectHome=read-only
      NoNewPrivileges=true
      ReadOnlyPaths=/etc
      ReadWritePaths=/var /tmp /loki
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
  become: true
  notify: reload_systemd

- name: "ISO 27001 §8.26 | Action 700000 | Deploy Promtail Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/promtail-{{ monitoring_instance }}.container"
    content: |
      [Unit]
      Description=Promtail Log Collector
      After=network-online.target {{ monitoring_pod_name }}.pod loki-{{ monitoring_instance }}.service
      Requires={{ monitoring_pod_name }}.pod loki-{{ monitoring_instance }}.service
      [Container]
      # Health Check
      HealthCmd=/usr/bin/curl -f http://localhost:9080/metrics || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s

      Pod={{ monitoring_pod_name }}.pod
      Image={{ monitoring_promtail_image }}
      CapDrop=ALL
      ContainerName=promtail-{{ monitoring_instance }}
      CPUQuota=25%
      Volume={{ monitoring_config_dir }}/promtail/promtail-config.yml:/etc/promtail/config.yml:ro
      Volume=/var/log:/var/log:ro
      # Grant access to system journal
      Volume=/run/log/journal:/run/log/journal:ro
      ReadOnlyFilesystem=true
      ReadWritePaths=/tmp/positions.yaml /var /tmp
      [Service]
      ProtectSystem=strict
      PrivateTmp=true
      PrivateDevices=true
      ProtectHome=read-only
      NoNewPrivileges=true
      ReadOnlyPaths=/etc
      ReadWritePaths=/var /tmp /tmp/positions.yaml
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
  become: true
  notify: reload_systemd
