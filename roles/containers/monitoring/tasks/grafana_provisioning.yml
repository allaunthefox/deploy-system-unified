---
# Grafana Provisioning for Forensic Intelligence

- name: Create Grafana Provisioning Directories
  ansible.builtin.file:
    path: "{{ monitoring_config_dir }}/grafana/provisioning/{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: '0755'
  loop:
    - datasources
    - dashboards
  become: true
  tags: [monitoring, grafana]

- name: "ISO 27001 ยง12.4 | Action 840030 | Provision Loki Datasource"
  ansible.builtin.copy:
    dest: "{{ monitoring_config_dir }}/grafana/provisioning/datasources/loki.yml"
    content: |
      apiVersion: 1
      datasources:
        - name: Loki
          type: loki
          access: proxy
          url: http://localhost:3100
          jsonData:
            maxLines: 1000
    mode: '0644'
  become: true
  tags: [monitoring, grafana, forensic]

- name: Provision Dashboards Provider
  ansible.builtin.copy:
    dest: "{{ monitoring_config_dir }}/grafana/provisioning/dashboards/provider.yml"
    content: |
      apiVersion: 1
      providers:
        - name: 'Forensic'
          orgId: 1
          folder: 'Forensic'
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /etc/grafana/provisioning/dashboards
    mode: '0644'
  become: true
  tags: [monitoring, grafana]

- name: "ISO 27001 ยง12.4 | Action 840030 | Deploy Forensic Dashboard JSON"
  ansible.builtin.template:
    src: forensic_dashboard.json.j2
    dest: "{{ monitoring_config_dir }}/grafana/provisioning/dashboards/forensic_dashboard.json"
    mode: '0644'
  become: true
  notify: restart_monitoring_pod
  tags: [monitoring, grafana, forensic, remediate]

- name: "ISO 27001 ยง12.4 | Action 840030 | Deploy Forensic Alerting Rules"
  ansible.builtin.copy:
    src: forensic_alerts.yml
    dest: "{{ monitoring_config_dir }}/loki/forensic_alerts.yml"
    mode: '0644'
  become: true
  tags: [monitoring, loki, forensic, alert]
