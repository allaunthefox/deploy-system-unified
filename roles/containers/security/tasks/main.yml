# =============================================================================
# Audit Event Identifier: DSU-PLY-100173
# Last Updated: 2026-02-28
# =============================================================================
---
# Tasks for containers/security - Core Security Infrastructure
# Compliance: ISO 27001 ยง8.20 / NIST SC-7

- name: "ISO 27040 | 900000 | Create Headscale Config Directory"
  ansible.builtin.file:
    path: "{{ containers_headscale_config_dir }}"
    state: directory
    mode: '0755'
    owner: "{{ containers_user_uid }}"
    group: "{{ containers_user_gid }}"
  become: true
  tags: [security, storage, 900000]

- name: "ISO 27001 ยง8.20 | 700000 | Create Headscale Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/headscale.container"
    content: |
      [Unit]
      Description=Headscale Zero-Trust Control Server
      After=network-online.target
      [Container]
      Image={{ containers_headscale_image }}
      ContainerName=headscale
      Network=host
      Volume={{ containers_headscale_config_dir }}:/var/lib/headscale:Z
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ containers_headscale_image.split('@')[1] | default('none') }}
      Exec=serve
      [Service]
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
  become: true
  when: containers_headscale_enable
  notify: reload_systemd
  tags: [security, vpn, 700000]
