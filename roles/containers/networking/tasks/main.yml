# =============================================================================
# Audit Event Identifier: DSU-PLY-100171
# Last Updated: 2026-02-28
# =============================================================================
---
# Tasks for containers/networking - Core Network Services
# Compliance: ISO 27001 ยง8.20 / NIST SC-7

- name: "ISO 27040 | 900000 | Create AdGuard Config Directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ containers_user_uid }}"
    group: "{{ containers_user_gid }}"
  loop:
    - "{{ containers_adguard_config_dir }}"
    - "{{ containers_adguard_config_dir }}/work"
    - "{{ containers_adguard_config_dir }}/conf"
  become: true
  tags: [networking, storage, 900000]

- name: "ISO 27001 ยง8.20 | 700000 | Create AdGuard Home Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/adguard.container"
    content: |
      [Unit]
      Description=AdGuard Home DNS Filter
      After=network-online.target
      [Container]
      Image={{ containers_adguard_image }}
      ContainerName=adguard
      Network={{ containers_adguard_network }}
      Volume={{ containers_adguard_config_dir }}/work:/opt/adguardhome/work:Z
      Volume={{ containers_adguard_config_dir }}/conf:/opt/adguardhome/conf:Z
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ containers_adguard_image.split('@')[1] | default('none') }}
      [Service]
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
  become: true
  when: containers_adguard_enable
  notify: reload_systemd
  tags: [networking, dns, 700000]
