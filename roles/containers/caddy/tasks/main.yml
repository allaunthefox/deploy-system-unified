# =============================================================================
# Audit Event Identifier: DSU-PLY-100050
# Last Updated: 2026-03-01
# =============================================================================
---
# Container Caddy role - Caddy reverse proxy configuration
# Compliance: CIS Docker Benchmark 3.x, STIG V-230480, NIST SC-8/SC-13, ISO 27001 §8.24/§8.28

- name: "ISO 9001 | 600013 | CIS 3.1 | STIG V-230480 | NIST IA-2 | Validate Caddy Secrets (Red Team Hardening)"
  ansible.builtin.assert:
    that:
      - crowdsec_firewall_bouncer_key is defined
      - (crowdsec_firewall_bouncer_key | default('') | length) > 0
    fail_msg: "Caddy secrets missing or empty. Set crowdsec_firewall_bouncer_key."
  when:
    - crowdsec_enable | default(false)
    - containers_caddy_fail_secure | default(true) | bool
  tags: [cis_3_1, stg_v230480, nist_ia_2, containers, caddy, security, verify, 600013]

- name: "ISO 9001 | 600013 | CIS 3.2 | STIG V-230480 | NIST IA-2 | Verify Caddy secret files when fail-secure is enabled"
  ansible.builtin.include_tasks: verify_secrets.yml
  when:
    - containers_caddy_fail_secure | default(true) | bool
  tags: [cis_3_2, stg_v230480, nist_ia_2, containers, caddy, security, verify, 600013]

- name: "ISO 9001 | 600013 | CIS 3.3 | STIG V-230480 | NIST SC-13 | Validate Porkbun API keys are set"
  ansible.builtin.assert:
    that:
      - porkbun_api_key | default('') | length > 0
      - porkbun_secret_api_key | default('') | length > 0
    fail_msg: "Porkbun API keys are required. Set porkbun_api_key and porkbun_secret_api_key."
  tags: [cis_3_3, stg_v230480, nist_sc_13, containers, caddy, security, verify, 600013]

- name: "ISO 27001 §10.1 | 400011 | CIS 3.4 | STIG V-230480 | NIST IA-2 | Create Caddy secrets file"
  ansible.builtin.template:
    src: caddy.env.j2
    dest: "{{ containers_secrets_dir }}/caddy.env"
    mode: '0600'
    owner: "{{ containers_secrets_owner }}"
    group: "{{ containers_secrets_group }}"
  become: true
  tags: [cis_3_4, stg_v230480, nist_ia_2, containers, caddy, secrets, 400011]

- name: "ISO 27001 §8.20 | 700030 | CIS 3.5 | STIG V-230480 | NIST SC-8 | Create Proxy Network Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/proxy_net.network"
    content: |
      [Network]
      NetworkName=proxy_net
      Driver=bridge
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  notify: reload_systemd
  tags: [cis_3_5, stg_v230480, nist_sc_8, containers, caddy, network, 700030]

- name: "ISO 27040 | 900000 | CIS 3.6 | STIG V-230480 | NIST AC-3 | Create Caddy directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  loop: [/srv/containers/caddy, /srv/containers/caddy/config, /srv/containers/caddy/data, /srv/containers/caddy/logs, /srv/containers/caddy/conf.d]
  become: true
  tags: [cis_3_6, stg_v230480, nist_ac_3, containers, caddy, storage, 900000]

- name: "ISO 27001 §8.24 | 540001 | CIS 3.7 | STIG V-230480 | NIST SC-8 | Create Caddyfile"
  ansible.builtin.copy:
    dest: /srv/containers/caddy/Caddyfile
    content: |
      # Caddyfile - Managed by Deploy-System-Unified
      {
        admin off
        servers :443 {
            protocols h1 h2 h3
        }
        email {{ caddy_acme_email | default('admin@example.com') }}
        log {
          output file /var/log/caddy/access.log {
            roll_size 10mb
            roll_keep 5
            roll_keep_for 720h
          }
          format json
        }
      }
      import /etc/caddy/conf.d/*.caddy
      :80, :443 {
        abort
      }
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: caddy_generate_config | default(true)
  notify: restart_caddy
  tags: [cis_3_7, stg_v230480, nist_sc_8, containers, caddy, config, 540001]

- name: "ISO 9001 | 600013 | CIS 3.8 | STIG V-230480 | NIST CM-6 | Validate Quadlet GPU capabilities (Linux CAP_* only)"
  ansible.builtin.assert:
    that:
      - quadlet_gpu_capabilities | default([]) | reject('match', '^CAP_') | list | length == 0
    fail_msg: "Invalid quadlet_gpu_capabilities: only Linux CAP_* values are allowed."
  when: containers_quadlet_enable_gpu_support | default(false)
  tags: [cis_3_8, stg_v230480, nist_cm_6, containers, caddy, security, verify, 600013]

- name: "ISO 27001 §9.2 | 540000 | Forensic Chain of Trust | Rule [B-03] (The Ingress Lock) | Wait for Authentik readiness"
  ansible.builtin.wait_for:
    host: "localhost"
    port: 9000
    timeout: 60
    msg: "Mandatory Identity Provider (Authentik) not reachable. Ingress deployment locked to prevent unauthorized access."
  when:
    - authentik_enabled | default(true) | bool
    - not ansible_check_mode
  become: true
  tags: [forensic, security, caddy, audit, 540000, verify]

- name: "ISO 27001 §8.24 | 700000 | CIS 3.9 | STIG V-230480 | NIST SC-8 | Create Caddy container quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/caddy.container"
    content: |
      [Unit]
      Description=Caddy Reverse Proxy
      After=network-online.target
      Wants=network-online.target
      [Container]
      HealthCmd=/usr/bin/curl -f http://localhost:80/ || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s
      {% set _digest = caddy_image_digest | default('') %}
      Image=docker.io/serfriz/caddy-porkbun-dockerproxy:2.10.2{% if _digest | length > 0 %}@sha256:{{ _digest }}{% endif %}
      Pull={{ caddy_pull_policy | default('newer') }}
      {% if podman_rootless_enabled | bool %}
      UserNS=auto
      {% endif %}
      DropCapability=ALL
      CapAdd=NET_BIND_SERVICE
      Exec=caddy run --config /etc/caddy/Caddyfile --adapter caddyfile
      EnvironmentFile={{ containers_secrets_dir }}/caddy.env
      ContainerName=caddy
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-24
      Label=DSU_ACTION_CODE=700000
      Label=DSU_IMAGE_DIGEST={{ _digest if _digest | length > 0 else 'none' }}
      {% if containers_caddy_network == 'host' or (not podman_rootless_enabled | bool) %}
      Network=host
      {% else %}
      Network={{ containers_caddy_network }}.network
      {% for net in containers_caddy_extra_networks | default([]) %}
      Network={{ net }}.network
      {% endfor %}
      PublishPort={{ containers_caddy_http_port }}:80
      PublishPort={{ containers_caddy_https_port }}:443
      PublishPort={{ containers_containers_caddy_https_port_udp }}:443/udp
      {% endif %}
      Volume=/srv/containers/caddy/Caddyfile:/etc/caddy/Caddyfile:ro,U
      Volume=/srv/containers/caddy/data:/data:U,Z
      Volume=/srv/containers/caddy/config:/config:U,Z
      Volume=/srv/containers/caddy/logs:/var/log/caddy:U,Z
      Volume=/srv/containers/caddy/conf.d:/etc/caddy/conf.d:ro,U
      ReadOnly=true
      ReadWritePaths=/data /config /var/log/caddy /var /tmp
      [Service]
      ProtectSystem=strict
      PrivateTmp=true
      PrivateDevices=true
      ProtectHome=read-only
      NoNewPrivileges=true
      ReadOnlyPaths=/etc
      ReadWritePaths=/var /tmp /data /config /var/log/caddy
      Restart=always
      TimeoutStartSec={{ caddy_timeout_start | default(900) }}
      TimeoutStopSec={{ caddy_timeout_stop | default(70) }}
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags: [cis_3_9, stg_v230480, nist_sc_8, iso_27001_8_24, containers, caddy, deploy, 700000]
  notify: [reload_systemd, restart_caddy]

- name: "ISO 9001 | 600013 | CIS 3.10 | STIG V-230480 | NIST CM-6 | Set containers caddy completion flag"
  ansible.builtin.set_fact:
    containers_caddy_complete: true
  tags: [cis_3_10, stg_v230480, nist_cm_6, containers, caddy, initialization, 600013]

- name: "ISO 27040 | 900000 | CIS 3.11 | STIG V-230480 | NIST AC-3 | Create Crowdsec Directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  loop: [/srv/containers/caddy/crowdsec, /srv/containers/caddy/crowdsec/config, /srv/containers/caddy/crowdsec/data]
  become: true
  when: crowdsec_enable | default(false)
  tags: [cis_3_11, stg_v230480, nist_ac_3, containers, caddy, crowdsec, storage, 900000]

- name: "ISO 27001 §16.1 | 460002 | CIS 3.12 | STIG V-230480 | NIST SC-8 | Create Crowdsec Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/crowdsec.container"
    content: |
      [Unit]
      Description=Crowdsec Security Engine
      After=network-online.target caddy.service
      [Container]
      HealthCmd=cscli metrics | grep -q "total" || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s
      Image={{ crowdsec_image }}
      Pull={{ crowdsec_pull_policy | default('newer') }}
      DropCapability=ALL
      ContainerName=crowdsec
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-16-1
      Label=DSU_ACTION_CODE=460002
      Label=DSU_IMAGE_DIGEST={{ crowdsec_image.split('@')[1] | default('none') }}
      {% if podman_rootless_enabled | bool %}
      Network={{ containers_caddy_network }}.network
      {% else %}
      Network=host
      {% endif %}
      Environment=COLLECTIONS={{ crowdsec_collections | join(' ') }}
      Volume=/srv/containers/caddy/logs:/var/log/caddy:ro,Z
      Volume=/srv/containers/caddy/crowdsec/config:/etc/crowdsec:Z
      Volume=/srv/containers/caddy/crowdsec/data:/var/lib/crowdsec/data:Z
      ReadOnly=true
      ReadWritePaths=/etc/crowdsec /var/lib/crowdsec/data /var /tmp
      [Service]
      ProtectSystem=strict
      PrivateTmp=true
      PrivateDevices=true
      ProtectHome=read-only
      NoNewPrivileges=true
      ReadOnlyPaths=/etc
      ReadWritePaths=/var /tmp /etc/crowdsec /var/lib/crowdsec
      Restart=always
      TimeoutStartSec={{ crowdsec_timeout_start | default(600) }}
      TimeoutStopSec={{ crowdsec_timeout_stop | default(70) }}
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0600'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: crowdsec_enable | default(false)
  tags: [cis_3_12, stg_v230480, nist_sc_8, iso_27001_16_1, containers, crowdsec, deploy, 460002]
  notify: reload_systemd

- name: "ISO 27001 §16.1 | 460002 | CIS 3.13 | STIG V-230480 | NIST CM-7 | Install Crowdsec Bouncer Dependencies"
  ansible.builtin.package:
    name: ipset
    state: present
  become: true
  when: crowdsec_enable | default(false)
  tags: [cis_3_13, stg_v230480, nist_cm_7, containers, caddy, crowdsec, security, 460002]

- name: "ISO 27001 §16.1 | 460002 | CIS 3.14 | STIG V-230480 | NIST AC-6 | Create Crowdsec Bouncer Directory (Host)"
  ansible.builtin.file:
    path: /etc/crowdsec/bouncers
    state: directory
    mode: '0755'
    owner: root
    group: root
  become: true
  tags: [cis_3_14, stg_v230480, nist_ac_6, containers, caddy, crowdsec, storage, 460002]

- name: "ISO 27001 §16.1 | 460002 | CIS 3.15 | STIG V-230480 | NIST SC-8 | Create Firewall Bouncer Config (Host)"
  ansible.builtin.template:
    src: firewall-bouncer.yaml.j2
    dest: /etc/crowdsec/bouncers/crowdsec-firewall-bouncer.yaml
    mode: '0600'
    owner: root
    group: root
    force: false
  become: true
  when: crowdsec_enable | default(false)
  tags: [cis_3_15, stg_v230480, nist_sc_8, containers, caddy, crowdsec, config, 460002]

- name: "ISO 9001 | 600013 | CIS 3.16 | STIG V-230480 | NIST CA-7 | Check if Bouncer is installed"
  ansible.builtin.stat:
    path: /usr/local/bin/crowdsec-firewall-bouncer
  register: containers_bouncer_bin
  become: true
  tags: [cis_3_16, stg_v230480, nist_ca_7, containers, caddy, crowdsec, verify, 600013]

- name: "ISO 27001 §16.1 | 460002 | CIS 3.17 | STIG V-230480 | NIST CM-7 | Install Firewall Bouncer (Host)"
  block:
    - name: "ISO 27001 §16.1 | 460002 | CIS 3.17.1 | STIG V-230480 | NIST SC-8 | Download Bouncer"
      ansible.builtin.get_url:
        url: "https://github.com/crowdsecurity/cs-firewall-bouncer/releases/download/v{{ crowdsec_firewall_bouncer_version }}/crowdsec-firewall-bouncer-linux-amd64.tgz"
        dest: /tmp/crowdsec-firewall-bouncer.tgz
        mode: '0644'
        checksum: "sha256:{{ crowdsec_firewall_bouncer_sha256 }}"
      tags: [cis_3_17_1, stg_v230480, nist_sc_8, crowdsec, deploy, 460002]

    - name: "ISO 27001 §16.1 | 460002 | CIS 3.17.2 | STIG V-230480 | NIST CM-7 | Extract Bouncer"
      ansible.builtin.unarchive:
        src: /tmp/crowdsec-firewall-bouncer.tgz
        dest: /tmp/
        remote_src: true
        include: ["crowdsec-firewall-bouncer-v{{ crowdsec_firewall_bouncer_version }}/crowdsec-firewall-bouncer"]
        strip_components: 1
      tags: [cis_3_17_2, stg_v230480, nist_cm_7, crowdsec, deploy, 460002]

    - name: "ISO 27001 §16.1 | 460002 | CIS 3.17.3 | STIG V-230480 | NIST AC-6 | Copy Binary"
      ansible.builtin.copy:
        src: /tmp/crowdsec-firewall-bouncer
        dest: /usr/local/bin/crowdsec-firewall-bouncer
        mode: '0755'
        remote_src: true
      tags: [cis_3_17_3, stg_v230480, nist_ac_6, crowdsec, deploy, 460002]

    - name: "ISO 27001 §16.1 | 460002 | CIS 3.17.4 | STIG V-230480 | NIST CM-6 | Install Service File"
      ansible.builtin.copy:
        dest: /etc/systemd/system/crowdsec-firewall-bouncer.service
        content: |
          [Unit]
          Description=The firewall bouncer for CrowdSec
          After=syslog.target network.target remote-fs.target nss-lookup.target crowdsec.service
          [Service]
          Type=simple
          ExecStart=/usr/local/bin/crowdsec-firewall-bouncer -c /etc/crowdsec/bouncers/crowdsec-firewall-bouncer.yaml
          Restart=always
          RestartSec=2
          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      tags: [cis_3_17_4, stg_v230480, nist_cm_6, crowdsec, deploy, 460002]
  become: true
  when: (crowdsec_enable | default(false)) and (not containers_bouncer_bin.stat.exists)

- name: "ISO 27001 §16.1 | 460002 | CIS 3.18 | STIG V-230480 | NIST CA-7 | Enable and Start Firewall Bouncer"
  ansible.builtin.systemd:
    name: crowdsec-firewall-bouncer
    state: started
    enabled: true
    daemon_reload: true
  become: true
  when: crowdsec_enable | default(false)
  tags: [cis_3_18, stg_v230480, nist_ca_7, containers, caddy, crowdsec, deploy, 460002]
