# Goss tests for containers/caddy role
# ISO 27001 ยง8.26 - Container security

# =============================================================================
# PACKAGE TESTS
# =============================================================================
package:
  podman:
    installed: true
  caddy:
    installed: true

# =============================================================================
# FILE TESTS - Verify Caddy configuration
# =============================================================================
file:
  /etc/containers/systemd/caddy.container:
    exists: true
    mode: "0644"
    owner: root
    group: root
    contains:
      - "/Description=Caddy/"
      - "/Image=/"
      - "/ContainerName=caddy/"
      - "/Restart=always/"

  /srv/containers/caddy:
    exists: true
    filetype: directory
    mode: "0755"

  /etc/caddy:
    exists: true
    filetype: directory

# =============================================================================
# SERVICE TESTS
# =============================================================================
service:
  caddy:
    enabled: true
    running: true

# =============================================================================
# COMMAND TESTS
# =============================================================================
command:
  caddy_container:
    exec: 'podman ps -a | grep caddy || docker ps -a | grep caddy || true'
    exit-status: 0
    timeout: 10000

  caddy_version:
    exec: 'caddy version'
    exit-status: 0
    timeout: 10000

# =============================================================================
# PORT TESTS - Verify HTTP/HTTPS
# =============================================================================
port:
  tcp:80:
    listening: true
  tcp:443:
    listening: true

# =============================================================================
# PROCESS TESTS
# =============================================================================
process:
  caddy:
    running: true
