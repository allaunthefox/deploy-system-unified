# =============================================================================
# Audit Event Identifier: DSU-PLY-100045
# Last Updated: 2026-02-28
# =============================================================================
---
# Defaults for containers/caddy role
containers_caddy_generate_config: "{{ caddy_generate_config | default(true) }}"
containers_caddy_acme_email: "{{ caddy_acme_email | default('admin@owowatdis.lol') }}"

# Host ports for Caddy (rootless defaults shift to high ports unless privileged ports are enabled)
containers_caddy_http_port: >-
  {{ caddy_http_port | default((containers_podman_rootless_enabled | default(false) | bool
      and not (containers_podman_rootless_allow_privileged_ports | default(false) | bool))
     | ternary(8080, 80)) }}
containers_caddy_https_port: >-
  {{ caddy_https_port | default((containers_podman_rootless_enabled | default(false) | bool
      and not (containers_podman_rootless_allow_privileged_ports | default(false) | bool))
     | ternary(8443, 443)) }}
containers_caddy_https_port_udp: "{{ containers_caddy_https_port }}"

# Porkbun DNS Credentials (required for DNS challenge)
containers_porkbun_api_key: "{{ porkbun_api_key | default(vault_porkbun_api_key | default('')) }}"
containers_porkbun_secret_api_key: "{{ porkbun_secret_api_key | default(vault_porkbun_secret_api_key | default('')) }}"

# Caddy acts as the ingress gateway and must have access to all app networks
# OR, we run it on "proxy_net" and expose app ports there.
# For simplicity with Quadlets, we can attach multiple networks to the Caddy Pod.
containers_caddy_network: "{{ caddy_network | default('proxy_net') }}"
containers_caddy_extra_networks: "{{ caddy_extra_networks | default(['media_net', 'ops_net', 'monitoring_net', 'anubis_net']) }}"

# Unix Socket Migration (Internal Socket Isolation)
containers_caddy_use_unix_sockets: "{{ true if deployment_profile | default('standard') in ['hardened', 'production'] else false }}"
containers_caddy_socket_dir: "/run/caddy"

# Crowdsec (Security Automation)
containers_crowdsec_enable: "{{ crowdsec_enable | default(true) }}"
containers_crowdsec_image: "{{ crowdsec_image | default('docker.io/crowdsecurity/crowdsec:latest') }}"
containers_crowdsec_firewall_bouncer_key: "{{ crowdsec_firewall_bouncer_key | default(vault_crowdsec_firewall_bouncer_key | default('CHANGE_ME')) }}"

# Hardening: fail-secure gating for Caddy secret checks
containers_caddy_fail_secure: "{{ containers_fail_secure | default(true) }}"
# Crowdsec firewall bouncer pinning (supply-chain hardening)
containers_crowdsec_firewall_bouncer_version: "{{ crowdsec_firewall_bouncer_version | default('0.0.34') }}"
containers_crowdsec_firewall_bouncer_sha256: "{{ crowdsec_firewall_bouncer_sha256 | default('8b07e08fb35a90b33eb2403eb93966679b39adb42c9cd03882de66cdf19a949f') }}"
# crowdsec_firewall_bouncer_image: docker.io/crowdsec/crowdsec-firewall-bouncer-iptables:latest (Deprecated/Missing)
containers_crowdsec_secrets_dir: "{{ crowdsec_secrets_dir | default('/srv/containers/secrets') }}"
# Crowdsec reads logs from Caddy, so it maps that volume
containers_crowdsec_collections: "{{ crowdsec_collections | default(['crowdsecurity/linux', 'crowdsecurity/sshd', 'crowdsecurity/caddy', 'crowdsecurity/whitelist-good-actors']) }}"

# GPU Support (Inherited logic from Quadlets)
containers_quadlet_enable_gpu_support: "{{ quadlet_enable_gpu_support | default(false) }}"

# Timeout configuration (prevent startup failures on slow networks)
containers_caddy_timeout_start: "{{ caddy_timeout_start | default(900) }}"
containers_caddy_timeout_stop: "{{ caddy_timeout_stop | default(70) }}"

# Image pull backoff (prevent registry rate-limit bans)
containers_caddy_pull_policy: "{{ caddy_pull_policy | default('newer') }}"
containers_caddy_pull_retry: "{{ caddy_pull_retry | default(5) }}"
containers_caddy_pull_retry_delay: "{{ caddy_pull_retry_delay | default('30s') }}"
containers_caddy_image_digest: "{{ caddy_image_digest | default('') }}"

# Crowdsec pull backoff
containers_crowdsec_pull_policy: "{{ crowdsec_pull_policy | default('newer') }}"
containers_crowdsec_pull_retry: "{{ crowdsec_pull_retry | default(5) }}"
containers_crowdsec_pull_retry_delay: "{{ crowdsec_pull_retry_delay | default('30s') }}"
