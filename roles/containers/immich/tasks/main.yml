---
# Tasks for containers/immich - High Performance Photo Management
# Compliance: ISO 27001 ยง8.20 / NIST SC-7 / ISO 27040

- name: "ISO 27001 ยง8.20 | 700030 | Create Immich Network Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/immich_net.network"
    content: |
      [Network]
      NetworkName={{ containers_immich_network }}
      Driver=bridge
      Internal=true
    mode: '0644'
  become: true
  notify: reload_systemd
  tags: [immich, networking, 700030]

- name: "ISO 27040 | 900000 | Create Immich Data Directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "1000"
    group: "1000"
    modification_time: preserve
    access_time: preserve
  loop:
    - "{{ containers_immich_root_dir }}"
    - "{{ containers_immich_root_dir }}/upload"
    - "{{ containers_immich_root_dir }}/profile"
    - "{{ containers_immich_config_dir }}/postgres"
  become: true
  tags: [immich, storage, 900000]

- name: "ISO 27001 ยง8.20 | 700000 | Create Immich Redis Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/immich-redis.container"
    content: |
      [Unit]
      Description=Immich Redis Cache
      After=network-online.target
      [Container]
      Image={{ containers_immich_redis_image }}
      ContainerName=immich-redis
      Network={{ containers_immich_network }}.network
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_IMAGE_DIGEST={{ containers_immich_redis_image.split('@')[1] | default('none') }}
      [Service]
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
  become: true
  notify: reload_systemd
  tags: [immich, deploy, 700000]

- name: "ISO 27001 ยง8.20 | 700000 | Create Immich Server Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/immich-server.container"
    content: |
      [Unit]
      Description=Immich Server
      After=immich-redis.service
      [Container]
      Image={{ containers_immich_server_image }}
      ContainerName=immich-server
      Network={{ containers_immich_network }}.network
      Volume={{ containers_immich_root_dir }}/upload:/usr/src/app/upload:Z
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_IMAGE_DIGEST={{ containers_immich_server_image.split('@')[1] | default('none') }}
      Environment=REDIS_HOSTNAME=immich-redis
      Environment=DB_HOSTNAME=immich-postgres
      Environment=DB_USERNAME={{ containers_immich_db_user }}
      Environment=DB_PASSWORD={{ containers_immich_db_pass }}
      Environment=DB_DATABASE_NAME={{ containers_immich_db_name }}
      [Service]
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
  become: true
  notify: reload_systemd
  tags: [immich, deploy, 700000]
