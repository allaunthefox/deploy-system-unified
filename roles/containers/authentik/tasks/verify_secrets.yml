---
# Verify Authentik secrets when fail-secure is enabled
- name: Check Authentik secrets file exists
  ansible.builtin.stat:
    path: "{{ containers_secrets_dir }}/authentik.env"
  register: containers_authentik_env
  changed_when: false
  when:
    - containers_containers_authentik_fail_secure | default(true) | bool
    - containers_secrets_dir is defined
  tags: [security, containers, authentik, audit]

- name: "ISO 27001 ยง10.1 | Audit Code 400010 | Assert Authentik secrets file exists and is secure"
  ansible.builtin.assert:
    that:
      - containers_authentik_env is defined
      - containers_authentik_env.stat.exists
      - containers_authentik_env.stat.mode == '0600'
      - containers_authentik_env.stat.pw_name == containers_secrets_owner
    fail_msg: >-
      Authentik secrets file missing or insecure: {{ containers_secrets_dir }}/authentik.env.
      Create the file with mode 0600 and owner {{ containers_secrets_owner }}
      or set containers_containers_authentik_fail_secure=false to bypass.
  when:
    - containers_containers_authentik_fail_secure | default(true) | bool
    - containers_secrets_dir is defined
  tags: [security, containers, authentik, audit, iso27001]

- name: Check Authentik secrets file does not contain placeholder token
  ansible.builtin.shell: |
    grep -E "generate_me_with_openssl_rand_base64_60|changeme_please_secure_me|CHANGE_ME" \
      "{{ containers_secrets_dir }}/authentik.env" >/dev/null 2>&1
  args:
    executable: /bin/sh
  register: containers_authentik_env_grep
  changed_when: false
  no_log: true
  when:
    - containers_containers_authentik_fail_secure | default(true) | bool
    - containers_secrets_dir is defined
  tags: [security, containers, authentik, audit]

- name: "Audit Code 520011 | Assert Authentik secrets file does not contain placeholder token"
  ansible.builtin.assert:
    that:
      - containers_authentik_env_grep is defined
      - containers_authentik_env_grep.rc == 1
    fail_msg: >-
      Authentik secrets file contains placeholder values (CHANGE_ME).
      Replace with real secrets or set containers_containers_authentik_fail_secure=false to bypass.
  when:
    - containers_containers_authentik_fail_secure | default(true) | bool
    - containers_secrets_dir is defined
  tags: [security, containers, authentik, audit]

- name: Assert Authentik secrets file is not empty
  ansible.builtin.assert:
    that:
      - containers_authentik_env is defined
      - containers_authentik_env.stat.size is defined
      - containers_authentik_env.stat.size | int > 0
    fail_msg: >-
      Authentik secrets file is empty: {{ containers_secrets_dir }}/authentik.env.
      Populate it with real secrets or set containers_containers_authentik_fail_secure=false to bypass.
  when:
    - containers_containers_authentik_fail_secure | default(true) | bool
    - containers_secrets_dir is defined
  tags: [security, containers, authentik, audit]

- name: Assert Authentik password and secret key variables are not default
  ansible.builtin.assert:
    that:
      - (containers_authentik_pg_pass | default('')) != "changeme_please_secure_me"
      - (containers_authentik_secret_key | default('')) != "generate_me_with_openssl_rand_base64_60"
    fail_msg: >-
      Default weak secrets detected for Authentik.
      Please update 'containers_authentik_secret_key' and 'containers_authentik_pg_pass'
      in your variables or set containers_containers_authentik_fail_secure=false to bypass.
  when:
    - containers_containers_authentik_fail_secure | default(true) | bool
  tags: [security, containers, authentik, audit]
