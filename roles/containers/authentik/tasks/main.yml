---
# Tasks for containers/authentik
# Compliance: CIS Docker Benchmark 4.x, STIG V-230490, NIST IA-2/IA-3/IA-4, ISO 27001 §9.2/§9.3

- name: "CIS 4.1 | STIG V-230490 | NIST IA-2 | Verify Authentik secrets when fail-secure is enabled"
  ansible.builtin.include_tasks: verify_secrets.yml
  when:
    - containers_containers_authentik_fail_secure | default(true) | bool
  tags:
    - cis_4_1
    - stg_v230490
    - nist_ia_2
    - containers
    - authentik
    - security

- name: "CIS 4.2 | STIG V-230490 | NIST AC-3 | Create Authentik Directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0750'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  loop:
    - "{{ containers_authentik_base_dir }}"
    - "{{ containers_authentik_data_dir }}"
    - "{{ containers_authentik_config_dir }}"
    - "{{ containers_authentik_data_dir }}/media"
    - "{{ containers_authentik_data_dir }}/custom-templates"
    - "{{ containers_authentik_data_dir }}/postgres"
    - "{{ containers_authentik_data_dir }}/redis"
  become: true
  tags:
    - cis_4_2
    - stg_v230490
    - nist_ac_3
    - containers
    - authentik

- name: "CIS 4.3 | STIG V-230490 | NIST IA-2 | ISO 27001 §10.1 | Audit Code 400011 | Create Authentik secrets file"
  ansible.builtin.template:
    src: authentik.env.j2
    dest: "{{ containers_secrets_dir }}/authentik.env"
    mode: '0600'
    owner: "{{ containers_secrets_owner }}"
    group: "{{ containers_secrets_group }}"
  become: true
  tags:
    - cis_4_3
    - stg_v230490
    - nist_ia_2
    - iso_27001_10_1
    - containers
    - authentik
    - remediate

- name: "CIS 4.4 | STIG V-230490 | NIST SC-8 | ISO 27001 §8.20 | Audit Code 700000 | Create Authentik Postgres Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/authentik-postgres.container"
    content: |
      [Unit]
      Description=Authentik PostgreSQL Database
      After=network-online.target

      [Container]
      # Health Check
      HealthCmd=pg_isready -U authentik || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s

      Image={{ containers_authentik_postgres_image }}
      DropCapability=ALL
      ContainerName=authentik-postgres

      {% if containers_authentik_network_name == 'host' %}
      Network=host
      {% else %}
      Network={{ containers_authentik_network_name }}.network
      {% endif %}

      EnvironmentFile={{ containers_secrets_dir }}/authentik.env

      Volume={{ containers_authentik_data_dir }}/postgres:/var/lib/postgresql/data:Z
      ReadOnly=true
      ReadWritePaths=/var/lib/postgresql/data /var /tmp

      [Service]
      ProtectSystem=strict
      PrivateTmp=true
      PrivateDevices=true
      ProtectHome=read-only
      NoNewPrivileges=true
      ReadOnlyPaths=/etc
      ReadWritePaths=/var /tmp /var/lib/postgresql/data
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0600'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags:
    - cis_4_4
    - stg_v230490
    - nist_sc_8
    - iso_27001_8_20
    - iso_27001_8_26
    - containers
    - authentik
    - remediate
  notify: reload_systemd

- name: "CIS 4.5 | STIG V-230490 | NIST SC-8 | ISO 27001 §8.20 | Audit Code 700000 | Create Authentik Redis Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/authentik-redis.container"
    content: |
      [Unit]
      Description=Authentik Redis
      After=network-online.target

      [Container]
      # Health Check
      HealthCmd=redis-cli ping || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s

      Image={{ containers_authentik_redis_image }}
      DropCapability=ALL
      ContainerName=authentik-redis

      {% if containers_authentik_network_name == 'host' %}
      Network=host
      {% else %}
      Network={{ containers_authentik_network_name }}.network
      {% endif %}

      ReadOnly=true
      ReadWritePaths=/data /var /tmp

      [Service]
      ProtectSystem=strict
      PrivateTmp=true
      PrivateDevices=true
      ProtectHome=read-only
      NoNewPrivileges=true
      ReadOnlyPaths=/etc
      ReadWritePaths=/var /tmp /data
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0600'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags:
    - cis_4_5
    - stg_v230490
    - nist_sc_8
    - iso_27001_8_20
    - iso_27001_8_26
    - containers
    - authentik
    - remediate
  notify: reload_systemd

- name: "CIS 4.6 | STIG V-230490 | NIST IA-2 | ISO 27001 §8.20 | Audit Code 700000 | Create Authentik Server Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/authentik-server.container"
    content: |
      [Unit]
      Description=Authentik Server
      After=authentik-postgres.service authentik-redis.service
      Requires=authentik-postgres.service authentik-redis.service

      [Container]
      # Health Check
      HealthCmd=/usr/bin/curl -f http://localhost:9000/api/health/ || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s

      Image={{ containers_authentik_image }}
      ContainerName=authentik-server
      DropCapability=ALL
      CapAdd=NET_BIND_SERVICE
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ containers_authentik_image.split('@')[1] | default('none') }}

      {% if containers_authentik_network_name == 'host' %}
      Network=host
      {% else %}
      Network={{ containers_authentik_network_name }}.network
      {% endif %}
      # Internal port 9000, exposed to Caddy via bridge

      Exec=server

      EnvironmentFile={{ containers_secrets_dir }}/authentik.env

      Volume={{ containers_authentik_data_dir }}/media:/media:Z
      Volume={{ containers_authentik_data_dir }}/custom-templates:/templates:Z
      ReadOnly=true
      ReadWritePaths=/media /templates /var /tmp

      [Service]
      ProtectSystem=strict
      PrivateTmp=true
      PrivateDevices=true
      ProtectHome=read-only
      NoNewPrivileges=true
      ReadOnlyPaths=/etc
      ReadWritePaths=/var /tmp /media /templates
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0600'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags:
    - cis_4_6
    - stg_v230490
    - nist_ia_2
    - iso_27001_8_20
    - iso_27001_8_26
    - containers
    - authentik
    - remediate
  notify: reload_systemd

- name: "CIS 4.7 | STIG V-230490 | NIST IA-3 | ISO 27001 §8.20 | Audit Code 700000 | Create Authentik Worker Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/authentik-worker.container"
    content: |
      [Unit]
      Description=Authentik Worker
      After=authentik-postgres.service authentik-redis.service authentik-server.service
      Requires=authentik-postgres.service authentik-redis.service

      [Container]
      # Health Check
      HealthCmd=ps aux | grep -v grep | grep ak worker || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s

      Image={{ containers_authentik_image }}
      ContainerName=authentik-worker
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ containers_authentik_image.split('@')[1] | default('none') }}

      {% if containers_authentik_network_name == 'host' %}
      Network=host
      {% else %}
      Network={{ containers_authentik_network_name }}.network
      {% endif %}

      Exec=worker

      EnvironmentFile={{ containers_secrets_dir }}/authentik.env

      Volume={{ containers_authentik_data_dir }}/media:/media:Z
      Volume={{ containers_authentik_data_dir }}/custom-templates:/templates:Z
      ReadOnly=true
      ReadWritePaths=/media /templates /var /tmp

      [Service]
      ProtectSystem=strict
      PrivateTmp=true
      PrivateDevices=true
      ProtectHome=read-only
      NoNewPrivileges=true
      ReadOnlyPaths=/etc
      ReadWritePaths=/var /tmp /media /templates
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0600'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags:
    - cis_4_7
    - stg_v230490
    - nist_ia_3
    - iso_27001_8_20
    - iso_27001_8_26
    - containers
    - authentik
    - remediate
  notify: reload_systemd

- name: "CIS 4.8 | STIG V-230490 | NIST IA-2 | ISO 27001 §9.2 | Audit Code 540001 | Deploy Caddy Authentik Configuration"
  ansible.builtin.copy:
    dest: /srv/containers/caddy/conf.d/authentik.caddy
    content: |
      # Authentik Config
      auth.example.com {
        reverse_proxy {{ 'localhost' if (containers_authentik_network_name == 'host' or not podman_rootless_enabled | default(true) | bool) else 'authentik-server' }}:9000
      }

      # Reusable snippet for other sites to protect themselves
      (containers_authentik_protect) {
        forward_auth {{ 'localhost' if (containers_authentik_network_name == 'host' or not podman_rootless_enabled | default(true) | bool) else 'authentik-server' }}:9000 {
            uri /outpost.goauthentik.io/auth/caddy
            copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name
            copy_headers X-Authentik-Uid X-Authentik-Jwt X-Authentik-Meta-Jwks
            copy_headers X-Authentik-Meta-Outpost-Token X-Authentik-Meta-Provider-Slug
            copy_headers X-Authentik-Meta-App-Slug X-Authentik-Meta-Version
        }
      }
    mode: '0644'
  become: true
  tags:
    - cis_4_8
    - stg_v230490
    - nist_ia_2
    - iso_27001_9_2
    - containers
    - authentik
    - remediate
  # Only deploy if using Caddy as the ingress
  when: true
  notify: restart_caddy
