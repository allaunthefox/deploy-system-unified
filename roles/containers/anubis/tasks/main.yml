# =============================================================================
# Audit Event Identifier: DSU-PLY-100034
# Last Updated: 2026-03-01
# =============================================================================
---
# Tasks for containers/anubis - Web AI Firewall
# Compliance: CIS Docker Benchmark | Pod Security Standards | ISO 27001 ยง8.26

- name: "ISO 27001 ยง8.26 | 700030 | Create Anubis Network Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/anubis_net.network"
    content: |
      [Network]
      NetworkName=anubis_net
      Driver=bridge
      Subnet=10.89.50.0/24
      Gateway=10.89.50.1
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags: [iso_27001_8_26, containers, anubis, remediate, 700030]
  notify: reload_systemd

- name: "ISO 9001 | 600013 | Validate Quadlet GPU capabilities (Linux CAP_* only)"
  ansible.builtin.assert:
    that:
      - quadlet_gpu_capabilities | default([]) | reject('match', '^CAP_') | list | length == 0
    fail_msg: "Invalid quadlet_gpu_capabilities: only Linux CAP_* values are allowed."
  when: quadlet_enable_gpu_support | default(false)
  tags: [security, containers, anubis, verification, 600013]

- name: "ISO 27001 ยง8.26 | 700000 | Create Anubis container quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/anubis.container"
    content: |
      [Unit]
      Description=Anubis Web AI Firewall
      After=network-online.target
      Wants=network-online.target

      [Container]
      # Health Check
      HealthCmd=/usr/bin/curl -f http://localhost:31338/health || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s

      Image={{ anubis_image }}
      DropCapability=ALL
      ContainerName={{ anubis_container_name }}
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-26
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ anubis_image.split('@')[1] | default('none') }}
      {% if podman_rootless_enabled | bool %}
      Network=anubis_net.network
      {% else %}
      Network=host
      {% endif %}
      Exec=-bind :31338
      Environment=PORT=31338
      Environment=TARGET={{ anubis_target_url }}
      Environment=DIFFICULTY={{ anubis_difficulty }}
      Environment=VALIDATORS=user-agent,proof-of-work
      {% if quadlet_enable_gpu_support %}
      {% set caps = quadlet_gpu_capabilities | default([]) | select('match', '^CAP_') | list %}
      {% if caps | length > 0 %}
      Capabilities={{ caps | join(' ') }}
      {% endif %}
      {% for device in quadlet_gpu_devices | default(quadlet_gpu_default_configs[quadlet_gpu_vendor]['devices']) %}
      Device={{ device }}
      {% endfor %}
      {% for mount in quadlet_gpu_default_configs[quadlet_gpu_vendor]['mounts'] %}
      Volume={{ mount }}
      {% endfor %}
      {% endif %}
      ReadOnly=true
      ReadWritePaths=/var /tmp
      [Service]
      ProtectSystem=strict
      PrivateTmp=true
      PrivateDevices=true
      ProtectHome=read-only
      NoNewPrivileges=true
      ReadOnlyPaths=/etc
      ReadWritePaths=/var /tmp
      Restart=always
      TimeoutStartSec=300
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags: [iso_27001_8_26, containers, anubis, remediate, deploy, 700000]
  notify:
    - reload_systemd
    - restart anubis
  when: anubis_enabled | bool

- name: "ISO 27001 ยง8.26 | 700001 | Enable and start Anubis service"
  ansible.builtin.systemd:
    name: anubis
    enabled: true
    state: started
    scope: "{{ containers_systemd_scope }}"
  environment: "{{ containers_systemd_env }}"
  become: true
  become_user: "{{ containers_systemd_owner }}"
  tags: [iso_27001_8_26, containers, anubis, deploy, 700001]
  when: 
    - anubis_enabled | bool 
    - ansible_service_mgr == "systemd" 
    - ansible_facts['service_mgr'] == "systemd" 
    - (ansible_facts['os_family'] != 'Container' or '/run/systemd/system' in ansible_facts['mounts'] | map(attribute='mount') | list)
  failed_when: false
