---
# Verify secret files for ops services when fail-secure is enabled
- name: Check Vaultwarden secrets file exists
  ansible.builtin.stat:
    path: "{{ containers_secrets_dir }}/vaultwarden.env"
  register: vaultwarden_env
  changed_when: false
  when:
    - vaultwarden_enable | bool
    - containers_vaultwarden_fail_secure | default(true) | bool
    - containers_secrets_dir is defined
  tags: [security, containers, ops, audit]

- name: "ISO 27001 ยง10.1 | Audit Code 400010 | Assert Vaultwarden secret file exists and is secure"
  ansible.builtin.assert:
    that:
      - vaultwarden_env is defined
      - vaultwarden_env.stat.exists
      - vaultwarden_env.stat.mode == '0600'
      - vaultwarden_env.stat.pw_name == containers_secrets_owner
    msg: "Vaultwarden secrets file missing or insecure: {{ containers_secrets_dir }}/vaultwarden.env. Create the file with mode 0600 and owner {{ containers_secrets_owner }} or set vaultwarden_fail_secure=false to bypass."
  when:
    - vaultwarden_enable | bool
    - containers_vaultwarden_fail_secure | default(true) | bool
    - containers_secrets_dir is defined
  tags: [security, containers, ops, audit, iso27001]

- name: Check Vaultwarden secret file does not contain placeholder token
  ansible.builtin.shell: |
    
    grep -E "CHANGE_ME_IN_VAULT_TO_HASH|CHANGE_ME" "{{ containers_secrets_dir }}/vaultwarden.env" >/dev/null 2>&1
  args:
    executable: /bin/sh
  register: vaultwarden_env_grep
  changed_when: false
  no_log: true
  when:
    - vaultwarden_enable | bool
    - containers_vaultwarden_fail_secure | default(true) | bool
    - containers_secrets_dir is defined
  tags: [security, containers, ops, audit]

- name: "Audit Code 520011 | Assert Vaultwarden secret file does not contain placeholder token"
  ansible.builtin.assert:
    that:
      - vaultwarden_env_grep is defined
      - vaultwarden_env_grep.rc == 1
    msg: "Vaultwarden secrets file contains placeholder values (CHANGE_ME). Replace with a real ADMIN_TOKEN or set vaultwarden_fail_secure=false to bypass."
  when:
    - vaultwarden_enable | bool
    - containers_vaultwarden_fail_secure | default(true) | bool
    - containers_secrets_dir is defined
  tags: [security, containers, ops, audit]
