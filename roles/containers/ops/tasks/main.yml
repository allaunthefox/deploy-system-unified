---
# Tasks for containers/ops

- name: Run ops secret verifications
  ansible.builtin.include_tasks: verify_secrets.yml

- name: Pull Ops Images
  ansible.builtin.include_tasks: pull_images.yml

- name: Validate Vaultwarden admin token is set
  ansible.builtin.assert:
    that:
      - vaultwarden_admin_token is defined
      - (vaultwarden_admin_token | default('') | length) > 0
      - (vaultwarden_admin_token | default('') | length) > 0
    fail_msg: "Vaultwarden admin token is not set. Define 'vaultwarden_admin_token' in encrypted inventory."
  when:
    - vaultwarden_enable | bool
    - containers_fail_secure | default(true) | bool

- name: Create Ops Network Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/ops_net.network"
    content: |
      [Network]
      NetworkName=ops_net
      Driver=bridge
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  notify: reload_systemd

- name: Create Ops Directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "1000"
    group: "1000"
  loop:
    - "{{ ops_root_dir }}"
    - "{{ ops_config_dir }}"
    - "{{ ops_config_dir }}/homarr"
    - "{{ ops_config_dir }}/vaultwarden"
    - "{{ ops_config_dir }}/wikijs-db"
    - "{{ ops_config_dir }}/wikijs-db/data"
    - "{{ ops_config_dir }}/wiki"
    - "{{ ops_config_dir }}/wiki/data"
  become: true
  when: ops_enable

- name: Create Ops Pod Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/{{ ops_pod_name }}.pod"
    content: |
      [Pod]
      PodName={{ ops_pod_name }}
      {% if ops_pod_network == 'host' or (not podman_rootless_enabled | bool) %}
      Network=host

      # Published Ports are implicit in Network=host mode
      # Homarr
      # PublishPort={{ homarr_port }}:7575

      # Vaultwarden (WebSocket + HTTP)
      # PublishPort=3012:3012

      # Filebrowser
      # PublishPort={{ filebrowser_port }}:8082

      # HTTP port usually proxied, but exposing for verify
      # PublishPort={{ vaultwarden_port }}:80
      {% else %}
      Network={{ ops_pod_network }}.network

      # Published Ports (rootless)
      # Homarr
      PublishPort={{ homarr_port }}:7575

      # Vaultwarden (WebSocket + HTTP)
      PublishPort=3012:3012

      # Filebrowser
      PublishPort={{ filebrowser_port }}:8082

      # HTTP port usually proxied, but exposing for verify
      PublishPort=8081:8081
      {% endif %}

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: ops_enable
  notify: reload_systemd

- name: Set Ops proxy hosts
  ansible.builtin.set_fact:
    containers_ops_homarr_host: "{{ 'localhost' if (ops_pod_network == 'host' or not podman_rootless_enabled | bool) else 'homarr' }}"
    containers_ops_vaultwarden_host: "{{ 'localhost' if (ops_pod_network == 'host' or not podman_rootless_enabled | bool) else 'vaultwarden' }}"
    containers_ops_wiki_host: "{{ 'localhost' if (ops_pod_network == 'host' or not podman_rootless_enabled | bool) else 'wiki' }}"
    containers_ops_anubis_host: "{{ 'localhost' if (ops_pod_network == 'host' or not podman_rootless_enabled | bool) else 'anubis-gatekeeper' }}"
    containers_ops_wastebin_host: "{{ 'localhost' if (ops_pod_network == 'host' or not podman_rootless_enabled | bool) else 'wastebin' }}"
    containers_ops_filebrowser_host: "{{ 'localhost' if (ops_pod_network == 'host' or not podman_rootless_enabled | bool) else 'filebrowser' }}"
  when: ops_enable

- name: Deploy Ops Caddy Configuration
  ansible.builtin.copy:
    dest: "/srv/containers/caddy/conf.d/ops_stack.caddy"
    content: |
      # Ops Stack Reverse Proxy

      # Homarr
      dashboard.{{ ops_domain }} {
        reverse_proxy {{ containers_ops_homarr_host }}:7575
      }

      # Vaultwarden
      vault.{{ ops_domain }} {
        reverse_proxy {{ containers_ops_vaultwarden_host }}:8081 {
           header_up X-Real-IP {remote_host}
        }
        reverse_proxy /notifications/hub/negotiate {{ containers_ops_vaultwarden_host }}:8081
        reverse_proxy /notifications/hub {{ containers_ops_vaultwarden_host }}:3012
      }

      # Wiki.js
      wiki.{{ ops_domain }} {
        reverse_proxy {{ containers_ops_wiki_host }}:31337
      }

      # Anubis
      anubis.{{ ops_domain }} {
        reverse_proxy {{ containers_ops_anubis_host }}:31338
      }

      # Wastebin
      paste.{{ ops_domain }} {
        reverse_proxy {{ containers_ops_wastebin_host }}:8088
      }

      # Filebrowser
      files.{{ ops_domain }} {
        reverse_proxy {{ containers_ops_filebrowser_host }}:8082
      }
    mode: '0644'
  become: true
  when: ops_enable
  notify: restart_caddy

- name: Create Homarr Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/homarr.container"
    content: |
      [Unit]
      Description=Homarr Dashboard
      After=network-online.target {{ ops_pod_name }}.pod
      Requires={{ ops_pod_name }}.pod

      [Container]
      Pod={{ ops_pod_name }}.pod
      Image={{ homarr_image }}
      ContainerName=homarr

      Volume={{ ops_config_dir }}/homarr/configs:/app/data/configs:Z
      Volume={{ ops_config_dir }}/homarr/icons:/app/public/icons:Z
      Volume={{ ops_config_dir }}/homarr/data:/data:Z

      # Mount container socket if dashboard needs to control containers (Optional, riskier)
      # Volume=/run/podman/podman.sock:/var/run/docker.sock:Z

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: homarr_enable
  notify: reload_systemd

- name: Create Vaultwarden Secrets File
  ansible.builtin.copy:
    dest: "{{ containers_secrets_dir }}/vaultwarden.env"
    content: |
      ADMIN_TOKEN={{ vaultwarden_admin_token }}
      # Optional: SMTP credentials could go here
    mode: '0600'
    owner: "{{ containers_secrets_owner }}"
    group: "{{ containers_secrets_group }}"
  become: true
  when: vaultwarden_enable
  notify: reload_systemd

- name: Create Vaultwarden Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/vaultwarden.container"
    content: |
      [Unit]
      Description=Vaultwarden Password Manager
      After=network-online.target {{ ops_pod_name }}.pod
      Requires={{ ops_pod_name }}.pod

      [Container]
      Pod={{ ops_pod_name }}.pod
      Image={{ vaultwarden_image }}
      ContainerName=vaultwarden

      Volume={{ ops_config_dir }}/vaultwarden:/data:Z

      Environment=SIGNUPS_ALLOWED={{ vaultwarden_signups_allowed }}
      Environment=WEBSOCKET_ENABLED=true
      Environment=ROCKET_PORT=8081

      # Secure Secrets Injection
      EnvironmentFile={{ containers_secrets_dir }}/vaultwarden.env

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: vaultwarden_enable
  notify: reload_systemd

- name: Create Wiki.js Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/wiki.container"
    content: |
      [Unit]
      Description=Wiki.js Documentation Platform
      After=network-online.target {{ ops_pod_name }}.pod wikijs-db.service
      Requires={{ ops_pod_name }}.pod wikijs-db.service

      [Container]
      Pod={{ ops_pod_name }}.pod
      Image={{ wiki_image }}
      ContainerName=wiki

      Volume={{ ops_config_dir }}/wiki/data:/data:Z

      Environment=DB_TYPE=postgres
      Environment=DB_HOST=localhost
      Environment=DB_PORT=5432
      Environment=DB_USER=wiki
      Environment=DB_PASS={{ wikijs_pg_password | default('wikijs_pass') }}
      Environment=DB_NAME=wiki
      Environment=HA_ACTIVE=false
      Environment=PORT=31337

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: wiki_enable
  notify: reload_systemd

- name: Create Wiki.js Postgres Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/wikijs-db.container"
    content: |
      [Unit]
      Description=Wiki.js PostgreSQL Database
      After=network-online.target

      [Container]
      Image=docker.io/library/postgres:16-alpine
      ContainerName=wikijs-db

      {% if ops_pod_network == 'host' or (not podman_rootless_enabled | default(true) | bool) %}
      Network=host
      {% else %}
      Network={{ ops_pod_network }}.network
      {% endif %}

      # Override default port if in host mode to avoid conflicts
      {% if ops_pod_network == 'host' or (not podman_rootless_enabled | default(true) | bool) %}
      Exec=postgres -p {{ wikijs_db_port | default(5433) }}
      {% endif %}

      Environment=POSTGRES_DB=wiki
      Environment=POSTGRES_USER=wiki
      Environment=POSTGRES_PASSWORD={{ wikijs_pg_password | default('wikijs_pass') }}

      Volume={{ ops_config_dir }}/wikijs-db/data:/var/lib/postgresql/data:Z

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: wiki_enable
  notify: reload_systemd

- name: Create Wastebin Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/wastebin.container"
    content: |
      [Unit]
      Description=Wastebin Paste Service
      After=network-online.target {{ ops_pod_name }}.pod
      Requires={{ ops_pod_name }}.pod

      [Container]
      Pod={{ ops_pod_name }}.pod
      Image={{ wastebin_image }}
      ContainerName=wastebin

      Volume={{ ops_config_dir }}/wastebin:/data:Z

      Environment=WASTEBIN_DATABASE_PATH=/data/wastebin.db
      Environment=WASTEBIN_TITLE="Ops Pastebin"

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: wastebin_enable
  notify: reload_systemd

- name: Create Filebrowser Container Quadlet
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/filebrowser.container"
    content: |
      [Unit]
      Description=Filebrowser Web File Manager
      After=network-online.target {{ ops_pod_name }}.pod
      Requires={{ ops_pod_name }}.pod

      [Container]
      Pod={{ ops_pod_name }}.pod
      Image={{ filebrowser_image }}
      ContainerName=filebrowser

      # Override default port 80 to avoid conflict with Vaultwarden in the same Pod
      Exec=/filebrowser --port 8082 --root /data --database /config/filebrowser.db

      Volume={{ ops_config_dir }}/filebrowser:/config:Z
      Volume={{ ops_root_dir }}:/data:Z

      [Service]
      Restart=always

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: filebrowser_enable | default(false)
  notify: reload_systemd