---
# Memcached Container Role using Podman Quadlets

- name: Create Memcached directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  loop:
    - /srv/containers/memcached
  become: true
  tags:
    - containers
    - memcached

- name: "ISO 27001 ยง8.26 | Action 700000 | Create Memcached Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/memcached.container"
    content: |
      [Unit]
      Description=Memcached Distributed Memory Object Caching System
      After=network-online.target
      Wants=network-online.target

      [Container]
      Image={{ memcached_image }}
      ContainerName=memcached
      PublishPort={{ memcached_port }}:11211

      # Pass memory limit to executable (-m <MB>)
      Exec=memcached -m {{ memcached_memory_mb }} -o modern

      # Cgroup Memory Limits
      # Ensure the container doesn't exceed 125% of the application limit
      # to prevent OOM kills while allowing for overhead.
      MemoryWithSwap=false
      MemoryMax={{ (memcached_memory_mb | int * 1.25) | int }}M

      [Service]
      Restart=always
      TimeoutStartSec=300

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags:
    - iso_27001_8_26
    - containers
    - memcached
    - remediate
  notify: reload_systemd