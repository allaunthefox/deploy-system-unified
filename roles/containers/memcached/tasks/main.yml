# =============================================================================
# Audit Event Identifier: DSU-PLY-100100
# Last Updated: 2026-03-01
# =============================================================================
---
# Memcached Container Role using Podman Quadlets
# Compliance: ISO 27001 ยง8.26 / ISO 27040

- name: "ISO 27040 | 900000 | Create Memcached directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  loop:
    - /srv/containers/memcached
  become: true
  tags:
    - containers
    - memcached
    - storage
    - 900000

- name: "ISO 27001 ยง8.26 | 700000 | Create Memcached Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/memcached.container"
    content: |
      [Unit]
      Description=Memcached Distributed Memory Object Caching System
      After=network-online.target
      Wants=network-online.target

      [Container]
      Image={{ memcached_image }}
      ContainerName=memcached
      PublishPort={{ memcached_port }}:11211
      
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-26
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ memcached_image.split('@')[1] | default('none') }}

      # Pass memory limit to executable (-m <MB>)
      Exec=memcached -m {{ memcached_memory_mb }} -o modern

      # Cgroup Memory Limits
      # Ensure the container doesn't exceed 125% of the application limit
      # to prevent OOM kills while allowing for overhead.
      MemoryWithSwap=false
      MemoryMax={{ (memcached_memory_mb | int * 1.25) | int }}M

      [Service]
      Restart=always
      TimeoutStartSec=300

      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags:
    - iso_27001_8_26
    - containers
    - memcached
    - deploy
    - 700000
  notify: reload_systemd
