---
# Tasks for containers/media
# Compliance: CIS Docker Benchmark 7.x, STIG V-230460, NIST SC-8/AC-3, ISO 27001 §8.20
- name: "ISO 27001 §8.20 | 700010 | Pull Media Images"
  ansible.builtin.include_tasks: pull_images.yml
  tags:
    - cis_7_1
    - stg_v230460
    - nist_sc_8
    - containers
    - media
    - 700010
- name: "ISO 27001 §8.20 | 700030 | Create Media Network Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/{{ media_network }}.network"
    content: |
      [Network]
      NetworkName={{ media_network }}
      Driver=bridge
      # Internal network - no external access by default (CVE-DSU-032)
      # Traffic must go through the reverse proxy (Caddy) for external access
      Internal=true
    mode: '0644'
- name: "ISO 27001 §8.20 | 600013 | Create Media Directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ media_puid }}"
    group: "{{ media_pgid }}"
    modification_time: preserve
    access_time: preserve
  loop:
    - "{{ containers_media_root_dir }}"
    - "{{ containers_media_root_dir }}/movies"
    - "{{ containers_media_root_dir }}/tv"
    - "{{ containers_media_root_dir }}/music"
    - "{{ containers_media_root_dir }}/books"
    - "{{ containers_media_root_dir }}/downloads"
    - "{{ containers_media_config_dir }}"
    - "{{ containers_media_config_dir }}/jellyfin"
    - "{{ containers_media_config_dir }}/plex"
    - "{{ containers_media_config_dir }}/radarr"
    - "{{ containers_media_config_dir }}/sonarr"
    - "{{ containers_media_config_dir }}/lidarr"
    - "{{ containers_media_config_dir }}/readarr"
    - "{{ containers_media_config_dir }}/prowlarr"
    - "{{ containers_media_config_dir }}/jellyseerr"
    - "{{ containers_media_config_dir }}/navidrome"
    - "{{ containers_media_config_dir }}/transmission"
    - "{{ containers_media_config_dir }}/bazarr"
    - "{{ containers_media_config_dir }}/kavita"
    - "{{ containers_media_config_dir }}/audiobookshelf"
  become: true
  tags:
    - cis_7_3
    - stg_v230460
    - nist_ac_3
    - containers
    - media
- name: "ISO 27001 §8.20 | 700000 | Create Media Pod Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/{{ media_pod_name }}.pod"
    content: |
      [Pod]
      PodName={{ media_pod_name }}
      {% if media_pod_network == 'host' or (not podman_rootless_enabled | bool) %}
      # Host Networking (Rootless or Rootful)
      Network=host
      # Published Ports are implicit in Network=host mode
      # {% if not media_gatekeeper_mode %}
      # PublishPort={{ jellyfin_port_http }}:8096
      # ...
      # {% endif %}
      # BitTorrent Peer Ports (Must be Public/Ingress)
      # Apply port offset for multi-tenancy support
      # PublishPort={{ transmission_port_peer | int + media_port_offset | int }}:51413
      # PublishPort={{ transmission_port_peer | int + media_port_offset | int }}:51413/udp
      {% else %}
      # Rootless networking uses user-defined networks
      Network={{ media_pod_network }}.network
      # APPLICATION PORTS: Published only if explicitly in non-hardened mode
      # In Production/Hardened, all traffic MUST flow through Caddy (L5 Ingress)
      {% if deployment_profile not in ['hardened', 'production'] and not media_gatekeeper_mode %}
      PublishPort={{ jellyfin_port_http }}:8096
      PublishPort={{ plex_port_http }}:32400
      PublishPort={{ radarr_port }}:7878
      PublishPort={{ sonarr_port }}:8989
      PublishPort={{ lidarr_port }}:8686
      PublishPort={{ readarr_port }}:8787
      PublishPort={{ prowlarr_port }}:9696
      PublishPort={{ jellyseerr_port }}:5055
      PublishPort={{ navidrome_port }}:4533
      PublishPort={{ transmission_port_web }}:9091
      PublishPort={{ bazarr_port }}:6767
      PublishPort={{ kavita_port }}:5000
      PublishPort={{ audiobookshelf_port }}:13378
      {% endif %}
      # BitTorrent Peer Ports (Mandatory Public/Ingress)
      PublishPort={{ transmission_port_peer | int + media_port_offset | int }}:51413
      PublishPort={{ transmission_port_peer | int + media_port_offset | int }}:51413/udp
      {% endif %}
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: media_pod_enable
  notify: reload_systemd
  tags:
    - cis_7_4
    - stg_v230460
    - nist_sc_8
    - containers
    - media
    - 700000
- name: "ISO 27001 §9.4 | 540001 | Deploy Media Caddy Configuration"
  ansible.builtin.copy:
    dest: "/srv/containers/caddy/conf.d/media_stack_{{ containers_media_instance_name }}.caddy"
    content: |
      # Media Stack Reverse Proxy Configuration
      # Instance: {{ containers_media_instance_name }}
      # Assumes Caddy and Media Pod share the same network (deploy-net) OR both are Host Mode.
      {% set use_local = (containers_media_pod_network == 'host' or not podman_rootless_enabled | bool) %}
      # Jellyfin
      jellyfin.{{ containers_media_domain }} {
        {% if containers_media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        {% set backend = 'jellyfin-' ~ containers_media_instance_name %}
        reverse_proxy {{ ('localhost' if use_local else backend) }}:8096
      }
      # Radarr
      radarr.{{ containers_media_domain }} {
        {% if containers_media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        {% set backend = 'radarr-' ~ containers_media_instance_name %}
        reverse_proxy {{ ('localhost' if use_local else backend) }}:7878
      }
      # Sonarr
      sonarr.{{ containers_media_domain }} {
        {% if containers_media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        {% set backend = 'sonarr-' ~ containers_media_instance_name %}
        reverse_proxy {{ ('localhost' if use_local else backend) }}:8989
      }
      # Lidarr
      lidarr.{{ containers_media_domain }} {
        {% if containers_media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        {% set backend = 'lidarr-' ~ containers_media_instance_name %}
        reverse_proxy {{ ('localhost' if use_local else backend) }}:8686
      }
      # Readarr
      readarr.{{ containers_media_domain }} {
        {% if containers_media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        {% set backend = 'readarr-' ~ containers_media_instance_name %}
        reverse_proxy {{ ('localhost' if use_local else backend) }}:8787
      }
      # Prowlarr
      prowlarr.{{ containers_media_domain }} {
        {% if containers_media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        {% set backend = 'prowlarr-' ~ containers_media_instance_name %}
        reverse_proxy {{ ('localhost' if use_local else backend) }}:9696
      }
      # Jellyseerr
      jellyseerr.{{ containers_media_domain }} {
        {% if containers_media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        {% set backend = 'jellyseerr-' ~ containers_media_instance_name %}
        reverse_proxy {{ ('localhost' if use_local else backend) }}:5055
      }
      # Navidrome
      navidrome.{{ containers_media_domain }} {
        {% if containers_media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        {% set backend = 'navidrome-' ~ containers_media_instance_name %}
        reverse_proxy {{ ('localhost' if use_local else backend) }}:4533
      }
      # Plex
      # Plex typically handles its own auth and remote access, but we can proxy it.
      plex.{{ containers_media_domain }} {
        {% set backend = 'plex-' ~ containers_media_instance_name %}
        reverse_proxy {{ ('localhost' if use_local else backend) }}:32400
      }
      # Transmission
      transmission.{{ containers_media_domain }} {
        {% if containers_media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        {% set backend = 'transmission-' ~ containers_media_instance_name %}
        reverse_proxy {{ ('localhost' if use_local else backend) }}:9091
      }
      # Bazarr
      bazarr.{{ containers_media_domain }} {
        {% if containers_media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        {% set backend = 'bazarr-' ~ containers_media_instance_name %}
        reverse_proxy {{ ('localhost' if use_local else backend) }}:6767
      }
      # Kavita
      kavita.{{ containers_media_domain }} {
        {% if containers_media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        {% set backend = 'kavita-' ~ containers_media_instance_name %}
        reverse_proxy {{ ('localhost' if use_local else backend) }}:5000
      }
      # Audiobookshelf
      audiobookshelf.{{ containers_media_domain }} {
        {% if containers_media_auth_provider == 'authentik' %}
        import authentik_protect
        {% endif %}
        {% set backend = 'audiobookshelf-' ~ containers_media_instance_name %}
        reverse_proxy {{ ('localhost' if use_local else backend) }}:13378
      }
    mode: '0644'
  become: true
  tags:
    - cis_7_5
    - stg_v230460
    - nist_sc_8
    - iso_27001_9_4
    - containers
    - media
    - remediate
    - 540001
- name: "ISO 27001 §8.20 | 700000 | Create Jellyfin Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/jellyfin-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Jellyfin Media Server ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod
      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ containers_jellyfin_image }}
      ContainerName=jellyfin-{{ media_instance_name }}
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ containers_jellyfin_image.split('@')[1] | default('none') }}
      # Health Check
      HealthCmd=/usr/bin/curl -f http://localhost:8096/health || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s
      CPUQuota=100%
      # Hardware Acceleration
      {% if media_hw_accel %}
      {% set target_name = 'jellyfin-' ~ media_instance_name %}
      {% if containers_gpu_allocation_flags is defined and (target_name in containers_gpu_allocation_flags or 'jellyfin' in containers_gpu_allocation_flags) %}
      # Granular GPU Allocation
      Annotation=run.oci.keep_original_groups=true
      {% set flags = containers_gpu_allocation_flags[target_name] if target_name in containers_gpu_allocation_flags else containers_gpu_allocation_flags['jellyfin'] %}
      {% for flag in flags.split(' ') %}
      AddDevice={{ flag.split('=')[1] }}
      {% endfor %}
      {% else %}
      AddDevice=/dev/dri
      {% endif %}
      {% endif %}
      # Resource Limits
      # Volumes
      Volume={{ containers_media_config_dir }}/jellyfin:/config:Z
      Volume={{ containers_media_root_dir }}:/data:Z
      # Environment
      Environment=TZ={{ media_timezone }}
      [Service]
      MemoryMax={{ jellyfin_memory_max }}
      Restart=always
      TimeoutStartSec=300
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags:
    - cis_7_6
    - stg_v230460
    - nist_ac_3
    - iso_27001_8_20
    - iso_27001_8_26
    - containers
    - media
    - remediate
    - 700000
- name: "ISO 27001 §8.20 | 700000 | Create Radarr Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/radarr-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Radarr Movie Manager ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod
      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ containers_radarr_image }}
      ContainerName=radarr-{{ media_instance_name }}
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ containers_radarr_image.split('@')[1] | default('none') }}
      # Health Check
      HealthCmd=/usr/bin/curl -f http://localhost:7878/ping || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s
      CPUQuota=25%
      Volume={{ containers_media_config_dir }}/radarr:/config:Z
      Volume={{ containers_media_root_dir }}:/data:Z
      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}
      Environment=TZ={{ media_timezone }}
      [Service]
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: containers_radarr_enable
  notify: reload_systemd
  tags:
    - cis_7_7
    - stg_v230460
    - nist_ac_3
    - containers
    - media
    - 700000
- name: "ISO 27001 §8.20 | 700000 | Create Sonarr Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/sonarr-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Sonarr TV Series Manager ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod
      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ containers_sonarr_image }}
      ContainerName=sonarr-{{ media_instance_name }}
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ containers_sonarr_image.split('@')[1] | default('none') }}
      # Health Check
      HealthCmd=/usr/bin/curl -f http://localhost:8989/ping || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s
      CPUQuota=25%
      Volume={{ containers_media_config_dir }}/sonarr:/config:Z
      Volume={{ containers_media_root_dir }}:/data:Z
      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}
      Environment=TZ={{ media_timezone }}
      [Service]
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: containers_sonarr_enable
  notify: reload_systemd
  tags:
    - cis_7_8
    - stg_v230460
    - nist_ac_3
    - containers
    - media
    - 700000
- name: "ISO 27001 §8.20 | 700000 | Create Prowlarr Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/prowlarr-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Prowlarr Indexer Manager ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod
      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ containers_prowlarr_image }}
      ContainerName=prowlarr-{{ media_instance_name }}
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ containers_prowlarr_image.split('@')[1] | default('none') }}
      # Health Check
      HealthCmd=/usr/bin/curl -f http://localhost:9696/health || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s
      CPUQuota=25%
      Volume={{ media_config_dir }}/prowlarr:/config:Z
      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}
      Environment=TZ={{ media_timezone }}
      [Service]
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: containers_prowlarr_enable
  notify: reload_systemd
  tags:
    - cis_7_9
    - stg_v230460
    - nist_ac_3
    - containers
    - media
    - 700000
- name: "CIS 7.10 | STIG V-230460 | NIST IA-2 | Verify media secrets when fail-secure is enabled"
  ansible.builtin.include_tasks: verify_secrets.yml
  when:
    - transmission_enable
  tags:
    - cis_7_10
    - stg_v230460
    - nist_ia_2
    - containers
    - media
    - security
- name: "CIS 7.11 | STIG V-230460 | NIST CM-6 | Enforce CHANGE_ME policy for media stack"
  ansible.builtin.include_tasks: "{{ role_path }}/../tasks/policy_change_me.yml"
  vars:
    change_me_policy_items:
      - name: "transmission_user"
        value: "{{ transmission_user | default('admin') }}"
        bad_values: ["admin", "CHANGE_ME_IN_VAULT", "CHANGE_ME_IN_SOPS", ""]
      - name: "transmission_pass"
        value: "{{ transmission_pass | default('admin') }}"
        bad_values: ["admin", "CHANGE_ME_IN_VAULT", "CHANGE_ME_IN_SOPS", ""]
  when: transmission_enable
  tags:
    - cis_7_11
    - stg_v230460
    - nist_cm_6
    - containers
    - media
    - security
- name: "ISO 27001 §10.1 | 400011 | Create Transmission Secrets File"
  ansible.builtin.copy:
    dest: "{{ containers_secrets_dir }}/transmission-{{ media_instance_name }}.env"
    content: |
      USER={{ transmission_user }}
      PASS={{ transmission_pass }}
    mode: '0600'
    owner: "{{ containers_secrets_owner }}"
    group: "{{ containers_secrets_group }}"
  become: true
  when: transmission_enable
  notify: reload_systemd
  tags:
    - cis_7_12
    - stg_v230460
    - nist_ia_2
    - containers
    - media
    - 400011
- name: "ISO 27001 §8.20 | 700000 | Create Transmission Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/transmission-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Transmission Download Client ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod
      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ containers_transmission_image }}
      ContainerName=transmission-{{ media_instance_name }}
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ containers_transmission_image.split('@')[1] | default('none') }}
      # Health Check
      HealthCmd=/usr/bin/curl -f http://localhost:9091/transmission/rpc || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s
      CPUQuota=75%
      Volume={{ media_config_dir }}/transmission:/config:Z
      Volume={{ containers_media_root_dir }}/downloads:/downloads:Z
      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}
      Environment=TZ={{ media_timezone }}
      # Secure Secrets Injection
      EnvironmentFile={{ containers_secrets_dir }}/transmission-{{ media_instance_name }}.env
      [Service]
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_secrets_owner }}"
    group: "{{ containers_secrets_group }}"
  become: true
  when: transmission_enable
  notify: reload_systemd
  tags:
    - cis_7_13
    - stg_v230460
    - nist_ac_3
    - containers
    - media
    - 700000
- name: "ISO 27001 §8.20 | 700000 | Create Lidarr Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/lidarr-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Lidarr Music Manager ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod
      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ containers_lidarr_image }}
      ContainerName=lidarr-{{ media_instance_name }}
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ containers_lidarr_image.split('@')[1] | default('none') }}
      # Health Check
      HealthCmd=/usr/bin/curl -f http://localhost:8686/lidarr/health || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s
      CPUQuota=25%
      Volume={{ containers_media_config_dir }}/lidarr:/config:Z
      Volume={{ containers_media_root_dir }}:/data:Z
      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}
      Environment=TZ={{ media_timezone }}
      [Service]
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: containers_lidarr_enable
  notify: reload_systemd
  tags:
    - cis_7_14
    - stg_v230460
    - nist_ac_3
    - containers
    - media
    - 700000
- name: "ISO 27001 §8.20 | 700000 | Create Readarr Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/readarr-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Readarr Book Manager ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod
      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ containers_readarr_image }}
      ContainerName=readarr-{{ media_instance_name }}
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ containers_readarr_image.split('@')[1] | default('none') }}
      # Health Check
      HealthCmd=/usr/bin/curl -f http://localhost:8787/readarr/health || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s
      CPUQuota=25%
      Volume={{ containers_media_config_dir }}/readarr:/config:Z
      Volume={{ containers_media_root_dir }}:/data:Z
      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}
      Environment=TZ={{ media_timezone }}
      [Service]
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: containers_readarr_enable
  notify: reload_systemd
  tags:
    - cis_7_15
    - stg_v230460
    - nist_ac_3
    - containers
    - media
    - 700000
- name: "ISO 27001 §8.20 | 700000 | Create Jellyseerr Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/jellyseerr-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Jellyseerr Media Requests ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod
      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ containers_jellyseerr_image }}
      ContainerName=jellyseerr-{{ media_instance_name }}
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ containers_jellyseerr_image.split('@')[1] | default('none') }}
      # Health Check
      HealthCmd=/usr/bin/curl -f http://localhost:5055/api/v1/health || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s
      CPUQuota=50%
      Volume={{ media_config_dir }}/jellyseerr:/app/config:Z
      Environment=LOG_LEVEL=info
      Environment=TZ={{ media_timezone }}
      [Service]
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: containers_jellyseerr_enable
  notify: reload_systemd
  tags:
    - cis_7_16
    - stg_v230460
    - nist_ac_3
    - containers
    - media
    - 700000
- name: "ISO 27001 §8.20 | 700000 | Create Navidrome Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/navidrome-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Navidrome Music Server ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod
      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ containers_navidrome_image }}
      ContainerName=navidrome-{{ media_instance_name }}
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ containers_navidrome_image.split('@')[1] | default('none') }}
      # Health Check
      HealthCmd=test -f /var/lib/navidrome/music || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s
      CPUQuota=50%
      Volume={{ containers_media_config_dir }}/navidrome:/data:Z
      Volume={{ containers_media_root_dir }}/music:/music:ro,Z
      Environment=ND_SCANSCHEDULE=1h
      Environment=ND_LOGLEVEL=info
      Environment=ND_SESSIONTIMEOUT=24h
      Environment=ND_BASEURL=
      [Service]
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: navidrome_enable
  notify: reload_systemd
  tags:
    - cis_7_17
    - stg_v230460
    - nist_ac_3
    - containers
    - media
    - 700000
- name: "ISO 27001 §8.20 | 700000 | Create Plex Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/plex-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Plex Media Server ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod
      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ containers_plex_image }}
      ContainerName=plex-{{ media_instance_name }}
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ containers_plex_image.split('@')[1] | default('none') }}
      # Health Check
      HealthCmd=/usr/bin/curl -f http://localhost:32400/ || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s
      CPUQuota=100%
      # Hardware Acceleration
      {% if media_hw_accel %}
      {% set target_name = 'plex-' ~ media_instance_name %}
      {% if containers_gpu_allocation_flags is defined and (target_name in containers_gpu_allocation_flags or 'plex' in containers_gpu_allocation_flags) %}
      # Granular GPU Allocation
      Annotation=run.oci.keep_original_groups=true
      {% set flags = containers_gpu_allocation_flags[target_name] if target_name in containers_gpu_allocation_flags else containers_gpu_allocation_flags['plex'] %}
      {% for flag in flags.split(' ') %}
      AddDevice={{ flag.split('=')[1] }}
      {% endfor %}
      {% else %}
      AddDevice=/dev/dri
      {% endif %}
      {% endif %}
      Volume={{ containers_media_config_dir }}/plex:/config:Z
      Volume={{ containers_media_root_dir }}:/data:Z
      Environment=TZ={{ media_timezone }}
      Environment=PLEX_CLAIM={{ plex_claim_token }}
      Environment=PLEX_UID={{ media_puid }}
      Environment=PLEX_GID={{ media_pgid }}
      [Service]
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: plex_enable
  notify: reload_systemd
  tags:
    - cis_7_18
    - stg_v230460
    - nist_ac_3
    - containers
    - media
    - 700000
- name: "ISO 27001 §8.20 | 700000 | Create Bazarr Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/bazarr-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Bazarr Subtitle Manager ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod
      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ containers_bazarr_image }}
      ContainerName=bazarr-{{ media_instance_name }}
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ containers_bazarr_image.split('@')[1] | default('none') }}
      # Health Check
      HealthCmd=/usr/bin/curl -f http://localhost:6767/api/health || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s
      CPUQuota=25%
      Volume={{ containers_media_config_dir }}/bazarr:/config:Z
      Volume={{ containers_media_root_dir }}:/data:Z
      Environment=TZ={{ media_timezone }}
      Environment=PUID={{ media_puid }}
      Environment=PGID={{ media_pgid }}
      [Service]
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: bazarr_enable | default(false)
  notify: reload_systemd
  tags:
    - cis_7_19
    - stg_v230460
    - nist_ac_3
    - containers
    - media
    - 700000
- name: "ISO 27001 §8.20 | 700000 | Create Kavita Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/kavita-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Kavita Manga Server ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod
      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ containers_kavita_image }}
      ContainerName=kavita-{{ media_instance_name }}
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ containers_kavita_image.split('@')[1] | default('none') }}
      # Health Check
      HealthCmd=/usr/bin/curl -f http://localhost:5000/api/health || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s
      CPUQuota=50%
      Volume={{ containers_media_config_dir }}/kavita:/kavita/config:Z
      Volume={{ containers_media_root_dir }}:/data:Z
      Environment=TZ={{ media_timezone }}
      [Service]
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: kavita_enable | default(false)
  notify: reload_systemd
  tags:
    - cis_7_20
    - stg_v230460
    - nist_ac_3
    - containers
    - media
    - 700000
- name: "ISO 27001 §8.20 | 700000 | Create Audiobookshelf Container Quadlet"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/audiobookshelf-{{ media_instance_name }}.container"
    content: |
      [Unit]
      Description=Audiobookshelf Server ({{ media_instance_name }})
      After=network-online.target {{ media_pod_name }}.pod
      Requires={{ media_pod_name }}.pod
      [Container]
      Pod={{ media_pod_name }}.pod
      Image={{ containers_audiobookshelf_image }}
      ContainerName=audiobookshelf-{{ media_instance_name }}
      Label=DSU_UUID={{ object_uuid | default('unassigned') }}
      Label=DSU_ISO_CODE=ISO-27001-8-20
      Label=DSU_ACTION_CODE=700000
      Label=DSU_POSTURE={{ deployment_profile | default('unknown') }}
      Label=DSU_IMAGE_DIGEST={{ containers_audiobookshelf_image.split('@')[1] | default('none') }}
      # Health Check
      HealthCmd=/usr/bin/curl -f http://localhost:13378/api || exit 1
      HealthInterval=30s
      HealthTimeout=10s
      HealthRetries=3
      HealthStartPeriod=40s
      CPUQuota=50%
      Volume={{ containers_media_config_dir }}/audiobookshelf:/config:Z
      Volume={{ containers_media_root_dir }}/audiobooks:/audiobooks:Z
      Volume={{ containers_media_root_dir }}/podcasts:/podcasts:Z
      Environment=TZ={{ media_timezone }}
      [Service]
      Restart=always
      [Install]
      WantedBy=multi-user.target default.target
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  when: audiobookshelf_enable | default(false)
  notify: reload_systemd
  tags:
    - cis_7_21
    - stg_v230460
    - nist_ac_3
    - containers
    - media
    - 700000
