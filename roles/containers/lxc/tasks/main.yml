---
# LXC GPU configuration tasks
# Compliance: CIS Docker Benchmark 4.x, STIG V-230430, NIST SC-39/AC-6, ISO 27001 ยง8.20

- name: "CIS 4.1 | STIG V-230430 | NIST AC-6 | Determine LXC GPU slicing strategy based on virtualization type"
  ansible.builtin.set_fact:
    lxc_gpu_slicing_strategy: >-
      {% if lxc_gpu_slicing.strategy == "auto" %}
        {% if not is_virtualized %}
          {{ lxc_gpu_slicing.auto_strategy.bare_metal }}
        {% elif ansible_virtualization_role == "host" %}
          {{ lxc_gpu_slicing.auto_strategy.virtual_host }}
        {% else %}
          {{ lxc_gpu_slicing.auto_strategy.virtual_guest }}
        {% endif %}
      {% else %}
        {{ lxc_gpu_slicing.strategy }}
      {% endif %}
  when: lxc_enable_gpu_support
  tags:
    - cis_4_1
    - stg_v230430
    - nist_ac_6
    - containers
    - lxc

- name: "CIS 4.2 | STIG V-230430 | NIST SC-39 | ISO 27001 ยง8.20 | Action 800410 | Configure LXC container for GPU passthrough"
  when:
    - lxc_enable_gpu_support
    - lxc_gpu_slicing_strategy == "passthrough"
  tags:
    - cis_4_2
    - stg_v230430
    - nist_sc_39
    - iso_27001_8_20
    - iso_27001_8_26
    - containers
    - lxc
    - gpu
    - remediate
  block:
    - name: "CIS 4.2.1 | STIG V-230430 | NIST SC-39 | Include Vendor Specific Passthrough Config"
      ansible.builtin.include_tasks: "vendor/{{ lxc_gpu_vendor }}.yml"
      when: lxc_gpu_vendor in ['nvidia', 'amd', 'intel']
      tags:
        - cis_4_2_1
        - stg_v230430
        - nist_sc_39
        - containers
        - lxc
        - gpu

    - name: "CIS 4.2.2 | STIG V-230430 | NIST CM-6 | Create LXC GPU configuration template"
      ansible.builtin.template:
        src: lxc-gpu-config.j2
        dest: /etc/lxc/default.conf.d/gpu.conf
        mode: '0644'
      become: true
      tags:
        - cis_4_2_2
        - stg_v230430
        - nist_cm_6
        - containers
        - lxc
        - gpu

    - name: "CIS 4.2.3 | STIG V-230430 | NIST AC-6 | ISO 27001 ยง8.20 | Action 700000 | Apply GPU configuration to existing LXC containers"
      ansible.builtin.shell: |
        EXISTING_CONFIG=$(lxc config show {{ item }} 2>/dev/null || true)
        DESIRED_DEVICES="{{ lxc_gpu_passthrough_devices | default([]) | map('regex_replace', '^', 'lxc.cgroup2.devices.allow = c ') | join(\"\n\") }}"

        # Check if config is already present to avoid idempotent restarts
        if echo "$EXISTING_CONFIG" | grep -q "lxc.cgroup2.devices.allow"; then
            echo "Config present"
            exit 0
        fi

        # Apply config if missing
        CMD_ARGS="{{ lxc_gpu_passthrough_devices | default([]) | map('regex_replace', '^', 'lxc.cgroup2.devices.allow = c ') | join('; ') }}"
        lxc config set {{ item }} $CMD_ARGS
      register: lxc_gpu_config_result
      changed_when: "lxc_gpu_config_result.rc == 0 and 'Config present' not in lxc_gpu_config_result.stdout"
      failed_when: false
      loop: "{{ lxc_container_gpu_config.keys() | list }}"
      when: lxc_container_gpu_config | length > 0
      args:
        executable: /bin/bash
        pipefail: true
      tags:
        - cis_4_2_3
        - stg_v230430
        - nist_ac_6
        - iso_27001_8_20
        - iso_27001_8_26
        - containers
        - lxc
        - gpu
        - remediate

    - name: "CIS 4.2.4 | STIG V-230430 | NIST CM-7 | Restart LXC containers to apply GPU configuration"
      ansible.builtin.command:
        cmd: lxc restart {{ item }}
      register: lxc_restart_result
      changed_when: true
      failed_when: false
      loop: "{{ lxc_container_gpu_config.keys() | list }}"
      when: lxc_container_gpu_config | length > 0 and lxc_gpu_config_result.changed
      tags:
        - cis_4_2_4
        - stg_v230430
        - nist_cm_7
        - containers
        - lxc
        - gpu

- name: "CIS 4.3 | STIG V-230430 | NIST SC-39 | Load Vendor Specific Strategy Config"
  ansible.builtin.include_tasks: "{{ item }}"
  loop:
    - vendor/nvidia_mig.yml
    - vendor/nvidia_vgpu.yml
    - vendor/amd_sriov.yml
    - vendor/intel_level_zero.yml
    - vendor/intel_oneapi.yml
  tags:
    - cis_4_3
    - stg_v230430
    - nist_sc_39
    - containers
    - lxc
    - gpu

- name: "CIS 4.4 | STIG V-230430 | NIST AC-6 | Debug LXC GPU configuration"
  ansible.builtin.debug:
    msg: |
      LXC GPU Configuration:
        Strategy: {{ lxc_gpu_slicing_strategy }}
        Vendor: {{ lxc_gpu_vendor | upper }}
        Virtualization Type: {{ ansible_virtualization_type | default('None') }}
        Virtualization Role: {{ ansible_virtualization_role | default('None') }}
        {% if lxc_gpu_slicing_strategy == "passthrough" %}
        Passthrough Devices: {{ lxc_gpu_passthrough_devices | default([]) }}
        Passthrough Mounts: {{ lxc_gpu_passthrough_mounts | default([]) }}
        Passthrough Capabilities: {{ lxc_gpu_passthrough_capabilities | default([]) }}
        {% elif lxc_gpu_slicing_strategy == "mig" %}
        MIG Devices: {{ lxc_gpu_mig_devices | default([]) }}
        {% elif lxc_gpu_slicing_strategy == "vgpu" %}
        vGPU Device: {{ lxc_gpu_vgpu_device | default('') }}
        {% elif lxc_gpu_slicing_strategy == "sriov" %}
        SR-IOV Devices: {{ lxc_gpu_sriov_devices | default([]) }}
        {% elif lxc_gpu_slicing_strategy == "level-zero" %}
        Level Zero Partitions: {{ lxc_gpu_slicing.level_zero.partitions | default([]) }}
        {% elif lxc_gpu_slicing_strategy == "oneapi" %}
        OneAPI Toolkit: {{ lxc_gpu_slicing.oneapi.toolkit | default('') }}
        OneAPI Components: {{ lxc_gpu_slicing.oneapi.components | default([]) }}
        {% endif %}
  when: lxc_enable_gpu_support
  tags:
    - cis_4_4
    - stg_v230430
    - nist_ac_6
    - containers
    - lxc
    - gpu
