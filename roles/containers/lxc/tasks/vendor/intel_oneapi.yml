# =============================================================================
# Audit Event Identifier: DSU-PLY-100080
# Last Updated: 2026-02-28
# =============================================================================
---
# CIS Docker Benchmark | Pod Security Standards
- name: Configure LXC container for Intel OneAPI
  tags: [containers, lxc, gpu, intel]
  block:
    - name: Install Intel OneAPI toolkit (Debian/Ubuntu)
      block:
        - name: Download Intel OneAPI GPG key
          ansible.builtin.get_url:
            url: "{{ intel_oneapi_gpg_key_url }}"
            dest: "{{ intel_oneapi_gpg_keyring_path }}"
            mode: '0644'
          become: true
          tags: [containers, lxc, gpu, intel]

        - name: Ensure Intel OneAPI fingerprint is configured when verification is enabled
          ansible.builtin.assert:
            that:
              - intel_oneapi_gpg_fingerprint | length > 0
            fail_msg: "intel_oneapi_gpg_fingerprint must be set when intel_oneapi_gpg_fingerprint_verify=true."
          when: intel_oneapi_gpg_fingerprint_verify | default(false) | bool
          tags: [containers, lxc, gpu, intel]

        - name: Read Intel OneAPI GPG fingerprint
          ansible.builtin.command:
            cmd: "gpg --show-keys --with-colons {{ intel_oneapi_gpg_keyring_path }}"
          register: intel_oneapi_keyinfo
          changed_when: false
          when: intel_oneapi_gpg_fingerprint_verify | default(false) | bool
          tags: [containers, lxc, gpu, intel]

        - name: Extract Intel OneAPI GPG fingerprint
          ansible.builtin.set_fact:
            intel_oneapi_actual_fingerprint: >-
              {{ (intel_oneapi_keyinfo.stdout_lines
                  | select('match', '^fpr:')
                  | map('regex_replace', '^fpr:+([0-9A-F]+):.*', '\\1')
                  | list
                  | first
                  | default('')) | upper }}
          when: intel_oneapi_gpg_fingerprint_verify | default(false) | bool
          tags: [containers, lxc, gpu, intel]

        - name: Verify Intel OneAPI GPG fingerprint
          ansible.builtin.assert:
            that:
              - intel_oneapi_actual_fingerprint != ""
              - intel_oneapi_actual_fingerprint == (intel_oneapi_gpg_fingerprint | regex_replace('[^0-9A-Fa-f]', '') | upper)
            fail_msg: "Intel OneAPI GPG fingerprint mismatch. Expected {{ intel_oneapi_gpg_fingerprint }}, got {{ intel_oneapi_actual_fingerprint }}."
          when: intel_oneapi_gpg_fingerprint_verify | default(false) | bool
          tags: [containers, lxc, gpu, intel]

        - name: Add Intel OneAPI repository
          ansible.builtin.apt_repository:
            repo: "{{ intel_oneapi_repo }}"
            filename: oneapi
          become: true
          tags: [containers, lxc, gpu, intel]

        - name: Install Intel OneAPI toolkit package
          ansible.builtin.apt:
            name: "intel-oneapi-{{ lxc_gpu_slicing.oneapi.toolkit }}"
            state: present
            update_cache: true
          become: true
          tags: [containers, lxc, gpu, intel]
      when: ansible_facts['os_family'] == 'Debian'
      tags: [containers, lxc, gpu, intel]

    - name: Set Intel OneAPI environment variables
      ansible.builtin.lineinfile:
        path: /etc/profile.d/intel-oneapi.sh
        line: "{{ item }}"
        create: true
        mode: '0755'
      loop:
        - 'source /opt/intel/oneapi/setvars.sh'
      become: true
      tags: [containers, lxc, gpu, intel]

    - name: Create LXC OneAPI configuration template
      ansible.builtin.template:
        src: lxc-gpu-config.j2
        dest: /etc/lxc/default.conf.d/oneapi.conf
        mode: '0644'
      become: true
      tags: [containers, lxc, gpu, intel]
  when:
    - lxc_enable_gpu_support
    - lxc_gpu_slicing_strategy == "oneapi"
    - lxc_gpu_vendor == "intel"
