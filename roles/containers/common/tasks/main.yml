# =============================================================================
# Audit Event Identifier: DSU-PLY-100058
# Last Updated: 2026-03-01
# =============================================================================
---
# Common container utilities and handlers
# WI-CONT | Work Instructions for Containers
# ISO 27001 §8.26 - Application Security Controls

- name: "ISO 27001 §8.26 | 700000 | CIS 5.1.1 | Container Common - Ensure container-specific sysctls are restricted"
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/99-container.conf
    reload: true
  loop:
    - { name: 'kernel.unprivileged_userns_clone', value: '0' }
    - { name: 'user.max_user_namespaces', value: '0' }
  become: true
  when: ansible_system == 'Linux'
  tags: [security, containers, sysctl, deploy, 700000]

- name: "ISO 27040 | 450002 | Storage Pattern - Enforce NOCOW for database directories (Btrfs)"
  ansible.builtin.shell: |
    if [ -d "{{ item }}" ]; then
      if findmnt -n -o FSTYPE -T "{{ item }}" | grep -q "btrfs"; then
        chattr +C "{{ item }}"
        echo "changed"
      fi
    fi
  register: _nocow_result
  changed_when: "'changed' in _nocow_result.stdout"
  loop: "{{ containers_nocow_paths | default(['/srv/containers/database', '/srv/containers/immich/db', '/srv/containers/postgres']) }}"
  become: true
  when: ansible_system == 'Linux'
  tags: [storage, database, performance, deploy, 450002]

- name: "ISO 27001 §8.26 | 450002 | Fix | Clear Podman Storage Lock (Restricted Kernel Fix)"
  ansible.builtin.file:
    path: /var/lib/containers/storage/storage.lock
    state: absent
  become: true
  tags: [containers, runtime, storage, deploy, 450002]

- name: "ISO 27040 | 450002 | Ensure Podman Storage Directory Permissions"
  ansible.builtin.file:
    path: /var/lib/containers/storage
    state: directory
    owner: root
    group: root
    mode: '0700'
  become: true
  tags: [containers, runtime, storage, deploy, 450002]

- name: "ISO 27001 §8.26 | 700001 | Container Runtime - Ensure seccomp profile is set"
  block:
    - name: "ISO 9001 | 600013 | Create container seccomp profile directory"
      ansible.builtin.file:
        path: /etc/seccomp.d
        state: directory
        mode: '0755'
      become: true

    - name: "ISO 27001 §8.26 | 700001 | Deploy container seccomp restrictions"
      ansible.builtin.copy:
        dest: /etc/seccomp.d/container-default.json
        content: |
          {
            "defaultAction": "SCMP_ACT_LOG",
            "syscalls": [
              {"names": ["unshare"], "action": "SCMP_ACT_ERRNO"},
              {"names": ["clone"], "action": "SCMP_ACT_ERRNO", "args": [{"index": 0, "value": 0x20000, "opMask": 0x20000}]},
              {"names": ["setns"], "action": "SCMP_ACT_ERRNO"}
            ]
          }
        mode: '0644'
      become: true
  tags: [security, containers, deploy, 700001]

- name: "ISO 27001 §8.26 | 700011 | Container Network - Standardize MTU for Restricted Kernels"
  ansible.builtin.set_fact:
    containers_standard_mtu: 1400
  tags: [networking, internal, initialization, 700011]
