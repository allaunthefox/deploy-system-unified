# =============================================================================
# Audit Event Identifier: DSU-PLY-100119
# Last Updated: 2026-02-28
# =============================================================================
---
# Container quadlets role - Systemd quadlet management
# Compliance: CIS Docker Benchmark 2.x, STIG V-230470, NIST CM-6/SC-39, ISO 27001 ยง8.20

- name: "CIS 2.1 | STIG V-230470 | NIST CM-6 | Ensure checkpoint directory exists"
  ansible.builtin.file:
    path: /var/lib/deploy-system/checkpoints
    state: directory
    mode: '0700'
  become: true
  tags:
    - cis_2_1
    - stg_v230470
    - nist_cm_6
    - containers
    - quadlets

- name: "CIS 2.2 | STIG V-230470 | NIST SC-39 | Check for Quadlet checkpoint"
  ansible.builtin.stat:
    path: /var/lib/deploy-system/checkpoints/quadlets_checkpoint.json
  register: containers_quadlet_checkpoint_stat
  become: true
  tags:
    - cis_2_2
    - stg_v230470
    - nist_sc_39
    - containers
    - quadlets

- name: "CIS 2.3 | STIG V-230470 | NIST SC-39 | Read existing checkpoint"
  ansible.builtin.slurp:
    src: /var/lib/deploy-system/checkpoints/quadlets_checkpoint.json
  register: containers_checkpoint_content
  when: containers_quadlet_checkpoint_stat.stat.exists
  become: true
  tags:
    - cis_2_3
    - stg_v230470
    - nist_sc_39
    - containers
    - quadlets

- name: "CIS 2.4 | STIG V-230470 | NIST CM-6 | Restore object UUID from checkpoint"
  ansible.builtin.set_fact:
    containers_object_uuid: "{{ (containers_checkpoint_content.content | b64decode | from_json).uuid }}"
  when: containers_quadlet_checkpoint_stat.stat.exists
  tags:
    - cis_2_4
    - stg_v230470
    - nist_cm_6
    - containers
    - quadlets

- name: "CIS 2.5 | STIG V-230470 | NIST SC-39 | Generate new Network UUID (if no checkpoint)"
  ansible.builtin.import_role:
    name: core/identity
  when: not containers_quadlet_checkpoint_stat.stat.exists
  tags:
    - cis_2_5
    - stg_v230470
    - nist_sc_39
    - containers
    - quadlets

- name: "CIS 2.6 | STIG V-230470 | NIST CM-6 | Determine quadlet object UUID"
  ansible.builtin.set_fact:
    containers_quadlet_object_uuid: "{{ containers_object_uuid | default(object_uuid | default('')) }}"
  changed_when: false
  tags:
    - cis_2_6
    - stg_v230470
    - nist_cm_6
    - containers
    - quadlets

- name: "CIS 2.7 | STIG V-230470 | NIST AC-6 | Ensure quadlet directory exists"
  ansible.builtin.file:
    path: "{{ containers_systemd_dir }}"
    state: directory
    mode: '0755'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags:
    - cis_2_7
    - stg_v230470
    - nist_ac_6
    - containers
    - quadlets

- name: "CIS 2.8 | STIG V-230470 | NIST SC-8 | ISO 27001 ยง8.20 | Audit Code 700030 | Create quadlet network configuration"
  ansible.builtin.copy:
    dest: "{{ containers_systemd_dir }}/{{ containers_quadlet_network_name }}.network"
    content: |
      [Network]
      Label=org.deploy-system.uuid={{ containers_quadlet_object_uuid }}
      NetworkName={{ containers_quadlet_network_name }}
      Driver=bridge
      Subnet={{ containers_quadlet_network_subnet }}
      Gateway={{ containers_quadlet_network_gateway }}
      IPRange={{ containers_quadlet_network_iprange }}
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  become: true
  tags:
    - cis_2_8
    - stg_v230470
    - nist_sc_8
    - iso_27001_8_20
    - iso_27001_8_26
    - nist_sc_39
    - containers
    - quadlets
    - remediate
  when: containers_quadlet_create_network | bool

- name: "CIS 2.9 | STIG V-230470 | NIST CM-6 | ISO 27001 ยง8.20 | Audit Code 700000 | Deploy custom quadlet files"
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "{{ containers_systemd_dir }}/{{ item | basename }}"
    mode: '0644'
    owner: "{{ containers_systemd_owner }}"
    group: "{{ containers_systemd_group }}"
  loop: "{{ containers_quadlet_custom_files }}"
  become: true
  tags:
    - cis_2_9
    - stg_v230470
    - nist_cm_6
    - iso_27001_8_20
    - iso_27001_8_26
    - nist_cm_2
    - containers
    - quadlets
    - remediate
  when: containers_quadlet_custom_files | length > 0
  notify: reload_systemd

- name: "CIS 2.10 | STIG V-230470 | NIST CM-7 | Reload systemd to pick up quadlets"
  ansible.builtin.systemd:
    daemon_reload: true
    scope: "{{ containers_systemd_scope }}"
  environment: "{{ containers_systemd_env }}"
  become: true
  become_user: "{{ containers_systemd_owner }}"
  when: ansible_facts['service_mgr'] == 'systemd'
  failed_when: false
  tags:
    - cis_2_10
    - stg_v230470
    - nist_cm_7
    - containers
    - quadlets

- name: "CIS 2.11 | STIG V-230470 | NIST CA-7 | List generated quadlet services"
  ansible.builtin.shell:
    cmd: >-
      {{ (podman_rootless_enabled | default(false) | bool)
         | ternary("bash -o pipefail -c 'systemctl --user list-unit-files --type=service | grep -E \"\\\\.container|\\\\.pod\"'",
                   "bash -o pipefail -c 'systemctl list-unit-files --type=service | grep -E \"\\\\.container|\\\\.pod\"'") }}
  register: containers_quadlet_services
  changed_when: false
  failed_when: false
  environment: "{{ containers_systemd_env }}"
  become: true
  become_user: "{{ containers_systemd_owner }}"
  when: ansible_facts['service_mgr'] == 'systemd'
  tags:
    - cis_2_11
    - stg_v230470
    - nist_ca_7
    - containers
    - quadlets

- name: "CIS 2.12 | STIG V-230470 | NIST CA-7 | Display available quadlet services"
  ansible.builtin.debug:
    msg: "Available quadlet services: {{ containers_quadlet_services.stdout_lines | default([]) }}"
  when: ansible_facts['service_mgr'] == 'systemd'
  tags:
    - cis_2_12
    - stg_v230470
    - nist_ca_7
    - containers
    - quadlets

- name: "CIS 2.13 | STIG V-230470 | NIST CM-6 | Set containers quadlets completion flag"
  ansible.builtin.set_fact:
    containers_quadlets_complete: true
  tags:
    - cis_2_13
    - stg_v230470
    - nist_cm_6
    - containers
    - quadlets

- name: "CIS 2.14 | STIG V-230470 | NIST SC-39 | Save Quadlet checkpoint"
  ansible.builtin.copy:
    dest: /var/lib/deploy-system/checkpoints/quadlets_checkpoint.json
    content: |
      {
        "uuid": "{{ containers_quadlet_object_uuid }}",
        "role": "containers/quadlets",
        "deployment_variables": {
          "network_name": "{{ containers_quadlet_network_name }}",
          "subnet": "{{ containers_quadlet_network_subnet }}"
        }
      }
    mode: '0600'
  become: true
  tags:
    - cis_2_14
    - stg_v230470
    - nist_sc_39
    - containers
    - quadlets
