---
# Tasks for orchestration/k8s_node - Kubernetes Node Readiness
# Compliance: CIS Kubernetes Benchmark 1.x-5.x, STIG V-230500, NIST SC-7/SC-8/AC-3/CM-6, ISO 27001 ยง8.20/ยง8.23

- name: "CIS 4.3.1 | STIG V-230520 | NIST CM-6 | Disable SWAP (Mandatory for K8s)"
  ansible.builtin.command: swapoff -a
  become: true
  when: ansible_swaptotal_mb > 0
  tags:
    - cis_4_3_1
    - stig_v_230520
    - nist_cm_6
    - kubernetes
    - orchestration

- name: "CIS 4.3.2 | STIG V-230521 | NIST CM-6 | Remove SWAP from fstab"
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: '^([^#].*?\sswap\s+.*)$'
    replace: '# \1'
  become: true
  tags:
    - cis_4_3_2
    - stig_v_230521
    - nist_cm_6
    - kubernetes
    - orchestration

- name: "CIS 4.3.3 | STIG V-230522 | NIST SC-7 | ISO 27001 ยง8.26 | Audit Code 820000 | Load Kubernetes required kernel modules"
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - overlay
    - br_netfilter
  become: true
  tags:
    - cis_4_3_3
    - stig_v_230522
    - nist_sc_7
    - iso_27001_8_26
    - kubernetes
    - orchestration

- name: "CIS 4.3.4 | STIG V-230523 | NIST SC-8 | ISO 27001 ยง8.26 | Audit Code 820000 | Configure sysctl for Kubernetes networking"
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/k8s.conf
    reload: true
  loop:
    - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
    - { name: 'net.ipv4.ip_forward', value: '1' }
  become: true
  tags:
    - cis_4_3_4
    - stig_v_230523
    - nist_sc_8
    - iso_27001_8_26
    - kubernetes
    - orchestration
    - remediate

- name: "CIS 4.3.5 | STIG V-230524 | NIST AC-3 | Create directory for Kubernetes manifests"
  ansible.builtin.file:
    path: /etc/kubernetes/manifests
    state: directory
    mode: '0755'
  become: true
  tags:
    - cis_4_3_5
    - stig_v_230524
    - nist_ac_3
    - kubernetes
    - orchestration

- name: "CIS 4.3.6 | STIG V-230525 | NIST SC-39 | Deploy GPU device plugins"
  ansible.builtin.include_tasks: gpu.yml
  tags:
    - cis_4_3_6
    - stig_v_230525
    - nist_sc_39
    - kubernetes
    - gpu
  when: k8s_gpu_device_plugins_enabled | default(false)
