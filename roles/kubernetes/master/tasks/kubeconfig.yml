---
# Export Kubeconfig

- name: Wait for kubeconfig to be generated
  ansible.builtin.wait_for:
    path: /etc/rancher/k3s/k3s.yaml
  become: true
  when: not _k8s_is_container
  tags: [kubernetes, master, remediate]

- name: "ISO 27001 ยง8.21 | Audit Code 830000 | Secure source kubeconfig permissions"
  ansible.builtin.file:
    path: /etc/rancher/k3s/k3s.yaml
    mode: '0600'
    owner: root
    group: root
  become: true
  tags: [kubernetes, master, security, remediate, 830000]

- name: "ISO 27001 ยง8.21 | Audit Code 830000 | Add admin user to k3s group for kubeconfig access"
  ansible.builtin.user:
    name: "{{ system_admin_user | default('admin') }}"
    groups: k3s
    append: true
  become: true
  when: not _k8s_is_container
  tags: [kubernetes, master, security, remediate, 830000]

- name: "ISO 27001 ยง8.21 | Audit Code 830000 | Set k3s group ownership on kubeconfig"
  ansible.builtin.file:
    path: /etc/rancher/k3s/k3s.yaml
    mode: '0640'
    owner: root
    group: k3s
  become: true
  tags: [kubernetes, master, security, remediate, 830000]

- name: Ensure .kube directory exists for admin
  ansible.builtin.file:
    path: "/home/{{ system_admin_user | default('admin') }}/.kube"
    state: directory
    mode: '0700'
    owner: "{{ system_admin_user | default('admin') }}"
    group: "{{ system_admin_user | default('admin') }}"
  become: true
  when: not _k8s_is_container
  tags: [kubernetes, master, remediate]

- name: Copy kubeconfig to admin home
  ansible.builtin.copy:
    src: /etc/rancher/k3s/k3s.yaml
    dest: "/home/{{ system_admin_user | default('admin') }}/.kube/config"
    remote_src: true
    mode: '0600'
    owner: "{{ system_admin_user | default('admin') }}"
    group: "{{ system_admin_user | default('admin') }}"
  become: true
  when: not _k8s_is_container
  tags: [kubernetes, master, remediate]

- name: Update API server address in kubeconfig
  ansible.builtin.replace:
    path: "/home/{{ system_admin_user | default('admin') }}/.kube/config"
    regexp: 'https://127.0.0.1:6443'
    replace: "https://{{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}:{{ kubernetes_api_port }}"
  become: true
  when: not _k8s_is_container
  tags: [kubernetes, master, remediate]
