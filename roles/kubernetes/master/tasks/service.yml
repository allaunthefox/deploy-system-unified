# =============================================================================
# Audit Event Identifier: DSU-PLY-100588
# Last Updated: 2026-02-28
# =============================================================================
---
# CIS Kubernetes Benchmark | ISO 27001 ยง14.2
# Manage K3s Service

- name: Enable and start K3s service
  ansible.builtin.systemd:
    name: k3s
    state: started
    enabled: true
  become: true
  when: not _k8s_is_container
  tags: [kubernetes, master, remediate]

- name: Wait for k3s node to be ready
  ansible.builtin.command: kubectl get node {{ ansible_hostname }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
  register: _node_ready
  until: _node_ready.stdout == "True"
  retries: 20
  delay: 10
  changed_when: false
  become: true
  when: not _k8s_is_container
  tags: [kubernetes, master, remediate]
