---
# Save checkpoint for kubernetes/master

- name: Create evidence directory
  ansible.builtin.file:
    path: "/var/lib/deploy-system/evidence/kubernetes"
    state: directory
    mode: '0755'
  become: true
  tags: [kubernetes, master, checkpoint]

- name: Capture K3s node status
  ansible.builtin.command: kubectl get nodes -o json
  register: _k8s_node_status
  changed_when: false
  become: true
  when: not _k8s_is_container
  tags: [kubernetes, master, checkpoint]

- name: VERIFY | K3s status capture success
  ansible.builtin.assert:
    that: 
      - _k8s_node_status.rc == 0
      - (_k8s_node_status.stdout | from_json).items | length > 0
    fail_msg: "Failed to capture valid K3s node status for checkpoint."
  when: not _k8s_is_container
  tags: [kubernetes, master, checkpoint, verification]

- name: Save K3s status evidence
  ansible.builtin.copy:
    content: "{{ _k8s_node_status.stdout | from_json | to_nice_json }}"
    dest: "/var/lib/deploy-system/evidence/kubernetes/master_status.json"
    mode: '0644'
  become: true
  when:
    - not _k8s_is_container
    - _k8s_node_status.stdout is defined
  tags: [kubernetes, master, checkpoint]

- name: Update deployment checkpoint
  ansible.builtin.set_fact:
    _dsu_checkpoint_phases: "{{ (_dsu_checkpoint_phases | default([])) + additional_phases }}"
  tags: [kubernetes, master, checkpoint]

- name: Save Checkpoint Evidence
  ansible.builtin.copy:
    content: |
      {
        "phase": "kubernetes/master",
        "timestamp": "{{ ansible_date_time.iso8601 }}",
        "status": "success",
        "node": "{{ ansible_hostname }}",
        "arch": "{{ _k8s_norm_arch }}"
      }
    dest: "/var/lib/deploy-system/evidence/kubernetes/checkpoint.json"
    mode: '0644'
  become: true
  tags: [kubernetes, master, checkpoint]
