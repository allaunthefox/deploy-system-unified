# =============================================================================
# Audit Event Identifier: DSU-PLY-100593
# Last Updated: 2026-02-28
# =============================================================================
# Main entry point for kubernetes/master
# Compliance: CIS Kubernetes Benchmark 1.x-5.x, STIG V-230500, NIST SC-7/SC-8/AC-3/CM-6, ISO 27001 ยง8.20/ยง8.23

- name: "Forensic Chain of Trust | Enforce Rule [B-02] (The Aggregator Wait)"
  ansible.builtin.include_tasks: "../../containers/common/tasks/wait_for_aggregator.yml"
  tags: [forensic, audit, 840020]

- name: "Forensic Chain of Trust | Audit Code 810302 | Wait for K3s API Gateway (Restricted Kernel Fix)"
  ansible.builtin.wait_for:
    host: "172.17.0.1"
    port: 443
    timeout: 30
    msg: "K3s API Gateway not responding. Infrastructure not ready for master initialization."
  when:
    - kubernetes_proxy_mode == "nftables"
    - not ansible_check_mode
  become: true
  tags: [kubernetes, master, gateway, audit, 810302]

- name: "CIS 4.1.1 | STIG V-230501 | NIST CM-6 | Normalize Architecture for Kubernetes"
  ansible.builtin.set_fact:
    _k8s_norm_arch: >-
      {{
        'x86_64' if ansible_architecture in ['amd64', 'x86_64'] else
        'aarch64' if ansible_architecture in ['arm64', 'aarch64', 'armv8b', 'armv8l'] else
        'riscv64' if ansible_architecture in ['riscv64', 'risc64', 'riscv'] else
        ansible_architecture
      }}
  tags:
    - cis_4_1_1
    - stig_v_230501
    - nist_cm_6
    - kubernetes
    - master

- name: "CIS 4.1.2 | STIG V-230502 | NIST AC-3 | Validate OS Compatibility for Kubernetes"
  ansible.builtin.assert:
    that:
      - ansible_os_family in ['Debian', 'RedHat', 'Archlinux', 'Alpine']
    fail_msg: "Unsupported OS for Kubernetes prototype: {{ ansible_os_family }}"
  tags:
    - cis_4_1_2
    - stig_v_230502
    - nist_ac_3
    - kubernetes
    - master

- name: "CIS 4.1.3 | STIG V-230503 | NIST SC-7 | Run K3s Pre-flight Security Checks"
  ansible.builtin.include_tasks: preflight.yml
  tags:
    - cis_4_1_3
    - stig_v_230503
    - nist_sc_7
    - kubernetes
    - master

- name: "CIS 4.1.4 | STIG V-230504 | NIST CM-6 | ISO 27001 ยง8.26 | Audit Code 820000 | Install K3s Binary"
  ansible.builtin.include_tasks: install.yml
  tags:
    - cis_4_1_4
    - stig_v_230504
    - nist_cm_6
    - iso_27001_8_26
    - kubernetes
    - master

- name: "CIS 4.1.5 | STIG V-230505 | NIST SC-8 | ISO 27001 ยง8.23 | Audit Code 820000 | Configure K3s Master"
  ansible.builtin.include_tasks: configure.yml
  tags:
    - cis_4_1_5
    - stig_v_230505
    - nist_sc_8
    - iso_27001_8_23
    - kubernetes
    - master
    - remediate

- name: "CIS 4.1.6 | STIG V-230506 | NIST AC-3 | Manage K3s Service"
  ansible.builtin.include_tasks: service.yml
  tags:
    - cis_4_1_6
    - stig_v_230506
    - nist_ac_3
    - kubernetes
    - master

- name: "CIS 4.1.7 | STIG V-230507 | NIST SC-7 | Export Kubeconfig Securely"
  ansible.builtin.include_tasks: kubeconfig.yml
  tags:
    - cis_4_1_7
    - stig_v_230507
    - nist_sc_7
    - kubernetes
    - master

- name: "CIS 4.1.8 | STIG V-230508 | NIST CM-6 | Save Role Checkpoint"
  ansible.builtin.include_tasks: save_checkpoint.yml
  vars:
    additional_phases: ["kubernetes/master"]
  tags:
    - cis_4_1_8
    - stig_v_230508
    - nist_cm_6
    - kubernetes
    - master
