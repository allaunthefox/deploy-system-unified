---
# Main entry point for kubernetes/node
# Compliance: CIS Kubernetes Benchmark 1.x-5.x, STIG V-230500, NIST SC-7/SC-8/AC-3/CM-6, ISO 27001 ยง8.20/ยง8.23

- name: "CIS 4.2.1 | STIG V-230511 | NIST CM-6 | Detect Container Environment"
  ansible.builtin.set_fact:
    _k8s_is_container: "{{ (ansible_virtualization_type | default('unknown') in ['docker', 'podman', 'container', 'lxc']) }}"
  tags:
    - cis_4_2_1
    - stig_v_230511
    - nist_cm_6
    - kubernetes
    - node

- name: "CIS 4.2.2 | STIG V-230511 | NIST CM-6 | Normalize Architecture for Kubernetes Node"
  ansible.builtin.set_fact:
    _k8s_norm_arch: >-
      {{
        'x86_64' if ansible_architecture in ['amd64', 'x86_64'] else
        'aarch64' if ansible_architecture in ['arm64', 'aarch64', 'armv8b', 'armv8l'] else
        'riscv64' if ansible_architecture in ['riscv64', 'risc64', 'riscv'] else
        ansible_architecture
      }}
  tags:
    - cis_4_2_2
    - stig_v_230511
    - nist_cm_6
    - kubernetes
    - node

- name: "CIS 4.2.2 | STIG V-230512 | NIST AC-3 | Validate OS Compatibility for Kubernetes Node"
  ansible.builtin.assert:
    that:
      - ansible_os_family in ['Debian', 'RedHat', 'Archlinux', 'Alpine']
    fail_msg: "Unsupported OS for Kubernetes prototype: {{ ansible_os_family }}"
  tags:
    - cis_4_2_2
    - stig_v_230512
    - nist_ac_3
    - kubernetes
    - node

- name: "CIS 4.2.3 | STIG V-230513 | NIST SC-7 | Run K3s Pre-flight Security Checks"
  ansible.builtin.include_role:
    name: kubernetes/master
    tasks_from: preflight.yml
  tags:
    - cis_4_2_3
    - stig_v_230513
    - nist_sc_7
    - kubernetes
    - node

- name: "CIS 4.2.4 | STIG V-230514 | NIST CM-6 | Install K3s Binary on Node"
  ansible.builtin.include_role:
    name: kubernetes/master
    tasks_from: install.yml
  tags:
    - cis_4_2_4
    - stig_v_230514
    - nist_cm_6
    - kubernetes
    - node

- name: "CIS 4.2.5 | STIG V-230515 | NIST SC-8 | ISO 27001 ยง8.23 | Audit Code 820003 | Configure K3s Agent"
  ansible.builtin.template:
    src: k3s-agent.service.j2
    dest: /etc/systemd/system/k3s-agent.service
    mode: '0644'
  become: true
  notify: reload_systemd
  tags:
    - cis_4_2_5
    - stig_v_230515
    - nist_sc_8
    - iso_27001_8_23
    - kubernetes
    - node
    - remediate

- name: "CIS 4.2.6 | STIG V-230516 | NIST AC-3 | ISO 27001 ยง8.26 | Audit Code 820004 | Start K3s Agent"
  ansible.builtin.systemd:
    name: k3s-agent
    state: started
    enabled: true
  become: true
  when: not _k8s_is_container
  tags:
    - cis_4_2_6
    - stig_v_230516
    - nist_ac_3
    - iso_27001_8_26
    - kubernetes
    - node