---
# Configure IngressClass for the installed controller

- name: "Check if IngressClass already exists"
  kubernetes.core.k8s_info:
    kind: IngressClass
    name: "{{ kubernetes_ingress_class_name }}"
  register: _ingress_class_info

- name: "Create IngressClass"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: networking.k8s.io/v1
      kind: IngressClass
      metadata:
        name: "{{ kubernetes_ingress_class_name }}"
        annotations:
          ingressclass.kubernetes.io/is-default-class: "true"
      spec:
        controller: >-
          {{
            'k8s.io/ingress-nginx' if kubernetes_ingress_controller == 'nginx-ingress' else
            'traefik.io/ingress-controller' if kubernetes_ingress_controller == 'traefik' else
            'getambassador.io/ambassador-ingress-class'
          }}
  when: _ingress_class_info.resources | length == 0
