---
# Handlers for kubernetes/ingress role

- name: "Reload ingress controller"
  when: kubernetes_ingress_controller == "nginx-ingress"
  kubernetes.core.k8s:
    name: "ingress-nginx-controller"
    namespace: "{{ kubernetes_ingress_namespace }}"
    kind: Deployment
    state: patched
    definition:
      spec:
        replicas: 1  # Trigger restart

- name: "Restart ingress controller"
  ansible.builtin.command:
    cmd: >-
      kubectl rollout restart deployment 
      -n {{ kubernetes_ingress_namespace }} 
      {{ 'ingress-nginx-controller' if kubernetes_ingress_controller == 'nginx-ingress' else kubernetes_ingress_controller }}
  become: true
  become_user: root
  changed_when: true

- name: "Update helm release"
  kubernetes.core.helm:
    name: "{{ 'ingress-nginx' if kubernetes_ingress_controller == 'nginx-ingress' else kubernetes_ingress_controller }}"
    release_namespace: "{{ kubernetes_ingress_namespace }}"
    state: upgraded
  become: true
  become_user: root
