---
# Tasks for security/ips - Intrusion Prevention System (Fail2Ban)
- name: "CIS 5.6.1 | STIG V-230344 | NIST AC-7 | NIST SI-3 | Action 460002 | Install Fail2Ban"
  ansible.builtin.package:
    name: fail2ban
    state: present
  become: true
  tags:
    - cis_5_6_1
    - stig_v_230344
    - nist_ac_7
    - nist_si_3
    - iso_27001_16_1
    - security
    - ips
    - forensic

- name: "CIS 5.6.1 | STIG V-230345 | NIST AC-7 | NIST SI-3 | ISO 27001 ยง16.1 | Action 460003 | Configure Fail2Ban for SSH protection"
  ansible.builtin.copy:
    content: |
      [sshd]
      enabled = {{ ips_fail2ban_sshd_enabled | lower }}
      port    = {{ ssh_effective_port | default(system_ssh_port) | default(22) }}
      logpath = %(sshd_log)s
      backend = %(sshd_backend)s
      maxretry = {{ ips_fail2ban_sshd_maxretry }}
      bantime  = {{ ips_fail2ban_sshd_bantime }}
      findtime = {{ ips_fail2ban_sshd_findtime }}
    dest: /etc/fail2ban/jail.d/99-sshd-hardened.local
    mode: '0644'
  become: true
  tags:
    - cis_5_6_1
    - stig_v_230345
    - nist_ac_7
    - nist_si_3
    - iso_27001_16_1
    - security
    - ips
    - forensic
    - remediate
  notify: restart_fail2ban

- name: "CIS 5.6.1 | STIG V-230346 | NIST SI-3 | Install Caddy Filter"
  ansible.builtin.copy:
    src: filter_caddy.conf
    dest: /etc/fail2ban/filter.d/caddy.conf
    mode: '0644'
  become: true
  tags:
    - cis_5_6_1
    - stig_v_230346
    - nist_si_3
    - security
    - ips
  notify: restart_fail2ban

- name: "CIS 5.6.1 | STIG V-230347 | NIST SI-3 | ISO 27001 ยง16.1 | Action 460003 | Configure Fail2Ban for Caddy (Web Protection)"
  ansible.builtin.copy:
    content: |
      [caddy]
      enabled = {{ ips_fail2ban_caddy_enabled | lower }}
      port    = 80,443
      filter  = caddy
      logpath = /var/log/caddy/access.log
      maxretry = {{ ips_fail2ban_caddy_maxretry }}
      bantime  = {{ ips_fail2ban_caddy_bantime }}
      findtime = 10m
    dest: /etc/fail2ban/jail.d/99-caddy-hardened.local
    mode: '0644'
  become: true
  tags:
    - cis_5_6_1
    - stig_v_230347
    - nist_si_3
    - iso_27001_16_1
    - security
    - ips
    - forensic
    - remediate
  notify: restart_fail2ban

- name: "CIS 5.6.1 | STIG V-230348 | NIST AC-7 | NIST SI-3 | Enable and start Fail2Ban"
  ansible.builtin.systemd:
    name: fail2ban
    enabled: true
    state: started
  become: true
  tags:
    - cis_5_6_1
    - stig_v_230348
    - nist_ac_7
    - nist_si_3
    - security
    - ips

- name: VERIFY | Fail2Ban is functional (Zero-Tolerance)
  ansible.builtin.shell: fail2ban-client ping
  register: _f2b_ping
  failed_when: "'Server replied: pong' not in _f2b_ping.stdout"
  changed_when: false
  become: true
  tags: [security, ips, verification]

- name: VERIFY | Fail2Ban jails are active
  ansible.builtin.shell: fail2ban-client status sshd
  register: _f2b_status
  failed_when: "'Status for the jail: sshd' not in _f2b_status.stdout"
  changed_when: false
  become: true
  tags: [security, ips, verification]
