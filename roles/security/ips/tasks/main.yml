---
# Tasks for security/ips - Intrusion Prevention System (Fail2Ban)
- name: "ISO 9001 | Action 600030 | Validate IPS Eligibility (Ephemeral Guard)"
  ansible.builtin.assert:
    that:
      - not ips_ephemeral_skip | bool
    fail_msg: "IPS (Fail2Ban) is skipped in ephemeral profiles. Set system_security_ips_ephemeral_allow: true to override."
  tags: [security, ips, profile_guard]
  when: (deployment_profile | default('') == 'ephemeral')

- name: "ISO 27001 ยง16.1 | Action 460002 | Install Fail2Ban"
  ansible.builtin.package:
    name: fail2ban
    state: present
  become: true
  tags:
    - iso_27001_16_1
    - security
    - ips
    - forensic

- name: "ISO 27001 ยง16.1 | Action 460003 | Configure Fail2Ban for SSH protection"
  ansible.builtin.copy:
    content: |
      [sshd]
      enabled = {{ ips_fail2ban_sshd_enabled | lower }}
      port    = {{ ssh_effective_port | default(system_ssh_port) | default(22) }}
      logpath = %(sshd_log)s
      backend = %(sshd_backend)s
      maxretry = {{ ips_fail2ban_sshd_maxretry }}
      bantime  = {{ ips_fail2ban_sshd_bantime }}
      findtime = {{ ips_fail2ban_sshd_findtime }}
    dest: /etc/fail2ban/jail.d/99-sshd-hardened.local
    mode: '0644'
  become: true
  tags:
    - iso_27001_16_1
    - security
    - ips
    - forensic
    - remediate
  notify: restart_fail2ban

- name: Install Caddy Filter
  ansible.builtin.copy:
    src: filter_caddy.conf
    dest: /etc/fail2ban/filter.d/caddy.conf
    mode: '0644'
  become: true
  tags:
    - security
    - ips
  notify: restart_fail2ban

- name: "ISO 27001 ยง16.1 | Action 460003 | Configure Fail2Ban for Caddy (Web Protection)"
  ansible.builtin.copy:
    content: |
      [caddy]
      enabled = {{ ips_fail2ban_caddy_enabled | lower }}
      port    = 80,443
      filter  = caddy
      logpath = /var/log/caddy/access.log
      maxretry = {{ ips_fail2ban_caddy_maxretry }}
      bantime  = {{ ips_fail2ban_caddy_bantime }}
      findtime = 10m
    dest: /etc/fail2ban/jail.d/99-caddy-hardened.local
    mode: '0644'
  become: true
  tags:
    - iso_27001_16_1
    - security
    - ips
    - forensic
    - remediate
  notify: restart_fail2ban

- name: Enable and start Fail2Ban
  ansible.builtin.systemd:
    name: fail2ban
    enabled: true
    state: started
  become: true
  tags:
    - security
    - ips