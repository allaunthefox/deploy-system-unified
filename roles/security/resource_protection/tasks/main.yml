---
# Tasks for security/resource_protection - DoS and Resource Exhaustion Mitigation
- name: "CIS 5.4.1 | STIG V-230225 | NIST SC-5 | ISO 27001 ยง8.20 | Action 400002 | Validate minimum resource requirements"
  ansible.builtin.assert:
    that:
      - ansible_memtotal_mb >= resource_min_ram_mb[virt_type] | default(resource_min_ram_mb['default'])
    fail_msg: |-
      Insufficient RAM for {{ virt_type | upper }} environment.
      Required: {{ resource_min_ram_mb[virt_type] | default(resource_min_ram_mb['default']) }}MB
  tags:
    - cis_5_4_1
    - stig_v_230225
    - nist_sc_5
    - iso_27001_8_20
    - security
    - resources
- name: "CIS 5.4.2 | STIG V-230226 | NIST AC-6 | ISO 27001 ยง8.20 | Action 400003 | Configure system-wide ulimits for process isolation"
  ansible.builtin.copy:
    content: |
      * soft core 0
      * hard core 0
      * soft nproc 2048
      * hard nproc 4096
      * soft nofile 8192
      * hard nofile 16384
    dest: /etc/security/limits.d/99-resource-protection.conf
    mode: '0644'
  become: true
  tags:
    - cis_level_2
    - cis_5_4_2
    - stig_v_230226
    - nist_ac_6
    - iso_27001_8_20
    - security
    - resources
    - remediate

- name: VERIFY | Core dumps are disabled (Zero-Tolerance)
  ansible.builtin.shell: |
    grep -q "hard core 0" /etc/security/limits.d/99-resource-protection.conf && \
    sysctl kernel.core_pattern | grep -q "|/bin/false" || sysctl kernel.core_pattern | grep -q "^kernel.core_pattern = core"
  become: true
  changed_when: false
  tags: [security, resources, verification]

- name: "CIS 5.4.3 | STIG V-230226 | NIST AC-6 | ISO 27001 ยง8.20 | Action 400004 | Enforce Systemd global resource limits"
  ansible.builtin.lineinfile:
    path: /etc/systemd/system.conf
    regexp: "^#?Default{{ item.key }}="
    line: "Default{{ item.key }}={{ item.value }}"
  loop:
    - { key: 'TasksMax', value: "{{ resource_default_tasks_max }}" }
    - { key: 'MemoryMax', value: "{{ resource_default_memory_max }}" }
    - { key: 'MemoryAccounting', value: 'yes' }
    - { key: 'CPUAccounting', value: 'yes' }
  become: true
  notify: reload_systemd
  tags:
    - cis_level_2
    - cis_5_4_3
    - stig_v_230226
    - nist_ac_6
    - iso_27001_8_20
    - security
    - resources
    - remediate

- name: VERIFY | Systemd resource accounting (Zero-Tolerance)
  ansible.builtin.shell: |
    grep -q "DefaultMemoryAccounting=yes" /etc/systemd/system.conf && \
    grep -q "DefaultCPUAccounting=yes" /etc/systemd/system.conf
  become: true
  changed_when: false
  tags: [security, resources, verification]