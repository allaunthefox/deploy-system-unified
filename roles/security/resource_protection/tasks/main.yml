# =============================================================================
# Audit Event Identifier: DSU-PLY-100356
# Last Updated: 2026-02-28
# =============================================================================
---
# Tasks for security/resource_protection - DoS and Resource Exhaustion Mitigation
- name: "ISO 27001 ยง8.20 | 400002 | Validate minimum resource requirements"
  ansible.builtin.assert:
    that:
      - ansible_memtotal_mb >= resource_min_ram_mb[virt_type] | default(resource_min_ram_mb['default'])
    fail_msg: |-
      Insufficient RAM for {{ virt_type | upper }} environment.
      Required: {{ resource_min_ram_mb[virt_type] | default(resource_min_ram_mb['default']) }}MB
  tags:
    - cis_5_4_1
    - stig_v_230225
    - nist_sc_5
    - iso_27001_8_20
    - 400002
    - security
    - resources

- name: "ISO 27001 ยง8.20 | 400003 | Configure system-wide ulimits for process isolation"
  ansible.builtin.copy:
    content: |
      * soft core 0
      * hard core 0
      * soft nproc 2048
      * hard nproc 4096
      * soft nofile 8192
      * hard nofile 16384
    dest: /etc/security/limits.d/99-resource-protection.conf
    mode: '0644'
  become: true
  tags:
    - cis_5_4_2
    - stig_v_230226
    - nist_ac_6
    - iso_27001_8_20
    - 400003
    - security
    - resources
    - remediate

- name: "ISO 27001 ยง8.20 | 400004 | Enforce Systemd global resource limits"
  ansible.builtin.lineinfile:
    path: /etc/systemd/system.conf
    regexp: "^#?Default{{ item.key }}="
    line: "Default{{ item.key }}={{ item.value }}"
  loop:
    - { key: 'TasksMax', value: "{{ resource_default_tasks_max }}" }
    - { key: 'MemoryMax', value: "{{ resource_default_memory_max }}" }
    - { key: 'MemoryAccounting', value: 'yes' }
    - { key: 'CPUAccounting', value: 'yes' }
  become: true
  notify: reload_systemd
  tags:
    - cis_5_4_3
    - stig_v_230226
    - nist_ac_6
    - iso_27001_8_20
    - 400004
    - security
    - resources
    - remediate