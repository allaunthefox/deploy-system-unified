---
# Tasks for security/file_integrity role - AIDE Initialization and Monitoring
- name: Derive file integrity guards
  ansible.builtin.set_fact:
    _file_integrity_is_container: "{{ ansible_virtualization_type | default('') in ['docker', 'podman', 'container', 'lxc'] }}"
    _file_integrity_is_systemd: "{{ ansible_service_mgr | default('') == 'systemd' }}"
  changed_when: false
  tags: [security, file_integrity]

- name: Configure file integrity monitoring
  when: not _file_integrity_is_container
  tags: [security, file_integrity]
  block:
    - name: Install AIDE
      ansible.builtin.package:
        name: aide
        state: present
      become: true

    - name: Check if AIDE database already exists
      ansible.builtin.stat:
        path: /var/lib/aide/aide.db.gz
      register: aide_db_stat
      become: true

- name: "CIS 1.3.1 | ISO 27001 ยง12.2 | Action 52030 | Initialize AIDE database (Baseline - Debian/Ubuntu)"
  ansible.builtin.command: aideinit
  become: true
  tags:
    - cis_1_3_1
    - iso_27001_12_2
    - remediate
  when:
    - not aide_db_stat.stat.exists
    - not ansible_check_mode
    - ansible_facts['os_family'] == 'Debian'
    - not (is_virtualized | default(false))
  async: 600 # AIDE init can take a long time
  poll: 10

- name: "CIS 1.3.1 | ISO 27001 ยง12.2 | Action 52030 | Initialize AIDE database (Baseline - RedHat/Arch)"
  ansible.builtin.command: aide --init
  become: true
  tags:
    - cis_1_3_1
    - iso_27001_12_2
    - remediate
  when:
    - not aide_db_stat.stat.exists
    - not ansible_check_mode
    - ansible_facts['os_family'] in ['RedHat', 'Archlinux']
    - not (is_virtualized | default(false))
  async: 600 # AIDE init can take a long time
  poll: 10

- name: "CIS 1.3.2 | ISO 27001 ยง12.2 | Action 52030 | Configure AIDE cron job for daily checks"
  ansible.builtin.cron:
    name: "Daily AIDE integrity check"
    minute: "0"
    hour: "2"
    job: "aide --check | tee -a /var/log/aide/check_$(date +\\%Y\\%m\\%d).log"
    user: root
  become: true
  tags:
    - cis_1_3_2
    - iso_27001_12_2
    - remediate

    - name: Configure AIDE to check for changes on boot
      ansible.builtin.template:
        src: "aide-boot-check.service.j2"
        dest: /etc/systemd/system/aide-boot-check.service
        mode: '0644'
      become: true
      when: _file_integrity_is_systemd

    - name: Enable AIDE boot check service
      ansible.builtin.systemd:
        name: aide-boot-check.service
        enabled: true
        daemon_reload: true
      become: true
      when: _file_integrity_is_systemd and not ansible_check_mode

    - name: Skip AIDE boot check service enablement in check mode
      ansible.builtin.debug:
        msg: "Skipping AIDE boot check service enablement in check mode"
      when: ansible_check_mode and _file_integrity_is_systemd

- name: Set file integrity monitoring completion flag
  ansible.builtin.set_fact:
    security_file_integrity_complete: true
  tags: [security, file_integrity]
