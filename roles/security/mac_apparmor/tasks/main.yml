# =============================================================================
# Audit Event Identifier: DSU-PLY-100349
# Last Updated: 2026-02-28
# =============================================================================
---
# Tasks for security/mac_apparmor - Mandatory Access Control
- name: "ISO 27001 §8.26 | 440001 | Install AppArmor packages (Debian/Ubuntu)"
  ansible.builtin.package:
    name:
      - apparmor
      - apparmor-utils
      - apparmor-profiles
    state: present
  when: ansible_os_family == 'Debian'
  become: true
  tags:
    - cis_1_6_1
    - stig_v_230240
    - nist_ac_3
    - iso_27001_8_26
    - 440001
    - security
    - apparmor

- name: "ISO 27001 §8.26 | 440002 | Install AppArmor packages (Alpine)"
  ansible.builtin.package:
    name:
      - apparmor
      - apparmor-utils
    state: present
  when: ansible_os_family == 'Alpine'
  become: true
  tags:
    - cis_1_6_1
    - stig_v_230240
    - nist_ac_3
    - iso_27001_8_26
    - 440002
    - security
    - apparmor

- name: "ISO 27001 §8.26 | 440001 | Enable and start AppArmor service"
  ansible.builtin.service:
    name: apparmor
    enabled: true
    state: started
  when:
    - ansible_os_family in ['Debian', 'Alpine']
    - not (is_virtualized | default(false))
  become: true
  tags:
    - cis_1_6_2
    - stig_v_230241
    - nist_ac_3
    - iso_27001_8_26
    - 440001
    - security
    - apparmor

- name: "ISO 27001 §8.26 | 440003 | Verify Container-Specific AppArmor Profiles"
  ansible.builtin.shell:
    cmd: aa-status | grep -E "podman-default|container-default"
  register: apparmor_container_profiles
  failed_when: false
  changed_when: false
  become: true
  tags: [security, apparmor, audit, 440003]

- name: "ISO 27001 §8.26 | 440003 | Warn if container profiles are missing"
  ansible.builtin.debug:
    msg: "WARNING: Container-specific AppArmor profiles (podman-default) not detected. Layer 4 isolation is relying on generic profiles."
  when: 
    - apparmor_container_profiles.rc != 0
    - deployment_profile in ['hardened', 'production']
  tags: [security, apparmor, audit, 440003]

- name: "ISO 27001 §8.26 | 450001 | Register AppArmor Security Parameters for GRUB"
  ansible.builtin.set_fact:
    core_grub_security_params: >-
      {{
        core_grub_security_params | default([]) +
        ['apparmor=1', 'security=apparmor']
      }}
  tags:
    - cis_1_6_2
    - stig_v_230241
    - nist_ac_3
    - iso_27001_8_26
    - 450001
    - security
    - apparmor
    - remediate
  when:
    - ansible_os_family in ['Debian', 'Alpine']
    - not (is_virtualized | default(false))
