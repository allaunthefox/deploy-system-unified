---
# Tasks for security/mac_apparmor - Mandatory Access Control
- name: "CIS 1.6.1 | STIG V-230240 | NIST AC-3 | ISO 27001 ยง8.26 | Action 440001 | Install AppArmor packages (Debian/Ubuntu)"
  ansible.builtin.package:
    name:
      - apparmor
      - apparmor-utils
      - apparmor-profiles
    state: present
  when: ansible_os_family == 'Debian'
  become: true
  tags:
    - cis_1_6_1
    - stig_v_230240
    - nist_ac_3
    - iso_27001_8_26
    - security
    - apparmor

- name: "CIS 1.6.1 | STIG V-230240 | NIST AC-3 | ISO 27001 ยง8.26 | Action 440002 | Install AppArmor packages (Alpine)"
  ansible.builtin.package:
    name:
      - apparmor
      - apparmor-utils
    state: present
  when: ansible_os_family == 'Alpine'
  become: true
  tags:
    - cis_1_6_1
    - stig_v_230240
    - nist_ac_3
    - iso_27001_8_26
    - security
    - apparmor

- name: "CIS 1.6.2 | STIG V-230241 | NIST AC-3 | ISO 27001 ยง8.26 | Action 440001 | Enable and start AppArmor service"
  ansible.builtin.service:
    name: apparmor
    enabled: true
    state: started
  when:
    - ansible_os_family in ['Debian', 'Alpine']
    - not (is_virtualized | default(false))
  become: true
  tags:
    - cis_1_6_2
    - stig_v_230241
    - nist_ac_3
    - iso_27001_8_26
    - security
    - apparmor

  when:
    - ansible_os_family in ['Debian', 'Alpine']
    - not (is_virtualized | default(false))

- name: VERIFY | AppArmor is active and enforced (Zero-Tolerance)
  ansible.builtin.shell: |
    if [ -d /sys/kernel/security/apparmor ]; then
      aa-status --enabled
    else
      echo "AppArmor not supported by kernel"
      exit 1
    fi
  register: _aa_status
  failed_when: _aa_status.rc != 0
  when:
    - ansible_os_family in ['Debian', 'Alpine']
    - not (is_virtualized | default(false))
  become: true
  changed_when: false
  tags: [security, apparmor, verification]

- name: VERIFY | AppArmor has loaded profiles
  ansible.builtin.shell: aa-status | grep -q "profiles are loaded"
  register: _aa_profiles
  failed_when: _aa_profiles.rc != 0
  when:
    - ansible_os_family in ['Debian', 'Alpine']
    - not (is_virtualized | default(false))
  become: true
  changed_when: false
  tags: [security, apparmor, verification]
