---
# Tasks for security/mac_apparmor - Mandatory Access Control
- name: Install AppArmor packages (Debian/Ubuntu)
  ansible.builtin.package:
    name:
      - apparmor
      - apparmor-utils
      - apparmor-profiles
    state: present
  when: ansible_os_family == 'Debian'
  become: true

- name: Install AppArmor packages (Alpine)
  ansible.builtin.package:
    name:
      - apparmor
      - apparmor-utils
    state: present
  when: ansible_os_family == 'Alpine'
  become: true

- name: "ISO 27001 ยง8.26 | Action 440001 | Enable and start AppArmor service"
  ansible.builtin.service:
    name: apparmor
    enabled: true
    state: started
  when:
    - ansible_os_family in ['Debian', 'Alpine']
    - not (is_virtualized | default(false))
  become: true
  tags:
    - iso_27001_8_26
    - security
    - apparmor

- name: "ISO 27001 ยง8.26 | Action 450001 | Register AppArmor Security Parameters for GRUB"
  ansible.builtin.set_fact:
    core_grub_security_params: >-
      {{
        core_grub_security_params | default([]) +
        ['apparmor=1', 'security=apparmor']
      }}
  tags:
    - iso_27001_8_26
    - security
    - apparmor
    - remediate
  when:
    - ansible_os_family in ['Debian', 'Alpine']
    - not (is_virtualized | default(false))
