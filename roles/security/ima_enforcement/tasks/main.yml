# =============================================================================
# Audit Event Identifier: DSU-PLY-110051
# Playbook Type: Kernel Security Role
# Last Updated: 2026-02-28
# Version: 1.0
# =============================================================================
---
# Tasks for security/ima_enforcement - Runtime Binary Integrity
# NIST SI-7 | ISO 27001 ยง8.15 
# is governed by the GPLv2 License. See: https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/security/integrity/ima

- name: "INTEGRITY | Detect Virtualization Environment"
  ansible.builtin.set_fact:
    _ima_is_container: "{{ (ansible_virtualization_type | default('unknown') in ['docker', 'podman', 'container', 'lxc']) or (ansible_is_chroot | default(false)) }}"
  tags: [security, ima, internal]

- name: "INTEGRITY | Register IMA Kernel Parameters for GRUB"
  ansible.builtin.set_fact:
    core_grub_security_params: >-
      {{
        core_grub_security_params | default([]) +
        [
          'ima_policy=' ~ ima_policy,
          'ima_appraise=' ~ ima_appraise_mode,
          'ima_template=' ~ ima_template
        ]
      }}
  when: 
    - ima_enabled | bool
    - not _ima_is_container
  tags: [security, ima, kernel]

- name: "INTEGRITY | Install IMA/EVM utilities"
  ansible.builtin.package:
    name: ima-evm-utils
    state: present
  become: true
  when: 
    - ima_enabled | bool
    - not _ima_is_container
  tags: [security, ima, packages]

- name: "INTEGRITY | Ensure IMA policy directory exists"
  ansible.builtin.file:
    path: /etc/ima
    state: directory
    mode: '0755'
    owner: root
    group: root
  become: true
  when: 
    - ima_enabled | bool
    - not _ima_is_container
  tags: [security, ima]

- name: "INTEGRITY | Deploy IMA appraisal policy"
  ansible.builtin.template:
    src: ima-policy.j2
    dest: /etc/ima/ima-policy
    mode: '0644'
    owner: root
    group: root
  become: true
  when: 
    - ima_enabled | bool
    - not _ima_is_container
  tags: [security, ima, policy]

- name: "INTEGRITY | Ensure key directory exists"
  ansible.builtin.file:
    path: "{{ ima_key_dir }}"
    state: directory
    mode: '0700'
    owner: root
    group: root
  become: true
  when: 
    - ima_enabled | bool
    - not _ima_is_container
  tags: [security, ima, keys]

- name: "INTEGRITY | Deploy IMA key rotation script"
  ansible.builtin.template:
    src: ima-rotate-keys.sh.j2
    dest: "{{ ima_key_rotation_script }}"
    mode: '0700'
    owner: root
    group: root
  become: true
  when: 
    - ima_enabled | bool
    - not _ima_is_container
  tags: [security, ima, automation]

- name: "INTEGRITY | Perform initial IMA key generation and signing"
  ansible.builtin.command:
    cmd: "{{ ima_key_rotation_script }}"
    creates: "{{ ima_private_key }}"
  become: true
  when: 
    - ima_enabled | bool
    - not _ima_is_container
    - not ansible_check_mode
  tags: [security, ima, keys]

- name: "INTEGRITY | Deploy IMA rotation systemd service"
  ansible.builtin.template:
    src: ima-rotate.service.j2
    dest: /etc/systemd/system/ima-rotate.service
    mode: '0644'
  become: true
  when: 
    - ima_enabled | bool
    - not _ima_is_container
    - ima_key_rotation_enabled | bool
  tags: [security, ima, automation]

- name: "INTEGRITY | Deploy IMA rotation systemd timer"
  ansible.builtin.template:
    src: ima-rotate.timer.j2
    dest: /etc/systemd/system/ima-rotate.timer
    mode: '0644'
  become: true
  when: 
    - ima_enabled | bool
    - not _ima_is_container
    - ima_key_rotation_enabled | bool
  tags: [security, ima, automation]

- name: "INTEGRITY | Enable and start IMA key rotation timer"
  ansible.builtin.systemd:
    name: ima-rotate.timer
    state: started
    enabled: true
    daemon_reload: true
  become: true
  when: 
    - ima_enabled | bool
    - not _ima_is_container
    - ima_key_rotation_enabled | bool
    - not ansible_check_mode
  tags: [security, ima, automation]

- name: "SIEM | Ensure auditd is configured to capture IMA events"
  ansible.builtin.copy:
    dest: /etc/audit/rules.d/99-ima.rules
    content: |
      # IMA Integrity Monitoring Rules (NIST AU-12)
      -a always,exit -F arch=b64 -S all -F type=AUDIT_INTEGRITY_DATA -k ima_data
      -a always,exit -F arch=b64 -S all -F type=AUDIT_INTEGRITY_METADATA -k ima_metadata
      -a always,exit -F arch=b64 -S all -F type=AUDIT_INTEGRITY_STATUS -k ima_status
      -a always,exit -F arch=b64 -S all -F type=AUDIT_INTEGRITY_HASH -k ima_hash
      -a always,exit -F arch=b64 -S all -F type=AUDIT_INTEGRITY_PCR -k ima_pcr
      -a always,exit -F arch=b64 -S all -F type=AUDIT_INTEGRITY_RULE -k ima_rule
    mode: '0600'
  become: true
  notify: restart_auditd
  when: 
    - ima_enabled | bool
    - not _ima_is_container
  tags: [security, ima, siem, audit]

- name: VERIFY | IMA is active in kernel (Zero-Tolerance)
  ansible.builtin.shell: |
    grep -q "ima" /proc/cmdline
  register: _ima_cmdline
  failed_when: _ima_cmdline.rc != 0
  become: true
  when: 
    - ima_enabled | bool
    - not _ima_is_container
    - not ansible_check_mode
  changed_when: false
  tags: [security, ima, verification]
