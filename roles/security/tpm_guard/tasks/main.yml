# =============================================================================
# Audit Event Identifier: DSU-PLY-100246
# Last Updated: 2026-02-28
# =============================================================================
---
# Tasks for security/tpm_guard - Hardware Root of Trust Watchdog
# NIST SI-7 | ISO 27001 ยง8.15 | Audit Code 800510

- name: "NIST SI-7 | Audit Code 800510 | Check for TPM device"
  ansible.builtin.stat:
    path: /dev/tpm0
  register: tpm_device
  tags: [security, tpm, hardware]

- name: "NIST SI-7 | Audit Code 800510 | Install TPM tools"
  ansible.builtin.package:
    name: tpm2-tools
    state: present
  become: true
  when: tpm_device.stat.exists
  tags: [security, tpm, hardware]

- name: "NIST SI-7 | Audit Code 800510 | Create Integrity Purge Script"
  ansible.builtin.copy:
    dest: /usr/local/bin/dsu-integrity-purge
    mode: '0700'
    owner: root
    group: root
    content: |
      #!/bin/bash
      # DSU Integrity Purge Script
      # Wipes secrets and isolates host upon integrity failure
      
      logger -p authpriv.emerg "CRITICAL: TPM INTEGRITY FAILURE DETECTED. INITIATING PURGE PROTOCOL."
      
      {% if tpm_guard_wipe_secrets %}
      echo "WIPING SECRETS..."
      # Force unmount tmpfs - data is instantly lost
      umount -f {{ tpm_guard_secrets_path }} || rm -rf {{ tpm_guard_secrets_path }}/*
      {% endif %}
      
      {% if tpm_guard_isolate_network %}
      echo "ISOLATING NETWORK..."
      # Drop all traffic
      iptables -P INPUT DROP
      iptables -P OUTPUT DROP
      iptables -F
      ip link set eth0 down 2>/dev/null || true
      {% endif %}
      
      {% if tpm_guard_purge_kernel %}
      echo "PURGING KERNEL..."
      echo c > /proc/sysrq-trigger
      {% endif %}
  become: true
  when: tpm_guard_enabled | bool
  tags: [security, tpm, purge]

- name: "NIST SI-7 | Audit Code 800510 | Create TPM Integrity Watchdog Script"
  ansible.builtin.copy:
    dest: /usr/local/bin/dsu-tpm-watchdog
    mode: '0700'
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -e
      # Simple check: Can we read the PCRs?
      # In a real scenario, we would compare against a sealed "Golden State"
      if ! tpm2_pcrread > /dev/null 2>&1; then
          /usr/local/bin/dsu-integrity-purge
      fi
  become: true
  when: tpm_guard_enabled | bool
  tags: [security, tpm, watchdog]

- name: "NIST SI-7 | Audit Code 800510 | Create TPM Watchdog Service"
  ansible.builtin.copy:
    dest: /etc/systemd/system/dsu-tpm-watchdog.service
    content: |
      [Unit]
      Description=DSU TPM Integrity Watchdog
      
      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/dsu-tpm-watchdog
  become: true
  when: tpm_guard_enabled | bool
  tags: [security, tpm, watchdog]

- name: "NIST SI-7 | Audit Code 800510 | Create TPM Watchdog Timer"
  ansible.builtin.copy:
    dest: /etc/systemd/system/dsu-tpm-watchdog.timer
    content: |
      [Unit]
      Description=Run DSU TPM Watchdog periodically
      
      [Timer]
      OnBootSec=1min
      OnUnitActiveSec={{ tpm_guard_interval }}
      
      [Install]
      WantedBy=timers.target
  become: true
  when: tpm_guard_enabled | bool
  tags: [security, tpm, watchdog]

- name: "NIST SI-7 | Audit Code 800510 | Enable TPM Watchdog"
  ansible.builtin.systemd:
    name: dsu-tpm-watchdog.timer
    enabled: true
    state: started
    daemon_reload: true
  become: true
  when: 
    - tpm_guard_enabled | bool
    - tpm_device.stat.exists
  tags: [security, tpm, watchdog]

- name: VERIFY | TPM Guard Active (Zero-Tolerance)
  ansible.builtin.shell: systemctl is-active dsu-tpm-watchdog.timer
  register: _tpm_timer
  failed_when: _tpm_timer.rc != 0
  become: true
  when: 
    - tpm_guard_enabled | bool
    - tpm_device.stat.exists
  changed_when: false
  tags: [security, tpm, verification]
