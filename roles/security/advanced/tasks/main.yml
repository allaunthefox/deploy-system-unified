---
# Advanced security hardening with secure patterns for security/advanced role
# - name: Validate advanced security hardening prerequisites (idempotent)
#   ansible.builtin.assert:
#     that:
#       - advanced_security_hardening_enabled | default(false)
#     msg: "Advanced security hardening not enabled - skipping configuration"
- name: "CIS 5.2.1 | STIG V-230220 | NIST IA-5 | ISO 27001 §9.2 | Action 400001 | Set effective SSH port to randomized value (idempotent)"
  ansible.builtin.set_fact:
    ssh_effective_port: "{{ advanced_security_hardening_random_ssh_port }}"
  when:
    - ssh_randomize_port | bool
    - advanced_security_hardening_random_ssh_port is defined
  tags:
    - cis_5_2_1
    - stig_v_230220
    - nist_ia_5
    - iso_27001_9_2
    - security
    - advanced
    - ssh
- name: "CIS 5.2.1 | STIG V-230220 | NIST IA-5 | ISO 27001 §9.2 | Action 400001 | Update SSH configuration with random port (idempotent)"
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^Port '
    line: "Port {{ ssh_effective_port | default(advanced_security_hardening_random_ssh_port) | default(system_ssh_port) | default(22) }}"
    validate: '/usr/sbin/sshd -t -f %s'
  when:
    - ssh_randomize_port | bool
    - advanced_security_hardening_random_ssh_port is defined
  become: true
  notify: 'restart_sshd'
  no_log: true
  tags:
    - cis_5_2_1
    - stig_v_230220
    - nist_ia_5
    - iso_27001_9_2
    - security
    - advanced
    - ssh
    - remediate

- name: "CIS 5.2.1 | ISO 27001 §9.2 | Action 400002 | Update firewall for randomized SSH port (CRITICAL - prevents lockout)"
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    destination_port: "{{ ssh_effective_port | default(advanced_security_hardening_random_ssh_port) }}"
    source: "0.0.0.0/0"
    jump: ACCEPT
    comment: "SSH randomized port (auto-added by security/advanced role)"
    state: present
  when:
    - ssh_randomize_port | bool
    - advanced_security_hardening_random_ssh_port is defined
  become: true
  notify: 'save_firewall_rules'
  tags:
    - cis_5_2_1
    - iso_27001_9_2
    - security
    - advanced
    - ssh
    - firewall
    - critical

- name: "CIS 5.2.4 | STIG V-230221 | NIST IA-5 | ISO 27001 §10.1 | Action 540201 | Enable SSH key rotation if enabled (idempotent)"
  ansible.builtin.debug:
    msg: "SSH key rotation is enabled and will rotate keys every {{ ssh_key_rotation_interval_days }} days"
  when: ssh_key_rotation_enabled | bool
  tags:
    - cis_5_2_4
    - stig_v_230221
    - nist_ia_5
    - iso_27001_10_1
    - security
    - advanced

- name: "CIS 5.2.4 | STIG V-230221 | NIST IA-5 | ISO 27001 §10.1 | Action 540202 | Schedule SSH key rotation task (idempotent)"
  ansible.builtin.cron:
    name: "Rotate SSH host keys"
    minute: "0"
    hour: "2"
    day: "*/{{ ssh_key_rotation_interval_days }}"
    job: "/usr/local/bin/rotate_ssh_keys.sh"
    state: present
  when: ssh_key_rotation_enabled | bool
  tags:
    - cis_5_2_4
    - stig_v_230221
    - nist_ia_5
    - iso_27001_10_1
    - security
    - advanced
    - remediate

- name: "CIS 5.2.4 | STIG V-230221 | NIST IA-5 | ISO 27001 §10.1 | Action 540203 | Create SSH key rotation script with secure permissions (idempotent)"
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      # Script to rotate SSH host keys securely
      # Backup current keys
      backup_dir="/etc/ssh/backup/$(date +%Y%m%d_%H%M%S)"
      mkdir -p "$backup_dir"
      cp /etc/ssh/ssh_host_* "$backup_dir/" 2>/dev/null || true
      # Remove old keys
      rm -f /etc/ssh/ssh_host_*
      # Generate new keys with secure permissions
      if command -v dpkg-reconfigure >/dev/null 2>&1; then
        dpkg-reconfigure openssh-server 2>/dev/null || {
          ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key -N "" -C "Generated by Deploy-System-Unified"
          ssh-keygen -t ecdsa -b 256 -f /etc/ssh/ssh_host_ecdsa_key -N "" -C "Generated by Deploy-System-Unified"
          ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N "" -C "Generated by Deploy-System-Unified"
        }
      else
        ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key -N "" -C "Generated by Deploy-System-Unified"
        ssh-keygen -t ecdsa -b 256 -f /etc/ssh/ssh_host_ecdsa_key -N "" -C "Generated by Deploy-System-Unified"
        ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N "" -C "Generated by Deploy-System-Unified"
      fi
      # Set proper permissions
      chmod 600 /etc/ssh/ssh_host_*
      chmod 644 /etc/ssh/ssh_host_*.pub
      # Restart SSH service
      systemctl 'restart_sshd'
    dest: /usr/local/bin/rotate_ssh_keys.sh
    mode: '0700'
    owner: root
    group: root
  when: ssh_key_rotation_enabled | bool
  tags:
    - cis_5_2_4
    - stig_v_230221
    - nist_ia_5
    - iso_27001_10_1
    - security
    - advanced
    - remediate
