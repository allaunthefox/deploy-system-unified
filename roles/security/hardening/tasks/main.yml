---
# Security hardening role - Enhanced core security configurations
# Note: Firewalls are managed by networking/firewall
# Note: Updates are managed by core/updates
# Note: IPS/Fail2Ban is managed by security/ips
# Note: Audit Integrity is managed by security/audit_integrity

- name: Ensure security-related packages are installed (Debian/Ubuntu)
  ansible.builtin.apt:
    name:
      - libpam-tmpdir
      - auditd
    state: present
  when: ansible_facts['os_family'] == 'Debian'
  become: true
  tags:
    - cis_1_1_1
    - stig_v_230217
    - nist_cm_6
    - security
    - hardening

- name: Ensure security-related packages are installed (RedHat/CentOS)
  ansible.builtin.dnf:
    name:
      - audit
    state: present
  when: ansible_facts['os_family'] == 'RedHat'
  become: true
  tags:
    - cis_1_1_1
    - stig_v_230217
    - nist_cm_6
    - security
    - hardening

- name: Ensure security-related packages are installed (Arch Linux)
  community.general.pacman:
    name:
      - audit
    state: present
  when: ansible_distribution == 'Archlinux'
  become: true
  tags:
    - cis_1_1_1
    - stig_v_230217
    - nist_cm_6
    - security
    - hardening

- name: Ensure security-related packages are installed (Alpine)
  community.general.apk:
    name:
      - audit
    state: present
  when: ansible_os_family == 'Alpine'
  become: true
  tags:
    - cis_1_1_1
    - stig_v_230217
    - nist_cm_6
    - security
    - hardening

- name: Configure auditd service
  ansible.builtin.systemd:
    name: auditd
    enabled: true
    state: started
  become: true
  when:
    - ansible_facts['service_mgr'] == 'systemd'
    - not (is_virtualized | default(false))
  tags:
    - cis_4_1_1
    - cis_4_1_2
    - stig_v_230250
    - nist_au_2
    - nist_au_4
    - security
    - audit

- name: "CIS 1.1.1 | STIG V-230217 | ISO 27001 ยง8.8 | NIST CM-2 | NIST CM-6 | NIST SC-28 | Action 600113 | Harden file system permissions"
  block:
    - name: Set secure permissions on sensitive files
      ansible.builtin.file:
        path: "{{ item.path }}"
        mode: "{{ item.mode }}"
        owner: root
        group: root
      loop:
        - { path: '/etc/shadow', mode: '0600' }
        - { path: '/etc/passwd', mode: '0644' }
        - { path: '/etc/group', mode: '0644' }
        - { path: '/etc/sudoers', mode: '0440' }
        - { path: '/etc/ssh', mode: '0755' }
        - { path: '/etc/ssh/sshd_config', mode: '0644' }
      become: true

    - name: VERIFY | Sensitive file permissions (Zero-Tolerance)
      ansible.builtin.stat:
        path: "{{ item.path }}"
      register: _file_stat
      loop:
        - { path: '/etc/shadow', mode: '0600' }
        - { path: '/etc/passwd', mode: '0644' }
        - { path: '/etc/group', mode: '0644' }
        - { path: '/etc/sudoers', mode: '0440' }
        - { path: '/etc/ssh', mode: '0755' }
        - { path: '/etc/ssh/sshd_config', mode: '0644' }
      failed_when: 
        - "_file_stat.stat.mode != item.mode"
        - "_file_stat.stat.pw_name != 'root'"

    - name: Set sticky bit on world-writable directories
      ansible.builtin.shell: |
        set -o pipefail
        find / -type d -perm -0002 ! -perm -1000 ! -path '/proc*' ! -path '/sys*' ! -path '/dev*' ! -path '/run*' -exec chmod +t {} \; -print | wc -l
      args:
        executable: /bin/bash
      become: true
      register: sticky_result
      changed_when: (sticky_result.stdout | default('0') | trim | int) > 0

    - name: VERIFY | World-writable sticky bit (Zero-Tolerance)
      ansible.builtin.shell: |
        set -o pipefail
        find / -type d -perm -0002 ! -perm -1000 ! -path '/proc*' ! -path '/sys*' ! -path '/dev*' ! -path '/run*' | wc -l
      args:
        executable: /bin/bash
      become: true
      register: _sticky_check
      failed_when: (_sticky_check.stdout | trim | int) > 0
  tags:
    - cis_1_1_1
    - stig_v_230217
    - iso_27001_8_8
    - nist_cm_2
    - nist_cm_6
    - nist_sc_28
    - remediate
    - high_severity
    - security

- name: "CIS 1.1.8 | CIS 2.1.13 | STIG V-230218 | ISO 27001 ยง9.2 | NIST IA-2 | NIST IA-5 | Action 510003 | Harden user accounts"
  block:
    - name: Lock system accounts that should not login
      ansible.builtin.user:
        name: "{{ item }}"
        password_lock: true
      loop:
        - bin
        - daemon
        - adm
        - lp
        - sync
        - shutdown
        - halt
        - mail
        - uucp
        - operator
        - games
        - gopher
        - ftp
        - nobody
        - systemd-network
        - systemd-resolve
      become: true
    - name: Set password aging limits
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: '^{{ item.regex }}'
        line: '{{ item.line }}'
      become: true
      loop:
        - { regex: 'PASS_MIN_DAYS', line: 'PASS_MIN_DAYS   7' }
        - { regex: 'PASS_MAX_DAYS', line: 'PASS_MAX_DAYS   90' }
        - { regex: 'PASS_WARN_AGE', line: 'PASS_WARN_AGE   7' }
    - name: Set inactive password lock (CIS 5.3.4)
      ansible.builtin.lineinfile:
        path: /etc/default/useradd
        regexp: '^INACTIVE='
        line: 'INACTIVE=30'
      become: true
  tags:
    - cis_1_1_8
    - cis_level_2
    - cis_2_1_13
    - cis_level_2
    - cis_5_3_1
    - cis_level_2
    - cis_5_3_2
    - cis_level_2
    - cis_5_3_3
    - cis_5_4_1
    - stig_v_230218
    - stig_v_230219
    - stig_v_230220
    - iso_27001_9_2
    - nist_ia_2
    - nist_ia_5
    - nist_ac_2
    - remediate
    - medium_severity
    - security

- name: "CIS 5.3.6 | STIG V-230221 | NIST AC-7 | NIST IA-5 | Configure account lockout (pam_faillock)"
  block:
    - name: Configure pam_faillock for Debian/Ubuntu
      ansible.builtin.lineinfile:
        path: /etc/pam.d/common-auth
        regexp: '^auth.*pam_faillock.so'
        line: 'auth required pam_faillock.so deny=3 unlock_time=600 fail_interval=900'
        insertafter: '^auth'
      become: true
      when: ansible_facts['os_family'] == 'Debian'

    - name: VERIFY | pam_faillock is configured (Debian/Ubuntu)
      ansible.builtin.shell: grep -q "pam_faillock.so deny=3 unlock_time=600 fail_interval=900" /etc/pam.d/common-auth
      become: true
      when: ansible_facts['os_family'] == 'Debian'
      changed_when: false

    - name: Configure pam_faillock for RHEL/CentOS
      ansible.builtin.lineinfile:
        path: /etc/pam.d/password-auth
        regexp: '^auth.*pam_faillock.so'
        line: 'auth required pam_faillock.so deny=3 unlock_time=600 fail_interval=900'
        insertafter: '^auth'
      become: true
      when: ansible_facts['os_family'] == 'RedHat'

    - name: Configure pam_faillock for RHEL/CentOS system-auth
      ansible.builtin.lineinfile:
        path: /etc/pam.d/system-auth
        regexp: '^auth.*pam_faillock.so'
        line: 'auth required pam_faillock.so deny=3 unlock_time=600 fail_interval=900'
        insertafter: '^auth'
      become: true
      when: ansible_facts['os_family'] == 'RedHat'

    - name: VERIFY | pam_faillock is configured (RHEL/CentOS)
      ansible.builtin.shell: |
        grep -q "pam_faillock.so deny=3 unlock_time=600 fail_interval=900" /etc/pam.d/password-auth && \
        grep -q "pam_faillock.so deny=3 unlock_time=600 fail_interval=900" /etc/pam.d/system-auth
      become: true
      when: ansible_facts['os_family'] == 'RedHat'
      changed_when: false
  tags:
    - cis_level_2
    - cis_5_3_6
    - stig_v_230221
    - nist_ac_7
    - nist_ia_5
    - security
    - hardening
    - remediate

- name: "CIS 1.1.2 | CIS 1.1.3 | CIS 1.1.4 | CIS 1.1.5 | CIS 1.1.6 | CIS 1.1.7 | CIS 1.1.8 | STIG V-230222 | NIST CM-6 | NIST SC-28 | Disable unused filesystems"
  block:
    - name: Create modprobe blacklist configuration for unused filesystems
      ansible.builtin.copy:
        dest: /etc/modprobe.d/blacklist-unused-filesystems.conf
        content: |
          # Disable unused filesystems per CIS 1.1.x
          # CIS 1.1.2 - UDF filesystem
          install udf /bin/true
          blacklist udf
          # CIS 1.1.3 - cramfs filesystem
          install cramfs /bin/true
          blacklist cramfs
          # CIS 1.1.4 - freevxfs filesystem
          install freevxfs /bin/true
          blacklist freevxfs
          # CIS 1.1.5 - jffs2 filesystem
          install jffs2 /bin/true
          blacklist jffs2
          # CIS 1.1.6 - hfs filesystem
          install hfs /bin/true
          blacklist hfs
          # CIS 1.1.7 - hfsplus filesystem
          install hfsplus /bin/true
          blacklist hfsplus
          # CIS 1.1.8 - squashfs filesystem
          install squashfs /bin/true
          blacklist squashfs
        mode: '0644'
      become: true

    - name: VERIFY | Unused filesystems are blacklisted
      ansible.builtin.shell: |
        for fs in udf cramfs freevxfs jffs2 hfs hfsplus squashfs; do
          if lsmod | grep -q "^$fs"; then
            echo "$fs is still loaded"
            exit 1
          fi
        done
      become: true
      changed_when: false
  tags:
    - cis_1_1_2
    - cis_1_1_3
    - cis_1_1_4
    - cis_1_1_5
    - cis_1_1_6
    - cis_1_1_7
    - cis_1_1_8
    - stig_v_230222
    - nist_cm_6
    - nist_sc_28
    - security
    - kernel

- name: "CIS 2.1.1 | CIS 2.1.2 | CIS 2.1.3 | CIS 2.1.4 | CIS 2.1.5 | CIS 2.1.6 | CIS 2.1.7 | CIS 2.1.8 | CIS 2.1.9 | CIS 2.1.10 | CIS 2.1.11 | CIS 2.1.12 | CIS 2.1.13 | STIG V-230223 | NIST CM-7 | Remove unnecessary packages"
  block:
    - name: Remove unnecessary packages (Debian/Ubuntu)
      ansible.builtin.apt:
        name:
          - xorg
          - avahi-daemon
          - isc-dhcp-server
          - bind9
          - vsftpd
          - samba
          - squid
          - dovecot-imapd
          - dovecot-pop3d
          - nfs-kernel-server
          - rpcbind
          - tftp-hpa
          - telnetd
          - snmpd
          - nis
        state: absent
        purge: true
      become: true
      when: ansible_facts['os_family'] == 'Debian'

    - name: Remove unnecessary packages (RedHat/CentOS)
      ansible.builtin.dnf:
        name:
          - xorg-x11-server-Xorg
          - avahi
          - dhcp-server
          - bind
          - vsftpd
          - samba
          - squid
          - dovecot
          - nfs-utils
          - rpcbind
          - tftp
          - telnet-server
          - snmp
          - ypbind
          - nis
        state: absent
      become: true
      when: ansible_facts['os_family'] == 'RedHat'

    - name: VERIFY | Unnecessary packages are removed (Zero-Tolerance)
      ansible.builtin.shell: |
        set -o pipefail
        if command -v dpkg >/dev/null 2>&1; then
          dpkg -l xorg avahi-daemon isc-dhcp-server bind9 vsftpd samba squid dovecot-imapd dovecot-pop3d nfs-kernel-server rpcbind tftp-hpa telnetd snmpd nis 2>&1 | grep -E "^ii" | wc -l
        elif command -v rpm >/dev/null 2>&1; then
          rpm -q xorg-x11-server-Xorg avahi dhcp-server bind vsftpd samba squid dovecot nfs-utils rpcbind tftp telnet-server snmp ypbind nis 2>&1 | grep -v "not installed" | wc -l
        else
          echo "0"
        fi
      register: _pkg_check
      failed_when: (_pkg_check.stdout | trim | int) > 0
      become: true
      changed_when: false
  tags:
    - cis_level_2
    - cis_2_1_1
    - cis_level_2
    - cis_2_1_2
    - cis_level_2
    - cis_2_1_3
    - cis_level_2
    - cis_2_1_4
    - cis_level_2
    - cis_2_1_5
    - cis_level_2
    - cis_2_1_6
    - cis_level_2
    - cis_2_1_7
    - cis_level_2
    - cis_2_1_8
    - cis_level_2
    - cis_2_1_9
    - cis_level_2
    - cis_2_1_10
    - cis_level_2
    - cis_2_1_11
    - cis_level_2
    - cis_2_1_12
    - cis_level_2
    - cis_2_1_13
    - stig_v_230223
    - nist_cm_7
    - security
    - hardening
    - remediate

- name: "CIS 6.1.1 | NIST CM-3 | NIST CM-8 | NIST SC-4 | NIST IA-5 | Harden PAM configuration (Debian)"
  block:
    - name: Configure PAM hardening parameters (Debian)
      ansible.builtin.lineinfile:
        path: "{{ item.path }}"
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { path: '/etc/pam.d/common-password', regexp: '^password.*pam_unix.so', line: 'password        [success=1 default=ignore]      pam_unix.so obscure sha512 rounds=65536' }
        - { path: '/etc/pam.d/common-session', regexp: '^session.*pam_tmpdir.so', line: 'session optional        pam_tmpdir.so' }
      become: true
      when: ansible_facts['os_family'] == 'Debian'

    - name: VERIFY | PAM hardening parameters (Debian)
      ansible.builtin.shell: |
        grep -q "pam_unix.so obscure sha512 rounds=65536" /etc/pam.d/common-password && \
        grep -q "pam_tmpdir.so" /etc/pam.d/common-session
      become: true
      when: ansible_facts['os_family'] == 'Debian'
      changed_when: false
  tags:
    - cis_level_2
    - cis_6_1_1
    - nist_cm_3
    - nist_cm_8
    - nist_sc_4
    - nist_ia_5
    - security
    - hardening

- name: "CIS 8.1.2 | NIST AC-18 | NIST SC-18 | Disable wireless interfaces"
  block:
    - name: Down all wireless interfaces
      ansible.builtin.shell: |
        set -o pipefail
        for iface in $(iw dev 2>/dev/null | grep -i interface | awk '{print $2}'); do
          ip link set "$iface" down 2>/dev/null || true
        done
      args:
        executable: /bin/bash
      become: true
      changed_when: false

    - name: VERIFY | Wireless interfaces are down (Zero-Tolerance)
      ansible.builtin.shell: |
        set -o pipefail
        if command -v iw >/dev/null 2>&1; then
          iw dev 2>/dev/null | grep -i interface | awk '{print $2}' | while read iface; do
            if ip link show "$iface" | grep -q "UP"; then
              echo "$iface is still UP"
              exit 1
            fi
          done
        fi
      args:
        executable: /bin/bash
      become: true
      changed_when: false
  tags:
    - cis_level_2
    - cis_8_1_2
    - nist_ac_18
    - nist_sc_18
    - security
    - hardening

- name: "CIS Level 2 | Action 600117 | Apply sysctl hardening parameters"
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value | string }}"
    state: present
    sysctl_file: /etc/sysctl.d/99-hardened.conf
    reload: true
  loop: "{{ hardening_sysctl_params | dict2items }}"
  become: true
  tags:
    - cis_level_2
    - security
    - hardening

- name: "CIS 1.7.1 | CIS 1.7.2 | Action 600114 | Configure login banners"
  ansible.builtin.copy:
    dest: "{{ item }}"
    content: |
      ******************************************************************************
      *                                                                            *
      *                       Authorized Use Only                                  *
      *                                                                            *
      *  This system is for the use of authorized users only. Individuals using    *
      *  this computer system without authority, or in excess of their             *
      *  authority, are subject to having all of their activities on this system   *
      *  monitored and recorded by system personnel.                               *
      *                                                                            *
      ******************************************************************************
    mode: '0644'
    owner: root
    group: root
  loop:
    - /etc/issue
    - /etc/issue.net
  become: true
  tags:
    - cis_1_7_1
    - cis_1_7_2
    - security
    - hardening

- name: "CIS 5.1.8 | CIS 5.1.9 | Action 600115 | Configure cron and at allow files"
  block:
    - name: Ensure cron.allow and at.allow exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: touch
        mode: '0640'
        owner: root
        group: root
      loop:
        - /etc/cron.allow
        - /etc/at.allow
      become: true

    - name: Ensure cron.deny and at.deny are absent
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/cron.deny
        - /etc/at.deny
      become: true
  tags:
    - cis_5_1_8
    - cis_5_1_9
    - security
    - hardening

- name: "CIS 5.5 | Action 600116 | Ensure root account is locked"
  ansible.builtin.user:
    name: root
    password_lock: true
  become: true
  tags:
    - cis_5_5
    - security
    - hardening

- name: Set security hardening completion flag
  ansible.builtin.set_fact:
    security_hardening_complete: true
  tags:
    - security
    - hardening
