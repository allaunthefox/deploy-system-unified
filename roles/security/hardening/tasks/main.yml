# =============================================================================
# Audit Event Identifier: DSU-PLY-100321
# Last Updated: 2026-03-01
# =============================================================================
---
# Security hardening role - Enhanced core security configurations
# Note: Firewalls are managed by networking/firewall
# Note: Updates are managed by core/updates
# Note: IPS/Fail2Ban is managed by security/ips
# Note: Audit Integrity is managed by security/audit_integrity

- name: "ISO 27001 §8.19 | 530000 | CIS 1.1.1 | STIG V-230217 | NIST CM-6 | Ensure security-related packages are installed (Debian/Ubuntu)"
  ansible.builtin.apt:
    name:
      - libpam-tmpdir
      - auditd
    state: present
  when: ansible_facts['os_family'] == 'Debian'
  become: true
  tags: [cis_1_1_1, stig_v_230217, nist_cm_6, security, hardening, deploy, 530000]

- name: "ISO 27001 §8.19 | 530000 | CIS 1.1.1 | STIG V-230217 | NIST CM-6 | Ensure security-related packages are installed (RedHat/CentOS)"
  ansible.builtin.dnf:
    name:
      - audit
    state: present
  when: ansible_facts['os_family'] == 'RedHat'
  become: true
  tags: [cis_1_1_1, stig_v_230217, nist_cm_6, security, hardening, deploy, 530000]

- name: "ISO 27001 §8.19 | 530000 | CIS 1.1.1 | STIG V-230217 | NIST CM-6 | Ensure security-related packages are installed (Arch Linux)"
  community.general.pacman:
    name:
      - audit
    state: present
  when: ansible_distribution == 'Archlinux'
  become: true
  tags: [cis_1_1_1, stig_v_230217, nist_cm_6, security, hardening, deploy, 530000]

- name: "ISO 27001 §8.19 | 530000 | CIS 1.1.1 | STIG V-230217 | NIST CM-6 | Ensure security-related packages are installed (Alpine)"
  community.general.apk:
    name:
      - audit
    state: present
  when: ansible_os_family == 'Alpine'
  become: true
  tags: [cis_1_1_1, stig_v_230217, nist_cm_6, security, hardening, deploy, 530000]

- name: "ISO 27001 §12.4 | 840040 | CIS 4.1.1 | STIG V-230250 | NIST AU-2 | Configure auditd service"
  ansible.builtin.systemd:
    name: auditd
    enabled: true
    state: started
  become: true
  when:
    - ansible_facts['service_mgr'] == 'systemd'
    - not (is_virtualized | default(false))
  tags: [cis_4_1_1, stig_v_230250, nist_au_2, security, audit, deploy, 840040]

- name: "ISO 27001 §8.8 | 600113 | CIS 1.1.1 | STIG V-230217 | NIST CM-2 | Harden file system permissions"
  block:
    - name: "ISO 9001 | 600013 | Set secure permissions on sensitive files"
      ansible.builtin.file:
        path: "{{ item.path }}"
        mode: "{{ item.mode }}"
        owner: root
        group: root
      loop:
        - { path: '/etc/shadow', mode: '0600' }
        - { path: '/etc/passwd', mode: '0644' }
        - { path: '/etc/group', mode: '0644' }
        - { path: '/etc/sudoers', mode: '0440' }
        - { path: '/etc/ssh', mode: '0755' }
        - { path: '/etc/ssh/sshd_config', mode: '0644' }
      become: true
      failed_when: false

    - name: "ISO 9001 | 600013 | Set sticky bit on world-writable directories"
      ansible.builtin.shell: |
        find / -type d -perm -0002 ! -perm -1000 ! -path '/proc*' ! -path '/sys*' ! -path '/dev*' ! -path '/run*' -exec chmod +t {} \; -print | wc -l
      args:
        executable: /bin/sh
      become: true
      register: sticky_result
      changed_when: (sticky_result.stdout | default('0') | trim | int) > 0
      failed_when: false
  tags: [cis_1_1_1, stig_v_230217, iso_27001_8_8, nist_cm_2, remediate, security, 600113]

- name: "ISO 27001 §9.2 | 510003 | CIS 1.1.8 | STIG V-230218 | NIST IA-2 | Harden user accounts"
  block:
    - name: "ISO 9001 | 600013 | Lock system accounts that should not login"
      ansible.builtin.user:
        name: "{{ item }}"
        password_lock: true
      loop: [bin, daemon, adm, lp, sync, shutdown, halt, mail, uucp, operator, games, gopher, ftp, nobody, systemd-network, systemd-resolve]
      become: true

    - name: "ISO 9001 | 600013 | Set password aging limits"
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: '^{{ item.regex }}'
        line: '{{ item.line }}'
      become: true
      loop:
        - { regex: 'PASS_MIN_DAYS', line: 'PASS_MIN_DAYS   7' }
        - { regex: 'PASS_MAX_DAYS', line: 'PASS_MAX_DAYS   90' }
        - { regex: 'PASS_WARN_AGE', line: 'PASS_WARN_AGE   14' }
  tags: [cis_1_1_8, stig_v_230218, iso_27001_9_2, nist_ia_2, remediate, security, 510003]

- name: "ISO 27001 §9.2 | 510003 | CIS 5.3.6 | STIG V-230221 | NIST AC-7 | Configure account lockout (pam_faillock)"
  block:
    - name: "ISO 9001 | 600013 | Configure pam_faillock for Debian/Ubuntu"
      ansible.builtin.lineinfile:
        path: /etc/pam.d/common-auth
        regexp: '^auth.*pam_faillock.so'
        line: 'auth required pam_faillock.so deny=3 unlock_time=600 fail_interval=900'
        insertafter: '^auth'
      become: true
      when: ansible_facts['os_family'] == 'Debian'
      failed_when: false

    - name: "ISO 9001 | 600013 | Configure pam_faillock for RHEL/CentOS"
      ansible.builtin.lineinfile:
        path: /etc/pam.d/password-auth
        regexp: '^auth.*pam_faillock.so'
        line: 'auth required pam_faillock.so deny=3 unlock_time=600 fail_interval=900'
        insertafter: '^auth'
      become: true
      when: ansible_facts['os_family'] == 'RedHat'
      failed_when: false
  tags: [cis_5_3_6, stig_v_230221, nist_ac_7, security, hardening, remediate, 510003]

- name: "ISO 27001 §8.26 | 700001 | CIS 1.1.2 | STIG V-230222 | NIST CM-6 | Disable unused filesystems"
  ansible.builtin.copy:
    dest: /etc/modprobe.d/blacklist-unused-filesystems.conf
    content: |
      # Disable unused filesystems per CIS 1.1.x
      install udf /bin/true
      blacklist udf
      install cramfs /bin/true
      blacklist cramfs
      install freevxfs /bin/true
      blacklist freevxfs
      install jffs2 /bin/true
      blacklist jffs2
      install hfs /bin/true
      blacklist hfs
      install hfsplus /bin/true
      blacklist hfsplus
      install squashfs /bin/true
      blacklist squashfs
    mode: '0644'
  become: true
  failed_when: false
  tags: [cis_1_1_2, stig_v_230222, nist_cm_6, security, kernel, 700001]

- name: "ISO 27001 §8.19 | 530000 | CIS 2.1.1 | STIG V-230223 | NIST CM-7 | Remove unnecessary packages"
  block:
    - name: "ISO 9001 | 600013 | Remove unnecessary packages (Debian/Ubuntu)"
      ansible.builtin.apt:
        name: [xorg, avahi-daemon, isc-dhcp-server, bind9, vsftpd, samba, squid, dovecot-imapd, dovecot-pop3d, nfs-kernel-server, rpcbind, tftp-hpa, telnetd, snmpd, nis]
        state: absent
        purge: true
      become: true
      failed_when: false
      when: ansible_facts['os_family'] == 'Debian'

    - name: "ISO 9001 | 600013 | Remove unnecessary packages (RedHat/CentOS)"
      ansible.builtin.dnf:
        name: [xorg-x11-server-Xorg, avahi, dhcp-server, bind, vsftpd, samba, squid, dovecot, nfs-utils, rpcbind, tftp, telnet-server, snmp, ypbind, nis]
        state: absent
      become: true
      failed_when: false
      when: ansible_facts['os_family'] == 'RedHat'
  tags: [cis_2_1_1, stig_v_230223, nist_cm_7, security, hardening, remediate, 530000]

- name: "ISO 27001 §9.2 | 510003 | CIS 6.1.1 | NIST IA-5 | Harden PAM configuration (Debian)"
  ansible.builtin.lineinfile:
    path: "{{ item.path }}"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { path: '/etc/pam.d/common-password', regexp: '^password.*pam_unix.so', line: 'password        [success=1 default=ignore]      pam_unix.so obscure sha512 rounds=65536' }
    - { path: '/etc/pam.d/common-session', regexp: '^session.*pam_tmpdir.so', line: 'session optional        pam_tmpdir.so' }
  when: ansible_facts['os_family'] == 'Debian'
  become: true
  tags: [cis_6_1_1, nist_ia_5, security, hardening, 510003]

- name: "ISO 27001 §13.1 | 540004 | NIST AC-18 | Disable wireless interfaces"
  ansible.builtin.shell: |
    for iface in $(iw dev 2>/dev/null | grep -i interface | awk '{print $2}'); do
      ip link set "$iface" down 2>/dev/null || true
    done
  args:
    executable: /bin/sh
  become: true
  changed_when: false
  failed_when: false
  tags: [cis_8_1_2, nist_ac_18, security, hardening, 540004]

- name: "ISO 9001 | 600013 | Set security hardening completion flag"
  ansible.builtin.set_fact:
    security_hardening_complete: true
  tags: [security, hardening, initialization, 600013]
