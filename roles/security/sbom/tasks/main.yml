---
# Tasks for security/sbom - Supply Chain Auditing

- name: "ISO 27001 ยง14.2 | Action 520040 | Initialize SBOM Generation"
  ansible.builtin.set_fact:
    sbom_output_dir: "{{ playbook_dir }}/ci-artifacts/sbom"
  tags: [security, sbom, supply_chain]

- name: Ensure SBOM output directory exists
  ansible.builtin.file:
    path: "{{ sbom_output_dir }}"
    state: directory
    mode: '0755'
  delegate_to: localhost
  run_once: true
  tags: [security, sbom]

- name: Generate SBOM Report (Forensic Scan)
  ansible.builtin.template:
    src: sbom_gen.py.j2
    dest: /tmp/sbom_gen.py
    mode: '0755'
  delegate_to: localhost
  run_once: true
  tags: [security, sbom]

- name: "ISO 27001 ยง14.2 | Action 520041 | Execute SBOM Audit"
  ansible.builtin.shell: "python3 /tmp/sbom_gen.py > {{ sbom_output_dir }}/sbom.json"
  delegate_to: localhost
  run_once: true
  changed_when: true
  tags: [security, sbom, audit, supply_chain]

- name: "ISO 27001 ยง14.2 | Action 520047 | Sign SBOM Audit Record (Immutable Trace)"
  ansible.builtin.shell: "sha256sum {{ sbom_output_dir }}/sbom.json > {{ sbom_output_dir }}/sbom.json.sha256"
  delegate_to: localhost
  run_once: true
  changed_when: true
  tags: [security, sbom, audit, supply_chain]

- name: "Action 520041 | Validate SBOM Integrity"
  ansible.builtin.stat:
    path: "{{ sbom_output_dir }}/sbom.json"
  register: sbom_file
  delegate_to: localhost
  run_once: true
  failed_when: not sbom_file.stat.exists
  tags: [security, sbom, audit]

- name: Clean up temporary generator
  ansible.builtin.file:
    path: /tmp/sbom_gen.py
    state: absent
  delegate_to: localhost
  run_once: true
  tags: [security, sbom]
