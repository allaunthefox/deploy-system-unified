---
# Enhanced security with required tools and proper validation for Deploy-System-Unified

- name: Check if security tools are installed
  ansible.builtin.shell: "command -v {{ item }}"
  register: security_framework_tool_check
  loop: ["trivy", "bwrap", "firejail", "endlessh", "chronyd"]
  failed_when: false
  changed_when: false
  tags: [security, scanning]

- name: "ISO 27001 ยง12.2 | Action 530001 | Install standard security packages (Distro-Specific)"
  ansible.builtin.package:
    name: "{{ security_package_mapping[ansible_distribution | lower].packages + security_scanning_extra_packages }}"
    state: present
  become: true
  when:
    - security_scanning_install_tools | bool
    - ansible_distribution | lower in security_package_mapping.keys()
  tags:
    - iso27001
    - security
    - scanning

- name: Verify security tools are functional (idempotent)
  ansible.builtin.shell: |
    if command -v {{ item }} >/dev/null 2>&1 || command -v {{ item }}-go >/dev/null 2>&1; then
      echo "FOUND:{{ item }}"
    else
      echo "MISSING:{{ item }}"
    fi
  register: security_framework_tool_verification
  loop: ["trivy", "bwrap", "firejail", "endlessh"]
  changed_when: false
  failed_when: false
  tags: [security, scanning]

- name: Enforce security tool presence (idempotent)
  ansible.builtin.fail:
    msg: "Critical Security Tool Missing: {{ item.item }}"
  when: "'MISSING:' in item.stdout"
  loop: "{{ security_framework_tool_verification.results }}"
  tags: [security, scanning, audit]

- name: "ISO 27001 ยง12.2 | Action 520010 | Run comprehensive security scan with proper validation (idempotent)"
  ansible.builtin.shell: |
    set -o pipefail
    scan_results=""
    if command -v chkrootkit >/dev/null 2>&1; then
      chkrootkit_output=$(chkrootkit 2>&1)
      infections=$(echo "$chkrootkit_output" | grep -i "INFECTED\|Warning" | wc -l)
      scan_results="$scan_results CHKROOTKIT:$infections"
    fi
    if command -v rkhunter >/dev/null 2>&1; then
      rkhunter_output=$(rkhunter --check --sk --report-warnings-only 2>&1)
      warnings=$(echo "$rkhunter_output" | grep -i "Warning\|Suspicious" | wc -l)
      scan_results="$scan_results RKHUNTER:$warnings"
    fi
    if command -v aide >/dev/null 2>&1; then
      aide_output=$(aide --check 2>&1)
      changes=$(echo "$aide_output" | grep -i "found\|changed\|deleted\|added" | wc -l)
      scan_results="$scan_results AIDE:$changes"
    fi
    if command -v lynis >/dev/null 2>&1; then
      lynis_output=$(lynis audit system --quick-scan 2>&1)
      issues=$(echo "$lynis_output" | grep -i "warning\|suggestion" | wc -l)
      scan_results="$scan_results LYNIS:$issues"
    fi
    if command -v checkov >/dev/null 2>&1; then
      checkov_output=$(checkov --directory /etc --compact 2>&1)
      checkov_issues=$(echo "$checkov_output" | grep -i "HIGH\|CRITICAL" | wc -l)
      scan_results="$scan_results CHECKOV:$checkov_issues"
    fi
    echo "$scan_results"
  args:
    executable: /bin/bash
    pipefail: true
  register: security_framework_comprehensive_scan
  changed_when: false
  no_log: true
  tags:
    - iso27001
    - security
    - scanning
    - audit

- name: Parse comprehensive security scan results (idempotent)
  ansible.builtin.set_fact:
    security_framework_chkrootkit_infections: >-
      {{ security_framework_comprehensive_scan.stdout.split('CHKROOTKIT:')[1].split()[0] | default('0') | int
         if 'CHKROOTKIT:' in security_framework_comprehensive_scan.stdout else 0 }}
    security_framework_rkhunter_warnings: >-
      {{ security_framework_comprehensive_scan.stdout.split('RKHUNTER:')[1].split()[0] | default('0') | int
         if 'RKHUNTER:' in security_framework_comprehensive_scan.stdout else 0 }}
    security_framework_aide_changes: >-
      {{ security_framework_comprehensive_scan.stdout.split('AIDE:')[1].split()[0] | default('0') | int
         if 'AIDE:' in security_framework_comprehensive_scan.stdout else 0 }}
    security_framework_lynis_issues: >-
      {{ security_framework_comprehensive_scan.stdout.split('LYNIS:')[1].split()[0] | default('0') | int
         if 'LYNIS:' in security_framework_comprehensive_scan.stdout else 0 }}
    security_framework_checkov_issues: >-
      {{ security_framework_comprehensive_scan.stdout.split('CHECKOV:')[1].split()[0] | default('0') | int
         if 'CHECKOV:' in security_framework_comprehensive_scan.stdout else 0 }}
  tags: [security, scanning]

- name: "Action 520011 | Validate comprehensive security scan results (idempotent)"
  ansible.builtin.assert:
    that:
      - security_framework_chkrootkit_infections == 0
      - security_framework_rkhunter_warnings <= security_scanning_rkhunter_warning_threshold
      - security_framework_aide_changes <= security_scanning_aide_change_threshold
      - security_framework_lynis_issues <= security_scanning_lynis_issue_threshold
      - security_framework_checkov_issues <= security_scanning_checkov_issue_threshold
    fail_msg: |
      Comprehensive security scan detected issues:
      - Chkrootkit infections: {{ security_framework_chkrootkit_infections }}
      - RKHunter warnings: {{ security_framework_rkhunter_warnings }}
      - AIDE changes: {{ security_framework_aide_changes }}
      - Lynis issues: {{ security_framework_lynis_issues }}
      - Checkov issues: {{ security_framework_checkov_issues }}
      - Deployment halted for security review
  tags:
    - iso27001
    - security
    - scanning
    - audit
