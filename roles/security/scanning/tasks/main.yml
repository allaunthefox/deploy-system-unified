# =============================================================================
# Audit Event Identifier: DSU-PLY-100380
# Last Updated: 2026-03-01
# =============================================================================
---
# Security/Scanning role - Focused on system validation and vulnerability scanning
# Compliance: CIS 3.3.x | STIG V-230340 | NIST RA-5 | ISO 27001 §8.15

- name: "ISO 9001 | 600030 | CIS 3.3.1 | STIG V-230340 | NIST RA-5 | Validate Scanning Eligibility (Ephemeral Guard)"
  ansible.builtin.assert:
    that:
      - not security_scanning_ephemeral_skip | bool
    fail_msg: "Heavy security scanning is skipped in ephemeral profiles. Use standard validation or set system_security_scanning_ephemeral_allow: true."
  tags: [cis_3_3_1, stig_v_230340, nist_ra_5, nist_si_2, iso_27001_8_15, security, scanning, profile_guard, 600030]
  when: security_scanning_enable | bool and (deployment_profile | default('') == 'ephemeral')

- name: "ISO 27001 §8.15 | 520001 | CIS 3.3.1 | STIG V-230340 | NIST RA-5 | Validate preflight requirements (idempotent)"
  ansible.builtin.include_role:
    name: ops/preflight
  tags: [cis_3_3_1, stig_v_230340, nist_ra_5, nist_si_2, nist_si_5, iso_27001_8_15, security, scanning, 520001]

- name: "ISO 27001 §8.15 | 520003 | CIS 3.3.2 | STIG V-230340 | NIST RA-5 | Verify directory structure (idempotent)"
  ansible.builtin.include_tasks: directory_verification.yml
  tags: [cis_3_3_2, stig_v_230340, nist_ra_5, nist_si_2, nist_si_6, iso_27001_8_15, security, scanning, 520003]

- name: "ISO 27001 §8.8 | 520010 | CIS 3.3.3 | STIG V-230341 | NIST SI-2 | Configure security tools (idempotent)"
  ansible.builtin.include_tasks: enhanced_security_with_required_tools.yml
  tags: [cis_3_3_3, stig_v_230341, nist_si_2, nist_si_3, nist_si_6, iso_27001_8_8, security, scanning, 520010]

- name: "ISO 9001 | 600013 | CIS 3.3.3 | Mark security tools configured"
  ansible.builtin.set_fact:
    enhanced_security_tools_configured: true
  tags: [cis_3_3_3, stig_v_230341, nist_si_2, nist_si_3, iso_27001_8_8, security, scanning, 600013]

- name: "ISO 27001 §8.15 | 520013 | CIS 3.3.4 | STIG V-230340 | NIST AU-2 | Verify Forensic Clock Synchronization (Chrony)"
  ansible.builtin.shell: |
    chronyc tracking | grep -q "System time.*slow\|System time.*fast\|Reference ID"
  args:
    executable: /bin/sh
  register: chrony_sync_check
  changed_when: false
  become: true
  failed_when: false
  tags: [cis_3_3_4, stig_v_230340, nist_au_2, nist_au_8, iso_27001_8_15, security, scanning, time, 520013]

- name: "ISO 27001 §8.15 | 520014 | CIS 3.3.4 | STIG V-230340 | NIST AU-2 | Validate clock precision"
  ansible.builtin.assert:
    that:
      - chrony_sync_check.rc == 0
    fail_msg: "System clock is not synchronized. Forensic logs and certificate validation may fail."
  tags: [cis_3_3_4, stig_v_230340, nist_au_2, nist_au_8, iso_27001_8_15, security, scanning, time, 520014]

- name: "ISO 27001 §8.8 | 520010 | CIS 3.3.5 | STIG V-230341 | NIST SI-2 | Run enhanced security scanning (idempotent)"
  ansible.builtin.include_tasks: enhanced_scanning.yml
  tags: [cis_3_3_5, stig_v_230341, nist_si_2, nist_si_3, nist_si_6, nist_si_8, iso_27001_8_8, security, scanning, 520010]

- name: "ISO 9001 | 600013 | CIS 3.3.5 | Mark security scanning configured"
  ansible.builtin.set_fact:
    security_scanning_configured: true
    enhanced_security_scanning_complete: true
  tags: [cis_3_3_5, stig_v_230341, nist_si_2, nist_si_3, iso_27001_8_8, security, scanning, 600013]

- name: "ISO 27001 §8.8 | 520011 | CIS 3.3.6 | STIG V-230341 | NIST SI-2 | Validate final security state (idempotent)"
  ansible.builtin.include_tasks: validation.yml
  tags: [cis_3_3_6, stig_v_230341, nist_si_2, nist_si_6, nist_si_10, iso_27001_8_8, security, scanning, audit, 520011]
