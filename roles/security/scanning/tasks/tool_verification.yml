---
# Security tooling verification for Deploy-System-Unified
- name: "ISO 27001 ยง12.2 | Audit Code 520010 | Verify security tools are installed (idempotent)"
  ansible.builtin.command: "{{ item }} --version"
  register: tool_verification
  loop: "{{ security_scanning_optional_tools + security_scanning_critical_tools + ['endlessh'] }}"
  changed_when: false
  failed_when: false
  tags:
    - iso27001
    - security
    - scanning

- name: Report missing security tools (idempotent)
  ansible.builtin.debug:
    msg: "WARNING: Security tool {{ item.item }} not available on this system"
  when: item.rc != 0
  loop: "{{ tool_verification.results }}"
  tags:
    - security
    - scanning

- name: "Audit Code 520011 | Verify all critical security tools are available (idempotent)"
  ansible.builtin.assert:
    that:
      - item.rc == 0
    fail_msg: "Critical security tool {{ item.item }} not available - deployment halted"
  loop: "{{ tool_verification.results }}"
  when: item.item in security_scanning_critical_tools
  tags:
    - security
    - scanning
    - audit
