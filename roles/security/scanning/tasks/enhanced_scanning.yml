---
# Enhanced security scanning for Deploy-System-Unified
- name: "ISO 27001 ยง12.2 | Action 520010 | Run comprehensive security scan (idempotent)"
  ansible.builtin.shell: |
    set -o pipefail
    scan_results=""
    
    # REQUIRE Trivy
    trivy_results=$(trivy filesystem /srv /etc/containers --security-checks vuln,config,secret --format json 2>/dev/null)
    trivy_critical=$(echo "$trivy_results" | jq -r '.Results[] | select(.Severity == "CRITICAL")' | wc -l)
    scan_results="$scan_results TRIVY_CRITICAL:$trivy_critical"
    
    # REQUIRE Checkov
    checkov_results=$(checkov --directory /etc/containers --compact --output json 2>/dev/null)
    checkov_critical=$(echo "$checkov_results" | jq -r '.results.failed_checks[] | select(.severity=="HIGH" or .severity=="CRITICAL")' | wc -l)
    scan_results="$scan_results CHECKOV_CRITICAL:$checkov_critical"
    
    # REQUIRE TruffleHog
    secret_results=$(trufflehog git . --since-commit HEAD~1 --only-verified 2>&1 | grep -i "found" | wc -l)
    scan_results="$scan_results TRUFFLEHOG_SECRETS:$secret_results"

    # REQUIRE ClamAV
    clamav_output=$(clamscan -r --no-summary /srv /etc/containers 2>/dev/null | grep -c "FOUND")
    scan_results="$scan_results CLAMAV_VIRUSES:$clamav_output"

    echo "$scan_results"
  register: comprehensive_scan
  changed_when: false
  no_log: true
  tags:
    - iso_27001_12_2
    - security
    - scanning
    - audit
  args:
    executable: /bin/bash
    pipefail: true
  when: not security_scanning_ephemeral_skip | bool

- name: Parse security scan results (idempotent)
  ansible.builtin.set_fact:
    trivy_critical_vulns: >-
      {{ comprehensive_scan.stdout | regex_search('TRIVY_CRITICAL:([0-9]+)', '\1') | first | default('0') | int
         if 'TRIVY_CRITICAL:' in (comprehensive_scan.stdout | default('')) else 0 }}
    checkov_critical_issues: >-
      {{ comprehensive_scan.stdout | regex_search('CHECKOV_CRITICAL:([0-9]+)', '\1') | first | default('0') | int
         if 'CHECKOV_CRITICAL:' in (comprehensive_scan.stdout | default('')) else 0 }}
    trufflehog_secrets_found: >-
      {{ comprehensive_scan.stdout | regex_search('TRUFFLEHOG_SECRETS:([0-9]+)', '\1') | first | default('0') | int
         if 'TRUFFLEHOG_SECRETS:' in (comprehensive_scan.stdout | default('')) else 0 }}
    clamav_viruses_found: >-
      {{ comprehensive_scan.stdout | regex_search('CLAMAV_VIRUSES:([0-9]+)', '\1') | first | default('0') | int
         if 'CLAMAV_VIRUSES:' in (comprehensive_scan.stdout | default('')) else 0 }}
  tags:
    - security
    - scanning

- name: "ISO 27001 ยง12.2 | Action 520011 | Validate security scan results (idempotent)"
  ansible.builtin.assert:
    that:
      - trivy_critical_vulns == 0
      - checkov_critical_issues == 0
      - trufflehog_secrets_found == 0
      - clamav_viruses_found == 0

- name: "ISO 27001 ยง5.37 | Action 520046 | Check for SBOM-driven Vulnerabilities"
  ansible.builtin.shell: |
    if [ -f "{{ playbook_dir }}/ci-artifacts/sbom/sbom.json" ]; then
      if command -v trivy >/dev/null 2>&1; then
        trivy sbom "{{ playbook_dir }}/ci-artifacts/sbom/sbom.json" --severity CRITICAL --exit-code 1
      fi
    fi
  delegate_to: localhost
  run_once: true
  changed_when: false
  tags: [security, scanning, sbom, audit]
