# =============================================================================
# Audit Event Identifier: DSU-PLY-110054
# Playbook Type: Threat Analysis Role
# Last Updated: 2026-02-28
# Version: 1.0
# =============================================================================
---
# Tasks for security/automated_threat_analysis
# NIST RA-3 | ISO 27001 ยง6.1.2
# Copyright The SLSA Authors.

- name: "THREAT | Install SLSA Verifier for supply chain security"
  ansible.builtin.get_url:
    url: "https://github.com/slsa-framework/slsa-verifier/releases/download/v2.4.1/slsa-verifier-linux-amd64"
    dest: "/usr/local/bin/slsa-verifier"
    mode: '0755'
    owner: root
    group: root
  become: true
  tags: [security, threat_analysis, slsa]

- name: "THREAT | Verify SLSA Provenance for core images"
  ansible.builtin.command: |
    /usr/local/bin/slsa-verifier verify-image "{{ item.image }}" \
      --source-uri "{{ item.source }}" \
      --builder-id "https://github.com/slsa-framework/slsa-github-generator"
  loop: "{{ threat_analysis_core_images | default([]) }}"
  register: _slsa_check
  failed_when: _slsa_check.rc != 0
  changed_when: false
  tags: [security, threat_analysis, slsa, verification]
