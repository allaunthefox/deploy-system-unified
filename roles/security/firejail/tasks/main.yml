---
# Tasks for security/firejail - Application Sandboxing
- name: "CIS 5.1.1 | STIG V-230220 | NIST CM-7 | ISO 27001 ยง8.26 | Action 410001 | Install Firejail"
  ansible.builtin.package:
    name: firejail
    state: present
  become: true
  tags:
    - cis_5_1_1
    - stig_v_230220
    - nist_cm_7
    - iso_27001_8_26
    - security
    - sandboxing

- name: "CIS 5.1.2 | STIG V-230220 | NIST SC-39 | ISO 27001 ยง8.26 | Action 410006 | Ensure Firejail profile directory exists"
  ansible.builtin.file:
    path: /etc/firejail
    state: directory
    mode: '0755'
  become: true
  tags:
    - cis_5_1_2
    - stig_v_230220
    - nist_sc_39
    - iso_27001_8_26
    - security
    - sandboxing

- name: "CIS 5.1.2 | STIG V-230220 | NIST SC-39 | ISO 27001 ยง8.26 | Action 410007 | Create local Firejail configuration directory"
  ansible.builtin.file:
    path: /usr/local/etc/firejail
    state: directory
    mode: '0755'
  become: true
  tags:
    - cis_5_1_2
    - stig_v_230220
    - nist_sc_39
    - iso_27001_8_26
    - security
    - sandboxing

- name: "CIS 5.1.3 | STIG V-230221 | NIST AC-6 | ISO 27001 ยง8.26 | Action 410002 | Configure Firejail GPU Access (Globals)"
  ansible.builtin.copy:
    content: |
      # Enable GPU acceleration for all Firejail sandboxes
      noblacklist /dev/dri
      noblacklist /dev/nvidia*
      noblacklist /dev/kfd
    dest: /etc/firejail/globals.local
    mode: '0644'
  become: true
  tags:
    - cis_5_1_3
    - stig_v_230221
    - nist_ac_6
    - iso_27001_8_26
    - security
    - sandboxing
    - remediate
  when: firejail_enable_gpu | default(false)

- name: VERIFY | Firejail is functional (Zero-Tolerance)
  ansible.builtin.shell: firejail --version
  register: _firejail_ver
  failed_when: _firejail_ver.rc != 0
  changed_when: false
  become: true
  tags: [security, sandboxing, verification]

- name: VERIFY | Firejail sandbox execution
  ansible.builtin.shell: firejail --noprofile --quiet --exit-if-exists ls /tmp
  register: _firejail_test
  failed_when: _firejail_test.rc != 0
  changed_when: false
  become: true
  tags: [security, sandboxing, verification]
