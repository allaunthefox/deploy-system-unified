# =============================================================================
# Audit Event Identifier: DSU-PLY-110001
# File Type: Role Tasks (main.yml)
# Role: sshd
# Last Updated: 2026-03-01
# =============================================================================
---
# SSHD configuration role - Enhanced SSH daemon configuration
# Compliance: CIS 5.2.x | STIG V-230237 | NIST AC-8 | ISO 27001 §10.1

- name: "ISO 27001 §12.4 | 600013 | Ensure sshd_config.d directory exists"
  ansible.builtin.file:
    path: /etc/ssh/sshd_config.d
    state: directory
    mode: '0755'
    owner: root
    group: root
  become: true
  tags: [security, sshd, initialization, 600013]

- name: "ISO 27001 §12.4 | 600013 | Ensure hardened SSH config file exists"
  ansible.builtin.file:
    path: "{{ security_sshd_config_path }}"
    state: touch
    mode: '0600'
    owner: root
    group: root
    modification_time: preserve
    access_time: preserve
  become: true
  tags: [security, sshd, initialization, 600013]

- name: "ISO 27001 §10.1 | 400102 | Ensure hardened config is included in sshd_config"
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    line: 'Include /etc/ssh/sshd_config.d/*.conf'
    insertafter: '^# Include.*'
    firstmatch: true
    validate: '/usr/sbin/sshd -t -f %s'
  become: true
  notify: 'restart_sshd'
  tags: [security, sshd, deploy, 400102]

- name: "ISO 9001 | 600013 | Check if security_sshd_config backup exists"
  ansible.builtin.stat:
    path: "{{ security_sshd_config_path }}.backup"
  register: security_sshd_config_backup
  become: true
  tags: [security, sshd, internal, 600013]

- name: "ISO 27040 | 900000 | Backup original security_sshd_config (only if missing)"
  ansible.builtin.copy:
    src: "{{ security_sshd_config_path }}"
    dest: "{{ security_sshd_config_path }}.backup"
    remote_src: true
    mode: '0600'
    force: false
  become: true
  when:
    - not (security_sshd_config_backup.stat.exists | default(false))
    - security_sshd_backup_config | default(true)
    - not ansible_check_mode
  tags: [security, sshd, backup, 900000]

- name: "ISO 9001 | 600013 | Determine SSH service name"
  ansible.builtin.set_fact:
    security_sshd_service_name: "{{ 'ssh' if ansible_facts['os_family'] == 'Debian' else 'sshd' }}"
  tags: [security, sshd, initialization, 600013]

- name: "ISO 27001 §10.1 | 400101 | Get OpenSSH version"
  ansible.builtin.shell:
    cmd: sshd -V 2>&1 | grep -oP 'OpenSSH_\K[0-9.]+' || echo "9.0"
    executable: /bin/sh
  register: security_sshd_version_raw
  changed_when: false
  become: true
  failed_when: false
  tags: [security, sshd, internal, 400101]

- name: "ISO 9001 | 600013 | Set OpenSSH version fact"
  ansible.builtin.set_fact:
    security_sshd_version: "{{ security_sshd_version_raw.stdout | default('9.0', true) }}"
  tags: [security, sshd, internal, 600013]

- name: "ISO 9001 | 600013 | Define supported PQC KEX algorithms"
  ansible.builtin.set_fact:
    security_sshd_kex_algorithms_pqc: >-
      {% set kex = [] %}
      {% set ver = security_sshd_version | default('9.0', true) %}
      {% if security_sshd_pqc_enabled | bool %}
      {%   if ver is version('9.9', '>=') %}
      {%     set _ = kex.append('mlkem768x25519-sha256') %}
      {%   elif ver is version('9.8', '>=') %}
      {%     set _ = kex.append('sntrup761x25519-sha512@openssh.com') %}
      {%   endif %}
      {% endif %}
      {{ kex }}
  changed_when: false
  tags: [security, sshd, internal, 600013]

- name: "ISO 9001 | 600013 | Define final KEX algorithms list"
  ansible.builtin.set_fact:
    security_sshd_kex_algorithms_final: >-
      {% set kex_list = security_sshd_kex_algorithms_pqc | default([]) %}
      {% if kex_list is string %}{% set kex_list = kex_list.split(',') %}{% endif %}
      {{ (kex_list + ['curve25519-sha256', 'curve25519-sha256@libssh.org', 'diffie-hellman-group16-sha512']) | join(',') }}
  changed_when: false
  tags: [security, sshd, internal, 600013]

- name: "ISO 27001 §12.4 | 600013 | CIS 1.1.5 | STIG V-230229 | Ensure SSH privilege separation directory exists"
  ansible.builtin.file:
    path: /run/sshd
    state: directory
    mode: '0755'
  become: true
  tags: [cis_1_1_5, stig_v_230229, security, sshd, 600013]

- name: "ISO 27001 §9.4 | 540001 | CIS 5.2.20 | NIST AC-8 | Configure SSH port"
  ansible.builtin.lineinfile:
    path: "{{ security_sshd_config_path }}"
    regexp: '^#?Port '
    line: "Port {{ ssh_effective_port | default(system_ssh_port) | default(22) }}"
    validate: '/usr/sbin/sshd -t -f %s'
  become: true
  notify: 'restart_sshd'
  tags: [cis_5_2_20, nist_ac_8, security, sshd, 540001]

- name: "ISO 27001 §10.1 | 400101 | CIS 5.2.11 | STIG V-230237 | NIST SC-8 | Configure SSH protocol and algorithms"
  ansible.builtin.blockinfile:
    path: "{{ security_sshd_config_path }}"
    marker: "# {mark} ANSIBLE MANAGED - SECURITY ALGORITHMS"
    block: |
      # Use only strong ciphers (FIPS 140-2 compliant)
      Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com
      # Use only strong MACs (FIPS 140-2 compliant)
      MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com
      # Use only strong key exchange algorithms (Dynamic PQC Support)
      KexAlgorithms {{ security_sshd_kex_algorithms_final }}
      # Use only strong host key algorithms
      HostKeyAlgorithms ssh-ed25519,rsa-sha2-512,rsa-sha2-256
    validate: '/usr/sbin/sshd -t -f %s'
  become: true
  tags:
    - cis_5_2_11
    - cis_5_2_12
    - cis_5_2_13
    - stig_v_230237
    - nist_sc_8
    - nist_sc_13
    - nist_ia_7
    - iso_27001_10_1
    - pqc
    - pqc_hybrid
    - forensic
    - remediate
    - ssh
    - high_severity
    - 400101
  notify: 'restart_sshd'

- name: "ISO 27001 §10.1 | 400016 | CIS 5.2.14 | STIG V-230238 | NIST SC-12 | Disable weak SSH host keys"
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/ssh/ssh_host_dsa_key
    - /etc/ssh/ssh_host_dsa_key.pub
    - /etc/ssh/ssh_host_ecdsa_key
    - /etc/ssh/ssh_host_ecdsa_key.pub
  become: true
  when: security_sshd_disable_weak_keys | default(false)
  tags: [cis_5_2_14, stig_v_230238, nist_sc_12, security, sshd, remediate, 400016]

- name: "ISO 27001 §10.1 | 400016 | CIS 5.2.14 | STIG V-230238 | NIST SC-13 | Generate strong Ed25519 host key if missing"
  ansible.builtin.command:
    cmd: ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N ""
    creates: /etc/ssh/ssh_host_ed25519_key
  become: true
  tags: [cis_5_2_14, stig_v_230238, nist_sc_13, security, sshd, 400016]

- name: "ISO 27001 §10.1 | 400016 | CIS 5.2.14 | STIG V-230238 | NIST SC-13 | Generate strong RSA host key if missing"
  ansible.builtin.command:
    cmd: ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key -N ""
    creates: /etc/ssh/ssh_host_rsa_key
  become: true
  tags: [cis_5_2_14, stig_v_230238, nist_sc_13, security, sshd, 400016]

- name: "ISO 27001 §8.8 | 600113 | CIS 5.2.2 | STIG V-230239 | NIST SC-12 | Set correct permissions on SSH host keys"
  ansible.builtin.file:
    path: "{{ item.path }}"
    mode: "{{ item.mode }}"
    owner: root
    group: root
  loop:
    - { path: '/etc/ssh/ssh_host_ed25519_key', mode: '0600' }
    - { path: '/etc/ssh/ssh_host_ed25519_key.pub', mode: '0644' }
    - { path: '/etc/ssh/ssh_host_rsa_key', mode: '0600' }
    - { path: '/etc/ssh/ssh_host_rsa_key.pub', mode: '0644' }
  become: true
  tags: [cis_5_2_2, stig_v_230239, nist_sc_12, iso_27001_10_1, automated, ssh, 600113]

- name: "ISO 27001 §9.2 | 510002 | Gather system groups for SSH validation"
  ansible.builtin.getent:
    database: group
  register: sshd_system_groups
  become: true
  tags: [security, sshd, validation, 510002]

- name: "ISO 27001 §9.2 | 510002 | Validate SSH trusted groups exist before restricting"
  ansible.builtin.assert:
    that:
      - item in sshd_system_groups.ansible_facts.getent_group.keys()
    fail_msg: >-
      SSH trusted group '{{ item }}' does not exist in /etc/group.
      This would lock out legitimate users. Create the group or remove from
      security_sshd_trusted_groups.
  loop: "{{ security_sshd_trusted_groups | default([]) }}"
  when: security_sshd_trusted_groups | length > 0
  tags: [security, sshd, validation, 510002]

- name: "ISO 27001 §9.2 | 510002 | Validate ansible_user is in allowed list"
  ansible.builtin.assert:
    that:
      - ansible_user in security_sshd_allowed_users | default([ansible_user])
    fail_msg: >-
      CRITICAL: Current ansible_user '{{ ansible_user }}' is not in
      security_sshd_allowed_users. This will lock you out after SSH restart!
      Add '{{ ansible_user }}' to security_sshd_allowed_users before proceeding.
  when: security_sshd_allowed_users is defined and security_sshd_allowed_users | length > 0
  tags: [security, sshd, validation, 510002]

- name: "ISO 27001 §8.8 | 600142 | CIS 5.2.21 | STIG V-230240 | Comment out unmanaged SSH authentication settings"
  ansible.builtin.replace:
    path: "{{ security_sshd_config_path }}"
    regexp: >-
      ^(PermitRootLogin|PasswordAuthentication|PubkeyAuthentication|UsePAM|X11Forwarding|
      AllowTcpForwarding|AllowAgentForwarding|AllowStreamLocalForwarding|PermitTunnel|
      Compression|ClientAliveInterval|ClientAliveCountMax|LoginGraceTime|MaxAuthTries|
      MaxSessions|PermitEmptyPasswords|ChallengeResponseAuthentication|UseDNS|LogLevel)\s+
    replace: '# \1 '
    validate: '/usr/sbin/sshd -t -f %s'
  become: true
  tags: [cis_5_2_21, stig_v_230240, security, sshd, remediation, 600142]

- name: "ISO 27001 §9.2 | 510003 | CIS 5.2.5 | STIG V-230241 | NIST IA-2 | Configure enhanced SSH security settings"
  ansible.builtin.blockinfile:
    path: "{{ security_sshd_config_path }}"
    marker: "# {mark} ANSIBLE MANAGED - ENHANCED SECURITY SETTINGS"
    block: |
      # Enhanced security settings
      LogLevel VERBOSE
      X11Forwarding {{ 'yes' if security_sshd_allow_x11_forwarding | bool else 'no' }}
      AllowTcpForwarding {{ 'yes' if security_sshd_allow_tcp_forwarding | bool else 'no' }}
      AllowAgentForwarding {{ 'yes' if security_sshd_allow_agent_forwarding | bool else 'no' }}
      AllowStreamLocalForwarding no
      PermitTunnel no
      Compression delayed
      ClientAliveInterval 300
      ClientAliveCountMax 2
      LoginGraceTime 60
      MaxAuthTries 3
      MaxSessions 10
      PermitEmptyPasswords no
      PermitRootLogin {{ security_sshd_permit_root_login }}
      PubkeyAuthentication yes
      PasswordAuthentication {{ security_sshd_password_authentication }}
      ChallengeResponseAuthentication no
      UsePAM yes
      UseDNS no
    validate: '/usr/sbin/sshd -t -f %s'
  become: true
  tags:
    - cis_5_2_5
    - stig_v_230241
    - nist_ia_2
    - nist_ac_3
    - nist_ac_6
    - nist_ac_7
    - nist_ac_10
    - nist_ac_11
    - nist_ac_12
    - nist_sc_8
    - nist_sc_10
    - nist_sc_13
    - nist_sc_15
    - iso_27001_9_2
    - forensic
    - remediate
    - ssh
    - high_severity
    - 510003
  notify: 'restart_sshd'

- name: "ISO 27037 | 520030 | CIS 5.2.22 | STIG V-230243 | Verify security_sshd_config has single-instance directives"
  ansible.builtin.shell: |
    awk '
      /^[[:space:]]*#/ { next }
      /^[[:space:]]*$/ { next }
      /^[[:space:]]*Match[[:space:]]+/ { in_match=1; next }
      in_match == 1 { next }
      {
        key=tolower($1)
        allowed = "^(port|permitrootlogin|passwordauthentication|" \
                "x11forwarding|allowtcpforwarding|allowagentforwarding|" \
                "clientaliveinterval|clientalivecountmax|maxauthtries|loglevel|" \
                "pubkeyauthentication|usepam|usedns|challengeresponseauthentication|" \
                "permitemptypasswords|maxsessions|logingracetime|compression|" \
                "allowstreamlocalforwarding|permittunnel)$"
        if (key ~ allowed) {
          count[key]++
        }
      }
      END {
        if (count["port"] != 1) {
          print "Port directive count=" (count["port"] + 0)
          exit 1
        }
        for (k in count) {
          if (count[k] > 1) {
            print "Duplicate directive " k " count=" count[k]
            dup=1
          }
        }
        if (dup) { exit 2 }
      }
    ' {{ security_sshd_config_path }}
  args:
    executable: /bin/sh
  changed_when: false
  become: true
  tags: [cis_5_2_22, stig_v_230243, audit, ssh, verification, 520030]

- name: "ISO 27001 §9.2 | 510003 | NIST AC-14 | STIG V-230244 | Add trusted-group Match blocks for allowed forwarding (conditional)"
  ansible.builtin.blockinfile:
    path: "{{ security_sshd_config_path }}"
    marker: "# {mark} ANSIBLE MANAGED - TRUSTED SSH EXCEPTIONS"
    block: |
      {% for grp in security_sshd_trusted_groups %}
      Match Group {{ grp }}
        AllowAgentForwarding yes
        AllowTcpForwarding yes
        X11Forwarding no
      {% endfor %}
    validate: '/usr/sbin/sshd -t -f %s'
  become: true
  when: security_sshd_enable_trusted_group_exceptions | default(false)
  notify: 'restart_sshd'
  tags: [nist_ac_14, stig_v_230244, security, sshd, 510003]

- name: "ISO 9001 | 600013 | Set SSHD configuration completion flag"
  ansible.builtin.set_fact:
    security_security_sshd_complete: true
  tags: [security, sshd, initialization, 600013]
