# =============================================================================
# Audit Event Identifier: DSU-PLY-100278
# Last Updated: 2026-02-28
# =============================================================================
---
# Main compliance validation tasks
# Compliance: CIS, STIG, NIST, ISO 27001

- name: "COMPLIANCE 1 | Initialize compliance validation"
  ansible.builtin.set_fact:
    compliance_validation_started: "{{ ansible_date_time.iso8601 }}"
  tags:
    - compliance
    - cis
    - stig
    - nist

- name: "COMPLIANCE 2 | Create compliance report directory"
  ansible.builtin.file:
    path: "{{ compliance_report_path }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  become: true
  tags:
    - compliance
    - cis

- name: "COMPLIANCE 3 | Run CIS Level 1 validation"
  ansible.builtin.include_tasks: cis_level_1.yml
  when: "'cis_level_1' in compliance_frameworks"
  tags:
    - compliance
    - cis
    - cis_level_1

- name: "COMPLIANCE 4 | Run CIS Level 2 validation"
  ansible.builtin.include_tasks: cis_level_2.yml
  when: "'cis_level_2' in compliance_frameworks"
  tags:
    - compliance
    - cis
    - cis_level_2

- name: "COMPLIANCE 5 | Run STIG validation"
  ansible.builtin.include_tasks: stig_validation.yml
  when: "'stig' in compliance_frameworks"
  tags:
    - compliance
    - stig

- name: "COMPLIANCE 6 | Run NIST 800-53 validation"
  ansible.builtin.include_tasks: nist_validation.yml
  when: "'nist' in compliance_frameworks"
  tags:
    - compliance
    - nist

- name: "COMPLIANCE 7 | Run Negative Security Testing"
  ansible.builtin.include_tasks: negative_testing.yml
  when: "'negative_testing' in compliance_frameworks"
  tags:
    - compliance
    - negative_testing
    - security

- name: "COMPLIANCE 8 | Generate compliance report"
  ansible.builtin.template:
    src: compliance_report.json.j2
    dest: "{{ compliance_report_path }}/cis_compliance_report.json"
    mode: '0644'
  become: true
  when: generate_compliance_report
  tags:
    - compliance
    - cis
    - report

- name: "COMPLIANCE 9 | Display compliance summary"
  ansible.builtin.debug:
    msg: |
      Compliance Validation Summary
      =============================
      CIS Level 1: {{ cis_level_1_score }}/{{ cis_level_1_total }} ({{ (cis_level_1_score / cis_level_1_total * 100) | round(1) if cis_level_1_total > 0 else 0 }}%)
      CIS Level 2: {{ cis_level_2_score }}/{{ cis_level_2_total }} ({{ (cis_level_2_score / cis_level_2_total * 100) | round(1) if cis_level_2_total > 0 else 0 }}%)
      STIG Score: {{ stig_score | default(0) }}/{{ stig_total | default(0) }} ({{ (stig_score | default(0) / stig_total | default(1) * 100) | round(1) if stig_total | default(0) > 0 else 0 }}%)
      NIST Score: {{ nist_score | default(0) }}/{{ nist_total | default(0) }} ({{ (nist_score | default(0) / nist_total | default(1) * 100) | round(1) if nist_total | default(0) > 0 else 0 }}%)
      Report: {{ compliance_report_path }}/cis_compliance_report.json
  tags:
    - compliance
    - cis
    - report

- name: "COMPLIANCE 7 | Enforce 100% CIS Compliance (Zero-Tolerance)"
  ansible.builtin.assert:
    that:
      - "(cis_level_1_total == 0) or (cis_level_1_score | int == cis_level_1_total | int)"
      - "(cis_level_2_total == 0) or (cis_level_2_score | int == cis_level_2_total | int)"
    fail_msg: |-
      Compliance validation failed! 100% compliance is required.
      Level 1: {{ cis_level_1_score }}/{{ cis_level_1_total }}
      Level 2: {{ cis_level_2_score }}/{{ cis_level_2_total }}
  tags: [compliance, cis, enforcement]
