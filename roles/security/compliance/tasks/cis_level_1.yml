---
# CIS Level 1 Validation Tasks

- name: "CIS 1.1.1 | Ensure mounting of squashfs filesystems is disabled"
  ansible.builtin.shell: |
    set -o pipefail
    modprobe -n -v squashfs 2>&1 | grep -c "install /bin/true" || echo "0"
  register: cis_1_1_1_result
  changed_when: false
  
  tags:
    - cis_1_1_1
    - cis_level_1

- name: "CIS 1.1.1 | Record compliance score"
  ansible.builtin.set_fact:
    cis_level_1_score: "{{ cis_level_1_score + (1 if cis_1_1_1_result.stdout | int > 0 else 0) }}"
    cis_level_1_total: "{{ cis_level_1_total + 1 }}"
  tags:
    - cis_1_1_1
    - cis_level_1

- name: "CIS 3.1.1 | Ensure IP forwarding is disabled"
  ansible.builtin.shell: |
    sysctl net.ipv4.ip_forward 2>&1 | awk '{print $NF}'
  register: cis_3_1_1_result
  changed_when: false
  
  tags:
    - cis_3_1_1
    - cis_level_1

- name: "CIS 3.1.1 | Record compliance score"
  ansible.builtin.set_fact:
    cis_level_1_score: "{{ cis_level_1_score + (1 if cis_3_1_1_result.stdout | int == 0 else 0) }}"
    cis_level_1_total: "{{ cis_level_1_total + 1 }}"
  tags:
    - cis_3_1_1
    - cis_level_1

- name: "CIS 3.2.1 | Ensure ICMP redirects are not accepted"
  ansible.builtin.shell: |
    sysctl net.ipv4.conf.all.accept_redirects 2>&1 | awk '{print $NF}'
  register: cis_3_2_1_result
  changed_when: false
  
  tags:
    - cis_3_2_1
    - cis_level_1

- name: "CIS 3.2.1 | Record compliance score"
  ansible.builtin.set_fact:
    cis_level_1_score: "{{ cis_level_1_score + (1 if cis_3_2_1_result.stdout | int == 0 else 0) }}"
    cis_level_1_total: "{{ cis_level_1_total + 1 }}"
  tags:
    - cis_3_2_1
    - cis_level_1

- name: "CIS 3.2.7 | Ensure TCP SYN Cookies is enabled"
  ansible.builtin.shell: |
    sysctl net.ipv4.tcp_syncookies 2>&1 | awk '{print $NF}'
  register: cis_3_2_7_result
  changed_when: false
  
  tags:
    - cis_3_2_7
    - cis_level_1

- name: "CIS 3.2.7 | Record compliance score"
  ansible.builtin.set_fact:
    cis_level_1_score: "{{ cis_level_1_score + (1 if cis_3_2_7_result.stdout | int == 1 else 0) }}"
    cis_level_1_total: "{{ cis_level_1_total + 1 }}"
  tags:
    - cis_3_2_7
    - cis_level_1

- name: "CIS 4.1.1 | Ensure auditd is installed"
  ansible.builtin.shell: |
    dpkg -l auditd 2>&1 | grep -c "^ii" || rpm -q auditd 2>&1 | grep -c "auditd" || echo "0"
  register: cis_4_1_1_result
  changed_when: false
  
  tags:
    - cis_4_1_1
    - cis_level_1

- name: "CIS 4.1.1 | Record compliance score"
  ansible.builtin.set_fact:
    cis_level_1_score: "{{ cis_level_1_score + (1 if cis_4_1_1_result.stdout | int > 0 else 0) }}"
    cis_level_1_total: "{{ cis_level_1_total + 1 }}"
  tags:
    - cis_4_1_1
    - cis_level_1

- name: "CIS 5.1.1 | Ensure permissions on /etc/shadow are configured"
  ansible.builtin.stat:
    path: /etc/shadow
  register: cis_5_1_1_stat
  tags:
    - cis_5_1_1
    - cis_level_1

- name: "CIS 5.1.1 | Record compliance score"
  ansible.builtin.set_fact:
    cis_level_1_score: "{{ cis_level_1_score + (1 if cis_5_1_1_stat.stat.mode == '0640' or cis_5_1_1_stat.stat.mode == '0600' else 0) }}"
    cis_level_1_total: "{{ cis_level_1_total + 1 }}"
  tags:
    - cis_5_1_1
    - cis_level_1

- name: "CIS 5.5.9 | Ensure SSH root login is disabled"
  ansible.builtin.shell: |
    sshd -T 2>/dev/null | grep -c "^permitrootlogin no" || grep -c "^PermitRootLogin no" /etc/ssh/sshd_config || echo "0"
  register: cis_5_5_9_result
  changed_when: false
  
  tags:
    - cis_5_5_9
    - cis_level_1

- name: "CIS 5.5.9 | Record compliance score"
  ansible.builtin.set_fact:
    cis_level_1_score: "{{ cis_level_1_score + (1 if cis_5_5_9_result.stdout | int > 0 else 0) }}"
    cis_level_1_total: "{{ cis_level_1_total + 1 }}"
  tags:
    - cis_5_5_9
    - cis_level_1

- name: "CIS 5.5.10 | Ensure SSH PermitEmptyPasswords is disabled"
  ansible.builtin.shell: |
    sshd -T 2>/dev/null | grep -c "^permitemptypasswords no" || grep -c "^PermitEmptyPasswords no" /etc/ssh/sshd_config || echo "0"
  register: cis_5_5_10_result
  changed_when: false
  
  tags:
    - cis_5_5_10
    - cis_level_1

- name: "CIS 5.5.10 | Record compliance score"
  ansible.builtin.set_fact:
    cis_level_1_score: "{{ cis_level_1_score + (1 if cis_5_5_10_result.stdout | int > 0 else 0) }}"
    cis_level_1_total: "{{ cis_level_1_total + 1 }}"
  tags:
    - cis_5_5_10
    - cis_level_1

- name: "CIS 5.5.5 | Ensure SSH MaxAuthTries is set to 4 or less"
  ansible.builtin.shell: |
    sshd -T 2>/dev/null | grep "^maxauthtries" | awk '{print $2}' || grep "^MaxAuthTries" /etc/ssh/sshd_config | awk '{print $2}' || echo "6"
  register: cis_5_5_5_result
  changed_when: false
  
  tags:
    - cis_5_5_5
    - cis_level_1

- name: "CIS 5.5.5 | Record compliance score"
  ansible.builtin.set_fact:
    cis_level_1_score: "{{ cis_level_1_score + (1 if cis_5_5_5_result.stdout | int <= 4 else 0) }}"
    cis_level_1_total: "{{ cis_level_1_total + 1 }}"
  tags:
    - cis_5_5_5
    - cis_level_1
