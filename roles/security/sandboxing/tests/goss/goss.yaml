# Goss tests for security/sandboxing role
# User-space application isolation via Bubblewrap and Landlock
# CIS Benchmark: 5.x - Access Control (Process Isolation)
# ISO 27001 ยง8.26 | STIG V-23022x | NIST AC-6/SC-39

# =============================================================================
# PACKAGE TESTS - Verify sandboxing packages
# =============================================================================
package:
  # CIS 5.x - User namespace tools
  bubblewrap:
    installed: true
  # CIS 5.x - Seccomp profiles
  seccomp:
    installed: true

# =============================================================================
# FILE TESTS - Verify sandboxing configuration files
# =============================================================================
file:
  # CIS 5.x - Bubblewrap binary
  /usr/bin/bwrap:
    exists: true
    mode: "0755"
    owner: root
    group: root

  # CIS 5.x - Sandboxing policy directory
  /etc/sandboxing/policies:
    exists: true
    filetype: directory
    mode: "0755"
    owner: root
    group: root

  # CIS 5.x - User namespace configuration
  /etc/subuid:
    exists: true
    mode: "0644"
    owner: root
    group: root

  # CIS 5.x - User namespace GID configuration
  /etc/subgid:
    exists: true
    mode: "0644"
    owner: root
    group: root

  # CIS 5.x - User namespace limits
  /etc/sysctl.d/99-user-namespace.conf:
    exists: true
    mode: "0644"
    owner: root
    group: root
    contains:
      - /^kernel.unprivileged_userns_clone = 0/
      - /^user.max_user_namespaces = 0/

# =============================================================================
# COMMAND TESTS - Verify sandboxing configurations
# =============================================================================
command:
  # CIS 5.x - Verify bubblewrap is installed and working
  bubblewrap_version:
    exec: 'bwrap --version 2>&1 | head -1'
    exit-status: 0
    stdout:
      - /bubblewrap/
    timeout: 5000

  # CIS 5.x - Verify user namespace is restricted
  user_namespace_restricted:
    exec: 'sysctl -n kernel.unprivileged_userns_clone 2>/dev/null || echo "0"'
    exit-status: 0
    stdout:
      - /^0$/
    timeout: 5000

  # CIS 5.x - Verify max user namespaces is restricted
  max_user_namespaces:
    exec: 'sysctl -n user.max_user_namespaces 2>/dev/null || echo "0"'
    exit-status: 0
    stdout:
      - /^0$/
    timeout: 5000

  # CIS 5.x - Verify subuid is configured
  subuid_configured:
    exec: 'wc -l < /etc/subuid'
    exit-status: 0
    stdout:
      - /^[1-9]/
    timeout: 5000

  # CIS 5.x - Verify subgid is configured
  subgid_configured:
    exec: 'wc -l < /etc/subgid'
    exit-status: 0
    stdout:
      - /^[1-9]/
    timeout: 5000

  # CIS 5.x - Verify bubblewrap can run
  bubblewrap_test:
    exec: 'bwrap --ro-bind / / --dev /dev --proc /proc --unshare-all echo "test" 2>&1'
    exit-status: 0
    stdout:
      - /^test$/
    timeout: 5000

  # CIS 5.x - Verify sandboxing config directory permissions
  sandbox_config_perms:
    exec: 'stat -c "%a" /etc/sandboxing/policies'
    exit-status: 0
    stdout:
      - /^755$/
    timeout: 5000
