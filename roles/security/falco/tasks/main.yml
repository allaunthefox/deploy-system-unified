# =============================================================================
# Audit Event Identifier: DSU-PLY-100288
# Last Updated: 2026-03-01
# =============================================================================
---
# Security - Falco Runtime Security Role
# Compliance: ISO 27001 §16.1 | NIST SI-4 | CIS 4.x

- name: "ISO 27037 | 520030 | Check if Falco is already installed"
  ansible.builtin.command:
    cmd: falco --version
  register: falco_check
  failed_when: false
  changed_when: false
  tags: [security, runtime, falco, verification, 520030]

- name: "ISO 9001 | 600013 | Detect operating system family for Falco"
  ansible.builtin.set_fact:
    falco_install_method: "{{ 'package' if ansible_facts['os_family'] in ['Debian', 'RedHat'] else 'binary' }}"
  changed_when: false
  tags: [security, runtime, falco, initialization, 600013]

- name: "ISO 27001 §16.1 | 460000 | Import Falco GPG key (Debian/Ubuntu)"
  ansible.builtin.apt_key:
    url: "{{ falco_gpg_key }}"
    state: present
  become: true
  when:
    - ansible_facts['os_family'] == 'Debian'
    - falco_install_method == 'package'
    - falco_check.rc != 0
  tags: [security, runtime, falco, deploy, 460000]

- name: "ISO 27001 §16.1 | 460000 | Add Falco repository (Debian/Ubuntu)"
  ansible.builtin.apt_repository:
    repo: "deb https://download.falco.org/packages/{{ falco_deb_repo_suffix }} {{ ansible_facts['distribution_release'] }} stable"
    state: present
  become: true
  when:
    - ansible_facts['os_family'] == 'Debian'
    - falco_install_method == 'package'
    - falco_check.rc != 0
  tags: [security, runtime, falco, deploy, 460000]

- name: "ISO 27001 §16.1 | 460000 | Add Falco repository (RHEL/CentOS)"
  ansible.builtin.yum_repository:
    name: falco
    description: Falco Repository
    baseurl: "https://download.falco.org/packages/rpm/{{ falco_rpm_repo_suffix }}"
    enabled: yes
    gpgcheck: "{{ falco_gpg_check }}"
    gpgkey: "{{ falco_gpg_key }}"
  become: true
  when:
    - ansible_facts['os_family'] == 'RedHat'
    - falco_install_method == 'package'
    - falco_check.rc != 0
  tags: [security, runtime, falco, deploy, 460000]

- name: "ISO 27001 §16.1 | 460001 | Install Falco package"
  ansible.builtin.package:
    name: "{{ falco_package_name }}"
    state: present
  become: true
  when:
    - falco_install_method == 'package'
    - falco_check.rc != 0
  tags: [security, runtime, falco, deploy, 460001]

- name: "ISO 27001 §16.1 | 460001 | Install Falco binary (manual)"
  ansible.builtin.unarchive:
    src: "https://download.falco.org/packages/binaries/falco-{{ falco_version }}-{{ ansible_facts['system']['hardware'] }}.tar.gz"
    dest: /
    remote_src: true
    creates: /usr/bin/falco
    checksum: "{{ 'sha256:' + falco_binary_checksum if falco_binary_checksum | default('') else omit }}"
  become: true
  when:
    - falco_install_method == 'binary'
    - falco_check.rc != 0
  tags: [security, runtime, falco, deploy, 460001]

- name: "ISO 9001 | 600013 | Create Falco system directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true
  loop:
    - /etc/falco
    - /etc/falco/rules.d
    - /var/log/falco
  tags: [security, runtime, falco, initialization, 600013]

- name: "ISO 27001 §16.1 | 460002 | Deploy Falco primary configuration"
  ansible.builtin.template:
    src: falco.yaml.j2
    dest: /etc/falco/falco.yaml
    owner: root
    group: root
    mode: '0644'
    validate: '/usr/bin/falco --c %s --validate'
  become: true
  notify: restart_falco
  tags: [security, runtime, falco, config, 460002]
  no_log: true

- name: "ISO 27001 §16.1 | 460002 | Deploy custom threat detection rules"
  ansible.builtin.copy:
    src: falco-rules.yaml
    dest: /etc/falco/rules.d/falco-rules.yaml
    owner: root
    group: root
    mode: '0644'
  become: true
  when: falco_custom_rules_src is defined
  tags: [security, runtime, falco, rules, 460002]

- name: "ISO 27001 §16.1 | 460002 | Deploy Falco systemd service"
  ansible.builtin.template:
    src: falco.service.j2
    dest: /etc/systemd/system/falco.service
    mode: '0644'
  become: true
  when:
    - falco_install_method == 'binary'
    - ansible_facts['service_mgr'] == 'systemd'
  notify: restart_falco
  tags: [security, runtime, falco, deploy, 460002]

- name: "ISO 27001 §16.1 | 460002 | Enable and start Falco monitoring service"
  ansible.builtin.systemd:
    name: falco
    enabled: true
    state: started
    daemon_reload: true
  become: true
  when: ansible_facts['service_mgr'] == 'systemd'
  tags: [security, runtime, falco, deploy, 460002]

- name: "ISO 9001 | 600013 | Check for Kubernetes environment"
  ansible.builtin.set_fact:
    is_kubernetes: "{{ true if (lookup('file', '/var/run/secrets/kubernetes.io/serviceaccount/namespace', errors='ignore') | default('', true) != '') else false }}"
  changed_when: false
  failed_when: false
  tags: [security, runtime, falco, initialization, 600013]

- name: "ISO 27001 §16.1 | 460003 | Deploy Falco Kubernetes Audit Rules"
  ansible.builtin.copy:
    src: k8s-audit-rules.yaml
    dest: /etc/falco/k8s-audit-rules.yaml
    owner: root
    group: root
    mode: '0644'
  become: true
  when: is_kubernetes | bool
  tags: [security, runtime, falco, k8s, rules, 460003]

- name: "ISO 9001 | 600013 | Set Falco integration completion flag"
  ansible.builtin.set_fact:
    falco_integration_complete: true
  tags: [security, runtime, falco, internal, 600013]
