# =============================================================================
# Audit Event Identifier: DSU-PLY-110056
# Last Updated: 2026-03-01
# =============================================================================
---
# NIST SP 800-53 | ISO 27001 ยง14.2
# Security - HashiCorp Vault Integration Role
# Supports: Vault agent injector, Kubernetes auth, dynamic secrets
# Note: HashiCorp Vault is governed by the Business Source License (BSL 1.1) / MPL.
# Copyright HashiCorp, Inc.

- name: Check if Vault is already configured
  ansible.builtin.stat:
    path: /etc/vault/config.hcl
  register: vault_config_check
  changed_when: false

- name: Check for Kubernetes environment
  ansible.builtin.set_fact:
    is_kubernetes: "{{ true if (ansible_facts['distribution'] == 'Ubuntu' and lookup('env', 'KUBERNETES_SERVICE_HOST') | default('', true) != '') or (lookup('file', '/var/run/secrets/kubernetes.io/serviceaccount/namespace') | default('', true) != '') else false }}"
  changed_when: false
  failed_when: false

- name: Install Vault binary (standalone mode)
  ansible.builtin.unarchive:
    src: >-
      {{
        (artifact_binary_mirror_base + '/vault_' + vault_version + '_' + ansible_facts['system']['hardware'] + '-linux.zip')
        if (artifact_binary_mirror_base | default('') | length > 0)
        else ("https://releases.hashicorp.com/vault/" + vault_version + "/vault_" + vault_version + "_" + ansible_facts['system']['hardware'] + "-linux.zip")
      }}
    dest: /usr/local/bin
    remote_src: true
    creates: /usr/local/bin/vault
    checksum: "{{ vault_checksums[vault_version][ansible_facts['system']['hardware']] | default(omit) }}"
  become: true
  when:
    - vault_install_mode == 'standalone'
    - not vault_config_check.stat.exists
  tags:
    - vault
    - security
    - secrets

- name: VERIFY | Vault binary is functional (Zero-Tolerance)
  ansible.builtin.command:
    cmd: /usr/local/bin/vault --version
  register: _vault_ver
  failed_when: "_vault_ver.rc != 0"
  changed_when: false
  become: true
  tags: [vault, security, verification]

- name: Create Vault user and group
  ansible.builtin.group:
    name: vault
    system: true
  become: true
  when:
    - vault_install_mode == 'standalone'
    - not vault_config_check.stat.exists
  tags:
    - vault
    - security
    - secrets

- name: Create Vault directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: vault
    group: vault
    mode: '0750'
  become: true
  loop:
    - /etc/vault
    - /var/lib/vault
    - /var/log/vault
  when:
    - vault_install_mode == 'standalone'
    - not vault_config_check.stat.exists
  tags:
    - vault
    - security
    - secrets

- name: Deploy Vault configuration file
  ansible.builtin.template:
    src: vault.hcl.j2
    dest: /etc/vault/config.hcl
    owner: vault
    group: vault
    mode: '0640'
    validate: 'vault validate -config=%s'
  become: true
  notify: restart_vault
  when:
    - vault_install_mode == 'standalone'
  tags:
    - vault
    - security
    - secrets
  no_log: true

- name: "VAULT | Configure Dynamic Secrets"
  ansible.builtin.include_tasks: dynamic_secrets.yml
  when: vault_enable_dynamic_secrets | bool
  tags: [security, vault, dynamic-secrets]

- name: Set Vault integration complete flag
  ansible.builtin.set_fact:
    vault_integration_complete: true
