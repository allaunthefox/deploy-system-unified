# =============================================================================
# Audit Event Identifier: DSU-PLY-100399
# Last Updated: 2026-02-28
# =============================================================================
---
# NIST SP 800-53 | ISO 27001 ยง14.2
# Example: Configuration for Dynamic PostgreSQL Credentials
# This demonstrates replacing a static SOPS encrypted secret with dynamic Vault credentials.

- name: "VAULT | Enable PostgreSQL secrets engine"
  hashivault_secret_engine:
    name: database
    backend: database
    state: present
  environment:
    VAULT_ADDR: "{{ vault_addr }}"
    VAULT_TOKEN: "{{ vault_root_token }}"
  when: vault_enable_dynamic_secrets | bool
  tags: [security, vault, dynamic-secrets]

- name: "VAULT | Configure PostgreSQL connection"
  hashivault_database_config:
    plugin_name: postgresql-database-plugin
    connection_url: "postgresql://{{ vault_pg_admin_user }}:{{ vault_pg_admin_pass }}@{{ vault_pg_host }}:5432/postgres?sslmode=disable"
    name: "main-postgres-db"
  environment:
    VAULT_ADDR: "{{ vault_addr }}"
    VAULT_TOKEN: "{{ vault_root_token }}"
  when: vault_enable_dynamic_secrets | bool
  tags: [security, vault, dynamic-secrets]

- name: "VAULT | Create App dynamic role for ephemeral credentials"
  hashivault_database_role:
    name: "app-dynamic-role"
    db_name: "main-postgres-db"
    creation_statements:
      - "CREATE ROLE \"{{name}}\" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}';"
      - "GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO \"{{name}}\";"
    default_ttl: "1h"
    max_ttl: "24h"
  environment:
    VAULT_ADDR: "{{ vault_addr }}"
    VAULT_TOKEN: "{{ vault_root_token }}"
  when: vault_enable_dynamic_secrets | bool
  tags: [security, vault, dynamic-secrets]
