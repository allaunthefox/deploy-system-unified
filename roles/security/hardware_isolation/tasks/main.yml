---
# Tasks for security/hardware_isolation - PCIe and DMA Protection

- name: "CIS 3.2.1 | STIG V-230231 | NIST SC-43 | ISO 27001 ยง8.26 | Audit Code 450003 | Detect CPU Vendor for IOMMU"
  ansible.builtin.set_fact:
    _hardware_isolation_vendor: >-
      {{
        'intel' if 'Intel' in (ansible_facts['processor'] | join(' ')) else
        'amd' if 'AMD' in (ansible_facts['processor'] | join(' ')) else
        'unknown'
      }}
  when: hardware_isolation_iommu_vendor == "auto"
  tags:
    - cis_3_2_1
    - stig_v_230231
    - nist_sc_43
    - iso_27001_8_26
    - security
    - isolation

- name: "CIS 3.2.1 | STIG V-230231 | NIST SC-43 | ISO 27001 ยง8.26 | Audit Code 450004 | Set IOMMU Vendor Fact"
  ansible.builtin.set_fact:
    _hardware_isolation_vendor: "{{ hardware_isolation_iommu_vendor }}"
  when: hardware_isolation_iommu_vendor != "auto"
  tags:
    - cis_3_2_1
    - stig_v_230231
    - nist_sc_43
    - iso_27001_8_26
    - security
    - isolation

- name: "CIS 3.2.2 | STIG V-230232 | NIST SC-8 | ISO 27001 ยง8.26 | Audit Code 450002 | Register IOMMU Isolation Parameters for GRUB"
  ansible.builtin.set_fact:
    core_grub_isolation_params: >-
      {{
        core_grub_isolation_params | default([]) +
        [
          _hardware_isolation_vendor ~ '_iommu=on'
        ] + (
          ['iommu=pt'] if hardware_isolation_iommu_pt else []
        ) + (
          ['pcie_acs_override=downstream,multifunction'] if hardware_isolation_acs_override else []
        )
      }}
  tags:
    - cis_3_2_2
    - stig_v_230232
    - nist_sc_8
    - iso_27001_8_26
    - security
    - isolation
    - remediate
  when:
    - not (is_virtualized | default(false))
    - hardware_isolation_iommu_enabled
    - _hardware_isolation_vendor in ['intel', 'amd']

- name: "CIS 3.2.3 | STIG V-230232 | NIST SC-8 | ISO 27001 ยง8.26 | Audit Code 450104 | Blacklist dangerous DMA-capable modules"
  ansible.builtin.template:
    src: dma-isolation.conf.j2
    dest: /etc/modprobe.d/99-dma-isolation.conf
    mode: '0644'
    owner: root
    group: root
  become: true
  tags:
    - cis_3_2_3
    - stig_v_230232
    - nist_sc_8
    - iso_27001_8_26
    - security
    - isolation
    - remediate
  when:
    - not (is_virtualized | default(false))
    - hardware_isolation_dma_protection_enabled
