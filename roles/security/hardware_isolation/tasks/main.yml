---
# Tasks for security/hardware_isolation - PCIe and DMA Protection

- name: Detect CPU Vendor for IOMMU
  ansible.builtin.set_fact:
    _hardware_isolation_vendor: >-
      {{
        'intel' if 'Intel' in (ansible_facts['processor'] | join(' ')) else
        'amd' if 'AMD' in (ansible_facts['processor'] | join(' ')) else
        'unknown'
      }}
  when: hardware_isolation_iommu_vendor == "auto"

- name: Set IOMMU Vendor Fact
  ansible.builtin.set_fact:
    _hardware_isolation_vendor: "{{ hardware_isolation_iommu_vendor }}"
  when: hardware_isolation_iommu_vendor != "auto"

- name: Register IOMMU Isolation Parameters for GRUB
  ansible.builtin.set_fact:
    core_grub_isolation_params: >-
      {{
        core_grub_isolation_params | default([]) +
        [
          _hardware_isolation_vendor ~ '_iommu=on'
        ] + (
          ['iommu=pt'] if hardware_isolation_iommu_pt else []
        ) + (
          ['pcie_acs_override=downstream,multifunction'] if hardware_isolation_acs_override else []
        )
      }}
  when:
    - not (is_virtualized | default(false))
    - hardware_isolation_iommu_enabled
    - _hardware_isolation_vendor in ['intel', 'amd']

- name: Blacklist dangerous DMA-capable modules
  ansible.builtin.template:
    src: dma-isolation.conf.j2
    dest: /etc/modprobe.d/99-dma-isolation.conf
    mode: '0644'
    owner: root
    group: root
  become: true
  when:
    - not (is_virtualized | default(false))
    - hardware_isolation_dma_protection_enabled
