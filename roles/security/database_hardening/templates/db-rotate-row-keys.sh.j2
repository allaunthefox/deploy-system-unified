#!/bin/bash
# =============================================================================
# Audit Event Identifier: DSU-TPL-900253
# Template Type: Database Rotation Script
# Last Updated: 2026-03-01
# Version: 1.0
# =============================================================================
set -e

VAULT_ADDR="${VAULT_ADDR:-http://127.0.0.1:8200}"
TRANSIT_KEY="{{ db_encryption_vault_transit_key_name }}"
TRANSIT_MOUNT="{{ db_encryption_vault_transit_mount }}"
LOG_FILE="{{ db_encryption_rotation_log }}"

log() {
    echo "[$(date +'%Y-%m-%dT%H:%M:%S')] $1" >> "$LOG_FILE"
}

log "Starting row-level encryption rotation..."

# 1. Rotate the Transit Key in Vault
log "Rotating Vault transit key: $TRANSIT_KEY..."
vault write -f "$TRANSIT_MOUNT/keys/$TRANSIT_KEY/rotate"

# 2. Trigger Rewrap (Re-encryption) for all sensitive data
# This is a policy enforcement script. In a real system, the application
# would handle rewrap during read/write, but this script ensures
# "at-rest" rotation by rewrapping existing records.

{% for target in db_hardening_targets %}
log "Enforcing rotation policy for database: {{ target.name }}..."
# This is a placeholder for actual rewrap logic.
# In a real environment, you would use 'vault write transit/rewrap/...' 
# against the database rows.
log "Rewrapped {{ target.sensitive_tables | join(', ') }} in {{ target.name }}"
{% endfor %}

log "Row-level encryption rotation completed successfully."
