---
# Production Container Host - Secure Solution Stack
# Solution: Base Hardened Infrastructure + Container Workload
# Features: Quantum-Ready (PQC Hybrid), ISO 27001 ยง9.2/10.1 Compliant
- ansible.builtin.import_playbook: base_hardened.yml

- name: Deploy Production Container Workload
  hosts: all
  become: true
  vars:
    # Define roles sequence in vars
    production_roles:
      # Container Infrastructure Workload
      - hardware/sas
      - hardware/gpu
      - containers/runtime
      - containers/config
      - containers/quadlets
      - containers/caddy
      # Monitoring
      - ops/monitoring          # Host Agent (Node Exporter)
      - containers/monitoring   # Stack (Forensic Dashboards)
      # Backup & Disaster Recovery
      - storage/backup/restic
      - storage/backup/rclone
      # Final Solution Integrity Verification
      - security/scanning
      - security/sbom           # Supply Chain Integrity

  tasks:
    - name: Execute Production Roles with Granular Checkpoints
      ansible.builtin.include_tasks: tasks/run_role.yml
      loop: "{{ production_roles }}"
      loop_control:
        loop_var: role_item

  post_tasks:
    - name: Create production container directories
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        mode: "{{ item.mode }}"
        owner: "{{ item.owner | default('root') }}"
        group: "{{ item.group | default('root') }}"
      loop:
        - { path: "/srv/containers", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/srv/containers/config", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/srv/containers/data", mode: '0755', owner: 'root', group: 'root' }
        - { path: "/srv/containers/secrets", mode: '0700', owner: 'root', group: 'root' }

    - name: Run post-deploy health checks
      ansible.builtin.include_role:
        name: ops/health_check
  handlers:
    - name: Restart caddy
      ansible.builtin.systemd:
        name: caddy
        state: restarted
      listen: "restart caddy"
