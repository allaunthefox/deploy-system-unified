---
# Production Container Host - Secure Solution Stack
# Solution: Base Hardened Infrastructure + Container Workload
# Features: Quantum-Ready (PQC Hybrid), ISO 27001 ยง9.2/10.1 Compliant
- ansible.builtin.import_playbook: base_hardened.yml

- name: Deploy Production Container Workload
  hosts: all
  become: true
  vars:
    # Define roles sequence in vars
    production_roles:
      # Container Infrastructure Workload
      - hardware/sas
      - hardware/gpu
      - containers/runtime
      - containers/config
      - containers/quadlets
      - containers/caddy
      - containers/networking   # DNS & Network Services (AdGuard)
      - containers/security     # Security Infra (Headscale)
      - containers/media        # Media Stack (ARR Stack)
      - containers/immich       # Photo Stack
      - containers/home_assistant # Automation Stack
      - containers/life         # Life Management Stack (Mealie, Firefly)
      - containers/ai           # AI Stack (Ollama, WebUI)
      - containers/archive      # Long-term Archive (YouTube, Wikipedia)
      # Monitoring
      - ops/monitoring          # Host Agent (Node Exporter)
      - containers/monitoring   # Stack (Forensic Dashboards)
      # Backup & Disaster Recovery
      - storage/backup/restic
      - storage/backup/rclone
      # Final Solution Integrity Verification
      - security/scanning
      - security/sbom           # Supply Chain Integrity & SBOM Audit

  tasks:
    - name: Execute Production Roles with Granular Checkpoints
      ansible.builtin.include_tasks: tasks/run_role.yml
      loop: "{{ production_roles }}"
      loop_control:
        loop_var: role_item

  handlers:
    - name: Import Global Handlers
      ansible.builtin.import_tasks: handlers/main.yml

    - name: Restart caddy
      ansible.builtin.systemd:
        name: caddy
        state: restarted
      listen: "restart caddy"
