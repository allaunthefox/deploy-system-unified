# =============================================================================
# Audit Event Identifier: DSU-PLY-100002
# Playbook Type: Production Deployment
# Description: Production container host - base hardened + container workload
# Compliance: ISO 27001 ยง9.2/10.1, PQC Hybrid
# Last Updated: 2026-02-28
# Version: 1.0
# =============================================================================
---
# Production Container Host - Secure Solution Stack
# Solution: Base Hardened Infrastructure + Container Workload
# Features: Quantum-Ready (PQC Hybrid), ISO 27001 ยง9.2/10.1 Compliant
- ansible.builtin.import_playbook: base_hardened.yml

- name: Deploy Production Container Workload
  hosts: all
  become: true
  tasks:
    - name: Execute Production Roles with Granular Checkpoints
      ansible.builtin.include_tasks: tasks/run_role.yml
      loop: "{{ deploy_workload_roles | default([]) }}"
      loop_control:
        loop_var: role_item

  post_tasks:
    - name: Force systemd reload to pick up new Quadlets
      ansible.builtin.systemd:
        daemon_reload: true
        scope: "{{ (podman_rootless_enabled | default(false) | bool) | ternary('user', 'system') }}"
      environment: "{{ containers_systemd_env | default({}) }}"
      become: true
      become_user: "{{ (podman_rootless_enabled | default(false) | bool) | ternary(podman_rootless_user, 'root') }}"

    - name: Ensure Caddy is running
      ansible.builtin.systemd:
        name: caddy
        state: started
        enabled: true
      become: true

  handlers:
    - name: Import Global Handlers
      ansible.builtin.import_tasks: handlers/main.yml
