# =============================================================================
# Audit Event Identifier: DSU-PLY-100006
# Playbook Type: Preflight Validation
# Description: Ontological contract enforcement and preflight assertions
# Last Updated: 2026-02-28
# Version: 1.0
# =============================================================================
---
- name: Preflight Validation - Ontological Contract Enforcement
  hosts: all
  gather_facts: false
  tasks:
    - name: Enforce single ontological profile group membership
      ansible.builtin.assert:
        that:
          - (group_names | intersect(['hardened', 'ephemeral', 'production', 'dev']) | length) == 1
        fail_msg: >-
          Host {{ inventory_hostname }} must belong to exactly one ontological profile group.
          Found in: {{ group_names | intersect(['hardened', 'ephemeral', 'production', 'dev']) | join(', ') }}

    - name: Assert deployment_profile is defined and typed correctly
      ansible.builtin.assert:
        that:
          - deployment_profile is defined
          - deployment_profile is string
        fail_msg: "CRITICAL: 'deployment_profile' must be defined as a string for {{ inventory_hostname }}."

    - name: Validate 'hardened' profile contract
      ansible.builtin.assert:
        that:
          - core_security_fail_secure | default(false) | bool == true
          - firewall_enabled | default(false) | bool == true
          - ssh_randomize_port | default(false) | bool == true
        fail_msg: >-
          Host {{ inventory_hostname }} declares profile 'hardened' but violates its contract.
          Expects: fail_secure=true, firewall=true, ssh_randomize=true.
      when: deployment_profile == 'hardened'

    - name: Validate 'ephemeral' profile contract
      ansible.builtin.assert:
        that:
          - ephemeral_volatile_secrets | default(false) | bool == true
          - core_security_fail_secure | default(false) | bool == true
          - firewall_enabled | default(false) | bool == true
        fail_msg: >-
          Host {{ inventory_hostname }} declares profile 'ephemeral' but violates its contract.
          Expects: volatile_secrets=true, fail_secure=true, firewall=true.
      when: deployment_profile == 'ephemeral'

    - name: Validate 'production' profile contract
      ansible.builtin.assert:
        that:
          - core_security_fail_secure | default(false) | bool == true
          - firewall_enabled | default(false) | bool == true
          - monitoring_enabled | default(false) | bool == true
        fail_msg: >-
          Host {{ inventory_hostname }} declares profile 'production' but violates its contract.
          Expects: fail_secure=true, firewall=true, monitoring=true.
      when: deployment_profile == 'production'

    - name: Validate 'dev' profile contract
      ansible.builtin.assert:
        that:
          - core_security_fail_secure | default(true) | bool == false
          - firewall_enabled | default(false) | bool == true
        fail_msg: >-
          Host {{ inventory_hostname }} declares profile 'dev' but violates its contract.
          Expects: fail_secure=false, firewall=true.
      when: deployment_profile == 'dev'

    - name: "ISO 27001 ยง8.20 | 800000 | Verify shared media drive availability"
      ansible.builtin.stat:
        path: "{{ media_root_dir }}"
      register: media_root_check
      when: media_root_dir is defined
      tags: [preflight, storage, 800000]

    - name: "ISO 27001 ยง8.20 | 800000 | Assert shared media drive is accessible"
      ansible.builtin.assert:
        that:
          - media_root_check.stat.exists
          - media_root_check.stat.isdir
        fail_msg: "CRITICAL: Shared media drive at {{ media_root_dir }} is not mounted or accessible."
      when: media_root_dir is defined
      tags: [preflight, storage, 800000]
