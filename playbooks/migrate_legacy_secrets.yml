# =============================================================================
# Audit Event Identifier: DSU-PLY-100013
# Playbook Type: Migration (Secrets)
# Description: Legacy data restore and secret rotation
# Reference: MIGRATION_PLAN.md
# Last Updated: 2026-02-28
# Version: 1.0
# =============================================================================
---
- name: "ISO 27001 ยง14.2 | 100013 | Migrate Legacy Data and Rotate Secrets"
  hosts: all
  become: true
  vars:
    backup_source_dir: "/tmp/migration_staging"
    authentik_dump: "{{ backup_source_dir }}/authentik.sql"
    wikijs_dump: "{{ backup_source_dir }}/wikijs.sql"

  tasks:
    - name: "ISO 9001 | 600013 | Ensure Staging Directory Exists"
      ansible.builtin.file:
        path: "{{ backup_source_dir }}"
        state: directory
        mode: '0700'

    # ---------------------------------------------------------
    # Authentik Migration
    # ---------------------------------------------------------
    - name: "ISO 9001 | 600013 | Authentik - Stop Service"
      ansible.builtin.systemd:
        name: authentik-server
        state: stopped
      ignore_errors: true

    - name: "ISO 9001 | 600013 | Authentik - Ensure DB is Running"
      ansible.builtin.systemd:
        name: authentik-postgres
        state: started

    - name: "ISO 9001 | 600013 | Authentik - Restore Database"
      ansible.builtin.shell: |
        podman exec -i authentik-postgres psql -U authentik -d authentik < {{ authentik_dump }}
      register: authentik_restore
      ignore_errors: true # May fail if DB exists or dump is partial

    - name: "ISO 9001 | 600013 | Authentik - Rotate Database Password"
      ansible.builtin.command: >
        podman exec -i authentik-postgres psql -U authentik -c
        "ALTER USER authentik WITH PASSWORD '{{ authentik_pg_password }}';"
      when: authentik_pg_password is defined

    - name: "ISO 9001 | 600013 | Authentik - Restart Service"
      ansible.builtin.systemd:
        name: authentik-server
        state: restarted

    # ---------------------------------------------------------
    # Wiki.js Migration
    # ---------------------------------------------------------
    - name: "ISO 9001 | 600013 | Wiki.js - Stop Service"
      ansible.builtin.systemd:
        name: wiki
        state: stopped
      ignore_errors: true

    - name: "ISO 9001 | 600013 | Wiki.js - Ensure DB is Running"
      ansible.builtin.systemd:
        name: wikijs-db
        state: started

    - name: "ISO 9001 | 600013 | Wiki.js - Restore Database"
      ansible.builtin.shell: |
        podman exec -i wikijs-db psql -U wiki -p 5433 -d wiki < {{ wikijs_dump }}
      ignore_errors: true

    - name: "ISO 9001 | 600013 | Wiki.js - Rotate Database Password"
      ansible.builtin.command: >
        podman exec -i wikijs-db psql -U wiki -p 5433 -c
        "ALTER USER wiki WITH PASSWORD '{{ wikijs_pg_password }}';"
      when: wikijs_pg_password is defined

    - name: "ISO 9001 | 600013 | Wiki.js - Restart Service"
      ansible.builtin.systemd:
        name: wiki
        state: restarted

    - name: "ISO 9001 | 600013 | cleanup staging"
      ansible.builtin.file:
        path: "{{ backup_source_dir }}"
        state: absent
