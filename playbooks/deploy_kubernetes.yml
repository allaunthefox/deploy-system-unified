# =============================================================================
# Audit Event Identifier: DSU-PLY-100004
# Playbook Type: Kubernetes Deployment
# Description: Deploys the stack using K3s and Helm charts
# Last Updated: 2026-03-01
# Version: 1.1
# =============================================================================
---
# Kubernetes Deployment Playbook
# Deploys the stack using K3s and Helm charts

- name: "ISO 27001 §14.2 | 100004 | Setup Kubernetes Infrastructure"
  hosts: k8s_master
  become: true
  roles:
    - role: kubernetes/master
      tags: [kubernetes, master]

- name: "ISO 27001 §14.2 | 100004 | Join Kubernetes Nodes"
  hosts: k8s_nodes
  become: true
  vars:
    k3s_version: v1.31.4+k3s1
    k3s_install_dir: /var/lib/rancher/k3s
    k3s_server_url: ""
    k3s_node_token: ""

  tasks:
    - name: "ISO 9001 | 600013 | Check if K3s agent is running"
      ansible.builtin.systemd:
        name: k3s-agent
        state: started
      register: k3s_agent
      ignore_errors: true
      tags: [kubernetes, internal, 600013]

    - name: "ISO 27001 §8.20 | 820000 | Join node to cluster"
      when: k3s_server_url and k3s_node_token and not k3s_agent.failed
      block:
        - name: "ISO 27001 §8.19 | 530000 | Download K3s install script"
          ansible.builtin.get_url:
            url: https://get.k3s.io
            dest: /tmp/k3s-install.sh
            mode: '0700'
            owner: root
            group: root
          register: _k3s_script
          become: true
          tags: [kubernetes, security, 530000]

        - name: "ISO 27001 §8.20 | 820000 | Execute K3s installer for node join"
          ansible.builtin.command:
            cmd: /bin/bash /tmp/k3s-install.sh
            creates: /var/lib/rancher/k3s/agent/etc/k3s-agent.yaml
          become: true
          environment:
            K3S_URL: "{{ k3s_server_url }}"
            K3S_TOKEN: "{{ k3s_node_token }}"
            INSTALL_K3S_VERSION: "{{ k3s_version }}"
          vars:
            ansible_no_log: true
          tags: [kubernetes, deploy, 820000]

- name: "ISO 27001 §14.2 | 100004 | Deploy Helm Charts"
  hosts: k8s_master
  become: true
  vars:
    helm_charts:
      - name: auth-stack
        chart: charts/auth-stack
        namespace: auth
        state: present
      - name: backup-stack
        chart: charts/backup-stack
        namespace: backup
        state: present
      - name: logging-stack
        chart: charts/logging-stack
        namespace: logging
        state: present
      - name: media-stack
        chart: charts/media-stack
        namespace: media
        state: present
      - name: monitoring-stack
        chart: charts/monitoring-stack
        namespace: monitoring
        state: present
      - name: network-stack
        chart: charts/network-stack
        namespace: network
        state: present
      - name: ops-stack
        chart: charts/ops-stack
        namespace: ops
        state: present
      - name: proxy-stack
        chart: charts/proxy-stack
        namespace: proxy
        state: present
      - name: security-stack
        chart: charts/security-stack
        namespace: security
        state: present

  tasks:
    - name: "ISO 27001 §8.19 | 530000 | Install Helm if not present"
      block:
        - name: "ISO 9001 | 600013 | Check if Helm is installed"
          ansible.builtin.command:
            cmd: which helm
          register: helm_check
          failed_when: false
          changed_when: false
          tags: [helm, internal, 600013]

        - name: "ISO 27001 §8.19 | 530000 | Download Helm install script"
          ansible.builtin.get_url:
            url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
            dest: /tmp/get-helm-3.sh
            mode: '0700'
            owner: root
            group: root
          when: helm_check.rc != 0
          become: true
          tags: [helm, security, 530000]

        - name: "ISO 27001 §8.19 | 530000 | Execute Helm installer"
          ansible.builtin.command:
            cmd: /bin/bash /tmp/get-helm-3.sh
            creates: /usr/local/bin/helm
          when: helm_check.rc != 0
          become: true
          vars:
            ansible_no_log: true
          tags: [helm, deploy, 530000]

    - name: "ISO 27001 §8.22 | 700030 | Create Kubernetes namespaces"
      kubernetes.core.k8s:
        name: "{{ item.namespace }}"
        kind: Namespace
        state: present
      loop: "{{ helm_charts }}"
      ignore_errors: true
      tags: [kubernetes, deploy, 700030]

    - name: "ISO 27001 §8.20 | 700000 | Deploy Helm charts"
      kubernetes.core.helm:
        name: "{{ item.name }}"
        chart_ref: "{{ item.chart }}"
        namespace: "{{ item.namespace }}"
        state: "{{ item.state }}"
      loop: "{{ helm_charts }}"
      when: item.state == 'present'
      tags: [helm, deploy, 700000]

- name: "ISO 27001 §14.2 | 100004 | Validate Helm Deployments"
  hosts: k8s_master
  become: true
  tasks:
    - name: "ISO 9001 | 600013 | Wait for all deployments to be ready"
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: "{{ item }}"
      register: deployments
      until: >
        deployments.resources | length > 0 and
        deployments.resources | json_query('[].status.readyReplicas') | unique | first >= 1
      retries: 10
      delay: 30
      loop:
        - auth
        - backup
        - logging
        - media
        - monitoring
        - network
        - ops
        - proxy
        - security
      ignore_errors: true
      tags: [kubernetes, audit, 600013]
