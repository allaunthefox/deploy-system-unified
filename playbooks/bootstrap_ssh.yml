# =============================================================================
# Audit Event Identifier: DSU-PLY-100005
# Playbook Type: Bootstrap
# Description: Bootstrap SSH connectivity for all target hosts
# Last Updated: 2026-02-28
# Version: 1.0
# =============================================================================
---
- name: Bootstrap SSH connectivity (run on controller for all targets)
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    # Get all target hosts from the inventory (excluding localhost)
    target_hosts: "{{ groups['all'] | default([]) | difference(['localhost', 'local']) }}"
  pre_tasks:
    - name: Resolve bootstrap settings
      ansible.builtin.set_fact:
        ssh_bootstrap_timeout_effective: "{{ ssh_bootstrap_timeout | default(2) | int }}"
        ssh_bootstrap_scan_enabled_effective: "{{ ssh_bootstrap_scan_enabled | default(ssh_randomize_port | default(false)) | bool }}"
        ssh_bootstrap_scan_range_start_effective: "{{ ssh_bootstrap_scan_range_start | default(ssh_random_port_range_start | default(10000)) | int }}"
        ssh_bootstrap_scan_range_end_effective: "{{ ssh_bootstrap_scan_range_end | default(ssh_random_port_range_end | default(20000)) | int }}"
        ssh_bootstrap_scan_max_ports_effective: >-
          {{ (ssh_bootstrap_scan_max_ports is defined)
             | ternary(ssh_bootstrap_scan_max_ports | int,
                       (ssh_randomize_port | default(false)) | ternary(0, 200)) }}
        ssh_port_cache_dir_effective: >-
          {{ (ssh_port_cache_dir | default('') | trim | length > 0)
             | ternary(ssh_port_cache_dir, (inventory_dir | default(playbook_dir)) ~ '/.ssh_port_cache') }}
      changed_when: false

    - name: Ensure SSH port cache directory exists
      ansible.builtin.file:
        path: "{{ ssh_port_cache_dir_effective }}"
        state: directory
        mode: '0700'
      delegate_to: localhost
      changed_when: false

  tasks:
    - name: "CRITICAL: Bootstrap SSH for ALL target hosts (not just localhost)"
      ansible.builtin.include_tasks: tasks/bootstrap_ssh_per_host.yml
      loop: "{{ target_hosts }}"
      loop_control:
        loop_var: target_host
      when:
        - target_host is defined
        - target_host != 'localhost'
        - target_host != 'local'
