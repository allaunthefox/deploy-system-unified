# =============================================================================
# Audit Event Identifier: DSU-PLY-100011
# Playbook Type: Restore Operations
# Description: Forensic data restoration with integrity verification
# Compliance: ISO 27040 ยง10.2
# Last Updated: 2026-02-28
# Version: 1.0
# =============================================================================
---
- ansible.builtin.import_playbook: bootstrap_ssh.yml

- name: Preflight - Verify backup integrity before restore
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Check for hash verification tools
      ansible.builtin.command: which sha256sum sha512sum openssl
      register: hash_tools_check
      changed_when: false
      failed_when: false

    - name: Fail if hash tools missing
      ansible.builtin.fail:
        msg: "Hash verification tools required for restore"
      when: hash_tools_check.rc != 0

    - name: Check for hash manifest
      ansible.builtin.stat:
        path: "/var/backups/security/hash_manifest.txt"
      register: hash_manifest_check

    - name: Fail if no hash manifest found during restore
      ansible.builtin.fail:
        msg: "CRITICAL: No hash manifest found. Cannot verify backup integrity. Restore aborted for security."
      when: not hash_manifest_check.stat.exists

- name: Restore Migration Data
  hosts: all
  become: true
  vars:
    migration_source: "{{ playbook_dir }}/../migration_assets"
    # Destination Paths (Must match role defaults)
    containers_media_config_dir: "/srv/containers/media_config/default"
    ops_config_dir: "/srv/containers/ops_config"
    containers_media_puid: 1000
    containers_media_pgid: 1000

  tasks:
    # -------------------------------------------------------
    # 1. FILE-BASED RESTORATIONS (SQLite & Configs)
    # -------------------------------------------------------

    # Jellyfin
    - name: Ensure Jellyfin config dir exists
      ansible.builtin.file:
        path: "{{ containers_media_config_dir }}/jellyfin/data"
        state: directory
        recurse: true
        owner: "{{ containers_media_puid }}"
        group: "{{ containers_media_pgid }}"

    - name: "ISO 27040 | 900010 | Restore Jellyfin DB"
      ansible.builtin.copy:
        src: "{{ migration_source }}/databases/jellyfin.db"
        dest: "{{ containers_media_config_dir }}/jellyfin/data/jellyfin.db"
        owner: "{{ containers_media_puid }}"
        group: "{{ containers_media_pgid }}"
        mode: '0644'
      tags:
        - iso_27040
        - 900010
        - restore
        - jellyfin

    # Radarr (Root config dir usually contains radarr.db)
    - name: "ISO 27040 | 900010 | Restore Radarr DB"
      ansible.builtin.copy:
        src: "{{ migration_source }}/databases/radarr.db"
        dest: "{{ containers_media_config_dir }}/radarr/radarr.db"
        owner: "{{ containers_media_puid }}"
        group: "{{ containers_media_pgid }}"
        mode: '0644'
      tags:
        - iso_27040
        - 900010
        - restore
        - radarr

    # Sonarr
    - name: "ISO 27040 | 900010 | Restore Sonarr DB"
      ansible.builtin.copy:
        src: "{{ migration_source }}/databases/sonarr.db"
        dest: "{{ containers_media_config_dir }}/sonarr/sonarr.db"
        owner: "{{ containers_media_puid }}"
        group: "{{ containers_media_pgid }}"
        mode: '0644'
      tags:
        - iso_27040
        - 900010
        - restore
        - sonarr

    # Vaultwarden (Volume Archive)
    - name: Ensure Vaultwarden dir
      ansible.builtin.file:
        path: "{{ ops_config_dir }}/vaultwarden"
        state: directory
        owner: "{{ containers_media_puid }}"
        group: "{{ containers_media_pgid }}"

    - name: List Vaultwarden archive contents before extraction
      ansible.builtin.shell:
        cmd:  tar -tf "{{ migration_source }}/databases/volumes/vaultwarden.tar"
        executable: /bin/sh
      register: _vaultwarden_archive_contents
      changed_when: false
      vars:
        ansible_no_log: true

    - name: Validate Vaultwarden archive doesn't contain path traversal
      ansible.builtin.assert:
        that:
          - "_vaultwarden_archive_contents.stdout_lines | select('search', '\\.\\./') | list | length == 0"
          - "_vaultwarden_archive_contents.stdout_lines | select('match', '^/') | list | length == 0"
        fail_msg: >
          CRITICAL: Vaultwarden archive contains path traversal sequences (../ or absolute paths).
          This may indicate a malicious archive. Aborting extraction.
          Files found: {{ _vaultwarden_archive_contents.stdout_lines | select('search', '\\.\\./|/^') | list }}
      vars:
        ansible_no_log: true

    - name: "ISO 27040 | 900010 | Restore Vaultwarden Data (safe extraction)"
      ansible.builtin.unarchive:
        src: "{{ migration_source }}/databases/volumes/vaultwarden.tar"
        dest: "{{ ops_config_dir }}/vaultwarden"
        owner: "{{ containers_media_puid }}"
        group: "{{ containers_media_pgid }}"
      when: _vaultwarden_archive_contents.stdout_lines | select('search', '\\.\\./') | list | length == 0
      vars:
        ansible_no_log: true
      tags:
        - iso_27040
        - 900010
        - restore
        - vaultwarden

    # Homarr
    - name: List Homarr archive contents before extraction
      ansible.builtin.shell:
        cmd:  tar -tf "{{ migration_source }}/databases/volumes/homarr.tar"
        executable: /bin/sh
      register: _homarr_archive_contents
      changed_when: false
      vars:
        ansible_no_log: true

    - name: Validate Homarr archive doesn't contain path traversal
      ansible.builtin.assert:
        that:
          - "_homarr_archive_contents.stdout_lines | select('search', '\\.\\./') | list | length == 0"
          - "_homarr_archive_contents.stdout_lines | select('match', '^/') | list | length == 0"
        fail_msg: >
          CRITICAL: Homarr archive contains path traversal sequences (../ or absolute paths).
          This may indicate a malicious archive. Aborting extraction.
          Files found: {{ _homarr_archive_contents.stdout_lines | select('search', '\\.\\./|/^') | list }}
      vars:
        ansible_no_log: true

    - name: "ISO 27040 | 900010 | Restore Homarr Data (safe extraction)"
      ansible.builtin.unarchive:
        src: "{{ migration_source }}/databases/volumes/homarr.tar"
        dest: "{{ ops_config_dir }}/homarr"
        owner: "{{ containers_media_puid }}"
        group: "{{ containers_media_pgid }}"
      when: _homarr_archive_contents.stdout_lines | select('search', '\\.\\./') | list | length == 0
      vars:
        ansible_no_log: true
      tags:
        - iso_27040
        - 900010
        - restore
        - homarr

    # Wastebin
    - name: List Wastebin archive contents before extraction
      ansible.builtin.shell:
        cmd:  tar -tf "{{ migration_source }}/databases/volumes/wastebin.tar"
        executable: /bin/sh
      register: _wastebin_archive_contents
      changed_when: false
      vars:
        ansible_no_log: true

    - name: Validate Wastebin archive doesn't contain path traversal
      ansible.builtin.assert:
        that:
          - "_wastebin_archive_contents.stdout_lines | select('search', '\\.\\./') | list | length == 0"
          - "_wastebin_archive_contents.stdout_lines | select('match', '^/') | list | length == 0"
        fail_msg: >
          CRITICAL: Wastebin archive contains path traversal sequences (../ or absolute paths).
          This may indicate a malicious archive. Aborting extraction.
          Files found: {{ _wastebin_archive_contents.stdout_lines | select('search', '\\.\\./|/^') | list }}
      vars:
        ansible_no_log: true

    - name: "ISO 27040 | 900010 | Restore Wastebin Data (safe extraction)"
      ansible.builtin.unarchive:
        src: "{{ migration_source }}/databases/volumes/wastebin.tar"
        dest: "{{ ops_config_dir }}/wastebin"
        owner: "{{ containers_media_puid }}"
        group: "{{ containers_media_pgid }}"
      when: _wastebin_archive_contents.stdout_lines | select('search', '\\.\\./') | list | length == 0
      vars:
        ansible_no_log: true
      tags:
        - iso_27040
        - 900010
        - restore
        - wastebin

    # -------------------------------------------------------
    # 2. POSTGRESQL RESTORATIONS (Authentik & Wiki.js)
    # -------------------------------------------------------
    # Requires containers to be running.

    - name: Copy Authentik SQL to Host Tmp
      ansible.builtin.copy:
        src: "{{ migration_source }}/databases/postgres/authentik.sql"
        dest: "/tmp/authentik.sql"

    - name: "ISO 27001 ยง12.4 | 560000 | Wait for Authentik DB"
      ansible.builtin.command: podman exec -i authentik-db-default pg_isready -U postgres
      register: db_check
      retries: 30
      delay: 2
      until: db_check.rc == 0
      failed_when: false
      changed_when: false
      tags:
        - iso_27001_12_4
        - 560000
        - restore
        - database

    - name: "ISO 27040 | 560022 | Drop & Create Authentik DB (Fresh Install State)"
      ansible.builtin.command: |
        podman exec -i authentik-db-default psql -U postgres -c "DROP DATABASE IF EXISTS authentik; CREATE DATABASE authentik;"
      when: db_check.rc == 0
      tags:
        - iso_27040
        - 560022
        - restore
        - database
        - authentik

    - name: "ISO 27040 | 560023 | Import Authentik Dump"
      ansible.builtin.shell:
        cmd:  podman exec -i authentik-db-default psql -U postgres -d authentik < /tmp/authentik.sql
        executable: /bin/sh
      when: db_check.rc == 0
      register: import_result
      tags:
        - iso_27040
        - 560023
        - restore
        - database
        - authentik

    - name: Debug Import
      ansible.builtin.debug:
        var: import_result

    - name: "ISO 27001 ยง8.8 | 600142 | Cleanup Authentik SQL"
      ansible.builtin.file:
        path: "/tmp/authentik.sql"
        state: absent
      tags:
        - iso_27001_8_8
        - 600142
        - cleanup
        - authentik

    # -------------------------------------------------------
    # 3. PERMISSIONS FIX
    # -------------------------------------------------------
    - name: "ISO 27001 ยง8.8 | 600142 | Fix Recursive Permissions"
      ansible.builtin.file:
        path: "{{ item }}"
        owner: "{{ containers_media_puid }}"
        group: "{{ containers_media_pgid }}"
        recurse: true
      loop:
        - "{{ containers_media_config_dir }}"
        - "{{ ops_config_dir }}"
      tags:
        - iso_27001_8_8
        - 600142
        - permissions
        - drift_correction
