name: HashiCorp Vault Secrets

on:
  workflow_dispatch:
    inputs:
      secrets:
        description: 'Comma-separated list of secret paths (e.g., secret/data/deploy/prod,secret/data/deploy/staging)'
        required: false
        default: ''

jobs:
  vault-secrets:
    name: Fetch Vault Secrets
    runs-on: ubuntu-latest
    outputs:
      secrets: ${{ steps.secrets.outputs.secrets }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Retrieve Vault Secrets
        id: secrets
        uses: hashicorp/vault-action@v3.4.0
        with:
          url: ${{ vars.VAULT_ADDR }}
          namespace: ${{ vars.VAULT_NAMESPACE }}
          method: token
          token: ${{ secrets.VAULT_TOKEN }}
          secrets: |
            secret/data/deploy/prod AWS_ACCESS_KEY_ID | AWS_ACCESS_KEY_ID;
            secret/data/deploy/prod AWS_SECRET_ACCESS_KEY | AWS_SECRET_ACCESS_KEY;
            secret/data/deploy/prod DEPLOY_PASSWORD | DEPLOY_PASSWORD

      - name: Print Secrets (Debug)
        run: |
          echo "AWS Access Key ID: ${AWS_ACCESS_KEY_ID:0:4}..."
          echo "Deploy Password set: ${{ steps.secrets.outputs.DEPLOY_PASSWORD != '' }}"

      - name: Deploy (Example)
        env:
          AWS_ACCESS_KEY_ID: ${{ steps.secrets.outputs.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ steps.secrets.outputs.AWS_SECRET_ACCESS_KEY }}
          DEPLOY_PASSWORD: ${{ steps.secrets.outputs.DEPLOY_PASSWORD }}
        run: |
          # Your deployment commands here
          echo "Deploying with Vault secrets..."
