# =============================================================================
# Audit Event Identifier: DSU-CIC-600001
# Pipeline Type: Idempotence Testing
# Description: Runs playbook twice and asserts zero changes on second run
# Trigger: push, pull_request
# Last Updated: 2026-02-28
# Version: 1.0
# =============================================================================
---
# Idempotence Test Pipeline
# Runs playbook twice and asserts zero changes on second run

name: Idempotence Test

on:
  push:
    branches: [main, 'ci/**']
  pull_request:
    branches: [main]

# Explicit permissions for GITHUB_TOKEN (least privilege)
permissions:
  contents: read
  actions: read

jobs:
  idempotence:
    name: Test Playbook Idempotence
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      matrix:
        playbook:
          - playbooks/base_hardened.yml
          - playbooks/production_deploy.yml

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          ansible-galaxy collection install -r requirements.yml --force

      - name: First run (apply changes)
        run: |
          ansible-playbook ${{ matrix.playbook }} \
            -i inventory/local.ini \
            --connection=local \
            --diff \
            2>&1 | tee /tmp/first_run.log
        continue-on-error: true

      - name: Second run (assert idempotence)
        run: |
          ansible-playbook ${{ matrix.playbook }} \
            -i inventory/local.ini \
            --connection=local \
            --diff \
            --check \
            2>&1 | tee /tmp/second_run.log

      - name: Check for changes in second run
        run: |
          if grep -q '"changed": true' /tmp/second_run.log || grep -q 'changed=1' /tmp/second_run.log; then
            echo "::error::Idempotence test failed! Second run detected changes."
            echo "::error::See logs above for details."
            echo ""
            echo "=== Second run output ==="
            cat /tmp/second_run.log
            exit 1
          else
            echo "::notice::Idempotence test passed! No changes on second run."
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: idempotence-logs-${{ matrix.playbook | basename }}
          path: |
            /tmp/first_run.log
            /tmp/second_run.log
