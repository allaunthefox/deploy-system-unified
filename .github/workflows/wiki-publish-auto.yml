name: Wiki Auto Publish

# Automatic publish of `wiki_pages/` to the repository Wiki.
# This workflow is intentionally gated and guarded:
# - Requires repository secret `WIKI_PUBLISH_ENABLED` == "true" to actually run the publish step
# - Requires `WIKI_PAT` repo secret (PAT with repo scope) or a configured deploy key
# - Uses an `environment: wiki-publish` so you can require manual reviewers/approvals

on:
  push:
    branches: [ main ]

jobs:
  publish:
    if: ${{ secrets.WIKI_PUBLISH_ENABLED == 'true' }}
    runs-on: ubuntu-latest
    environment: wiki-publish
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Run generator and linter (ensure up-to-date)
        run: |
          python3 .scripts/generate_role_pages.py
          # If generator produced changes on main, fail and surface diffs (so changes are committed via PR and audited)
          if [ -n "$(git status --porcelain)" ]; then
            echo "Generator produced changes on main. Please commit generated files before publishing." >&2
            git --no-pager status --porcelain
            git --no-pager diff --name-only
            exit 2
          fi
          python3 .scripts/wiki_wiki_lint.py --json > wiki-lint.json || true
          cat wiki-lint.json
          jq '{errors: (.errors | length), warnings: (.warnings | length)}' wiki-lint.json
          if [ $(jq '.errors' wiki-lint.json) -ne 0 ]; then echo 'Errors detected'; exit 2; fi
          if [ $(jq '.warnings' wiki-lint.json) -ne 0 ]; then echo 'Warnings detected'; exit 1; fi

      - name: Clone wiki repo and push (support SSH deploy key)
        env:
          WIKI_PAT: ${{ secrets.CI_ARTIFACT_PAT }}
          WIKI_SSH_KEY: ${{ secrets.WIKI_SSH_KEY }}
          SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}
        run: |
          set -x
          # Prefer SSH deploy key when present, else fall back to PAT-based HTTPS
          if [ -n "$WIKI_SSH_KEY" ] || [ -n "$SSH_DEPLOY_KEY" ]; then
            echo "Using SSH deploy key for wiki publish"
            mkdir -p ~/.ssh
            deploy_key_file=~/.ssh/wiki_deploy_key
            if [ -n "$WIKI_SSH_KEY" ]; then
              echo "$WIKI_SSH_KEY" > "$deploy_key_file"
            else
              echo "$SSH_DEPLOY_KEY" > "$deploy_key_file"
            fi
            chmod 600 "$deploy_key_file"
            # If passphrase provided, decrypt encrypted PEM into a usable key
            if [ -n "${WIKI_SSH_PASSPHRASE:-}" ]; then
              echo "Decrypting encrypted PEM"
              openssl pkey -in "$deploy_key_file" -passin pass:"$WIKI_SSH_PASSPHRASE" -out "${deploy_key_file}.dec"
              mv "${deploy_key_file}.dec" "$deploy_key_file"
              chmod 600 "$deploy_key_file"
            fi
            eval "$(ssh-agent -s)"
            ssh-add "$deploy_key_file"
            # Ensure GitHub is in known_hosts
            ssh-keyscan -H github.com >> ~/.ssh/known_hosts
            git clone "git@github.com:${{ github.repository }}.wiki.git" wiki-repo || (echo 'ssh clone failed' && ls -la && git remote -v && exit 4)
          else
            if [ -z "$WIKI_PAT" ]; then
              echo "WIKI_PAT is not set and no SSH key found; aborting publish"; exit 1
            fi
            WIKI_GIT_URL="https://x-access-token:${WIKI_PAT}@github.com/${{ github.repository }}.wiki.git"
            git clone "$WIKI_GIT_URL" wiki-repo || (echo 'clone failed' && ls -la && git remote -v && exit 4)
          fi
          rsync -av --delete wiki_pages/ wiki-repo/
          cd wiki-repo
          git add -A
          git commit -m "chore(wiki): publish wiki_pages from main (auto-run)" || echo "No changes to commit"
          git push origin master || git push origin main || (echo "Push failed" && exit 1)

      - name: Publish complete
        run: echo "Wiki publish attempted (see previous steps for result)."
