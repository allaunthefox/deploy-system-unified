name: "Forensic Naming Enforcer"

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'roles/**/*.yml'
      - 'playbooks/**/*.yml'

jobs:
  enforce-naming:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "ISO 27001 §12.2 | 520030 | Scan for non-compliant task names"
        run: |
          errors=0
          # Find all task files
          while IFS= read -r file; do
            # Grep for task names that don't match the pattern [Standard] | [6-digit code] | [Name]
            # Pattern: - name: "Standard | 123456 | Name"
            # Note: Allowing for single or double quotes
            # This regex looks for: line start, optional spaces, '- name:', quote, any chars, pipe, spaces, 6 digits, pipe, any chars, quote
            # shellcheck disable=SC2086  # pattern requires word splitting
  non_compliant=$(grep -Hn "^[[:space:]]*- name: [\"'][^|]* | [0-9]\{6\} | .*[\"']" "$file" -v | grep -v "^[[:space:]]*#" || true)
            
            # Additional check: Skip simple debug/set_fact tasks if they aren't marked as critical
            # But here we enforce it for ALL names in specified paths for maximum forensic fidelity
            if [ -n "$non_compliant" ]; then
              echo "❌ Non-compliant task names found in $file:"
              echo "$non_compliant"
              errors=$((errors + 1))
            fi
          done < <(find roles playbooks -name "*.yml" -not -path "*/molecule/*")

          if [ $errors -gt 0 ]; then
            echo "::error::Found $errors files with non-compliant forensic names. Every task must follow: [Standard] | [Action Code] | [Name]"
            exit 1
          else
            echo "✅ All task names follow forensic standards."
          fi
