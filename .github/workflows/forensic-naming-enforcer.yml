# =============================================================================
# Audit Event Identifier: DSU-CIC-600003
# Pipeline Type: Forensic Naming Enforcement
# Description: Validates Ansible forensic naming conventions
# Trigger: pull_request (roles/**/*.yml, playbooks/**/*.yml)
# Last Updated: 2026-02-28
# Version: 1.0
# =============================================================================
name: "Forensic Naming Enforcer"

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'roles/**/*.yml'
      - 'playbooks/**/*.yml'

# Explicit permissions for GITHUB_TOKEN (least privilege)
permissions:
  contents: read
  pull-requests: read

jobs:
  enforce-naming:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "ISO 27001 ยง12.2 | 520030 | Scan for non-compliant task names"
        continue-on-error: true
        run: |
          errors=0
          # Exclude meta/main.yml as they contain OS lists that trigger false positives
          while IFS= read -r file; do
            # 1. Extract all lines that look like task/play names
            # 2. Filter out names that follow the forensic pattern
            # 3. Filter out common false positives (indented list items like OS names in meta)
            # Pattern explanation: Standard(s) | CODE/Audit Code | Description
            non_compliant=$(grep -n -E "^[[:space:]]*- name:" "$file" | \
              grep -v '^[[:space:]]*#' | \
              grep -v -E " - name:[[:space:]]*[\"'][^|]+[|][[:space:]]*([^|]+[|][[:space:]]*)?([0-9]{6}|[DSU]|Audit Code|Audit Code [0-9]{6})[[:space:]]*[|]" || true)
            
            if [ -n "$non_compliant" ]; then
              # Final filter: ensure we aren't flagging simple list items (more than 4 spaces of indentation)
              filtered_non_compliant=""
              while IFS= read -r line; do
                indent=$(echo "$line" | sed -E 's/^([[:space:]]*).*/\1/' | wc -c)
                if [ "$indent" -le 6 ]; then
                  filtered_non_compliant="${filtered_non_compliant}${line}\n"
                fi
              done <<< "$non_compliant"
              
              if [ -n "$filtered_non_compliant" ] && [ "$filtered_non_compliant" != "\n" ]; then
                echo "Non-compliant task names found in $file:"
                echo -e "$filtered_non_compliant"
                errors=$((errors + 1))
              fi
            fi
          done < <(find roles playbooks -name "*.yml" -not -path "*/molecule/*" -not -name "meta/main.yml" -not -path "*/venv/*" -not -path "*/Offline_Research/*")

          if [ $errors -gt 0 ]; then
            echo "::error::Found $errors files with non-compliant forensic names."
            exit 1
          else
            echo "All task names follow forensic standards."
          fi
