name: Wiki PR Checks

on:
  pull_request:
    paths:
      - 'wiki_pages/**'
      - 'wiki_audit/**'
      - 'wiki_crowdsec_audit/**'
      - 'wiki_clean_sync/**'
      - 'projects/deploy-system-unified/docs/**'

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Run generator
        run: |
          python3 .scripts/generate_role_pages.py
          # Check for any files that the generator would change (fail the job so authors include them in PR)
          if [ -n "$(git status --porcelain)" ]; then
            echo "Generator produced changes; please run .scripts/generate_role_pages.py locally and include the results in your PR." >&2
            git --no-pager status --porcelain
            git --no-pager diff --name-only
            exit 2
          fi

      - name: Run wiki linter
        run: |
          python3 .scripts/wiki_wiki_lint.py --json > wiki-lint.json || true
          cat wiki-lint.json
          jq '{errors: (.errors | length), warnings: (.warnings | length)}' wiki-lint.json
          if [ $(jq '.errors' wiki-lint.json) -ne 0 ]; then echo 'Errors detected'; exit 2; fi
          if [ $(jq '.warnings' wiki-lint.json) -ne 0 ]; then echo 'Warnings detected'; exit 1; fi
        shell: bash
