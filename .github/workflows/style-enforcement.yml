# =============================================================================
# Audit Event Identifier: DSU-CIC-600002
# Pipeline Type: Style Guide Enforcement
# Description: Validates code style for Ansible, Python, Shell, YAML
# Trigger: push, pull_request
# Last Updated: 2026-02-28
# Version: 1.0
# =============================================================================
---
name: Style Guide Enforcement

# yamllint disable-line rule:truthy
on:
  push:
    branches:
      - main
      - 'ci/**'
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

env:
  # CI vault password for decrypting test fixtures
  ANSIBLE_VAULT_PASSWORD_FILE: /tmp/ci_vault_pass

jobs:
  style-enforcement:
    name: Run style guide enforcement
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create CI vault password file
        run: |
          echo "ci_test_password" > /tmp/ci_vault_pass
          chmod 600 /tmp/ci_vault_pass

      # yamllint disable rule:line-length
      - name: Make script executable
        run: |
          chmod +x dev_tools/tools/style-guide-enforcement/enforce_style_guide.sh
      # yamllint enable rule:line-length

      - name: Run enforcement (generate report)
        run: |
          set -o pipefail
          # Ensure style tools are available in the runner
          python -m pip install --upgrade pip || true
          python -m pip install --upgrade ansible-lint yamllint flake8 black || true
          SCRIPT=dev_tools/tools/style-guide-enforcement
          ./$SCRIPT/enforce_style_guide.sh --report || echo $? > .enforce_status
        continue-on-error: true

      - name: List reports
        run: |
          SCRIPT=dev_tools/tools/style-guide-enforcement
          ls -l $SCRIPT || true

      - name: Install jq (needed for report comments)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Upload compliance report
        uses: actions/upload-artifact@v4
        with:
          name: style-compliance-report
          path: |
            dev_tools/tools/style-guide-enforcement/compliance_report_*.md

      - name: Comment on PR with compliance report
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        # yamllint disable rule:line-length
        run: |
          set -x
          SCRIPT_DIR=dev_tools/tools/style-guide-enforcement
          if [ -f .enforce_status ]; then
            report_file=$(ls -t $SCRIPT_DIR/compliance_report_*.md 2>/dev/null | head -n1)
            echo "PR_NUMBER=$PR_NUMBER report_file=$report_file"
            if [ -z "$report_file" ]; then
              echo "No report found to post"
              exit 0
            fi
            report=$(sed 's/```/` ` `/g' "$report_file")
            echo "$report" | head -c 2000 > /tmp/report_snippet.txt || true
            echo "$report" > /tmp/report_full.txt || true
            # Build JSON body using Python for robust escaping
            python3 <<'PY' > /tmp/body.json
          import json
          with open('/tmp/report_full.txt', 'r', encoding='utf-8') as f:
              rpt = f.read()
          body = {"body": "### Style Guide Enforcement Report\n\nThe style enforcement job found issues. See report below:\n\n<details><summary>Click to expand report</summary>\n\n```\n" + rpt + "\n```\n</details>\n\nIf you'd like me to apply auto-fixable changes, reply with `--fix` and I can prepare a PR."}
          print(json.dumps(body))
          PY
            cat /tmp/body.json || true
            REPO_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}"
            http_code=$(curl -s -o /tmp/comment_response -w "%{http_code}" \
              -X POST -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              --data @/tmp/body.json "$REPO_URL/issues/$PR_NUMBER/comments")
            if [ "$http_code" -ne 201 ]; then
              echo "Failed to post comment: HTTP $http_code"
              echo "Response:"
              cat /tmp/comment_response || true
              echo "Continuing without failing the job"
            else
              echo "Comment posted successfully"
            fi
          else
            echo "No style issues detected; no comment posted"
          fi
        # yamllint enable rule:line-length

      - name: Comment on PR on success
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        # yamllint disable rule:line-length
        run: |
          if [ ! -f .enforce_status ]; then
            body='{"body":"âœ… Style enforcement passed. No issues detected. Good job!"}'
            REPO_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}"
            curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              --data "$body" "$REPO_URL/issues/$PR_NUMBER/comments"
          else
            echo "Issues were detected; not posting success message"
          fi
        # yamllint enable rule:line-length

      - name: Upload PR comment debug artifacts
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: pr-comment-debug
          path: |
            /tmp/comment_response
            /tmp/body.json
            /tmp/report_snippet.txt

      - name: Fail if enforcement found issues
        run: |
          if [ -f .enforce_status ]; then
            echo "Style enforcement detected issues"
            echo "Failing job with code $(cat .enforce_status)"
            exit $(cat .enforce_status)
          fi
