name: Style Guide Enforcement

on:
  push:
    branches: [ main, 'ci/**' ]
  pull_request:
    branches: [ main ]

jobs:
  style-enforcement:
    name: Run style guide enforcement
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make script executable
        run: chmod +x projects/deploy-system-unified/dev_tools/tools/style-guide-enforcement/enforce_style_guide.sh

      - name: Run enforcement (generate report)
        run: |
          set -o pipefail
          ./projects/deploy-system-unified/dev_tools/tools/style-guide-enforcement/enforce_style_guide.sh --report || echo $? > .enforce_status
        continue-on-error: true

      - name: List reports
        run: ls -l projects/deploy-system-unified/dev_tools/tools/style-guide-enforcement || true

      - name: Install jq (needed for report comments)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Upload compliance report
        uses: actions/upload-artifact@v4
        with:
          name: style-compliance-report
          path: projects/deploy-system-unified/dev_tools/tools/style-guide-enforcement/compliance_report_*.md

      - name: Comment on PR with compliance report
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -x
          if [ -f .enforce_status ]; then
            report_file=$(ls -t projects/deploy-system-unified/dev_tools/tools/style-guide-enforcement/compliance_report_*.md 2>/dev/null | head -n1)
            echo "PR_NUMBER=$PR_NUMBER report_file=$report_file"
            if [ -z "$report_file" ]; then
              echo "No report found to post"
              exit 0
            fi
            report=$(sed 's/```/` ` `/g' "$report_file")
            # write report snippet and full report to tmp files for debugging
            echo "$report" | head -c 2000 > /tmp/report_snippet.txt || true
            echo "$report" > /tmp/report_full.txt || true
            # Build JSON body using Python for robust escaping
            python - <<'PY' > /tmp/body.json
import json
with open('/tmp/report_full.txt','r',encoding='utf-8') as f:
    rpt = f.read()
body = {"body": "### Style Guide Enforcement Report\n\nThe style enforcement job found issues. See report below:\n\n<details><summary>Click to expand report</summary>\n\n```\n" + rpt + "\n```\n</details>\n\nIf you'd like me to apply auto-fixable changes, reply with `--fix` and I can prepare a PR."}
print(json.dumps(body))
PY
            cat /tmp/body.json || true
            http_code=$(curl -s -o /tmp/comment_response -w "%{http_code}" -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/json" --data @/tmp/body.json "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/$PR_NUMBER/comments")
            if [ "$http_code" -ne 201 ]; then
              echo "Failed to post comment: HTTP $http_code"
              echo "Response:"
              cat /tmp/comment_response || true
              echo "Continuing without failing the job"
            else
              echo "Comment posted successfully"
            fi
          else
            echo "No style issues detected; no comment posted"
          fi

      - name: Comment on PR on success
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [ ! -f .enforce_status ]; then
            body='{"body":"âœ… Style enforcement passed. No issues detected. Good job!"}'
            curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/json" \
              --data "$body" "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/$PR_NUMBER/comments"
          else
            echo "Issues were detected; not posting success message"
          fi

      - name: Upload PR comment debug artifacts
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: pr-comment-debug
          path: |
            /tmp/comment_response
            /tmp/body.json
            /tmp/report_snippet.txt

      - name: Fail if enforcement found issues
        run: |
          if [ -f .enforce_status ]; then
            echo "Style enforcement detected issues; failing job with code $(cat .enforce_status)"
            exit $(cat .enforce_status)
          fi