name: SSHD Idempotence Test

on:
  push:
    branches: [ main, 'chore/*' ]
  pull_request:
    branches: [ main ]

jobs:
  idempotence:
    name: Run idempotence verification in container
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run idempotence test on runner
        run: |
          set -euo pipefail
          # Install minimal deps on runner and run the idempotence playbook directly (avoids Docker mount issues)
          export ANSIBLE_ROLES_PATH="$GITHUB_WORKSPACE/roles:$GITHUB_WORKSPACE"
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends openssh-server python3 python3-pip ca-certificates apt-transport-https gnupg wget
          curl -sL https://github.com/mozilla/sops/releases/download/v3.9.1/sops-v3.9.1.linux -o /usr/local/bin/sops && sudo chmod +x /usr/local/bin/sops
          sudo pip3 install --no-cache-dir "ansible-core>=2.15,<2.16"
          # Confirm paths and run playbook
          ls -la "$GITHUB_WORKSPACE" || true
          ls -la "$GITHUB_WORKSPACE/roles" || true
          if [ -f "$GITHUB_WORKSPACE/roles/security/sshd/tests/idempotence.yml" ]; then
            PLAYBOOK="$GITHUB_WORKSPACE/roles/security/sshd/tests/idempotence.yml"
          elif [ -f "$GITHUB_WORKSPACE/deploy-system-unified/roles/security/sshd/tests/idempotence.yml" ]; then
            PLAYBOOK="$GITHUB_WORKSPACE/deploy-system-unified/roles/security/sshd/tests/idempotence.yml"
          else
            echo "ERROR: idempotence playbook not found on runner"; ls -la "$GITHUB_WORKSPACE" || true; exit 2
          fi
          ansible-playbook "$PLAYBOOK" --connection=local
