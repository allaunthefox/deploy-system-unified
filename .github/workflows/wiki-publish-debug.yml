name: Wiki Publish Debug

# Manual debug workflow to run publish steps in dry-run mode with verbose logging.
# Only to be used temporarily and removed after debugging.

on:
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'dry-run or real (default dry-run)'
        required: false
        default: 'dry-run'

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git --version
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Debug info
        run: |
          echo "RUN MODE: ${{ github.event.inputs.run_mode }}"
          echo "Repo: ${{ github.repository }}"
          echo "BRANCH: ${{ github.ref }}"
          echo "Secrets present: CI_ARTIFACT_PAT=${{ secrets.CI_ARTIFACT_PAT != '' }}"
          env | sort

      - name: Try API read of wiki repo refs
        env:
          WIKI_PAT: ${{ secrets.WIKI_PAT }}
          CI_PAT: ${{ secrets.CI_ARTIFACT_PAT }}
          WIKI_REPO_API: "https://api.github.com/repos/${{ github.repository }}.wiki"
        run: |
          set -x
          # Prefer WIKI_PAT, fall back to CI_ARTIFACT_PAT, and strip newlines
          if [ -n "${WIKI_PAT:-}" ]; then
            PAT="$(echo "$WIKI_PAT" | tr -d '\r\n')"
          else
            PAT="$(echo "${CI_PAT:-}" | tr -d '\r\n')"
          fi
          if [ -z "$PAT" ]; then echo "No token set (WIKI_PAT or CI_ARTIFACT_PAT)"; exit 3; fi
          echo "GET refs via API:"
          curl -i -s -H "Authorization: token $PAT" "$WIKI_REPO_API/git/refs" | sed -n '1,80p'

      - name: SSH auth debug
        run: |
          set -x
          # Try adding any provided key to the agent and do a verbose auth test so we can see what GitHub accepts
          if [ -n "${{ secrets.WIKI_SSH_KEY }}" ] || [ -n "${{ secrets.SSH_DEPLOY_KEY }}" ]; then
            mkdir -p ~/.ssh
            deploy_key_file=~/.ssh/wiki_deploy_key
            if [ -n "${{ secrets.WIKI_SSH_KEY }}" ]; then
              printf '%s\n' "${{ secrets.WIKI_SSH_KEY }}" > "$deploy_key_file" || true
            else
              printf '%s\n' "${{ secrets.SSH_DEPLOY_KEY }}" > "$deploy_key_file" || true
            fi
            chmod 600 "$deploy_key_file" || true
            eval "$(ssh-agent -s)" || true
            ssh-add "$deploy_key_file" || true
          fi
          ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -vT git@github.com || true

      - name: Clone wiki repo (verbose, SSH fallback)
        env:
          CI_PAT: ${{ secrets.CI_ARTIFACT_PAT }}
          WIKI_PAT: ${{ secrets.WIKI_PAT }}
          WIKI_SSH_KEY: ${{ secrets.WIKI_SSH_KEY }}
          SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}
          WIKI_SSH_PASSPHRASE: ${{ secrets.WIKI_SSH_PASSPHRASE }}
        run: |
          set -x
          # Strip newlines from tokens to avoid URL parse errors
          SAFE_WIKI_PAT="$(echo "${WIKI_PAT:-}" | tr -d '\r\n')"
          SAFE_CI_PAT="$(echo "${CI_PAT:-}" | tr -d '\r\n')"
          # Prefer SSH deploy key when present, otherwise use WIKI_PAT or CI_PAT for HTTPS
          if [ -n "$WIKI_SSH_KEY" ] || [ -n "$SSH_DEPLOY_KEY" ]; then
            echo "Using SSH deploy key for clone"
            mkdir -p ~/.ssh
            deploy_key_file=~/.ssh/wiki_deploy_key
            if [ -n "$WIKI_SSH_KEY" ]; then
              printf '%s\n' "$WIKI_SSH_KEY" > "$deploy_key_file"
            else
              printf '%s\n' "$SSH_DEPLOY_KEY" > "$deploy_key_file"
            fi
            chmod 600 "$deploy_key_file"
            # If passphrase provided, decrypt encrypted PEM
            if [ -n "${WIKI_SSH_PASSPHRASE:-}" ]; then
              echo "Decrypting encrypted PEM"
              openssl pkey -in "$deploy_key_file" -passin pass:"$WIKI_SSH_PASSPHRASE" -out "${deploy_key_file}.dec"
              mv "${deploy_key_file}.dec" "$deploy_key_file"
              chmod 600 "$deploy_key_file"
            fi
            eval "$(ssh-agent -s)"
            ssh-add "$deploy_key_file"
            ssh-keyscan -H github.com >> ~/.ssh/known_hosts
            git clone "git@github.com:${{ github.repository }}.wiki.git" wiki-repo || (echo 'ssh clone failed' && ls -la && git remote -v && exit 4)
          else
            if [ -n "$SAFE_WIKI_PAT" ]; then
              git clone "https://x-access-token:${SAFE_WIKI_PAT}@github.com/${{ github.repository }}.wiki.git" wiki-repo || (echo 'clone failed' && ls -la && git remote -v && exit 4)
            elif [ -n "$SAFE_CI_PAT" ]; then
              git clone "https://x-access-token:${SAFE_CI_PAT}@github.com/${{ github.repository }}.wiki.git" wiki-repo || (echo 'clone failed' && ls -la && git remote -v && exit 4)
            else
              echo 'CI_ARTIFACT_PAT not set and no SSH key found'; exit 3;
            fi
          fi
          ls -la wiki-repo || true

      - name: Rsync dry-run
        run: |
          set -x
          rsync -av --delete --dry-run wiki_pages/ wiki-repo/ || true

      - name: Conditional push (real when run_mode=real)
        env:
          WIKI_PAT: ${{ secrets.WIKI_PAT }}
          CI_PAT: ${{ secrets.CI_ARTIFACT_PAT }}
        run: |
          set -x
          # Strip newlines from tokens before building URL
          SAFE_WIKI_PAT="$(echo "${WIKI_PAT:-}" | tr -d '\r\n')"
          SAFE_CI_PAT="$(echo "${CI_PAT:-}" | tr -d '\r\n')"
          # Prefer using WIKI_PAT if set, else CI_ARTIFACT_PAT
          if [ -n "$SAFE_WIKI_PAT" ]; then
            WIKI_GIT_URL="https://x-access-token:${SAFE_WIKI_PAT}@github.com/${{ github.repository }}.wiki.git"
          else
            WIKI_GIT_URL="https://x-access-token:${SAFE_CI_PAT}@github.com/${{ github.repository }}.wiki.git"
          fi
          if [ -d wiki-repo/.git ]; then
            cd wiki-repo
            git add -A || true
            git commit -m "debug: test commit" || echo 'no commit'
            # If an SSH deploy key was used for clone, push via the existing 'origin' (SSH); otherwise push via HTTPS URL
            if [ -n "${WIKI_SSH_KEY:-}" ] || [ -n "${SSH_DEPLOY_KEY:-}" ]; then
              if [ "${{ github.event.inputs.run_mode }}" = "real" ]; then
                echo "Attempting real push to wiki repository via SSH (origin)..."
                git push origin master || git push origin main || (echo 'real push failed' && exit 6)
              else
                echo "Dry-run mode: simulating push via SSH (origin)"
                git push --dry-run origin master || echo 'master push dry-run failed or no master'
                git push --dry-run origin main || echo 'main push dry-run failed or no main'
              fi
            else
              if [ "${{ github.event.inputs.run_mode }}" = "real" ]; then
                echo "Attempting real push to wiki repository via HTTPS URL..."
                git push "$WIKI_GIT_URL" HEAD:master || git push "$WIKI_GIT_URL" HEAD:main || (echo 'real push failed' && exit 6)
              else
                echo "Dry-run mode: simulating push via HTTPS URL"
                git push --dry-run "$WIKI_GIT_URL" HEAD:master || echo 'master push dry-run failed or no master'
                git push --dry-run "$WIKI_GIT_URL" HEAD:main || echo 'main push dry-run failed or no main'
              fi
            fi
            cd ..
          else
            echo 'No wiki-repo git dir' && exit 5
          fi

      - name: Done
        run: echo "Debug run completed (dry-run). Check logs above for details."