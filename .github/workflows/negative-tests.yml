---
name: Negative Testing for Permissive Roles

on:
  push:
    paths:
      - 'roles/containers/**'
      - '.github/workflows/negative-tests.yml'
      - 'requirements-dev.txt'
  pull_request:
    paths:
      - 'roles/containers/**'
      - '.github/workflows/negative-tests.yml'
      - 'requirements-dev.txt'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  negative-tests:
    if: ${{ github.event_name == 'push' }}
    name: Negative Testing for Permissive Roles
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        role:
          - roles/containers/ops
          - roles/containers/caddy
          - roles/containers/authentik
          - roles/containers/media
        test_case:
          - missing_file
          - wrong_permissions
          - placeholder_values
          - wrong_owner
        include:
          - role: roles/containers/caddy
            test_case: missing_ssl_dir
          - role: roles/containers/caddy
            test_case: wrong_ssl_permissions
          - role: roles/containers/authentik
            test_case: missing_redis_file
          - role: roles/containers/authentik
            test_case: empty_file
          - role: roles/containers/media
            test_case: missing_jellyfin_file
          - role: roles/containers/media
            test_case: missing_radarr_file
          - role: roles/containers/media
            test_case: empty_media_file
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Podman via apt
        run: |
          sudo apt-get update
          sudo apt-get install -y podman
          podman --version

      - name: Check Podman availability
        run: |
          podman info || true

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt','**/pyproject.toml') }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Refresh and commit hashed dependencies
        run: |
          # install pip-tools so we can regenerate lock files
          python -m pip install --upgrade pip pip-tools
          pip-compile --generate-hashes requirements.in
          pip-compile --generate-hashes requirements-dev.in
          # if regeneration changed anything, commit back to branch
          if ! git diff --quiet requirements.txt requirements-dev.txt; then
            echo "Dependencies updated, committing changes."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add requirements.txt requirements-dev.txt
            git commit -m "ci: refresh hashed dependencies"
            git push
          else
            echo "Dependency hashes are up-to-date."
          fi

      - name: Install dependencies (ansible, molecule + podman plugin)
        run: |
          python -m pip install --upgrade pip
          # require hashes to enforce supply-chain verification (locked by pip-compile)
          pip install --require-hashes -r requirements-dev.txt

      - name: Cache Ansible Galaxy collections
        uses: actions/cache@v4
        with:
          path: |
            ~/.ansible/collections
          key: ${{ runner.os }}-ansible-collections-${{ hashFiles('**/collections.yml') }}

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install ansible.posix community.general containers.podman

      - name: Run negative tests
        run: |
          cd ${{ matrix.role }}
          echo "Running negative test: ${{ matrix.test_case }} for role ${{ matrix.role }}"
          test_case=${{ matrix.test_case }} molecule test --scenario-name negative
        env:
          test_case: ${{ matrix.test_case }}

      - name: Set artifact name
        if: always()
        run: |
          ART="${{ matrix.role }}"
          ART=${ART//\//-}
          echo "ARTIFACT_NAME=$ART" >> $GITHUB_ENV

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ matrix.test_case }}
          path: |
            ${{ matrix.role }}/molecule
            ${{ matrix.role }}/.molecule
          if-no-files-found: warn

  validate-workflow:
    name: Validate GitHub Actions Workflow
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate workflow syntax
        run: |
          echo "Validating .github/workflows/negative-tests.yml"
          python -c "import yaml; yaml.safe_load(open('.github/workflows/negative-tests.yml')); print('âœ… Workflow syntax is valid')"
