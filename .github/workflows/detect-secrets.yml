---
name: Detect Secrets

# yamllint disable-line rule:truthy
on:
  push:
    branches:
      - main
      - "ci/**"
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  detect-secrets:
    name: Detect Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install detect-secrets
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade detect-secrets

      - name: Locate baseline file
        id: baseline
        run: |
          # Look for .secrets.baseline in common locations
          if [ -f ".secrets.baseline" ]; then
            echo "path=.secrets.baseline" >> "$GITHUB_OUTPUT"
          elif [ -f "projects/deploy-system-unified/.secrets.baseline" ]; then
            echo "path=projects/deploy-system-unified/.secrets.baseline" >> "$GITHUB_OUTPUT"
          else
            echo "path=" >> "$GITHUB_OUTPUT"
            echo "No baseline found - will scan without baseline"
          fi

      - name: Run detect-secrets scan
        # yamllint disable rule:line-length
        run: |
          set -x
          BASELINE="${{ steps.baseline.outputs.path }}"

          # Exclude CI artifacts and documentation examples
          EXCLUDES="--exclude-files 'ci-artifacts/.*' --exclude-files '.secrets_scan.*' --exclude-files 'Offline_Research/.*'"

          if [ -n "$BASELINE" ] && [ -f "$BASELINE" ]; then
            echo "Using baseline: $BASELINE"
            # Audit mode: scan and compare to baseline
            detect-secrets scan $EXCLUDES --baseline "$BASELINE" > .secrets_scan.json 2>&1 || true

            # Check for NEW secrets not in baseline
            if [ -s .secrets_scan.json ]; then
              # Count new secrets (those not already in baseline)
              new_count=$(jq '[.results[] | select(length > 0)] | length' .secrets_scan.json 2>/dev/null || echo "0")
              if [ "$new_count" -gt 0 ]; then
                echo "::error::New secrets detected that are not in baseline!"
                jq '.results' .secrets_scan.json
                exit 1
              else
                echo "No new secrets detected."
              fi
            fi
          else
            echo "No baseline found, running fresh scan..."
            detect-secrets scan --all-files $EXCLUDES > .secrets_scan.json 2>&1 || true
            if [ -s .secrets_scan.json ]; then
              count=$(jq '.results | keys | length' .secrets_scan.json 2>/dev/null || echo "0")
              if [ "$count" -gt 0 ]; then
                echo "::error::Secrets detected! Create a baseline with: detect-secrets scan > .secrets.baseline"
                jq '.results' .secrets_scan.json
                exit 1
              fi
            fi
          fi
          echo "âœ… No secrets detected"
        # yamllint enable rule:line-length

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detect-secrets-scan
          path: .secrets_scan.json
          if-no-files-found: ignore
