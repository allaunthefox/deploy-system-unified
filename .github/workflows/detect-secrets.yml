---
name: Detect Secrets

# yamllint disable-line rule:truthy
on:
  push:
    branches:
      - main
      - "ci/**"
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  detect-secrets:
    name: Detect Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Guard against nested project mirror
        run: |
          set -euo pipefail
          # This repository was flattened; ensure no lingering nested copies exist
          if git ls-files 'deploy-system-unified/**' | grep -q '.'; then
            echo "::error::Tracked files found under obsolete path: deploy-system-unified/"
            git ls-files 'deploy-system-unified/**'
            exit 1
          fi

      - name: Install detect-secrets
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade detect-secrets

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Locate baseline file
        id: baseline
        run: |
          # Look for .secrets.baseline in common locations
          if [ -f ".secrets.baseline" ]; then
            echo "path=.secrets.baseline" >> "$GITHUB_OUTPUT"
          elif [ -f ".secrets.baseline" ]; then
            echo "path=.secrets.baseline" >> "$GITHUB_OUTPUT"
          fi
          else
            echo "path=" >> "$GITHUB_OUTPUT"
            echo "No baseline found - will scan without baseline"
          fi

      - name: Run detect-secrets scan
        # yamllint disable rule:line-length
        run: |
          set -euo pipefail
          WORKSPACE="${GITHUB_WORKSPACE:-$PWD}"
          BASELINE="${{ steps.baseline.outputs.path }}"
          SCAN_ERR="${WORKSPACE}/.secrets_scan.err"
          SCAN_JSON="${WORKSPACE}/.secrets_scan.json"
          : > "$SCAN_ERR"

          # Exclude CI artifacts and documentation examples
          EXCLUDES=(
            --exclude-files 'ci-artifacts/.*'
            --exclude-files '\.secrets_scan\..*'
            --exclude-files 'Offline_Research/.*'
            --exclude-files '(^|/)\.secrets\.baseline$'
            --exclude-files '\.ansible/collections/.*'
            --exclude-files '\.ansible/galaxy_cache/.*'
            --exclude-files '\.git/.*'
            --exclude-files 'inventory/group_vars/.*/secrets.*'
            --exclude-files 'charts/.*/values.*\.ya?ml'
            --exclude-files '.*\.sops\.ya?ml'
          )

          if [ -n "$BASELINE" ] && [ -f "$BASELINE" ]; then
            echo "Using baseline: $BASELINE"

            base_dir="$(dirname "$BASELINE")"
            tmp_baseline="$(mktemp)"
            cp "$BASELINE" "$tmp_baseline"

            # Newer detect-secrets versions update the baseline file in-place when --baseline is provided.
            # We therefore run against a temporary copy and diff its results against the committed baseline.
            # Run from the baseline directory so file paths in the baseline are stable and comparable.
            (
              cd "$base_dir"
              detect-secrets scan "${EXCLUDES[@]}" --baseline "$tmp_baseline" 1>/dev/null 2>"$SCAN_ERR"
            )
            cp "$tmp_baseline" "$SCAN_JSON"

            # Fail hard on JSON parse errors.
            jq -e '.results' "$BASELINE" >/dev/null
            jq -e '.results' "$tmp_baseline" >/dev/null

            baseline_fps="$(mktemp)"
            tmp_fps="$(mktemp)"
            jq -r '.results | to_entries[] | .key as $file | .value[]? | "\($file)|\(.type)|\(.hashed_secret)"' "$BASELINE" | sort -u > "$baseline_fps"
            jq -r '.results | to_entries[] | .key as $file | .value[]? | "\($file)|\(.type)|\(.hashed_secret)"' "$tmp_baseline" | sort -u > "$tmp_fps"

            new_secrets="$(comm -13 "$baseline_fps" "$tmp_fps" || true)"
            if [ -n "$new_secrets" ]; then
              echo "::error::New potential secrets detected (not present in baseline)."
              echo "$new_secrets"
              exit 1
            fi
            echo "No new secrets detected."
          else
            echo "No baseline found, running fresh scan..."

            detect-secrets scan --all-files "${EXCLUDES[@]}" > "$SCAN_JSON" 2>"$SCAN_ERR"
            jq -e '.results' "$SCAN_JSON" >/dev/null
            count=$(jq '[.results | to_entries[] | select(.value | length > 0)] | length' "$SCAN_JSON")
            if [ "$count" -gt 0 ]; then
              echo "::error::Potential secrets detected! Create a baseline with: detect-secrets scan > .secrets.baseline"
              jq '.results' "$SCAN_JSON"
              exit 1
            fi
          fi

          if [ -s "$SCAN_ERR" ]; then
            echo "--- detect-secrets stderr (first 200 lines) ---"
            sed -n '1,200p' "$SCAN_ERR"
          fi

          echo "âœ… No new secrets detected"
        # yamllint enable rule:line-length

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detect-secrets-scan
          path: |
            .secrets_scan.json
            .secrets_scan.err
          if-no-files-found: ignore
