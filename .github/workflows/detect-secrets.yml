name: Detect Secrets

on:
  push:
    branches: [ main, ci/** ]
  pull_request:
    branches: [ main ]

jobs:
  detect-secrets:
    name: Detect Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install detect-secrets
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade detect-secrets==1.3.0

      - name: Verify detect-secrets installation
        run: |
          python -m pip show detect-secrets || true
          detect-secrets --version || true

      - name: Run detect-secrets scan (debug)
        continue-on-error: true
        run: |
          set -x
          python -V || true
          pip --version || true
          pip freeze | head -n 50 || true
          detect-secrets --version || true

          echo "Running detect-secrets on repository..."
          detect-secrets scan --all-files --json > .secrets_scan.json 2> detect_secrets.err || true
          echo "Scan exit code: $?"
          # if JSON output is empty (some detect-secrets versions don't support --json), fall back to plaintext
          if [ ! -s .secrets_scan.json ]; then
            echo "JSON output empty; falling back to plaintext scan"
            detect-secrets scan --all-files > .secrets_scan.txt 2>> detect_secrets.err || true
          fi
          ls -l .secrets_scan.json .secrets_scan.txt detect_secrets.err || true
          echo "--- detect_secrets.err ---"
          cat detect_secrets.err || true

      - name: Upload scan debug artifacts
        uses: actions/upload-artifact@v4
        with:
          name: detect-secrets-debug
          path: |
            .secrets_scan.json
            detect_secrets.err

      - name: Analyze scan results
        run: |
          if [ ! -f .secrets_scan.json ]; then
            echo "No .secrets_scan.json found; skipping analysis"
            exit 0
          fi
          python - <<'PY'
            import sys, json
            try:
                j = json.load(open('.secrets_scan.json'))
            except Exception as e:
                print('Failed to parse .secrets_scan.json:', e)
                sys.exit(0)
            if j.get('results') and len(j['results'].keys()) > 0:
                print('Potential secrets detected:')
                for path, findings in j['results'].items():
                    for f in findings:
                        print(f"- {path}: {f.get("type")} at line {f.get("line_number")}")
                sys.exit(1)
            print('No potential secrets found')

            PY

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: detect-secrets-scan
          path: .secrets_scan.json
