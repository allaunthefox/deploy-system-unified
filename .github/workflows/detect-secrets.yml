name: Detect Secrets

on:
  push:
    branches: [ main, ci/** ]
  pull_request:
    branches: [ main ]

jobs:
  detect-secrets:
    name: Detect Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install detect-secrets
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade detect-secrets

      - name: Verify detect-secrets installation
        run: |
          python -m pip show detect-secrets || true
          detect-secrets --version || true

      - name: Run detect-secrets scan
        run: |
          echo "Running detect-secrets on repository..."
          detect-secrets scan --all-files --json > .secrets_scan.json
          echo "Scan complete; writing results to .secrets_scan.json"
          python - <<'PY'
import sys, json
with open('.secrets_scan.json') as f:
    j = json.load(f)
if j.get('results') and len(j['results'].keys()) > 0:
    print('Potential secrets detected:')
    for path, findings in j['results'].items():
        for f in findings:
            print(f"- {path}: {f.get('type')} at line {f.get('line_number')}")
    sys.exit(1)
print('No potential secrets found')
PY

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: detect-secrets-scan
          path: .secrets_scan.json
