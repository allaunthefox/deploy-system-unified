---
name: Detect Secrets

# yamllint disable-line rule:truthy
on:
  push:
    branches:
      - main
      - "ci/**"
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  detect-secrets:
    name: Detect Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install detect-secrets
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade detect-secrets

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Locate baseline file
        id: baseline
        run: |
          # Look for .secrets.baseline in common locations
          if [ -f ".secrets.baseline" ]; then
            echo "path=.secrets.baseline" >> "$GITHUB_OUTPUT"
          elif [ -f "projects/deploy-system-unified/.secrets.baseline" ]; then
            echo "path=projects/deploy-system-unified/.secrets.baseline" >> "$GITHUB_OUTPUT"
          else
            echo "path=" >> "$GITHUB_OUTPUT"
            echo "No baseline found - will scan without baseline"
          fi

      - name: Run detect-secrets scan
        # yamllint disable rule:line-length
        run: |
          set -euo pipefail
          BASELINE="${{ steps.baseline.outputs.path }}"

          # Exclude CI artifacts and documentation examples
          EXCLUDES=(
            --exclude-files 'ci-artifacts/.*'
            --exclude-files '\.secrets_scan\..*'
            --exclude-files 'Offline_Research/.*'
          )

          if [ -n "$BASELINE" ] && [ -f "$BASELINE" ]; then
            echo "Using baseline: $BASELINE"

            tmp_baseline="$(mktemp)"
            cp "$BASELINE" "$tmp_baseline"

            # Newer detect-secrets versions update the baseline file in-place when --baseline is provided.
            # We therefore run against a temporary copy and diff its results against the committed baseline.
            detect-secrets scan "${EXCLUDES[@]}" --baseline "$tmp_baseline" 1>/dev/null 2>.secrets_scan.err
            cp "$tmp_baseline" .secrets_scan.json

            # Fail hard on JSON parse errors.
            jq -e '.results' "$BASELINE" >/dev/null
            jq -e '.results' "$tmp_baseline" >/dev/null

            baseline_fps="$(mktemp)"
            tmp_fps="$(mktemp)"
            jq -r '.results | to_entries[] | .key as $file | .value[]? | "\($file)|\(.type)|\(.hashed_secret)"' "$BASELINE" | sort -u > "$baseline_fps"
            jq -r '.results | to_entries[] | .key as $file | .value[]? | "\($file)|\(.type)|\(.hashed_secret)"' "$tmp_baseline" | sort -u > "$tmp_fps"

            new_secrets="$(comm -13 "$baseline_fps" "$tmp_fps" || true)"
            if [ -n "$new_secrets" ]; then
              echo "::error::New potential secrets detected (not present in baseline)."
              echo "$new_secrets"
              exit 1
            fi
            echo "No new secrets detected."
          else
            echo "No baseline found, running fresh scan..."

            detect-secrets scan --all-files "${EXCLUDES[@]}" > .secrets_scan.json 2>.secrets_scan.err
            jq -e '.results' .secrets_scan.json >/dev/null
            count=$(jq '[.results | to_entries[] | select(.value | length > 0)] | length' .secrets_scan.json)
            if [ "$count" -gt 0 ]; then
              echo "::error::Potential secrets detected! Create a baseline with: detect-secrets scan > .secrets.baseline"
              jq '.results' .secrets_scan.json
              exit 1
            fi
          fi

          if [ -s .secrets_scan.err ]; then
            echo "--- detect-secrets stderr (first 200 lines) ---"
            sed -n '1,200p' .secrets_scan.err
          fi

          echo "âœ… No new secrets detected"
        # yamllint enable rule:line-length

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detect-secrets-scan
          path: |
            .secrets_scan.json
            .secrets_scan.err
          if-no-files-found: ignore
