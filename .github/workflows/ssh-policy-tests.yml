name: SSH Policy Tests

on:
  push:
    branches: [ "chore/ssh-policy-hardening", "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  idempotence:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (PR head)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          submodules: false

      - name: Run idempotence test on runner
        run: |
          set -euo pipefail
          # determine actual project root (checkout sometimes nests in another directory)
          PROJECT_ROOT="$GITHUB_WORKSPACE"
          if [ -d "$GITHUB_WORKSPACE/deploy-system-unified" ]; then
            PROJECT_ROOT="$GITHUB_WORKSPACE/deploy-system-unified"
          fi
          # Build ANSIBLE_ROLES_PATH from any 'roles' directories inside the project tree
          ROLES_PATHS=$(find "$PROJECT_ROOT" -type d -name roles -print | paste -sd ':' -)
          if [ -z "$ROLES_PATHS" ]; then
            echo "ERROR: no 'roles' directories found in project root ($PROJECT_ROOT)"
            find "$PROJECT_ROOT" -maxdepth 6 -type d -name roles -print || true
            exit 2
          fi
          export ANSIBLE_ROLES_PATH="$ROLES_PATHS:$PROJECT_ROOT"

          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends openssh-server python3 python3-pip ca-certificates gnupg wget
          curl -sL https://github.com/mozilla/sops/releases/download/v3.9.1/sops-v3.9.1.linux -o /usr/local/bin/sops && sudo chmod +x /usr/local/bin/sops
          sudo pip3 install --no-cache-dir "ansible-core>=2.15,<2.16"

          # Locate the idempotence playbook anywhere under the workspace
          PLAYBOOK=$(find "$GITHUB_WORKSPACE" -path '*/roles/security/sshd/tests/idempotence.yml' -print -quit)
          if [ -z "$PLAYBOOK" ]; then
            echo "ERROR: idempotence playbook not found in workspace"
            find "$GITHUB_WORKSPACE" -maxdepth 4 -type f -name idempotence.yml -print || true
            exit 2
          fi
          echo "Using playbook: $PLAYBOOK"; ls -la "$(dirname "$PLAYBOOK")" || true
          ansible-playbook "$PLAYBOOK" --connection=local
